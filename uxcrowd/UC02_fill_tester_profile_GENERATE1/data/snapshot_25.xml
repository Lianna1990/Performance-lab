<?xml version="1.0" encoding="utf-8"?>
<HTTPSnapshot xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" id="25">
  <HTTPTask id="295" hostname="prod.uxcrowd.ru" path="/assets/js/main_js/mediaelement-and-player.js" url="https://prod.uxcrowd.ru/assets/js/main_js/mediaelement-and-player.js" ip="127.0.0.1" port="443" connectionId="13" origin="Primary" frame="1" startDateTime="2019-10-18T15:08:50.563+03:00" startTime="80862078" endTime="80862375">
    <HTTPRequest method="GET">
      <HTTPHeaders>
        <HTTPHeaderEntity name="Host" index="0">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>cHJvZC51eGNyb3dkLnJ1</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="User-Agent" index="1">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>TW96aWxsYS81LjAgKFdpbmRvd3MgTlQgMTAuMDsgV09XNjQ7IHJ2OjQ4LjApIEdlY2tvLzIwMTAwMTAxIEZpcmVmb3gvNDguMA==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Accept" index="2">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Ki8q</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Accept-Language" index="3">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>cnUtUlUscnU7cT0wLjgsZW4tVVM7cT0wLjUsZW47cT0wLjM=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Accept-Encoding" index="4">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Z3ppcCwgZGVmbGF0ZSwgYnI=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Referer" index="5">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>aHR0cHM6Ly9wcm9kLnV4Y3Jvd2QucnUv</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Connection" index="6">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>a2VlcC1hbGl2ZQ==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPAllHeaders>
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>R0VUIC9hc3NldHMvanMvbWFpbl9qcy9tZWRpYWVsZW1lbnQtYW5kLXBsYXllci5qcyBIVFRQLzEuMQ0KSG9zdDogcHJvZC51eGNyb3dkLnJ1DQpVc2VyLUFnZW50OiBNb3ppbGxhLzUuMCAoV2luZG93cyBOVCAxMC4wOyBXT1c2NDsgcnY6NDguMCkgR2Vja28vMjAxMDAxMDEgRmlyZWZveC80OC4wDQpBY2NlcHQ6ICovKg0KQWNjZXB0LUxhbmd1YWdlOiBydS1SVSxydTtxPTAuOCxlbi1VUztxPTAuNSxlbjtxPTAuMw0KQWNjZXB0LUVuY29kaW5nOiBnemlwLCBkZWZsYXRlLCBicg0KUmVmZXJlcjogaHR0cHM6Ly9wcm9kLnV4Y3Jvd2QucnUvDQpDb25uZWN0aW9uOiBrZWVwLWFsaXZlDQoNCg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPAllHeaders>
      </HTTPHeaders>
    </HTTPRequest>
    <HTTPResponse>
      <contentLenght>510172</contentLenght>
      <HTTPHeaders>
        <HTTPHeaderEntity name="Server" index="0">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>bmdpbng=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Date" index="1">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>RnJpLCAxOCBPY3QgMjAxOSAxMjowNzoxOCBHTVQ=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Content-Type" index="2">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>YXBwbGljYXRpb24vamF2YXNjcmlwdDsgY2hhcnNldD1VVEYtOA==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Content-Length" index="3">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>NTEwMTcy</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Connection" index="4">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>a2VlcC1hbGl2ZQ==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Last-Modified" index="5">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>V2VkLCAyNSBTZXAgMjAxOSAxNToyMTowNiBHTVQ=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="ETag" index="6">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>IjVkOGI4NWUyLTdjOGRjIg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Cache-Control" index="7">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>bXVzdC1yZXZhbGlkYXRl</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Accept-Ranges" index="8">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>Ynl0ZXM=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Content-Security-Policy-Report-Only" index="9">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>ZGVmYXVsdC1zcmMgaHR0cHM6OyBzY3JpcHQtc3JjIGh0dHBzOiAndW5zYWZlLWV2YWwnICd1bnNhZmUtaW5saW5lJzsgc3R5bGUtc3JjIGh0dHBzOiAndW5zYWZlLWlubGluZSc7IGltZy1zcmMgaHR0cHM6IGRhdGE6OyBmb250LXNyYyBodHRwczogZGF0YTo7IHJlcG9ydC11cmkgL2NzcC1yZXBvcnQ=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Strict-Transport-Security" index="10">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>bWF4LWFnZT04NjQwMDs=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPHeaderEntity name="Content-Security-Policy-Report-Only" index="11">
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>ZGVmYXVsdC1zcmMgaHR0cHM6OyBzY3JpcHQtc3JjIGh0dHBzOiAndW5zYWZlLWV2YWwnICd1bnNhZmUtaW5saW5lJzsgc3R5bGUtc3JjIGh0dHBzOiAndW5zYWZlLWlubGluZSc7IGltZy1zcmMgaHR0cHM6IGRhdGE6OyBmb250LXNyYyBodHRwczogZGF0YTo7IHJlcG9ydC11cmkgL2NzcC1yZXBvcnQ=</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPHeaderEntity>
        <HTTPAllHeaders>
          <HTTPDataSet>
            <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
              <ActualData>SFRUUC8xLjEgMjAwIE9LDQpTZXJ2ZXI6IG5naW54DQpEYXRlOiBGcmksIDE4IE9jdCAyMDE5IDEyOjA3OjE4IEdNVA0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0OyBjaGFyc2V0PVVURi04DQpDb250ZW50LUxlbmd0aDogNTEwMTcyDQpDb25uZWN0aW9uOiBrZWVwLWFsaXZlDQpMYXN0LU1vZGlmaWVkOiBXZWQsIDI1IFNlcCAyMDE5IDE1OjIxOjA2IEdNVA0KRVRhZzogIjVkOGI4NWUyLTdjOGRjIg0KQ2FjaGUtQ29udHJvbDogbXVzdC1yZXZhbGlkYXRlDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1TZWN1cml0eS1Qb2xpY3ktUmVwb3J0LU9ubHk6IGRlZmF1bHQtc3JjIGh0dHBzOjsgc2NyaXB0LXNyYyBodHRwczogJ3Vuc2FmZS1ldmFsJyAndW5zYWZlLWlubGluZSc7IHN0eWxlLXNyYyBodHRwczogJ3Vuc2FmZS1pbmxpbmUnOyBpbWctc3JjIGh0dHBzOiBkYXRhOjsgZm9udC1zcmMgaHR0cHM6IGRhdGE6OyByZXBvcnQtdXJpIC9jc3AtcmVwb3J0DQpTdHJpY3QtVHJhbnNwb3J0LVNlY3VyaXR5OiBtYXgtYWdlPTg2NDAwOw0KQ29udGVudC1TZWN1cml0eS1Qb2xpY3ktUmVwb3J0LU9ubHk6IGRlZmF1bHQtc3JjIGh0dHBzOjsgc2NyaXB0LXNyYyBodHRwczogJ3Vuc2FmZS1ldmFsJyAndW5zYWZlLWlubGluZSc7IHN0eWxlLXNyYyBodHRwczogJ3Vuc2FmZS1pbmxpbmUnOyBpbWctc3JjIGh0dHBzOiBkYXRhOjsgZm9udC1zcmMgaHR0cHM6IGRhdGE6OyByZXBvcnQtdXJpIC9jc3AtcmVwb3J0DQoNCg==</ActualData>
            </HTTPData>
          </HTTPDataSet>
          <IsExternalData>false</IsExternalData>
        </HTTPAllHeaders>
      </HTTPHeaders>
      <HTTPBody>
        <HTTPDataSet>
          <HTTPData dataFilePath="" dfeDataType="Raw" sectionDataType="1">
            <ActualData>LyohCiAqIE1lZGlhRWxlbWVudC5qcwogKiBodHRwOi8vd3d3Lm1lZGlhZWxlbWVudC5jb20vCiAqCiAqIFdyYXBwZXIgdGhhdCBtaW1pY3MgbmF0aXZlIEhUTUw1IE1lZGlhRWxlbWVudCAoYXVkaW8gYW5kIHZpZGVvKQogKiB1c2luZyBhIHZhcmlldHkgb2YgdGVjaG5vbG9naWVzIChwdXJlIEphdmFTY3JpcHQsIEZsYXNoLCBpZnJhbWUpCiAqCiAqIENvcHlyaWdodCAyMDEwLTIwMTcsIEpvaG4gRHllciAoaHR0cDovL2ouaG4vKQogKiBMaWNlbnNlOiBNSVQKICoKICovCgoKKGZ1bmN0aW9uIGUodCwgbiwgcikgewogICAgZnVuY3Rpb24gcyhvLCB1KSB7CiAgICAgICAgaWYgKCFuW29dKSB7CiAgICAgICAgICAgIGlmICghdFtvXSkgewogICAgICAgICAgICAgICAgdmFyIGEgPSB0eXBlb2YgcmVxdWlyZSA9PSAiZnVuY3Rpb24iICYmIHJlcXVpcmU7CiAgICAgICAgICAgICAgICBpZiAoIXUgJiYgYSlyZXR1cm4gYShvLCAhMCk7CiAgICAgICAgICAgICAgICBpZiAoaSlyZXR1cm4gaShvLCAhMCk7CiAgICAgICAgICAgICAgICB2YXIgZiA9IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgbW9kdWxlICciICsgbyArICInIik7CiAgICAgICAgICAgICAgICB0aHJvdyBmLmNvZGUgPSAiTU9EVUxFX05PVF9GT1VORCIsIGYKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbCA9IG5bb10gPSB7ZXhwb3J0czoge319OwogICAgICAgICAgICB0W29dWzBdLmNhbGwobC5leHBvcnRzLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgdmFyIG4gPSB0W29dWzFdW2VdOwogICAgICAgICAgICAgICAgcmV0dXJuIHMobiA/IG4gOiBlKQogICAgICAgICAgICB9LCBsLCBsLmV4cG9ydHMsIGUsIHQsIG4sIHIpCiAgICAgICAgfQogICAgICAgIHJldHVybiBuW29dLmV4cG9ydHMKICAgIH0KCiAgICB2YXIgaSA9IHR5cGVvZiByZXF1aXJlID09ICJmdW5jdGlvbiIgJiYgcmVxdWlyZTsKICAgIGZvciAodmFyIG8gPSAwOyBvIDwgci5sZW5ndGg7IG8rKylzKHJbb10pOwogICAgcmV0dXJuIHMKfSkoewogICAgMTogW2Z1bmN0aW9uIChfZGVyZXFfLCBtb2R1bGUsIGV4cG9ydHMpIHsKCiAgICB9LCB7fV0sCiAgICAyOiBbZnVuY3Rpb24gKF9kZXJlcV8sIG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgIChmdW5jdGlvbiAoZ2xvYmFsKSB7CiAgICAgICAgICAgIHZhciB0b3BMZXZlbCA9IHR5cGVvZiBnbG9iYWwgIT09ICd1bmRlZmluZWQnID8gZ2xvYmFsIDoKICAgICAgICAgICAgICAgIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnID8gd2luZG93IDoge30KICAgICAgICAgICAgdmFyIG1pbkRvYyA9IF9kZXJlcV8oMSk7CgogICAgICAgICAgICBpZiAodHlwZW9mIGRvY3VtZW50ICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBkb2N1bWVudDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBkb2NjeSA9IHRvcExldmVsWydfX0dMT0JBTF9ET0NVTUVOVF9DQUNIRUA0J107CgogICAgICAgICAgICAgICAgaWYgKCFkb2NjeSkgewogICAgICAgICAgICAgICAgICAgIGRvY2N5ID0gdG9wTGV2ZWxbJ19fR0xPQkFMX0RPQ1VNRU5UX0NBQ0hFQDQnXSA9IG1pbkRvYzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGRvY2N5OwogICAgICAgICAgICB9CgogICAgICAgIH0pLmNhbGwodGhpcywgdHlwZW9mIGdsb2JhbCAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWwgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKICAgIH0sIHsiMSI6IDF9XSwKICAgIDM6IFtmdW5jdGlvbiAoX2RlcmVxXywgbW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgKGZ1bmN0aW9uIChnbG9iYWwpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IHdpbmRvdzsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZ2xvYmFsICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBnbG9iYWw7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IHNlbGY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IHt9OwogICAgICAgICAgICB9CgogICAgICAgIH0pLmNhbGwodGhpcywgdHlwZW9mIGdsb2JhbCAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWwgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKICAgIH0sIHt9XSwKICAgIDQ6IFtmdW5jdGlvbiAoX2RlcmVxXywgbW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgCgogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgICAgICAgICAgdmFsdWU6IHRydWUKICAgICAgICB9KTsKCiAgICAgICAgdmFyIF90eXBlb2YgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBTeW1ib2wuaXRlcmF0b3IgPT09ICJzeW1ib2wiID8gZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmo7CiAgICAgICAgICAgIH0gOiBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqICYmIHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgb2JqICE9PSBTeW1ib2wucHJvdG90eXBlID8gInN5bWJvbCIgOiB0eXBlb2Ygb2JqOwogICAgICAgICAgICB9OwoKICAgICAgICB2YXIgX21lanMgPSBfZGVyZXFfKDYpOwoKICAgICAgICB2YXIgX21lanMyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfbWVqcyk7CgogICAgICAgIHZhciBfZW4gPSBfZGVyZXFfKDE0KTsKCiAgICAgICAgdmFyIF9nZW5lcmFsID0gX2RlcmVxXygyOSk7CgogICAgICAgIGZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ZGVmYXVsdDogb2JqfTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIExvY2FsZS4KICAgICAgICAgKgogICAgICAgICAqIFRoaXMgb2JqZWN0IG1hbmFnZXMgdHJhbnNsYXRpb25zIHdpdGggcGx1cmFsaXphdGlvbi4gQWxzbyBkZWFscyB3aXRoIFdvcmRQcmVzcyBjb21wYXRpYmlsaXR5LgogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgdmFyIGkxOG4gPSB7bGFuZzogJ2VuJywgZW46IF9lbi5FTn07CgogICAgICAgIC8qKgogICAgICAgICAqIExhbmd1YWdlIHNldHRlci9nZXR0ZXIKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7Kn0gYXJncyAgQ2FuIHBhc3MgdGhlIGxhbmd1YWdlIGNvZGUgYW5kL29yIHRoZSB0cmFuc2xhdGlvbiBzdHJpbmdzIGFzIGFuIE9iamVjdAogICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBpMThuLmxhbmd1YWdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGFyZ3MgIT09IG51bGwgJiYgYXJncyAhPT0gdW5kZWZpbmVkICYmIGFyZ3MubGVuZ3RoKSB7CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmdzWzBdICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0xhbmd1YWdlIGNvZGUgbXVzdCBiZSBhIHN0cmluZyB2YWx1ZScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghYXJnc1swXS5tYXRjaCgvXlthLXpdezJ9KFwtW2Etel17Mn0pPyQvaSkpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdMYW5ndWFnZSBjb2RlIG11c3QgaGF2ZSBmb3JtYXQgYHh4YCBvciBgeHgteHhgJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaTE4bi5sYW5nID0gYXJnc1swXTsKCiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBsYW5ndWFnZSBzdHJpbmdzIHdlcmUgYWRkZWQ7IG90aGVyd2lzZSwgY2hlY2sgdGhlIHNlY29uZCBhcmd1bWVudCBvciBzZXQgdG8gRW5nbGlzaCBhcyBkZWZhdWx0CiAgICAgICAgICAgICAgICBpZiAoaTE4blthcmdzWzBdXSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgYXJnc1sxXSA9IGFyZ3NbMV0gIT09IG51bGwgJiYgYXJnc1sxXSAhPT0gdW5kZWZpbmVkICYmIF90eXBlb2YoYXJnc1sxXSkgPT09ICdvYmplY3QnID8gYXJnc1sxXSA6IHt9OwogICAgICAgICAgICAgICAgICAgIGkxOG5bYXJnc1swXV0gPSAhKDAsIF9nZW5lcmFsLmlzT2JqZWN0RW1wdHkpKGFyZ3NbMV0pID8gYXJnc1sxXSA6IF9lbi5FTjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJnc1sxXSAhPT0gbnVsbCAmJiBhcmdzWzFdICE9PSB1bmRlZmluZWQgJiYgX3R5cGVvZihhcmdzWzFdKSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICBpMThuW2FyZ3NbMF1dID0gYXJnc1sxXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGkxOG4ubGFuZzsKICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBUcmFuc2xhdGUgYSBzdHJpbmcgaW4gdGhlIGxhbmd1YWdlIHNldCB1cCAob3IgRW5nbGlzaCBieSBkZWZhdWx0KQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IG1lc3NhZ2UKICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gcGx1cmFsUGFyYW0KICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgaTE4bi50ID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICAgICAgICAgICAgdmFyIHBsdXJhbFBhcmFtID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBudWxsOwoKCiAgICAgICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSA9PT0gJ3N0cmluZycgJiYgbWVzc2FnZS5sZW5ndGgpIHsKCiAgICAgICAgICAgICAgICB2YXIgc3RyID0gdm9pZCAwLAogICAgICAgICAgICAgICAgICAgIHBsdXJhbEZvcm0gPSB2b2lkIDA7CgogICAgICAgICAgICAgICAgdmFyIGxhbmd1YWdlID0gaTE4bi5sYW5ndWFnZSgpOwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogTW9kaWZ5IHN0cmluZyB1c2luZyBhbGdvcml0aG0gdG8gZGV0ZWN0IHBsdXJhbCBmb3Jtcy4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgICAgICogQHNlZSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzEzNTM0MDgvbWVzc2FnZWZvcm1hdC1pbi1qYXZhc2NyaXB0LXBhcmFtZXRlcnMtaW4tbG9jYWxpemVkLXVpLXN0cmluZ3MKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfFN0cmluZ1tdfSBpbnB1dCAgIC0gU3RyaW5nIG9yIGFycmF5IG9mIHN0cmluZ3MgdG8gcGljayB0aGUgcGx1cmFsIGZvcm0KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBudW1iZXIgICAgICAgICAgIC0gTnVtYmVyIHRvIGRldGVybWluZSB0aGUgcHJvcGVyIHBsdXJhbCBmb3JtCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge051bWJlcn0gZm9ybSAgICAgICAgICAgICAtIE51bWJlciBvZiBsYW5ndWFnZSBmYW1pbHkgdG8gYXBwbHkgcGx1cmFsIGZvcm0KICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge1N0cmluZ30KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgdmFyIF9wbHVyYWwgPSBmdW5jdGlvbiBfcGx1cmFsKGlucHV0LCBudW1iZXIsIGZvcm0pIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCh0eXBlb2YgaW5wdXQgPT09ICd1bmRlZmluZWQnID8gJ3VuZGVmaW5lZCcgOiBfdHlwZW9mKGlucHV0KSkgIT09ICdvYmplY3QnIHx8IHR5cGVvZiBudW1iZXIgIT09ICdudW1iZXInIHx8IHR5cGVvZiBmb3JtICE9PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5wdXQ7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge0Z1bmN0aW9uW119CiAgICAgICAgICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICB2YXIgX3BsdXJhbEZvcm1zID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gMDogQ2hpbmVzZSwgSmFwYW5lc2UsIEtvcmVhbiwgUGVyc2lhbiwgVHVya2lzaCwgVGhhaSwgTGFvLCBBeW1hcsOhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGliZXRhbiwgQ2hpZ2EsIER6b25na2hhLCBJbmRvbmVzaWFuLCBMb2piYW4sIEdlb3JnaWFuLCBLYXpha2gsIEtobWVyLCBLeXJneXosIE1hbGF5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQnVybWVzZSwgWWFrdXQsIFN1bmRhbmVzZSwgVGF0YXIsIFV5Z2h1ciwgVmlldG5hbWVzZSwgV29sb2YKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAxID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAxOiBEYW5pc2gsIER1dGNoLCBFbmdsaXNoLCBGYXJvZXNlLCBGcmlzaWFuLCBHZXJtYW4sIE5vcndlZ2lhbiwgU3dlZGlzaCwgRXN0b25pYW4sIEZpbm5pc2gsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBIdW5nYXJpYW4sIEJhc3F1ZSwgR3JlZWssIEhlYnJldywgSXRhbGlhbiwgUG9ydHVndWVzZSwgU3BhbmlzaCwgQ2F0YWxhbiwgQWZyaWthYW5zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQW5naWthLCBBc3NhbWVzZSwgQXN0dXJpYW4sIEF6ZXJiYWlqYW5pLCBCdWxnYXJpYW4sIEJlbmdhbGksIEJvZG8sIEFyYWdvbmVzZSwgRG9ncmksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBFc3BlcmFudG8sIEFyZ2VudGluZWFuIFNwYW5pc2gsIEZ1bGFoLCBGcml1bGlhbiwgR2FsaWNpYW4sIEd1amFyYXRpLCBIYXVzYSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhpbmRpLCBDaGhhdHRpc2dhcmhpLCBBcm1lbmlhbiwgSW50ZXJsaW5ndWEsIEdyZWVubGFuZGljLCBLYW5uYWRhLCBLdXJkaXNoLCBMZXR6ZWJ1cmdlc2NoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTWFpdGhpbGksIE1hbGF5YWxhbSwgTW9uZ29saWFuLCBNYW5pcHVyaSwgTWFyYXRoaSwgTmFodWF0bCwgTmVhcG9saXRhbiwgTm9yd2VnaWFuIEJva21hbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5lcGFsaSwgTm9yd2VnaWFuIE55bm9yc2ssIE5vcndlZ2lhbiAob2xkIGNvZGUpLCBOb3J0aGVybiBTb3RobywgT3JpeWEsIFB1bmphYmksIFBhcGlhbWVudG8sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBQaWVtb250ZXNlLCBQYXNodG8sIFJvbWFuc2gsIEtpbnlhcndhbmRhLCBTYW50YWxpLCBTY290cywgU2luZGhpLCBOb3J0aGVybiBTYW1pLCBTaW5oYWxhLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU29tYWxpLCBTb25naGF5LCBBbGJhbmlhbiwgU3dhaGlsaSwgVGFtaWwsIFRlbHVndSwgVHVya21lbiwgVXJkdSwgWW9ydWJhCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pID09PSAxID8gYXJndW1lbnRzLmxlbmd0aCA8PSAxID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzFdIDogYXJndW1lbnRzLmxlbmd0aCA8PSAyID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAyOiBGcmVuY2gsIEJyYXppbGlhbiBQb3J0dWd1ZXNlLCBBY2hvbGksIEFrYW4sIEFtaGFyaWMsIE1hcHVkdW5ndW4sIEJyZXRvbiwgRmlsaXBpbm8sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBHdW4sIExpbmdhbGEsIE1hdXJpdGlhbiBDcmVvbGUsIE1hbGFnYXN5LCBNYW9yaSwgT2NjaXRhbiwgVGFqaWssIFRpZ3JpbnlhLCBVemJlaywgV2FsbG9vbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSA9PT0gMCB8fCAoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSA9PT0gMSA/IGFyZ3VtZW50cy5sZW5ndGggPD0gMSA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1sxXSA6IGFyZ3VtZW50cy5sZW5ndGggPD0gMiA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1syXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gMzogTGF0dmlhbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwID09PSAxICYmIChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pICUgMTAwICE9PSAxMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAxID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgIT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMiA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1syXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAzID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gNDogU2NvdHRpc2ggR2FlbGljCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pID09PSAxIHx8IChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pID09PSAxMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAxID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPT09IDIgfHwgKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPT09IDEyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDIgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSA+IDIgJiYgKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPCAyMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAzID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDQgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbNF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyA1OiAgUm9tYW5pYW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMSA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pID09PSAwIHx8IChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pICUgMTAwID4gMCAmJiAoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwMCA8IDIwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDIgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMyA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1szXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDY6IExpdGh1YW5pYW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgJSAxMCA9PT0gMSAmJiAoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwMCAhPT0gMTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMSA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pICUgMTAgPj0gMiAmJiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgJSAxMDAgPCAxMCB8fCAoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwMCA+PSAyMCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMiA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1syXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gNzogQmVsYXJ1c2lhbiwgQm9zbmlhbiwgQ3JvYXRpYW4sIFNlcmJpYW4sIFJ1c3NpYW4sIFVrcmFpbmlhbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwID09PSAxICYmIChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pICUgMTAwICE9PSAxMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAxID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgJSAxMCA+PSAyICYmIChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pICUgMTAgPD0gNCAmJiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgJSAxMDAgPCAxMCB8fCAoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwMCA+PSAyMCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMiA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1syXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAzID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gODogIFNsb3ZhaywgQ3plY2gKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMSA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pID49IDIgJiYgKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPD0gNCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAyID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDMgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbM107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyA5OiBQb2xpc2gKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMSA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pICUgMTAgPj0gMiAmJiAoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwIDw9IDQgJiYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pICUgMTAwIDwgMTAgfHwgKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgJSAxMDAgPj0gMjApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDIgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMyA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1szXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDEwOiBTbG92ZW5pYW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgJSAxMDAgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMiA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1syXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pICUgMTAwID09PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDMgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbM107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwMCA9PT0gMyB8fCAoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwMCA9PT0gNCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSA0ID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDEgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAxMTogSXJpc2ggR2FlbGljCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDEgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAyID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPiAyICYmIChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pIDwgNykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAzID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPiA2ICYmIChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pIDwgMTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gNCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1s0XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSA1ID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzVdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gMTI6IEFyYWJpYwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAxID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMiA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1syXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pID09PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDMgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbM107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwMCA+PSAzICYmIChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pICUgMTAwIDw9IDEwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDQgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbNF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwMCA+PSAxMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSA1ID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzVdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDYgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbNl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAxMzogTWFsdGVzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAxID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPT09IDAgfHwgKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgJSAxMDAgPiAxICYmIChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pICUgMTAwIDwgMTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMiA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1syXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pICUgMTAwID4gMTAgJiYgKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgJSAxMDAgPCAyMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAzID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDQgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbNF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAxNDogTWFjZWRvbmlhbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDEgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwID09PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDIgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMyA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1szXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDE1OiAgSWNlbGFuZGljCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pICE9PSAxMSAmJiAoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwID09PSAxID8gYXJndW1lbnRzLmxlbmd0aCA8PSAxID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzFdIDogYXJndW1lbnRzLmxlbmd0aCA8PSAyID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBOZXcgYWRkaXRpb25zCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gMTY6ICBLYXNodWJpYW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvTW96aWxsYS9Mb2NhbGl6YXRpb24vTG9jYWxpemF0aW9uX2FuZF9QbHVyYWxzI0xpc3Rfb2ZfX3BsdXJhbFJ1bGVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBCcmV0b24gaXMgbGlzdGVkIGFzICMxNiBidXQgaW4gdGhlIExvY2FsaXphdGlvbiBHdWlkZSBpdCBiZWxvbmdzIHRvIHRoZSBncm91cCAyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDEgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwID49IDIgJiYgKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgJSAxMCA8PSA0ICYmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSAlIDEwMCA8IDEwIHx8IChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pICUgMTAwID49IDIwKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAyID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDMgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbM107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAxNzogIFdlbHNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDEgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSA9PT0gMikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAyID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgIT09IDggJiYgKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgIT09IDExKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDMgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbM107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gNCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1s0XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDE4OiAgSmF2YW5lc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPT09IDAgPyBhcmd1bWVudHMubGVuZ3RoIDw9IDEgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMV0gOiBhcmd1bWVudHMubGVuZ3RoIDw9IDIgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDE5OiAgQ29ybmlzaAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzBdKSA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA8PSAxID8gdW5kZWZpbmVkIDogYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPT09IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMiA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1syXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pID09PSAzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDMgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbM107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gNCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1s0XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDIwOiAgTWFuZGlua2EKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1swXSkgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMSA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChhcmd1bWVudHMubGVuZ3RoIDw9IDAgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMF0pID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDw9IDIgPyB1bmRlZmluZWQgOiBhcmd1bWVudHNbMl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPD0gMyA/IHVuZGVmaW5lZCA6IGFyZ3VtZW50c1szXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XTsKICAgICAgICAgICAgICAgICAgICB9KCk7CgogICAgICAgICAgICAgICAgICAgIC8vIFBlcmZvcm0gcGx1cmFsIGZvcm0gb3IgcmV0dXJuIG9yaWdpbmFsIHRleHQKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3BsdXJhbEZvcm1zW2Zvcm1dLmFwcGx5KG51bGwsIFtudW1iZXJdLmNvbmNhdChpbnB1dCkpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBGZXRjaCB0aGUgbG9jYWxpemVkIHZlcnNpb24gb2YgdGhlIHN0cmluZwogICAgICAgICAgICAgICAgaWYgKGkxOG5bbGFuZ3VhZ2VdICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBzdHIgPSBpMThuW2xhbmd1YWdlXVttZXNzYWdlXTsKICAgICAgICAgICAgICAgICAgICBpZiAocGx1cmFsUGFyYW0gIT09IG51bGwgJiYgdHlwZW9mIHBsdXJhbFBhcmFtID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgICAgICAgICBwbHVyYWxGb3JtID0gaTE4bltsYW5ndWFnZV1bJ21lanMucGx1cmFsLWZvcm0nXTsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gX3BsdXJhbC5hcHBseShudWxsLCBbc3RyLCBwbHVyYWxQYXJhbSwgcGx1cmFsRm9ybV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBkZWZhdWx0IGxhbmd1YWdlIGlmIHJlcXVlc3RlZCB1aWQgaXMgbm90IHRyYW5zbGF0ZWQKICAgICAgICAgICAgICAgIGlmICghc3RyICYmIGkxOG4uZW4pIHsKICAgICAgICAgICAgICAgICAgICBzdHIgPSBpMThuLmVuW21lc3NhZ2VdOwogICAgICAgICAgICAgICAgICAgIGlmIChwbHVyYWxQYXJhbSAhPT0gbnVsbCAmJiB0eXBlb2YgcGx1cmFsUGFyYW0gPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsdXJhbEZvcm0gPSBpMThuLmVuWydtZWpzLnBsdXJhbC1mb3JtJ107CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ciA9IF9wbHVyYWwuYXBwbHkobnVsbCwgW3N0ciwgcGx1cmFsUGFyYW0sIHBsdXJhbEZvcm1dKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXMgYSBsYXN0IHJlc29ydCwgdXNlIHRoZSByZXF1ZXN0ZWQgdWlkLCB0byBtaW1pYyBvcmlnaW5hbCBiZWhhdmlvciBvZiBpMThuIHV0aWxzCiAgICAgICAgICAgICAgICAvLyAoaW4gd2hpY2ggdWlkIHdhcyB0aGUgZW5nbGlzaCB0ZXh0KQogICAgICAgICAgICAgICAgc3RyID0gc3RyIHx8IG1lc3NhZ2U7CgogICAgICAgICAgICAgICAgLy8gUmVwbGFjZSB0b2tlbgogICAgICAgICAgICAgICAgaWYgKHBsdXJhbFBhcmFtICE9PSBudWxsICYmIHR5cGVvZiBwbHVyYWxQYXJhbSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgICAgICBzdHIgPSBzdHIucmVwbGFjZSgnJTEnLCBwbHVyYWxQYXJhbSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuICgwLCBfZ2VuZXJhbC5lc2NhcGVIVE1MKShzdHIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgICB9OwoKICAgICAgICBfbWVqczIuZGVmYXVsdC5pMThuID0gaTE4bjsKCi8vIGBpMThuYCBjb21wYXRpYmlsaXR5IHdvcmtmbG93IHdpdGggV29yZFByZXNzCiAgICAgICAgaWYgKHR5cGVvZiBtZWpzTDEwbiAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgX21lanMyLmRlZmF1bHQuaTE4bi5sYW5ndWFnZShtZWpzTDEwbi5sYW5ndWFnZSwgbWVqc0wxMG4uc3RyaW5ncyk7CiAgICAgICAgfQoKICAgICAgICBleHBvcnRzLmRlZmF1bHQgPSBpMThuOwoKICAgIH0sIHsiMTQiOiAxNCwgIjI5IjogMjksICI2IjogNn1dLAogICAgNTogW2Z1bmN0aW9uIChfZGVyZXFfLCBtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAKCiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgICAgICAgICB2YWx1ZTogdHJ1ZQogICAgICAgIH0pOwoKICAgICAgICB2YXIgX3dpbmRvdyA9IF9kZXJlcV8oMyk7CgogICAgICAgIHZhciBfd2luZG93MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3dpbmRvdyk7CgogICAgICAgIHZhciBfZG9jdW1lbnQgPSBfZGVyZXFfKDIpOwoKICAgICAgICB2YXIgX2RvY3VtZW50MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2RvY3VtZW50KTsKCiAgICAgICAgdmFyIF9tZWpzID0gX2RlcmVxXyg2KTsKCiAgICAgICAgdmFyIF9tZWpzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX21lanMpOwoKICAgICAgICB2YXIgX21lZGlhID0gX2RlcmVxXygzMCk7CgogICAgICAgIHZhciBfcmVuZGVyZXIgPSBfZGVyZXFfKDcpOwoKICAgICAgICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDoge2RlZmF1bHQ6IG9ian07CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgIGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogTWVkaWEgQ29yZQogICAgICAgICAqCiAgICAgICAgICogVGhpcyBjbGFzcyBpcyB0aGUgZm91bmRhdGlvbiB0byBjcmVhdGUvcmVuZGVyIGRpZmZlcmVudCBtZWRpYSBmb3JtYXRzLgogICAgICAgICAqIEBjbGFzcyBNZWRpYUVsZW1lbnQKICAgICAgICAgKi8KICAgICAgICB2YXIgTWVkaWFFbGVtZW50ID0gZnVuY3Rpb24gTWVkaWFFbGVtZW50KGlkT3JOb2RlLCBvcHRpb25zKSB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgTWVkaWFFbGVtZW50KTsKCiAgICAgICAgICAgIHZhciB0ID0gdGhpczsKCiAgICAgICAgICAgIHQuZGVmYXVsdHMgPSB7CiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIExpc3Qgb2YgdGhlIHJlbmRlcmVycyB0byB1c2UKICAgICAgICAgICAgICAgICAqIEB0eXBlIHtTdHJpbmdbXX0KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgcmVuZGVyZXJzOiBbXSwKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogTmFtZSBvZiBNZWRpYUVsZW1lbnQgY29udGFpbmVyCiAgICAgICAgICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmYWtlTm9kZU5hbWU6ICdtZWRpYWVsZW1lbnR3cmFwcGVyJywKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogVGhlIHBhdGggd2hlcmUgc2hpbXMgYXJlIGxvY2F0ZWQKICAgICAgICAgICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIHBsdWdpblBhdGg6ICdidWlsZC8nCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih0LmRlZmF1bHRzLCBvcHRpb25zKTsKCiAgICAgICAgICAgIC8vIGNyZWF0ZSBvdXIgbm9kZSAobm90ZTogb2xkZXIgdmVyc2lvbnMgb2YgaU9TIGRvbid0IHN1cHBvcnQgT2JqZWN0LmRlZmluZVByb3BlcnR5IG9uIERPTSBub2RlcykKICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQgPSBfZG9jdW1lbnQyLmRlZmF1bHQuY3JlYXRlRWxlbWVudChvcHRpb25zLmZha2VOb2RlTmFtZSk7CiAgICAgICAgICAgIHQubWVkaWFFbGVtZW50Lm9wdGlvbnMgPSBvcHRpb25zOwoKICAgICAgICAgICAgdmFyIGlkID0gaWRPck5vZGUsCiAgICAgICAgICAgICAgICBpID0gdm9pZCAwLAogICAgICAgICAgICAgICAgaWwgPSB2b2lkIDA7CgogICAgICAgICAgICBpZiAodHlwZW9mIGlkT3JOb2RlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlID0gX2RvY3VtZW50Mi5kZWZhdWx0LmdldEVsZW1lbnRCeUlkKGlkT3JOb2RlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHQubWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZSA9IGlkT3JOb2RlOwogICAgICAgICAgICAgICAgaWQgPSBpZE9yTm9kZS5pZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWQgPSBpZCB8fCAnbWVqc18nICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygpLnNsaWNlKDIpOwoKICAgICAgICAgICAgaWYgKHQubWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZSAhPT0gdW5kZWZpbmVkICYmIHQubWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZSAhPT0gbnVsbCAmJiB0Lm1lZGlhRWxlbWVudC5hcHBlbmRDaGlsZCkgewogICAgICAgICAgICAgICAgLy8gY2hhbmdlIGlkCiAgICAgICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5vcmlnaW5hbE5vZGUuc2V0QXR0cmlidXRlKCdpZCcsIGlkICsgJ19mcm9tX21lanMnKTsKCiAgICAgICAgICAgICAgICAvLyBhZGQgbmV4dCB0byB0aGlzIG9uZQogICAgICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHQubWVkaWFFbGVtZW50LCB0Lm1lZGlhRWxlbWVudC5vcmlnaW5hbE5vZGUpOwoKICAgICAgICAgICAgICAgIC8vIGluc2VydCB0aGlzIG9uZSBpbnNpZ2h0CiAgICAgICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5hcHBlbmRDaGlsZCh0Lm1lZGlhRWxlbWVudC5vcmlnaW5hbE5vZGUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gVE9ETzogd2hlcmUgdG8gcHV0IHRoZSBub2RlPwogICAgICAgICAgICB9CgogICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5pZCA9IGlkOwogICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5yZW5kZXJlcnMgPSB7fTsKICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQucmVuZGVyZXIgPSBudWxsOwogICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5yZW5kZXJlck5hbWUgPSBudWxsOwogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRGV0ZXJtaW5lIHdoZXRoZXIgdGhlIHJlbmRlcmVyIHdhcyBmb3VuZCBvciBub3QKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHB1YmxpYwogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gcmVuZGVyZXJOYW1lCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0W119IG1lZGlhRmlsZXMKICAgICAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LmNoYW5nZVJlbmRlcmVyID0gZnVuY3Rpb24gKHJlbmRlcmVyTmFtZSwgbWVkaWFGaWxlcykgewoKICAgICAgICAgICAgICAgIHZhciB0ID0gX3RoaXM7CgogICAgICAgICAgICAgICAgLy8gY2hlY2sgZm9yIGEgbWF0Y2ggb24gdGhlIGN1cnJlbnQgcmVuZGVyZXIKICAgICAgICAgICAgICAgIGlmICh0Lm1lZGlhRWxlbWVudC5yZW5kZXJlciAhPT0gdW5kZWZpbmVkICYmIHQubWVkaWFFbGVtZW50LnJlbmRlcmVyICE9PSBudWxsICYmIHQubWVkaWFFbGVtZW50LnJlbmRlcmVyLm5hbWUgPT09IHJlbmRlcmVyTmFtZSkgewogICAgICAgICAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LnJlbmRlcmVyLnBhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQubWVkaWFFbGVtZW50LnJlbmRlcmVyLnN0b3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQucmVuZGVyZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5yZW5kZXJlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQucmVuZGVyZXIuc2V0U3JjKG1lZGlhRmlsZXNbMF0uc3JjKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBpZiBleGlzdGluZyByZW5kZXJlciBpcyBub3QgdGhlIHJpZ2h0IG9uZSwgdGhlbiBoaWRlIGl0CiAgICAgICAgICAgICAgICBpZiAodC5tZWRpYUVsZW1lbnQucmVuZGVyZXIgIT09IHVuZGVmaW5lZCAmJiB0Lm1lZGlhRWxlbWVudC5yZW5kZXJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LnJlbmRlcmVyLnBhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQubWVkaWFFbGVtZW50LnJlbmRlcmVyLnN0b3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQucmVuZGVyZXIuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5yZW5kZXJlci5oaWRlKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc2VlIGlmIHdlIGhhdmUgdGhlIHJlbmRlcmVyIGFscmVhZHkgY3JlYXRlZAogICAgICAgICAgICAgICAgdmFyIG5ld1JlbmRlcmVyID0gdC5tZWRpYUVsZW1lbnQucmVuZGVyZXJzW3JlbmRlcmVyTmFtZV0sCiAgICAgICAgICAgICAgICAgICAgbmV3UmVuZGVyZXJUeXBlID0gbnVsbDsKCiAgICAgICAgICAgICAgICBpZiAobmV3UmVuZGVyZXIgIT09IHVuZGVmaW5lZCAmJiBuZXdSZW5kZXJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIG5ld1JlbmRlcmVyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICBuZXdSZW5kZXJlci5zZXRTcmMobWVkaWFGaWxlc1swXS5zcmMpOwogICAgICAgICAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LnJlbmRlcmVyID0gbmV3UmVuZGVyZXI7CiAgICAgICAgICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQucmVuZGVyZXJOYW1lID0gcmVuZGVyZXJOYW1lOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciByZW5kZXJlckFycmF5ID0gdC5tZWRpYUVsZW1lbnQub3B0aW9ucy5yZW5kZXJlcnMubGVuZ3RoID8gdC5tZWRpYUVsZW1lbnQub3B0aW9ucy5yZW5kZXJlcnMgOiBfcmVuZGVyZXIucmVuZGVyZXIub3JkZXI7CgogICAgICAgICAgICAgICAgLy8gZmluZCB0aGUgZGVzaXJlZCByZW5kZXJlciBpbiB0aGUgYXJyYXkgb2YgcG9zc2libGUgb25lcwogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSByZW5kZXJlckFycmF5Lmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gcmVuZGVyZXJBcnJheVtpXTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSByZW5kZXJlck5hbWUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSB0aGUgcmVuZGVyZXIKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmVyTGlzdCA9IF9yZW5kZXJlci5yZW5kZXJlci5yZW5kZXJlcnM7CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1JlbmRlcmVyVHlwZSA9IHJlbmRlcmVyTGlzdFtpbmRleF07CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyT3B0aW9ucyA9IE9iamVjdC5hc3NpZ24obmV3UmVuZGVyZXJUeXBlLm9wdGlvbnMsIHQubWVkaWFFbGVtZW50Lm9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICBuZXdSZW5kZXJlciA9IG5ld1JlbmRlcmVyVHlwZS5jcmVhdGUodC5tZWRpYUVsZW1lbnQsIHJlbmRlck9wdGlvbnMsIG1lZGlhRmlsZXMpOwogICAgICAgICAgICAgICAgICAgICAgICBuZXdSZW5kZXJlci5uYW1lID0gcmVuZGVyZXJOYW1lOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3RvcmUgZm9yIGxhdGVyCiAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LnJlbmRlcmVyc1tuZXdSZW5kZXJlclR5cGUubmFtZV0gPSBuZXdSZW5kZXJlcjsKICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQucmVuZGVyZXIgPSBuZXdSZW5kZXJlcjsKICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQucmVuZGVyZXJOYW1lID0gcmVuZGVyZXJOYW1lOwoKICAgICAgICAgICAgICAgICAgICAgICAgbmV3UmVuZGVyZXIuc2hvdygpOwoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBTZXQgdGhlIGVsZW1lbnQgZGltZW5zaW9ucyBiYXNlZCBvbiBzZWxlY3RlZCByZW5kZXJlcidzIHNldFNpemUgbWV0aG9kCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoCiAgICAgICAgICAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LnNldFNpemUgPSBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewogICAgICAgICAgICAgICAgaWYgKHQubWVkaWFFbGVtZW50LnJlbmRlcmVyICE9PSB1bmRlZmluZWQgJiYgdC5tZWRpYUVsZW1lbnQucmVuZGVyZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5yZW5kZXJlci5zZXRTaXplKHdpZHRoLCBoZWlnaHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIHByb3BzID0gX21lanMyLmRlZmF1bHQuaHRtbDVtZWRpYS5wcm9wZXJ0aWVzLAogICAgICAgICAgICAgICAgbWV0aG9kcyA9IF9tZWpzMi5kZWZhdWx0Lmh0bWw1bWVkaWEubWV0aG9kcywKICAgICAgICAgICAgICAgIGFkZFByb3BlcnR5ID0gZnVuY3Rpb24gYWRkUHJvcGVydHkob2JqLCBuYW1lLCBvbkdldCwgb25TZXQpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gd3JhcHBlciBmdW5jdGlvbnMKICAgICAgICAgICAgICAgICAgICB2YXIgb2xkVmFsdWUgPSBvYmpbbmFtZV07CiAgICAgICAgICAgICAgICAgICAgdmFyIGdldEZuID0gZnVuY3Rpb24gZ2V0Rm4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb25HZXQuYXBwbHkob2JqLCBbb2xkVmFsdWVdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgc2V0Rm4gPSBmdW5jdGlvbiBzZXRGbihuZXdWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWUgPSBvblNldC5hcHBseShvYmosIFtuZXdWYWx1ZV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9sZFZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAvLyBNb2Rlcm4gYnJvd3NlcnMsIElFOSsgKElFOCBvbmx5IHdvcmtzIG9uIERPTSBvYmplY3RzLCBub3Qgbm9ybWFsIEpTIG9iamVjdHMpCiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5kZWZpbmVQcm9wZXJ0eSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgbmFtZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2V0OiBnZXRGbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldDogc2V0Rm4KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPbGRlciBGaXJlZm94CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvYmouX19kZWZpbmVHZXR0ZXJfXykgewoKICAgICAgICAgICAgICAgICAgICAgICAgb2JqLl9fZGVmaW5lR2V0dGVyX18obmFtZSwgZ2V0Rm4pOwogICAgICAgICAgICAgICAgICAgICAgICBvYmouX19kZWZpbmVTZXR0ZXJfXyhuYW1lLCBzZXRGbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGFzc2lnbkdldHRlcnNTZXR0ZXJzID0gZnVuY3Rpb24gYXNzaWduR2V0dGVyc1NldHRlcnMocHJvcE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJvcE5hbWUgIT09ICdzcmMnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNhcE5hbWUgPSAnJyArIHByb3BOYW1lLnN1YnN0cmluZygwLCAxKS50b1VwcGVyQ2FzZSgpICsgcHJvcE5hbWUuc3Vic3RyaW5nKDEpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldEZuID0gZnVuY3Rpb24gZ2V0Rm4oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0Lm1lZGlhRWxlbWVudC5yZW5kZXJlciAhPT0gdW5kZWZpbmVkICYmIHQubWVkaWFFbGVtZW50LnJlbmRlcmVyICE9PSBudWxsID8gdC5tZWRpYUVsZW1lbnQucmVuZGVyZXJbJ2dldCcgKyBjYXBOYW1lXSgpIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldEZuID0gZnVuY3Rpb24gc2V0Rm4odmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQubWVkaWFFbGVtZW50LnJlbmRlcmVyICE9PSB1bmRlZmluZWQgJiYgdC5tZWRpYUVsZW1lbnQucmVuZGVyZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LnJlbmRlcmVyWydzZXQnICsgY2FwTmFtZV0odmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRQcm9wZXJ0eSh0Lm1lZGlhRWxlbWVudCwgcHJvcE5hbWUsIGdldEZuLCBzZXRGbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhRWxlbWVudFsnZ2V0JyArIGNhcE5hbWVdID0gZ2V0Rm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhRWxlbWVudFsnc2V0JyArIGNhcE5hbWVdID0gc2V0Rm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyBgc3JjYCBpcyBhIHByb3BlcnR5IHNlcGFyYXRlZCBmcm9tIHRoZSBvdGhlcnMgc2luY2UgaXQgY2FycmllcyB0aGUgbG9naWMgdG8gc2V0IHRoZSBwcm9wZXIgcmVuZGVyZXIKICAgICAgICAgICAgICAgIC8vIGJhc2VkIG9uIHRoZSBtZWRpYSBmaWxlcyBkZXRlY3RlZAogICAgICAgICAgICAgICAgZ2V0U3JjID0gZnVuY3Rpb24gZ2V0U3JjKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0Lm1lZGlhRWxlbWVudC5yZW5kZXJlciAhPT0gdW5kZWZpbmVkICYmIHQubWVkaWFFbGVtZW50LnJlbmRlcmVyICE9PSBudWxsID8gdC5tZWRpYUVsZW1lbnQucmVuZGVyZXIuZ2V0U3JjKCkgOiBudWxsOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldFNyYyA9IGZ1bmN0aW9uIHNldFNyYyh2YWx1ZSkgewoKICAgICAgICAgICAgICAgICAgICB2YXIgbWVkaWFGaWxlcyA9IFtdOwoKICAgICAgICAgICAgICAgICAgICAvLyBjbGVhbiB1cCBVUkxzCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFGaWxlcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyYzogdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiB2YWx1ZSA/ICgwLCBfbWVkaWEuZ2V0VHlwZUZyb21GaWxlKSh2YWx1ZSkgOiAnJwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3JjID0gKDAsIF9tZWRpYS5hYnNvbHV0aXplVXJsKSh2YWx1ZVtpXS5zcmMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgPSB2YWx1ZVtpXS50eXBlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRmlsZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjOiBzcmMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogKHR5cGUgPT09ICcnIHx8IHR5cGUgPT09IG51bGwgfHwgdHlwZSA9PT0gdW5kZWZpbmVkKSAmJiBzcmMgPyAoMCwgX21lZGlhLmdldFR5cGVGcm9tRmlsZSkoc3JjKSA6IHR5cGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBmaW5kIGEgcmVuZGVyZXIgYW5kIFVSTCBtYXRjaAogICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJJbmZvID0gX3JlbmRlcmVyLnJlbmRlcmVyLnNlbGVjdChtZWRpYUZpbGVzLCB0Lm1lZGlhRWxlbWVudC5vcHRpb25zLnJlbmRlcmVycy5sZW5ndGggPyB0Lm1lZGlhRWxlbWVudC5vcHRpb25zLnJlbmRlcmVycyA6IFtdKSwKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSB2b2lkIDA7CgogICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBvcmlnaW5hbCBnZXRzIHRoZSBmaXJzdCBzb3VyY2UgZm91bmQKICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5vcmlnaW5hbE5vZGUuc2V0QXR0cmlidXRlKCdzcmMnLCBtZWRpYUZpbGVzWzBdLnNyYyB8fCAnJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIGRpZCB3ZSBmaW5kIGEgcmVuZGVyZXI/CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlckluZm8gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQgPSBfZG9jdW1lbnQyLmRlZmF1bHQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQuaW5pdEV2ZW50KCdlcnJvcicsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50Lm1lc3NhZ2UgPSAnTm8gcmVuZGVyZXIgZm91bmQnOwogICAgICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gdHVybiBvbiB0aGUgcmVuZGVyZXIgKHRoaXMgY2hlY2tzIGZvciB0aGUgZXhpc3RpbmcgcmVuZGVyZXIgYWxyZWFkeSkKICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5jaGFuZ2VSZW5kZXJlcihyZW5kZXJJbmZvLnJlbmRlcmVyTmFtZSwgbWVkaWFGaWxlcyk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0Lm1lZGlhRWxlbWVudC5yZW5kZXJlciA9PT0gdW5kZWZpbmVkIHx8IHQubWVkaWFFbGVtZW50LnJlbmRlcmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gX2RvY3VtZW50Mi5kZWZhdWx0LmNyZWF0ZUV2ZW50KCdIVE1MRXZlbnRzJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmluaXRFdmVudCgnZXJyb3InLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5tZXNzYWdlID0gJ0Vycm9yIGNyZWF0aW5nIHJlbmRlcmVyJzsKICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGFzc2lnbk1ldGhvZHMgPSBmdW5jdGlvbiBhc3NpZ25NZXRob2RzKG1ldGhvZE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAvLyBydW4gdGhlIG1ldGhvZCBvbiB0aGUgY3VycmVudCByZW5kZXJlcgogICAgICAgICAgICAgICAgICAgIHQubWVkaWFFbGVtZW50W21ldGhvZE5hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHQubWVkaWFFbGVtZW50LnJlbmRlcmVyICE9PSB1bmRlZmluZWQgJiYgdC5tZWRpYUVsZW1lbnQucmVuZGVyZXIgIT09IG51bGwgJiYgdHlwZW9mIHQubWVkaWFFbGVtZW50LnJlbmRlcmVyW21ldGhvZE5hbWVdID09PSAnZnVuY3Rpb24nID8gdC5tZWRpYUVsZW1lbnQucmVuZGVyZXJbbWV0aG9kTmFtZV0oYXJncykgOiBudWxsOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gQXNzaWduIGFsbCBtZXRob2RzL3Byb3BlcnRpZXMvZXZlbnRzIHRvIGZha2Ugbm9kZSBpZiByZW5kZXJlciB3YXMgZm91bmQKICAgICAgICAgICAgYWRkUHJvcGVydHkodC5tZWRpYUVsZW1lbnQsICdzcmMnLCBnZXRTcmMsIHNldFNyYyk7CiAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LmdldFNyYyA9IGdldFNyYzsKICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQuc2V0U3JjID0gc2V0U3JjOwoKICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBwcm9wcy5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBhc3NpZ25HZXR0ZXJzU2V0dGVycyhwcm9wc1tpXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBhc3NpZ25NZXRob2RzKG1ldGhvZHNbaV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJRSAmJiBpT1MKICAgICAgICAgICAgaWYgKCF0Lm1lZGlhRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKSB7CgogICAgICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQuZXZlbnRzID0ge307CgogICAgICAgICAgICAgICAgLy8gc3RhcnQ6IGZha2UgZXZlbnRzCiAgICAgICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5hZGRFdmVudExpc3RlbmVyID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAvLyBjcmVhdGUgb3IgZmluZCB0aGUgYXJyYXkgb2YgY2FsbGJhY2tzIGZvciB0aGlzIGV2ZW50TmFtZQogICAgICAgICAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LmV2ZW50c1tldmVudE5hbWVdID0gdC5tZWRpYUVsZW1lbnQuZXZlbnRzW2V2ZW50TmFtZV0gfHwgW107CgogICAgICAgICAgICAgICAgICAgIC8vIHB1c2ggdGhlIGNhbGxiYWNrIGludG8gdGhlIHN0YWNrCiAgICAgICAgICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQuZXZlbnRzW2V2ZW50TmFtZV0ucHVzaChjYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gbm8gZXZlbnROYW1lIG1lYW5zIHJlbW92ZSBhbGwgbGlzdGVuZXJzCiAgICAgICAgICAgICAgICAgICAgaWYgKCFldmVudE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQuZXZlbnRzID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gc2VlIGlmIHdlIGhhdmUgYW55IGNhbGxiYWNrcyBmb3IgdGhpcyBldmVudE5hbWUKICAgICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gdC5tZWRpYUVsZW1lbnQuZXZlbnRzW2V2ZW50TmFtZV07CgogICAgICAgICAgICAgICAgICAgIGlmICghY2FsbGJhY2tzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgZm9yIGEgc3BlY2lmaWMgY2FsbGJhY2sKICAgICAgICAgICAgICAgICAgICBpZiAoIWNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LmV2ZW50c1tldmVudE5hbWVdID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBzcGVjaWZpYyBjYWxsYmFjawogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIF9pID0gMCwgX2lsID0gY2FsbGJhY2tzLmxlbmd0aDsgX2kgPCBfaWw7IF9pKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc1tfaV0gPT09IGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5ldmVudHNbZXZlbnROYW1lXS5zcGxpY2UoX2ksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudAogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSB0Lm1lZGlhRWxlbWVudC5ldmVudHNbZXZlbnQudHlwZV07CgogICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBjYWxsYmFja3MubGVuZ3RoOyBpIDwgaWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzW2ldLmFwcGx5KG51bGwsIFtldmVudF0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHQubWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG1lZGlhRmlsZXMgPSBbXTsKCiAgICAgICAgICAgICAgICBzd2l0Y2ggKHQubWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKSB7CgogICAgICAgICAgICAgICAgICAgIGNhc2UgJ2lmcmFtZSc6CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRmlsZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNyYzogdC5tZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlLmdldEF0dHJpYnV0ZSgnc3JjJykKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgY2FzZSAnYXVkaW8nOgogICAgICAgICAgICAgICAgICAgIGNhc2UgJ3ZpZGVvJzoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG4gPSB2b2lkIDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmMgPSB2b2lkIDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlID0gdm9pZCAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlcyA9IHQubWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZS5jaGlsZE5vZGVzLmxlbmd0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVTb3VyY2UgPSB0Lm1lZGlhRWxlbWVudC5vcmlnaW5hbE5vZGUuZ2V0QXR0cmlidXRlKCdzcmMnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbnNpZGVyIGlmIG5vZGUgY29udGFpbnMgdGhlIGBzcmNgIGFuZCBgdHlwZWAgYXR0cmlidXRlcwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZVNvdXJjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0Lm1lZGlhRWxlbWVudC5vcmlnaW5hbE5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUZpbGVzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICgwLCBfbWVkaWEuZm9ybWF0VHlwZSkobm9kZVNvdXJjZSwgbm9kZS5nZXRBdHRyaWJ1dGUoJ3R5cGUnKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3JjOiBub2RlU291cmNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGVzdCA8c291cmNlPiB0eXBlcyB0byBzZWUgaWYgdGhleSBhcmUgdXNhYmxlCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzb3VyY2VzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG4gPSB0Lm1lZGlhRWxlbWVudC5vcmlnaW5hbE5vZGUuY2hpbGROb2Rlc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuLm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSAmJiBuLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3NvdXJjZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmMgPSBuLmdldEF0dHJpYnV0ZSgnc3JjJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICgwLCBfbWVkaWEuZm9ybWF0VHlwZSkoc3JjLCBuLmdldEF0dHJpYnV0ZSgndHlwZScpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUZpbGVzLnB1c2goe3R5cGU6IHR5cGUsIHNyYzogc3JjfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG1lZGlhRmlsZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LnNyYyA9IG1lZGlhRmlsZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0Lm1lZGlhRWxlbWVudC5vcHRpb25zLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIHQubWVkaWFFbGVtZW50Lm9wdGlvbnMuc3VjY2Vzcyh0Lm1lZGlhRWxlbWVudCwgdC5tZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQuc2hvd0luc2lnaHRMaW5lID0gZnVuY3Rpb24gKG1lZGlhLHQsWGlubmVyLFlpbm5lcixjdXJyZW50VGltZXJTdGFydCxjdXJyZW50VGltZXJTdG9wKSB7CiAgICAgICAgICAgICAgICAvL9C/0L7QutCw0LfRi9Cy0LDRgtGMINC40L3RgtC10YDRhNC10LnRgSDRgdC+0LfQtNCw0L3QuNGPINC40L3RgdCw0LnRgtCwINGC0L7Qu9GM0LrQviDQstC70LDQtNC10LvRjNGG0YMg0LLQuNC00LXQvgogICAgICAgICAgICAgICAgaWYgKCF0Lm9wdGlvbnMuc2hvd0luc2lnaHRDb250cm9scykgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgbWVkaWFEdXJhdGlvbiA9IG1lZGlhLmR1cmF0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyV2lkdGggPSAkKCcudXhjX190aW1lLXRvdGFsJykud2lkdGgoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoT25lU2VjID0gbWVkaWFEdXJhdGlvbiAvIGNvbnRhaW5lcldpZHRoLCBpdGVtV2lkdGgsbGVmdFdpZHRoLHJpZ2h0V2lkdGgKCiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFRpbWVyU3RhcnQ9PW51bGwgJiYgY3VycmVudFRpbWVyU3RvcD09bnVsbCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChYaW5uZXIgPCAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIFhpbm5lcj0wOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1XaWR0aCA9ICh0Lm9wdGlvbnMubW91c2Vkb3duWFlbMF0gLSBYaW5uZXIpID4gMCA/IHQub3B0aW9ucy5tb3VzZWRvd25YWVswXSAtIFhpbm5lciA6IC0odC5vcHRpb25zLm1vdXNlZG93blhZWzBdIC0gWGlubmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGVmdFdpZHRoID0gdC5vcHRpb25zLm1vdXNlZG93blhZWzBdIC0gWGlubmVyIDwgMCA/IHQub3B0aW9ucy5tb3VzZWRvd25YWVswXSA6IFhpbm5lcjsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1XaWR0aCA+IE51bWJlcih0LnJhaWwud2lkdGgoKSktTnVtYmVyKGxlZnRXaWR0aCkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVdpZHRoID0gIE51bWJlcih0LnJhaWwud2lkdGgoKSktTnVtYmVyKGxlZnRXaWR0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRXaWR0aCA9IHQub3B0aW9ucy5tb3VzZWRvd25YWVswXSAtIFhpbm5lciA8IDAgPyB0Lm9wdGlvbnMubW91c2Vkb3duWFlbMF0gKyBpdGVtV2lkdGggOiBYaW5uZXIgKyBpdGVtV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUaW1lclN0YXJ0ID0gd2lkdGhPbmVTZWMgKiBsZWZ0V2lkdGgsCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUaW1lclN0b3AgPSB3aWR0aE9uZVNlYyAqIHJpZ2h0V2lkdGg7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VGltZXJTdG9wPm1lZGlhRHVyYXRpb24pewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50VGltZXJTdG9wID0gbWVkaWFEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUaW1lclN0YXJ0PDApewogICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUaW1lclN0YXJ0PTA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VGltZXJTdG9wPDIpewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50VGltZXJTdG9wID0gMjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VGltZXJTdG9wLWN1cnJlbnRUaW1lclN0YXJ0PDIpewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLiRpbnNpZ2h0UGFuZWxBY3RpdmUhPW51bGwpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy4kaW5zaWdodFBhbmVsQWN0aXZlLmhhc0NsYXNzKCdsZWZ0X3BhbmVsJykpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50VGltZXJTdGFydCA9IGN1cnJlbnRUaW1lclN0b3AtMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuJGluc2lnaHRQYW5lbEFjdGl2ZS5oYXNDbGFzcygncmlnaHRfcGFuZWwnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUaW1lclN0b3AgPSBjdXJyZW50VGltZXJTdGFydCsyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGxlZnRXaWR0aCA9IGN1cnJlbnRUaW1lclN0YXJ0L3dpZHRoT25lU2VjOwogICAgICAgICAgICAgICAgICAgIHJpZ2h0V2lkdGggPSBjdXJyZW50VGltZXJTdG9wL3dpZHRoT25lU2VjOwogICAgICAgICAgICAgICAgICAgIGl0ZW1XaWR0aCA9IHJpZ2h0V2lkdGggLSBsZWZ0V2lkdGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkKCcuc3RhdHVzX2luc2lnaHQnKS5hdHRyKHsnZGF0YS10aW1lci1zdGFydCc6IGN1cnJlbnRUaW1lclN0YXJ0fSk7CiAgICAgICAgICAgICAgICAkKCcuc3RhdHVzX2luc2lnaHQnKS5hdHRyKHsnZGF0YS10aW1lci1zdG9wJzogY3VycmVudFRpbWVyU3RvcH0pOwoKICAgICAgICAgICAgICAgICQoJy5jb250YWluX2luc2lnaHQnKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICQoJy5pbnNpZ2h0X21vZGFsX2Jsb2NrJykucmVtb3ZlKCk7CgogICAgICAgICAgICAgICAgdC5vcHRpb25zLmN1cnJlbnRUaW1lclN0YXJ0ID0gY3VycmVudFRpbWVyU3RhcnQ7CiAgICAgICAgICAgICAgICB0Lm9wdGlvbnMuY3VycmVudFRpbWVyU3RvcCA9IGN1cnJlbnRUaW1lclN0b3A7CgogICAgICAgICAgICAgICAgdmFyIHN0YXJ0VGltZSA9IHNlY29uZHNUb01pbnV0ZXModC5vcHRpb25zLmN1cnJlbnRUaW1lclN0YXJ0KTsKICAgICAgICAgICAgICAgIHZhciBzdG9wVGltZSA9IHNlY29uZHNUb01pbnV0ZXModC5vcHRpb25zLmN1cnJlbnRUaW1lclN0b3ApOwoKICAgICAgICAgICAgICAgICQoJy51eGNfX3RpbWUtdG90YWwnKS5hcHBlbmQoJzxkaXYgY2xhc3M9ImNvbnRhaW5faW5zaWdodCI+PGRpdiBjbGFzcz0ibGVmdF9wYW5lbCI+PGRpdiBjbGFzcz0idGltZSI+JytzdGFydFRpbWUrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj48L2Rpdj48ZGl2IGNsYXNzPSJ0aW1lX2luc2lnaHQiPjwvZGl2PjxkaXYgY2xhc3M9InJpZ2h0X3BhbmVsIj48ZGl2IGNsYXNzPSJ0aW1lIj4nK3N0b3BUaW1lKyc8L2Rpdj48L2Rpdj48L2Rpdj4nKTsKCiAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLiRpbnNpZ2h0UGFuZWxBY3RpdmUhPW51bGwpewogICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuJGluc2lnaHRQYW5lbEFjdGl2ZS5oYXNDbGFzcygncmlnaHRfcGFuZWwnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHQub3B0aW9ucy4kaW5zaWdodFBhbmVsQWN0aXZlID0gJCgnLnJpZ2h0X3BhbmVsJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuJGluc2lnaHRQYW5lbEFjdGl2ZS5oYXNDbGFzcygnbGVmdF9wYW5lbCcpKXsKICAgICAgICAgICAgICAgICAgICAgICAgdC5vcHRpb25zLiRpbnNpZ2h0UGFuZWxBY3RpdmUgPSAkKCcubGVmdF9wYW5lbCcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0Lm9wdGlvbnMuJGluc2lnaHRQYW5lbEFjdGl2ZS5hdHRyKCJ0YWJpbmRleCIsLTEpLmZvY3VzKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdC5tZWRpYS5pbml0X21vZGFsX2luc2lnaHQodCwgdC5vcHRpb25zKTsKICAgICAgICAgICAgICAgICQoJy5yaWdodF9wYW5lbCcpLm9uKCdtb3VzZXVwIHRvdWNoZW5kJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICB0Lm9wdGlvbnMuaXNfYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICQoJy5yaWdodF9wYW5lbCcpLm9uKCdtb3VzZWRvd24nLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgIHQub3B0aW9ucy5pc19hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpLAogICAgICAgICAgICAgICAgICAgICAgICBjb250YWluX2luc2lnaHRfd2lkdGggPSAkKCcuY29udGFpbl9pbnNpZ2h0Jykud2lkdGgoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbWFpbl94ID0gZS5wYWdlWDsKICAgICAgICAgICAgICAgICAgICAkdGhpcy5hdHRyKCJ0YWJpbmRleCIsLTEpLmZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgdC5vcHRpb25zLiRpbnNpZ2h0UGFuZWxBY3RpdmUgPSAkKCcucmlnaHRfcGFuZWwnKTsKICAgICAgICAgICAgICAgICAgICAkKCcudXhjX190aW1lLXRvdGFsJykub2ZmKCJtb3VzZW1vdmUiKTsKICAgICAgICAgICAgICAgICAgICAkKCcudXhjX190aW1lLXRvdGFsJykubW91c2Vtb3ZlKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlcigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm9wdGlvbnMuaXNfYWN0aXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJChkb2N1bWVudCkudW5iaW5kKCAibW91c2V1cCIgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCIudXhjX190aW1lLXRvdGFsIikuY3NzKCdjdXJzb3InLCAncG9pbnRlcicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIi51eGNfX2NvbnRhaW5lciIpLmNzcygnY3Vyc29yJywgJ3BvaW50ZXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCIudXhjX190aW1lLWxvYWRlZCIpLmNzcygnY3Vyc29yJywgJ3BvaW50ZXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vbiggIm1vdXNldXAiLCBoYW5kbGVyICk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuaXNfYWN0aXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCIudXhjX190aW1lLXRvdGFsIikuY3NzKCdjdXJzb3InLCAnZS1yZXNpemUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIi51eGNfX2NvbnRhaW5lciIpLmNzcygnY3Vyc29yJywgJ2UtcmVzaXplJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCIudXhjX190aW1lLWxvYWRlZCIpLmNzcygnY3Vyc29yJywgJ2UtcmVzaXplJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY194ID0gZS5wYWdlWDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhZGRfd2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWFpbl94IC0gY194IDwgMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZF93aWR0aCA9IG1haW5feCAtIGNfeDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5jdXJyZW50VGFyZ2V0LmNsaWVudFdpZHRoID4gTnVtYmVyKCQoJy5jb250YWluX2luc2lnaHQnKS5jc3MoJ2xlZnQnKS5zcGxpdCgncHgnKVswXSkgKyAoY29udGFpbl9pbnNpZ2h0X3dpZHRoIC0gYWRkX3dpZHRoKSApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcuY29udGFpbl9pbnNpZ2h0JykuY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd3aWR0aCc6IGNvbnRhaW5faW5zaWdodF93aWR0aCAtIGFkZF93aWR0aCArICdweCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQub3B0aW9ucy5jdXJyZW50VGltZXJTdG9wID0gKE51bWJlcigkKCcuY29udGFpbl9pbnNpZ2h0JykuY3NzKCdsZWZ0Jykuc3BsaXQoJ3B4JylbMF0pICsgIGNvbnRhaW5faW5zaWdodF93aWR0aCAtIGFkZF93aWR0aCkgKiB3aWR0aE9uZVNlYzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZF93aWR0aCA9IGNvbnRhaW5faW5zaWdodF93aWR0aCAtIChtYWluX3ggLSBjX3gpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJy5jb250YWluX2luc2lnaHQnKS5jc3MoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnd2lkdGgnOiBhZGRfd2lkdGggKyAncHgnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5vcHRpb25zLmN1cnJlbnRUaW1lclN0b3AgPSAoTnVtYmVyKCQoJy5jb250YWluX2luc2lnaHQnKS5jc3MoJ2xlZnQnKS5zcGxpdCgncHgnKVswXSkgKyAgYWRkX3dpZHRoKSAqIHdpZHRoT25lU2VjOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy5jdXJyZW50VGltZXJTdG9wPnQub3B0aW9ucy5jdXJyZW50VGltZXJTdGFydCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0b3BUaW1lID0gc2Vjb25kc1RvTWludXRlcyh0Lm9wdGlvbnMuY3VycmVudFRpbWVyU3RvcCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnLnJpZ2h0X3BhbmVsJykuZmluZCgnLnRpbWUnKS5odG1sKHN0b3BUaW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEucG9zaXRpb25faW5zaWdodF9tb2RhbCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICQoJy5sZWZ0X3BhbmVsJykub24oJ21vdXNldXAgdG91Y2hlbmQnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgIHQub3B0aW9ucy5pc19hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgJCgnLmxlZnRfcGFuZWwnKS5vbignbW91c2Vkb3duJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICB0Lm9wdGlvbnMuaXNfYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0Lm9wdGlvbnMuJGluc2lnaHRQYW5lbEFjdGl2ZSA9ICQoJy5sZWZ0X3BhbmVsJyk7CiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICQoJy5sZWZ0X3BhbmVsJykuYXR0cigidGFiaW5kZXgiLC0xKS5mb2N1cygpOwogICAgICAgICAgICAgICAgICAgIHZhciAkdGhpcyA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5faW5zaWdodF93aWR0aCA9ICQoJy5jb250YWluX2luc2lnaHQnKS53aWR0aCgpLAogICAgICAgICAgICAgICAgICAgICAgICBjb250YWluX2luc2lnaHRfbGVmdCA9IE51bWJlcigkKCcuY29udGFpbl9pbnNpZ2h0JykuY3NzKCdsZWZ0Jykuc3BsaXQoJ3B4JylbMF0pLAogICAgICAgICAgICAgICAgICAgICAgICBtYWluX3ggPSBlLnBhZ2VYOwogICAgICAgICAgICAgICAgICAgICQoJy51eGNfX3RpbWUtdG90YWwnKS5vZmYoIm1vdXNlbW92ZSIpOwogICAgICAgICAgICAgICAgICAgICQoJy51eGNfX3RpbWUtdG90YWwnKS5tb3VzZW1vdmUoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVyKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQub3B0aW9ucy5pc19hY3RpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS51bmJpbmQoICJtb3VzZXVwIiApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIi51eGNfX3RpbWUtdG90YWwiKS5jc3MoJ2N1cnNvcicsICdwb2ludGVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiLnV4Y19fY29udGFpbmVyIikuY3NzKCdjdXJzb3InLCAncG9pbnRlcicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIi51eGNfX3RpbWUtbG9hZGVkIikuY3NzKCdjdXJzb3InLCAncG9pbnRlcicpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCAibW91c2V1cCIsIGhhbmRsZXIgKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy5pc19hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIi51eGNfX3RpbWUtdG90YWwiKS5jc3MoJ2N1cnNvcicsICdlLXJlc2l6ZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiLnV4Y19fY29udGFpbmVyIikuY3NzKCdjdXJzb3InLCAnZS1yZXNpemUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIi51eGNfX3RpbWUtbG9hZGVkIikuY3NzKCdjdXJzb3InLCAnZS1yZXNpemUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjX3ggPSBlLnBhZ2VYOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFkZF93aWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYWluX3ggLSBjX3ggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkX3dpZHRoID0gbWFpbl94IC0gY194OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250YWluX2luc2lnaHRfbGVmdCAtIGFkZF93aWR0aD4wKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnLmNvbnRhaW5faW5zaWdodCcpLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnd2lkdGgnOiBjb250YWluX2luc2lnaHRfd2lkdGggKyBhZGRfd2lkdGggKyAncHgnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2xlZnQnOiBjb250YWluX2luc2lnaHRfbGVmdCAtIGFkZF93aWR0aAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5vcHRpb25zLmN1cnJlbnRUaW1lclN0YXJ0ID0gd2lkdGhPbmVTZWMgKiAoY29udGFpbl9pbnNpZ2h0X2xlZnQgLSBhZGRfd2lkdGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkX3dpZHRoID0gbWFpbl94IC0gY194OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJy5jb250YWluX2luc2lnaHQnKS5jc3MoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnd2lkdGgnOiBjb250YWluX2luc2lnaHRfd2lkdGggKyBhZGRfd2lkdGggKyAncHgnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbGVmdCc6IGNvbnRhaW5faW5zaWdodF9sZWZ0IC0gYWRkX3dpZHRoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5vcHRpb25zLmN1cnJlbnRUaW1lclN0YXJ0ID0gd2lkdGhPbmVTZWMgKiAoY29udGFpbl9pbnNpZ2h0X2xlZnQgLSBhZGRfd2lkdGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy5jdXJyZW50VGltZXJTdGFydDx0Lm9wdGlvbnMuY3VycmVudFRpbWVyU3RvcCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0VGltZSA9IHNlY29uZHNUb01pbnV0ZXModC5vcHRpb25zLmN1cnJlbnRUaW1lclN0YXJ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcubGVmdF9wYW5lbCcpLmZpbmQoJy50aW1lJykuaHRtbChzdGFydFRpbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5wb3NpdGlvbl9pbnNpZ2h0X21vZGFsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgJCgnLmNvbnRhaW5faW5zaWdodCcpLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgJ3dpZHRoJzogaXRlbVdpZHRoICsgJ3B4JywKICAgICAgICAgICAgICAgICAgICAnbGVmdCc6IGxlZnRXaWR0aCArICdweCcKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdC5tZWRpYS5wb3NpdGlvbl9pbnNpZ2h0X21vZGFsKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LnBvc2l0aW9uX2luc2lnaHRfbW9kYWwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAkKCcuaW5zaWdodF9tb2RhbF9ibG9jaycpLm9mZnNldCh7J2xlZnQnOiAkKCcuY29udGFpbl9pbnNpZ2h0Jykub2Zmc2V0KCkubGVmdCArICgkKCcuY29udGFpbl9pbnNpZ2h0Jykud2lkdGgoKSAvIDIpLSQoJy5pbnNpZ2h0X21vZGFsX2Jsb2NrJykud2lkdGgoKS8yfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LmluaXRfbW9kYWxfaW5zaWdodCA9IGZ1bmN0aW9uICh0LCBvcHRpb24pIHsKCiAgICAgICAgICAgICAgICB2YXIgY29udGVudDsKICAgICAgICAgICAgICAgIGlmIChvcHRpb24uaW5zaWdodEVkaXQpewogICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSB0Lm1lZGlhLnJlbmRlck1vZGFsKCdzYXZlJyx0Lm1lZGlhLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gdC5tZWRpYS5yZW5kZXJNb2RhbCgnc2F2ZV9zaGFyZScsdC5tZWRpYS5vcHRpb25zKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICQoJy51eGNfX2NvbnRhaW5lcicpLmFwcGVuZCgnPGRpdiBjbGFzcz0iaW5zaWdodF9tb2RhbF9ibG9jayI+JyArIGNvbnRlbnQgKyAnPC9kaXY+Jyk7CiAgICAgICAgICAgIC8vICAgICQoJy5pbnNpZ2h0X21vZGFsX2Jsb2NrJykub2Zmc2V0KHsnbGVmdCc6ICQoJy5jb250YWluX2luc2lnaHQnKS5vZmZzZXQoKS5sZWZ0fSk7CiAgICAgICAgICAgICAgICB0Lm1lZGlhLmV2ZW50X3NhdmVfc2hhcmVfaW5zaWdodCh0LCBvcHRpb24pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LnJlbmRlck1vZGFsID0gZnVuY3Rpb24gKHR5cGUsIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIHZhciBkb21fZWxsZW1lbnQgPSAnJzsKICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NhdmVfc2hhcmUnOgogICAgICAgICAgICAgICAgICAgICAgICBkb21fZWxsZW1lbnQgPSAnPGRpdiBjbGFzcz0ic2F2ZV9zaGFyZV9jbG9zZSB0b3AiPjxkaXYgY2xhc3M9Imluc2lnaHRfd2hhdF90b19kbyI+JytvcHRpb25zLlRyYW5zbGF0aW9uLnRyYW5zbGF0ZSgnVkRPLlZETzg0JykrJzwvZGl2PjwvZGl2PicrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJzYXZlX3NoYXJlX2Nsb3NlIj4nKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJidG4gc2F2ZV9pbnNpZ2h0Ij4nK29wdGlvbnMuVHJhbnNsYXRpb24udHJhbnNsYXRlKCdWRE8uVkRPODUnKSsnPC9kaXY+JysKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHNwYW4gY2xhc3M9ImxpbmVfYnRuX21vZGFsIj48L3NwYW4+JysKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iYnRuIHNoYXJlX2luc2lnaHQiPicrb3B0aW9ucy5UcmFuc2xhdGlvbi50cmFuc2xhdGUoJ1ZETy5WRE84NicpKyc8L2Rpdj4nKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz0ibGluZV9idG5fbW9kYWwiPjwvc3Bhbj4nKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJidG4gY2xvc2VfaW5zaWdodCI+PC9kaXY+JysKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2Pic7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkb21fZWxsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NhdmUnOgogICAgICAgICAgICAgICAgICAgICAgICBkb21fZWxsZW1lbnQgPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ic2F2ZV9zaGFyZV9jbG9zZSI+JysKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iYnRuIHNhdmVfaW5zaWdodCI+JytvcHRpb25zLlRyYW5zbGF0aW9uLnRyYW5zbGF0ZSgnVkRPLlZETzg3JykrJzwvZGl2PicrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImJ0biBjbG9zZV9pbnNpZ2h0Ij48L2Rpdj4nKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvbV9lbGxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc2F2ZV9tb2RhbCc6CiAgICAgICAgICAgICAgICAgICAgICAgIGRvbV9lbGxlbWVudCA9ICc8ZGl2IGNsYXNzPSJzYXZlX21vZGFsIj48ZGl2IGNsYXNzPSJoZWFkZXJfbW9kYWwiPjxkaXYgY2xhc3M9InByZXZfbW9kYWwiPjwvZGl2PjxkaXYgY2xhc3M9InRpdGxlX21vZGFsIj4nK29wdGlvbnMuVHJhbnNsYXRpb24udHJhbnNsYXRlKCdWRE8uVkRPODgnKSsnPC9kaXY+PGRpdiBjbGFzcz0iY2xvc2VfbW9kYWwiPjwvZGl2PjwvZGl2PjxkaXYgY2xhc3M9ImNvbnRhaW5lcl9tb2RhbF9pbnNpZ2h0Ij48ZGl2IGNsYXNzPSJ0aXRsZV9pbnB1dCI+JytvcHRpb25zLlRyYW5zbGF0aW9uLnRyYW5zbGF0ZSgnVkRPLlZETzg5JykrJzwvZGl2PjxpbnB1dCB0eXBlPSJ0ZXh0IiBjbGFzcz0idGl0bGVfaW5zaWdodCI+PGRpdiBjbGFzcz0idGl0bGVfaW5wdXQiPicrb3B0aW9ucy5UcmFuc2xhdGlvbi50cmFuc2xhdGUoJ1ZETy5WRE85MCcpKyc8L2Rpdj48dGV4dGFyZWEgbmFtZT0iIiBpZD0iIiBjb2xzPSIzMCIgcm93cz0iMTAiIGNsYXNzPSJkZXNjcmlwdGlvbl9pbnNpZ2h0Ij48L3RleHRhcmVhPjwvZGl2PjxkaXYgY2xhc3M9ImJ0bl9zYXZlX2luc2lnaHQiPicrb3B0aW9ucy5UcmFuc2xhdGlvbi50cmFuc2xhdGUoJ1ZETy5WRE85MScpKyc8L2Rpdj48L2Rpdj4nOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZG9tX2VsbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdzaGFyZV9tb2RhbCc6CiAgICAgICAgICAgICAgICAgICAgICAgIGRvbV9lbGxlbWVudCA9ICc8ZGl2IGNsYXNzPSJzYXZlX21vZGFsIj48ZGl2IGNsYXNzPSJoZWFkZXJfbW9kYWwiPjxkaXYgY2xhc3M9InByZXZfbW9kYWwiPjwvZGl2PjxkaXYgY2xhc3M9InRpdGxlX21vZGFsIj4nK29wdGlvbnMuVHJhbnNsYXRpb24udHJhbnNsYXRlKCdWRE8uVkRPOTInKSsnJm5ic3A7Kzxicj4gJytvcHRpb25zLlRyYW5zbGF0aW9uLnRyYW5zbGF0ZSgnVkRPLlZETzkzJykrJzwvZGl2PjxkaXYgY2xhc3M9ImNsb3NlX21vZGFsIj48L2Rpdj48L2Rpdj48ZGl2IGNsYXNzPSJjb250YWluZXJfbW9kYWxfaW5zaWdodCI+PGRpdiBjbGFzcz0idGl0bGVfaW5wdXQiPicrb3B0aW9ucy5UcmFuc2xhdGlvbi50cmFuc2xhdGUoJ1ZETy5WRE85NCcpKyc8L2Rpdj48aW5wdXQgdHlwZT0idGV4dCIgY2xhc3M9InRpdGxlX2luc2lnaHQiPjxkaXYgY2xhc3M9InRpdGxlX2lucHV0Ij4nK29wdGlvbnMuVHJhbnNsYXRpb24udHJhbnNsYXRlKCdWRE8uVkRPOTUnKSsnPC9kaXY+PHRleHRhcmVhIG5hbWU9IiIgaWQ9IiIgY29scz0iMzAiIHJvd3M9IjEwIiBjbGFzcz0iZGVzY3JpcHRpb25faW5zaWdodCI+PC90ZXh0YXJlYT48L2Rpdj48ZGl2IGNsYXNzPSJidG5fc2F2ZV9pbnNpZ2h0Ij4nK29wdGlvbnMuVHJhbnNsYXRpb24udHJhbnNsYXRlKCdWRE8uVkRPOTYnKSsnPC9kaXY+PC9kaXY+JzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvbV9lbGxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc2F2ZV9tb2RhbF9zdWNjZXNzJzoKICAgICAgICAgICAgICAgICAgICAgICAgZG9tX2VsbGVtZW50ID0gJzxkaXYgY2xhc3M9InNhdmVfbW9kYWxfc3VjY2VzcyI+JytvcHRpb25zLlRyYW5zbGF0aW9uLnRyYW5zbGF0ZSgnVkRPLlZETzk3JykrJyA8c3Bhbj4nK29wdGlvbnMuVHJhbnNsYXRpb24udHJhbnNsYXRlKCdWRE8uVkRPOTgnKSsnPC9zcGFuPjxkaXYgY2xhc3M9ImJ0biBjbG9zZV9pbnNpZ2h0Ij48L2Rpdj48L2Rpdj4nOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZG9tX2VsbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICdzaGFyZV9tb2RhbF9zdWNjZXNzJzoKICAgICAgICAgICAgICAgICAgICAgICAgZG9tX2VsbGVtZW50ID0gJzxkaXYgY2xhc3M9InNhdmVfbW9kYWwiPjxkaXYgY2xhc3M9ImhlYWRlcl9tb2RhbCI+JysKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0idGl0bGVfbW9kYWwiPicrb3B0aW9ucy5UcmFuc2xhdGlvbi50cmFuc2xhdGUoJ1ZETy5WRE85OScpKyc8L2Rpdj48ZGl2IGNsYXNzPSJjbG9zZV9tb2RhbCI+PC9kaXY+PC9kaXY+JysKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iY29udGFpbmVyX21vZGFsX2luc2lnaHQgLW1pbmkiPjxkaXYgY2xhc3M9ImJsb2NrX3NoYXJlX2J0biI+JysKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0iYmxvY2tfc2hhcmUiJyArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkYXRhLXBhdGhzaGFyaW5nPSJ7e2luc2lnaHQudmlkZW8ucG9zdGVyUGF0aD8gaW5zaWdodC52aWRlby5wb3N0ZXJQYXRoIDogXCcvYXNzZXRzL2ltYWdlcy9wcmV2aWV3X3RlbXBsYXRlLnBuZ1wnfX0iJysKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RhdGEtdGl0bGVzaGFyaW5nPSInK29wdGlvbnMuVHJhbnNsYXRpb24udHJhbnNsYXRlKCdWRE8uVkRPMTAwJykrJyB7e2luc2lnaHQudmlkZW8uc2l0ZX19IicrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkYXRhLXVybHNoYXJpbmc9Ii9pbnNpZ2h0LXBhZ2U/aW5zaWdodElkPXt7aW5zaWdodC5pZH19IicrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkYXRhLWRlc2NyaXB0aW9uc2hhcmluZz0iJytvcHRpb25zLlRyYW5zbGF0aW9uLnRyYW5zbGF0ZSgnVkRPLlZETzEwMScpKyciPicrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPSJzaGFyZV9pY29uIGNvcHlfaW1nIiBzaGFyaW5nPicrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgaWQ9ImJsb2NrX2NvcHlfaW1nIiBjbGFzcz0iYmxvY2tfY29weV9pbWciIG5nLWNsYXNzPSIhaW5Db3B5P1wnc3RhdHVzX2Nsb3NlXCc6XCdcJyI+JysKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnICAgIDxkaXYgY2xhc3M9ImJsb2NrX2hyZWYiPicrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgY2xhc3M9Im9yaWduX2hyZWZfY29weSIgaWQ9Imluc2lnaHQtZnVsbC1ocmVmIicrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyAgICAgICAgICAgICAgIG5nLW1vZGVsPSJmdWxsSHJlZlBhZ2VJbnNpZ2h0Ij4nKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgICAgPC9kaXY+JysKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnICAgIDxzcGFuIGNsYXNzPSJ0ZXh0X2hyZWZfY29weSBidG5fY29weV9mdWxsX2hyZWYiIG5nLXNob3c9ImluQ29weSI+JytvcHRpb25zLlRyYW5zbGF0aW9uLnRyYW5zbGF0ZSgnVkRPLlZETzEwMicpKyc8L3NwYW4+JysKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnICAgPHNwYW4gY2xhc3M9InRleHRfaHJlZl9jb3B5IGNsb3NlX2J0bl9zaGFyZSInKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgICAgICAgICAgbmctc2hvdz0iIWluQ29weSI+PC9zcGFuPicrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9ImJsb2NrX2luZm9fc2hhcmUiPicrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicrCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+PGRpdiBjbGFzcz0ic2hhcmVfaWNvbiB2a19pbWciIHNoYXJpbmc+PC9kaXY+JysKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz0ic2hhcmVfaWNvbiBmYl9pbWciIHNoYXJpbmc+PC9kaXY+PGRpdiBjbGFzcz0ic2hhcmVfaWNvbiBvZF9pbWciIHNoYXJpbmc+PC9kaXY+PGRpdiBjbGFzcz0ic2hhcmVfaWNvbiB0d19pbWciIHNoYXJpbmc+PC9kaXY+PC9kaXY+PC9kaXY+PC9kaXY+JzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRvbV9lbGxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHQubWVkaWFFbGVtZW50LmV2ZW50X3NhdmVfc2hhcmVfaW5zaWdodCA9IGZ1bmN0aW9uICh0LCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLnNob3dNb2RhbEluc2lnaHQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIG9wdGlvbnMuaW5zaWdodEVkaXQ7CiAgICAgICAgICAgICAgICAkKCcuc2F2ZV9pbnNpZ2h0JykuY2xpY2soZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5pbnNpZ2h0RWRpdCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEuc2F2aW5nX2luc2lnaHQodCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAkKCIuaW5zaWdodF9tb2RhbF9ibG9jayIpLmh0bWwodC5tZWRpYS5yZW5kZXJNb2RhbCgnc2F2ZV9tb2RhbCcsb3B0aW9ucykpOwogICAgICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhLmV2ZW50X3NhdmVfaW5zaWdodCh0LCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICQoJy5zaGFyZV9pbnNpZ2h0JykuY2xpY2soZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAvLyQoIi5zdGF0dXNfaW5zaWdodCIpLnRyaWdnZXIoInNoYXJlaW5zaWdodCIsIG9ial9pbnNpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAkKCIuaW5zaWdodF9tb2RhbF9ibG9jayIpLmh0bWwodC5tZWRpYS5yZW5kZXJNb2RhbCgnc2hhcmVfbW9kYWwnLG9wdGlvbnMpKTsKICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhLmV2ZW50X3NoYXJlX2luc2lnaHQodCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICQoJy5jbG9zZV9pbnNpZ2h0JykuY2xpY2soZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAkKCcuY29udGFpbl9pbnNpZ2h0JykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgJCgnLmluc2lnaHRfbW9kYWxfYmxvY2snKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnNob3dNb2RhbEluc2lnaHQgPSB0cnVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0Lm1lZGlhLnBvc2l0aW9uX2luc2lnaHRfbW9kYWwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQuZXZlbnRfc2F2ZV9pbnNpZ2h0ID0gZnVuY3Rpb24gKHQsIG9wdGlvbnMpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMuc2hvd01vZGFsSW5zaWdodCA9IGZhbHNlOwogICAgICAgICAgICAgICAgJCgnLmNsb3NlX21vZGFsJykuY2xpY2soZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAkKCcuY29udGFpbl9pbnNpZ2h0JykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgJCgnLmluc2lnaHRfbW9kYWxfYmxvY2snKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnNob3dNb2RhbEluc2lnaHQgPSB0cnVlOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAkKCcucHJldl9tb2RhbCcpLmNsaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAkKCIuaW5zaWdodF9tb2RhbF9ibG9jayIpLmh0bWwodC5tZWRpYS5yZW5kZXJNb2RhbCgnc2F2ZV9zaGFyZScsb3B0aW9ucykpOwogICAgICAgICAgICAgICAgICAgIHQubWVkaWEuZXZlbnRfc2F2ZV9zaGFyZV9pbnNpZ2h0KHQsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAkKCcuYnRuX3NhdmVfaW5zaWdodCcpLmNsaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhLnNhdmluZ19pbnNpZ2h0KHQsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB0Lm1lZGlhLnBvc2l0aW9uX2luc2lnaHRfbW9kYWwoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQuc2F2aW5nX2luc2lnaHQgPSBmdW5jdGlvbiAodCwgb3B0aW9ucykgewogICAgICAgICAgICAgICAgdmFyIG9ial9pbnNpZ2h0ID0gewogICAgICAgICAgICAgICAgICAgICdjdXJyZW50VGltZXJTdGFydCc6IG9wdGlvbnMuY3VycmVudFRpbWVyU3RhcnQsCiAgICAgICAgICAgICAgICAgICAgJ2N1cnJlbnRUaW1lclN0b3AnOiBvcHRpb25zLmN1cnJlbnRUaW1lclN0b3AKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB2YXIgdGl0bGVfaW5zaWdodCA9ICQoJy50aXRsZV9pbnNpZ2h0JyksCiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb25faW5zaWdodCA9ICQoJy5kZXNjcmlwdGlvbl9pbnNpZ2h0Jyk7CiAgICAgICAgICAgICAgICBvYmpfaW5zaWdodC50aXRsZV9pbnNpZ2h0ID0gdGl0bGVfaW5zaWdodC52YWwoKTsKICAgICAgICAgICAgICAgIG9ial9pbnNpZ2h0LmRlc2NyaXB0aW9uX2luc2lnaHQgPSBkZXNjcmlwdGlvbl9pbnNpZ2h0LnZhbCgpOwogICAgICAgICAgICAgICAgJCgiLnN0YXR1c19pbnNpZ2h0IikudHJpZ2dlcigic2F2ZWluc2lnaHQiLCBvYmpfaW5zaWdodCk7CiAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMuaW5zaWdodEVkaXQpewogICAgICAgICAgICAgICAgICAgICQoIi5pbnNpZ2h0X21vZGFsX2Jsb2NrIikuaHRtbCh0Lm1lZGlhLnJlbmRlck1vZGFsKCdzYXZlX21vZGFsX3N1Y2Nlc3MnLG9wdGlvbnMpKTsKICAgICAgICAgICAgICAgICAgICAkKCcuY2xvc2VfaW5zaWdodCcpLmNsaWNrKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoJy5jb250YWluX2luc2lnaHQnKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgJCgnLmluc2lnaHRfbW9kYWxfYmxvY2snKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5zaG93TW9kYWxJbnNpZ2h0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdC5tZWRpYUVsZW1lbnQuZXZlbnRfc2hhcmVfaW5zaWdodCA9IGZ1bmN0aW9uICh0LCBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICBvcHRpb25zLnNob3dNb2RhbEluc2lnaHQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICQoJy5jbG9zZV9tb2RhbCcpLmNsaWNrKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgJCgnLmNvbnRhaW5faW5zaWdodCcpLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICQoJy5pbnNpZ2h0X21vZGFsX2Jsb2NrJykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5zaG93TW9kYWxJbnNpZ2h0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgJCgnLnByZXZfbW9kYWwnKS5jbGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgJCgiLmluc2lnaHRfbW9kYWxfYmxvY2siKS5odG1sKHQubWVkaWEucmVuZGVyTW9kYWwoJ3NhdmVfc2hhcmUnLG9wdGlvbnMpKTsKICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhLmV2ZW50X3NhdmVfc2hhcmVfaW5zaWdodCh0LCBvcHRpb25zKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgJCgnLmJ0bl9zYXZlX2luc2lnaHQnKS5jbGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9ial9pbnNpZ2h0ID0gewogICAgICAgICAgICAgICAgICAgICAgICAnY3VycmVudFRpbWVyU3RhcnQnOiBvcHRpb25zLmN1cnJlbnRUaW1lclN0YXJ0LAogICAgICAgICAgICAgICAgICAgICAgICAnY3VycmVudFRpbWVyU3RvcCc6IG9wdGlvbnMuY3VycmVudFRpbWVyU3RvcAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgdmFyIHRpdGxlX2luc2lnaHQgPSAkKCcudGl0bGVfaW5zaWdodCcpLAogICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbl9pbnNpZ2h0ID0gJCgnLmRlc2NyaXB0aW9uX2luc2lnaHQnKTsKICAgICAgICAgICAgICAgICAgICBvYmpfaW5zaWdodC50aXRsZV9pbnNpZ2h0ID0gdGl0bGVfaW5zaWdodC52YWwoKTsKICAgICAgICAgICAgICAgICAgICBvYmpfaW5zaWdodC5kZXNjcmlwdGlvbl9pbnNpZ2h0ID0gZGVzY3JpcHRpb25faW5zaWdodC52YWwoKTsKICAgICAgICAgICAgICAgICAgICAkKCIuc3RhdHVzX2luc2lnaHQiKS50cmlnZ2VyKCJzaGFyZWluc2lnaHQiLCBvYmpfaW5zaWdodCk7CiAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5ldmVudF9zaGFyZV9pbnNpZ2h0X3N1Y2Nlc3ModCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHQubWVkaWEucG9zaXRpb25faW5zaWdodF9tb2RhbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0Lm1lZGlhRWxlbWVudC5ldmVudF9zaGFyZV9pbnNpZ2h0X3N1Y2Nlc3MgPSBmdW5jdGlvbiAodCwgb3B0aW9ucykgewogICAgICAgICAgICAgICAgb3B0aW9ucy5zaG93TW9kYWxJbnNpZ2h0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAkKCcuY2xvc2VfbW9kYWwnKS5jbGljayhmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICQoJy5jb250YWluX2luc2lnaHQnKS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICAkKCcuaW5zaWdodF9tb2RhbF9ibG9jaycpLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuc2hvd01vZGFsSW5zaWdodCA9IHRydWU7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICQoJy5wcmV2X21vZGFsJykuY2xpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICQoIi5pbnNpZ2h0X21vZGFsX2Jsb2NrIikuaHRtbCh0Lm1lZGlhLnJlbmRlck1vZGFsKCdzYXZlX3NoYXJlJyxvcHRpb25zKSk7CiAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5ldmVudF9zYXZlX3NoYXJlX2luc2lnaHQodCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHQubWVkaWEucG9zaXRpb25faW5zaWdodF9tb2RhbCgpOwogICAgICAgICAgICB9CgoKCiAgICAgICAgICAgIC8vIEB0b2RvOiBWZXJpZnkgaWYgdGhpcyBpcyBuZWVkZWQKICAgICAgICAgICAgLy8gaWYgKHQubWVkaWFFbGVtZW50Lm9wdGlvbnMuZXJyb3IpIHsKICAgICAgICAgICAgLy8gCXQubWVkaWFFbGVtZW50Lm9wdGlvbnMuZXJyb3IodGhpcy5tZWRpYUVsZW1lbnQsIHRoaXMubWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZSk7CiAgICAgICAgICAgIC8vIH0KCiAgICAgICAgICAgIHJldHVybiB0Lm1lZGlhRWxlbWVudDsKICAgICAgICB9OwoKICAgICAgICBfd2luZG93Mi5kZWZhdWx0Lk1lZGlhRWxlbWVudCA9IE1lZGlhRWxlbWVudDsKCiAgICAgICAgZXhwb3J0cy5kZWZhdWx0ID0gTWVkaWFFbGVtZW50OwoKICAgIH0sIHsiMiI6IDIsICIzIjogMywgIjMwIjogMzAsICI2IjogNiwgIjciOiA3fV0sCiAgICA2OiBbZnVuY3Rpb24gKF9kZXJlcV8sIG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgIAoKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICAgICAgICAgIHZhbHVlOiB0cnVlCiAgICAgICAgfSk7CgogICAgICAgIHZhciBfd2luZG93ID0gX2RlcmVxXygzKTsKCiAgICAgICAgdmFyIF93aW5kb3cyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfd2luZG93KTsKCiAgICAgICAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHtkZWZhdWx0OiBvYmp9OwogICAgICAgIH0KCi8vIE5hbWVzcGFjZQogICAgICAgIHZhciBtZWpzID0ge307CgovLyB2ZXJzaW9uIG51bWJlcgogICAgICAgIG1lanMudmVyc2lvbiA9ICczLjEuMSc7CgovLyBCYXNpYyBIVE1MNSBzZXR0aW5ncwogICAgICAgIG1lanMuaHRtbDVtZWRpYSA9IHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtTdHJpbmdbXX0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHByb3BlcnRpZXM6IFsKICAgICAgICAgICAgICAgIC8vIEdFVC9TRVQKICAgICAgICAgICAgICAgICd2b2x1bWUnLCAnc3JjJywgJ2N1cnJlbnRUaW1lJywgJ211dGVkJywKCiAgICAgICAgICAgICAgICAvLyBHRVQgb25seQogICAgICAgICAgICAgICAgJ2R1cmF0aW9uJywgJ3BhdXNlZCcsICdlbmRlZCcsICdidWZmZXJlZCcsICdlcnJvcicsICduZXR3b3JrU3RhdGUnLCAncmVhZHlTdGF0ZScsICdzZWVraW5nJywgJ3NlZWthYmxlJywKCiAgICAgICAgICAgICAgICAvLyBPVEhFUlMKICAgICAgICAgICAgICAgICdjdXJyZW50U3JjJywgJ3ByZWxvYWQnLCAnYnVmZmVyZWRCeXRlcycsICdidWZmZXJlZFRpbWUnLCAnaW5pdGlhbFRpbWUnLCAnc3RhcnRPZmZzZXRUaW1lJywgJ2RlZmF1bHRQbGF5YmFja1JhdGUnLCAncGxheWJhY2tSYXRlJywgJ3BsYXllZCcsICdhdXRvcGxheScsICdsb29wJywgJ2NvbnRyb2xzJ10sCiAgICAgICAgICAgIHJlYWRPbmx5UHJvcGVydGllczogWydkdXJhdGlvbicsICdwYXVzZWQnLCAnZW5kZWQnLCAnYnVmZmVyZWQnLCAnZXJyb3InLCAnbmV0d29ya1N0YXRlJywgJ3JlYWR5U3RhdGUnLCAnc2Vla2luZycsICdzZWVrYWJsZSddLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHR5cGUge1N0cmluZ1tdfQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgbWV0aG9kczogWydsb2FkJywgJ3BsYXknLCAncGF1c2UnLCAnY2FuUGxheVR5cGUnXSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtTdHJpbmdbXX0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGV2ZW50czogWydsb2Fkc3RhcnQnLCAncHJvZ3Jlc3MnLCAnc3VzcGVuZCcsICdhYm9ydCcsICdlcnJvcicsICdlbXB0aWVkJywgJ3N0YWxsZWQnLCAncGxheScsICdwYXVzZScsICdsb2FkZWRtZXRhZGF0YScsICdsb2FkZWRkYXRhJywgJ3dhaXRpbmcnLCAncGxheWluZycsICdjYW5wbGF5JywgJ2NhbnBsYXl0aHJvdWdoJywgJ3NlZWtpbmcnLCAnc2Vla2VkJywgJ3RpbWV1cGRhdGUnLCAnZW5kZWQnLCAncmF0ZWNoYW5nZScsICdkdXJhdGlvbmNoYW5nZScsICd2b2x1bWVjaGFuZ2UnXSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtTdHJpbmdbXX0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIG1lZGlhVHlwZXM6IFsnYXVkaW8vbXAzJywgJ2F1ZGlvL29nZycsICdhdWRpby9vZ2EnLCAnYXVkaW8vd2F2JywgJ2F1ZGlvL3gtd2F2JywgJ2F1ZGlvL3dhdmUnLCAnYXVkaW8veC1wbi13YXYnLCAnYXVkaW8vbXBlZycsICdhdWRpby9tcDQnLCAndmlkZW8vbXA0JywgJ3ZpZGVvL3dlYm0nLCAndmlkZW8vb2dnJ10KICAgICAgICB9OwoKICAgICAgICBfd2luZG93Mi5kZWZhdWx0Lm1lanMgPSBtZWpzOwoKICAgICAgICBleHBvcnRzLmRlZmF1bHQgPSBtZWpzOwoKICAgIH0sIHsiMyI6IDN9XSwKICAgIDc6IFtmdW5jdGlvbiAoX2RlcmVxXywgbW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgCgogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgICAgICAgICAgdmFsdWU6IHRydWUKICAgICAgICB9KTsKICAgICAgICBleHBvcnRzLnJlbmRlcmVyID0gdW5kZWZpbmVkOwoKICAgICAgICB2YXIgX3R5cGVvZiA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA9PT0gInN5bWJvbCIgPyBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIG9iajsKICAgICAgICAgICAgfSA6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiBvYmogJiYgdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBvYmouY29uc3RydWN0b3IgPT09IFN5bWJvbCAmJiBvYmogIT09IFN5bWJvbC5wcm90b3R5cGUgPyAic3ltYm9sIiA6IHR5cGVvZiBvYmo7CiAgICAgICAgICAgIH07CgogICAgICAgIHZhciBfY3JlYXRlQ2xhc3MgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07CiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CiAgICAgICAgICAgICAgICBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwogICAgICAgICAgICAgICAgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7CiAgICAgICAgICAgICAgICByZXR1cm4gQ29uc3RydWN0b3I7CiAgICAgICAgICAgIH07CiAgICAgICAgfSgpOwoKICAgICAgICB2YXIgX21lanMgPSBfZGVyZXFfKDYpOwoKICAgICAgICB2YXIgX21lanMyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfbWVqcyk7CgogICAgICAgIGZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ZGVmYXVsdDogb2JqfTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsKICAgICAgICAgICAgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIENsYXNzIHRvIG1hbmFnZSByZW5kZXJlciBzZWxlY3Rpb24gYW5kIGFkZGl0aW9uLgogICAgICAgICAqIEBjbGFzcyBSZW5kZXJlcgogICAgICAgICAqLwogICAgICAgIHZhciBSZW5kZXJlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZnVuY3Rpb24gUmVuZGVyZXIoKSB7CiAgICAgICAgICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgUmVuZGVyZXIpOwoKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXJzID0ge307CiAgICAgICAgICAgICAgICB0aGlzLm9yZGVyID0gW107CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBSZWdpc3RlciBhIG5ldyByZW5kZXJlci4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHJlbmRlcmVyIC0gQW4gb2JqZWN0IHdpdGggYWxsIHRoZSByZW5kZXJlZCBpbmZvcm1hdGlvbiAobmFtZSBSRVFVSVJFRCkKICAgICAgICAgICAgICogQG1ldGhvZCBhZGQKICAgICAgICAgICAgICovCgoKICAgICAgICAgICAgX2NyZWF0ZUNsYXNzKFJlbmRlcmVyLCBbewogICAgICAgICAgICAgICAga2V5OiAnYWRkJywKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBhZGQocmVuZGVyZXIpIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlcmVyLm5hbWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdyZW5kZXJlciBtdXN0IGNvbnRhaW4gYXQgbGVhc3QgYG5hbWVgIHByb3BlcnR5Jyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyc1tyZW5kZXJlci5uYW1lXSA9IHJlbmRlcmVyOwogICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXIucHVzaChyZW5kZXJlci5uYW1lKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEl0ZXJhdGUgYSBsaXN0IG9mIHJlbmRlcmVycyB0byBkZXRlcm1pbmUgd2hpY2ggb25lIHNob3VsZCB0aGUgcGxheWVyIHVzZS4KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdFtdfSBtZWRpYUZpbGVzIC0gQSBsaXN0IG9mIHNvdXJjZSBhbmQgdHlwZSBvYnRhaW5lZCBmcm9tIHZpZGVvL2F1ZGlvL3NvdXJjZSB0YWdzOiBbe3NyYzonJyx0eXBlOicnfV0KICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7P1N0cmluZ1tdfSByZW5kZXJlcnMgLSBPcHRpb25hbCBsaXN0IG9mIHByZS1zZWxlY3RlZCByZW5kZXJlcnMKICAgICAgICAgICAgICAgICAqIEByZXR1cm4gez9PYmplY3R9IFRoZSByZW5kZXJlcidzIG5hbWUgYW5kIHNvdXJjZSBzZWxlY3RlZAogICAgICAgICAgICAgICAgICogQG1ldGhvZCBzZWxlY3QKICAgICAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAga2V5OiAnc2VsZWN0JywKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZWxlY3QobWVkaWFGaWxlcykgewogICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJlcnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IFtdOwoKCiAgICAgICAgICAgICAgICAgICAgcmVuZGVyZXJzID0gcmVuZGVyZXJzLmxlbmd0aCA/IHJlbmRlcmVycyA6IHRoaXMub3JkZXI7CgogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBpbCA9IHJlbmRlcmVycy5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSByZW5kZXJlcnNbaV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfcmVuZGVyZXIgPSB0aGlzLnJlbmRlcmVyc1trZXldOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9yZW5kZXJlciAhPT0gbnVsbCAmJiBfcmVuZGVyZXIgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDAsIGpsID0gbWVkaWFGaWxlcy5sZW5ndGg7IGogPCBqbDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBfcmVuZGVyZXIuY2FuUGxheVR5cGUgPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIG1lZGlhRmlsZXNbal0udHlwZSA9PT0gJ3N0cmluZycgJiYgX3JlbmRlcmVyLmNhblBsYXlUeXBlKG1lZGlhRmlsZXNbal0udHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyTmFtZTogX3JlbmRlcmVyLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcmM6IG1lZGlhRmlsZXNbal0uc3JjCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBTZXR0ZXJzL2dldHRlcnMKCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ29yZGVyJywKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gc2V0KG9yZGVyKSB7CgogICAgICAgICAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShvcmRlcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignb3JkZXIgbXVzdCBiZSBhbiBhcnJheSBvZiBzdHJpbmdzLicpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fb3JkZXIgPSBvcmRlcjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fb3JkZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ3JlbmRlcmVycycsCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChyZW5kZXJlcnMpIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlcmVycyAhPT0gbnVsbCAmJiAodHlwZW9mIHJlbmRlcmVycyA9PT0gJ3VuZGVmaW5lZCcgPyAndW5kZWZpbmVkJyA6IF90eXBlb2YocmVuZGVyZXJzKSkgIT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ3JlbmRlcmVycyBtdXN0IGJlIGFuIGFycmF5IG9mIG9iamVjdHMuJyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW5kZXJlcnMgPSByZW5kZXJlcnM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlbmRlcmVyczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV0pOwoKICAgICAgICAgICAgcmV0dXJuIFJlbmRlcmVyOwogICAgICAgIH0oKTsKCiAgICAgICAgdmFyIHJlbmRlcmVyID0gZXhwb3J0cy5yZW5kZXJlciA9IG5ldyBSZW5kZXJlcigpOwoKICAgICAgICBfbWVqczIuZGVmYXVsdC5SZW5kZXJlcnMgPSByZW5kZXJlcjsKCiAgICB9LCB7IjYiOiA2fV0sCiAgICA4OiBbZnVuY3Rpb24gKF9kZXJlcV8sIG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgIAoKICAgICAgICB2YXIgX3dpbmRvdyA9IF9kZXJlcV8oMyk7CgogICAgICAgIHZhciBfd2luZG93MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3dpbmRvdyk7CgogICAgICAgIHZhciBfZG9jdW1lbnQgPSBfZGVyZXFfKDIpOwoKICAgICAgICB2YXIgX2RvY3VtZW50MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2RvY3VtZW50KTsKCiAgICAgICAgdmFyIF9tZWpzID0gX2RlcmVxXyg2KTsKCiAgICAgICAgdmFyIF9tZWpzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX21lanMpOwoKICAgICAgICB2YXIgX2kxOG4gPSBfZGVyZXFfKDQpOwoKICAgICAgICB2YXIgX2kxOG4yID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfaTE4bik7CgogICAgICAgIHZhciBfcGxheWVyID0gX2RlcmVxXygxNik7CgogICAgICAgIHZhciBfcGxheWVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3BsYXllcik7CgogICAgICAgIHZhciBfY29uc3RhbnRzID0gX2RlcmVxXygyNyk7CgogICAgICAgIHZhciBGZWF0dXJlcyA9IF9pbnRlcm9wUmVxdWlyZVdpbGRjYXJkKF9jb25zdGFudHMpOwoKICAgICAgICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVXaWxkY2FyZChvYmopIHsKICAgICAgICAgICAgaWYgKG9iaiAmJiBvYmouX19lc01vZHVsZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iajsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBuZXdPYmogPSB7fTsKICAgICAgICAgICAgICAgIGlmIChvYmogIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIG5ld09ialtrZXldID0gb2JqW2tleV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV3T2JqLmRlZmF1bHQgPSBvYmo7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3T2JqOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDoge2RlZmF1bHQ6IG9ian07CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBGdWxsc2NyZWVuIGJ1dHRvbgogICAgICAgICAqCiAgICAgICAgICogVGhpcyBmZWF0dXJlIGNyZWF0ZXMgYSBidXR0b24gdG8gdG9nZ2xlIGZ1bGxzY3JlZW4gb24gdmlkZW87IGl0IGNvbnNpZGVycyBhIGxldGlldHkgb2YgcG9zc2liaWxpdGllcyB3aGVuIGRlYWxpbmcgd2l0aCBpdAogICAgICAgICAqIHNpbmNlIGl0IGlzIG5vdCBjb25zaXN0ZW50IGFjcm9zcyBicm93c2Vycy4gSXQgYWxzbyBhY2NvdW50cyBmb3IgdHJpZ2dlcmluZyB0aGUgZXZlbnQgdGhyb3VnaCBGbGFzaCBzaGltLgogICAgICAgICAqLwoKLy8gRmVhdHVyZSBjb25maWd1cmF0aW9uCiAgICAgICAgT2JqZWN0LmFzc2lnbihfcGxheWVyLmNvbmZpZywgewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICAgICAqLwogICAgICAgICAgICB1c2VQbHVnaW5GdWxsU2NyZWVuOiB0cnVlLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGZ1bGxzY3JlZW5UZXh0OiAnJwogICAgICAgIH0pOwoKICAgICAgICBPYmplY3QuYXNzaWduKF9wbGF5ZXIyLmRlZmF1bHQucHJvdG90eXBlLCB7CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpc0Z1bGxTY3JlZW46IGZhbHNlLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpc05hdGl2ZUZ1bGxTY3JlZW46IGZhbHNlLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpc0luSWZyYW1lOiBmYWxzZSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNQbHVnaW5DbGlja1Rocm91Z2hDcmVhdGVkOiBmYWxzZSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFBvc3NpYmxlIG1vZGVzCiAgICAgICAgICAgICAqICgxKSAnbmF0aXZlLW5hdGl2ZScgIEhUTUw1IHZpZGVvICArIGJyb3dzZXIgZnVsbHNjcmVlbiAoSUUxMCssIGV0Yy4pCiAgICAgICAgICAgICAqICgyKSAncGx1Z2luLW5hdGl2ZScgIHBsdWdpbiB2aWRlbyArIGJyb3dzZXIgZnVsbHNjcmVlbiAoZmFpbHMgaW4gc29tZSB2ZXJzaW9ucyBvZiBGaXJlZm94KQogICAgICAgICAgICAgKiAoMykgJ2Z1bGx3aW5kb3cnICAgICBGdWxsIHdpbmRvdyAocmV0YWlucyBhbGwgVUkpCiAgICAgICAgICAgICAqICg0KSAncGx1Z2luLWNsaWNrJyAgIEZsYXNoIDEgLSBjbGljayB0aHJvdWdoIHdpdGggcG9pbnRlciBldmVudHMKICAgICAgICAgICAgICogKDUpICdwbHVnaW4taG92ZXInICAgRmxhc2ggMiAtIGhvdmVyIHBvcHVwIGluIGZsYXNoIChJRTYtOCkKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGZ1bGxzY3JlZW5Nb2RlOiAnJywKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjb250YWluZXJTaXplVGltZW91dDogbnVsbCwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBGZWF0dXJlIGNvbnN0cnVjdG9yLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBBbHdheXMgaGFzIHRvIGJlIHByZWZpeGVkIHdpdGggYGJ1aWxkYCBhbmQgdGhlIG5hbWUgdGhhdCB3aWxsIGJlIHVzZWQgaW4gTWVwRGVmYXVsdHMuZmVhdHVyZXMgbGlzdAogICAgICAgICAgICAgKiBAcGFyYW0ge01lZGlhRWxlbWVudFBsYXllcn0gcGxheWVyCiAgICAgICAgICAgICAqIEBwYXJhbSB7JH0gY29udHJvbHMKICAgICAgICAgICAgICogQHBhcmFtIHskfSBsYXllcnMKICAgICAgICAgICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gbWVkaWEKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGJ1aWxkZnVsbHNjcmVlbjogZnVuY3Rpb24gYnVpbGRmdWxsc2NyZWVuKHBsYXllciwgY29udHJvbHMsIGxheWVycywgbWVkaWEpIHsKCiAgICAgICAgICAgICAgICBpZiAoIXBsYXllci5pc1ZpZGVvKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZW1iZWQgJiYgKF9jb25zdGFudHMuSVNfSVBBRCB8fCBfY29uc3RhbnRzLklTX0lQSE9ORSkgKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHBsYXllci5pc0luSWZyYW1lID0gX3dpbmRvdzIuZGVmYXVsdC5sb2NhdGlvbiAhPT0gX3dpbmRvdzIuZGVmYXVsdC5wYXJlbnQubG9jYXRpb247CgogICAgICAgICAgICAgICAgLy8gZGV0ZWN0IG9uIHN0YXJ0CiAgICAgICAgICAgICAgICBtZWRpYS5hZGRFdmVudExpc3RlbmVyKCdsb2Fkc3RhcnQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLmRldGVjdEZ1bGxzY3JlZW5Nb2RlKCk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyBidWlsZCBidXR0b24KICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBoaWRlVGltZW91dCA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgZnVsbHNjcmVlblRpdGxlID0gdC5vcHRpb25zLmZ1bGxzY3JlZW5UZXh0ID8gdC5vcHRpb25zLmZ1bGxzY3JlZW5UZXh0IDogX2kxOG4yLmRlZmF1bHQudCgnbWVqcy5mdWxsc2NyZWVuJyksCiAgICAgICAgICAgICAgICAgICAgZnVsbHNjcmVlbkJ0biA9ICQoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnYnV0dG9uICcgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnZnVsbHNjcmVlbi1idXR0b24iPicgKyAoJzxidXR0b24gdHlwZT0iYnV0dG9uIiBkYXRhLXRvZ2dsZT0icGxheWVyLXRvb2x0aXAiIGFyaWEtY29udHJvbHM9IicgKyB0LmlkICsgJyIgdGl0bGU9IicgKyBmdWxsc2NyZWVuVGl0bGUgKyAnIiBhcmlhLWxhYmVsPSInICsgZnVsbHNjcmVlblRpdGxlICsgJyI+PC9idXR0b24+JykgKyAnPC9kaXY+JykuYXBwZW5kVG8oY29udHJvbHMpLm9uKCdjbGljaycsIGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvZ2dsZSBmdWxsc2NyZWVuCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpc0Z1bGxTY3JlZW4gPSBGZWF0dXJlcy5IQVNfVFJVRV9OQVRJVkVfRlVMTFNDUkVFTiAmJiBGZWF0dXJlcy5JU19GVUxMU0NSRUVOIHx8IHBsYXllci5pc0Z1bGxTY3JlZW47CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bGxTY3JlZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5leGl0RnVsbFNjcmVlbigpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLmVudGVyRnVsbFNjcmVlbigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy5zaG93SW5zaWdodHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCcucHJvZ3Jlc3NfYmFyX3RpbWUnKS53aWR0aChOdW1iZXIoJCgnLnV4Y19fdGltZS1yYWlsJykuYXR0cignc3R5bGUnKS5zcGxpdCgnOiAnKVsxXS5zcGxpdCgncHg7JylbMF0pICsgTnVtYmVyKCQoJy5wcm9ncmVzc19iYXJfdGltZScpLndpZHRoKCkpICsgJ3B4Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KS5vbignbW91c2VvdmVyJywgZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdmVyeSBvbGQgYnJvd3NlcnMgd2l0aCBhIHBsdWdpbgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5mdWxsc2NyZWVuTW9kZSA9PT0gJ3BsdWdpbi1ob3ZlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoaWRlVGltZW91dCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChoaWRlVGltZW91dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlkZVRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBidXR0b25Qb3MgPSBmdWxsc2NyZWVuQnRuLm9mZnNldCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lclBvcyA9IHBsYXllci5jb250YWluZXIub2Zmc2V0KCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEucG9zaXRpb25GdWxsc2NyZWVuQnV0dG9uKGJ1dHRvblBvcy5sZWZ0IC0gY29udGFpbmVyUG9zLmxlZnQsIGJ1dHRvblBvcy50b3AgLSBjb250YWluZXJQb3MudG9wLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pLm9uKCdtb3VzZW91dCcsIGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0LmZ1bGxzY3JlZW5Nb2RlID09PSAncGx1Z2luLWhvdmVyJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhpZGVUaW1lb3V0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGhpZGVUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoaWRlVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLmhpZGVGdWxsc2NyZWVuQnV0dG9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHBsYXllci5mdWxsc2NyZWVuQnRuID0gZnVsbHNjcmVlbkJ0bjsKCiAgICAgICAgICAgICAgICB0Lmdsb2JhbEJpbmQoJ2tleWRvd24nLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBlLndoaWNoIHx8IGUua2V5Q29kZSB8fCAwOwogICAgICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IDI3ICYmIChGZWF0dXJlcy5IQVNfVFJVRV9OQVRJVkVfRlVMTFNDUkVFTiAmJiBGZWF0dXJlcy5JU19GVUxMU0NSRUVOIHx8IHQuaXNGdWxsU2NyZWVuKSkgewogICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuZXhpdEZ1bGxTY3JlZW4oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0Lm5vcm1hbEhlaWdodCA9IDA7CiAgICAgICAgICAgICAgICB0Lm5vcm1hbFdpZHRoID0gMDsKCiAgICAgICAgICAgICAgICAvLyBzZXR1cCBuYXRpdmUgZnVsbHNjcmVlbiBldmVudAogICAgICAgICAgICAgICAgaWYgKEZlYXR1cmVzLkhBU19UUlVFX05BVElWRV9GVUxMU0NSRUVOKSB7CgogICAgICAgICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogRGV0ZWN0IGFueSBjaGFuZ2VzIG9uIGZ1bGxzY3JlZW4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIENocm9tZSBkb2Vzbid0IGFsd2F5cyBmaXJlIHRoaXMgaW4gYW4gYDxpZnJhbWU+YAogICAgICAgICAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgdmFyIGZ1bGxzY3JlZW5DaGFuZ2VkID0gZnVuY3Rpb24gZnVsbHNjcmVlbkNoYW5nZWQoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXIuaXNGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoRmVhdHVyZXMuaXNGdWxsU2NyZWVuKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuaXNOYXRpdmVGdWxsU2NyZWVuID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZXNldCB0aGUgY29udHJvbHMgb25jZSB3ZSBhcmUgZnVsbHkgaW4gZnVsbCBzY3JlZW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuc2V0Q29udHJvbHNTaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5pc05hdGl2ZUZ1bGxTY3JlZW4gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB3aGVuIGEgdXNlciBwcmVzc2VzIEVTQwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSB0byBwdXQgdGhlIHBsYXllciBiYWNrIGludG8gcGxhY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuZXhpdEZ1bGxTY3JlZW4oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIHBsYXllci5nbG9iYWxCaW5kKEZlYXR1cmVzLkZVTExTQ1JFRU5fRVZFTlRfTkFNRSwgZnVsbHNjcmVlbkNoYW5nZWQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIERldGVjdCB0aGUgdHlwZSBvZiBmdWxsc2NyZWVuIGJhc2VkIG9uIGJyb3dzZXIncyBjYXBhYmlsaXRpZXMKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHJldHVybiB7U3RyaW5nfQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZGV0ZWN0RnVsbHNjcmVlbk1vZGU6IGZ1bmN0aW9uIGRldGVjdEZ1bGxzY3JlZW5Nb2RlKCkgewoKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBtb2RlID0gJycsCiAgICAgICAgICAgICAgICAgICAgaXNOYXRpdmUgPSB0Lm1lZGlhLnJlbmRlcmVyTmFtZSAhPT0gbnVsbCAmJiB0Lm1lZGlhLnJlbmRlcmVyTmFtZS5tYXRjaCgvKG5hdGl2ZXxodG1sNSkvKSAhPT0gbnVsbDsKCiAgICAgICAgICAgICAgICBpZiAoRmVhdHVyZXMuSEFTX1RSVUVfTkFUSVZFX0ZVTExTQ1JFRU4gJiYgaXNOYXRpdmUpIHsKICAgICAgICAgICAgICAgICAgICBtb2RlID0gJ25hdGl2ZS1uYXRpdmUnOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChGZWF0dXJlcy5IQVNfVFJVRV9OQVRJVkVfRlVMTFNDUkVFTiAmJiAhaXNOYXRpdmUpIHsKICAgICAgICAgICAgICAgICAgICBtb2RlID0gJ3BsdWdpbi1uYXRpdmUnOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0LnVzZVBsdWdpbkZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoRmVhdHVyZXMuU1VQUE9SVF9QT0lOVEVSX0VWRU5UUykgewogICAgICAgICAgICAgICAgICAgICAgICBtb2RlID0gJ3BsdWdpbi1jbGljayc7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgbmVlZHMgc29tZSBzcGVjaWFsIHNldHVwCiAgICAgICAgICAgICAgICAgICAgICAgIHQuY3JlYXRlUGx1Z2luQ2xpY2tUaHJvdWdoKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbW9kZSA9ICdwbHVnaW4taG92ZXInOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbW9kZSA9ICdmdWxsd2luZG93JzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0LmZ1bGxzY3JlZW5Nb2RlID0gbW9kZTsKICAgICAgICAgICAgICAgIHJldHVybiBtb2RlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjcmVhdGVQbHVnaW5DbGlja1Rocm91Z2g6IGZ1bmN0aW9uIGNyZWF0ZVBsdWdpbkNsaWNrVGhyb3VnaCgpIHsKCiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXM7CgogICAgICAgICAgICAgICAgLy8gZG9uJ3QgYnVpbGQgdHdpY2UKICAgICAgICAgICAgICAgIGlmICh0LmlzUGx1Z2luQ2xpY2tUaHJvdWdoQ3JlYXRlZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBhbGxvd3MgY2xpY2tpbmcgdGhyb3VnaCB0aGUgZnVsbHNjcmVlbiBidXR0b24gYW5kIGNvbnRyb2xzIGRvd24gZGlyZWN0bHkgdG8gRmxhc2gKCiAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgIFdoZW4gYSB1c2VyIHB1dHMgaGlzIG1vdXNlIG92ZXIgdGhlIGZ1bGxzY3JlZW4gYnV0dG9uLCB3ZSBkaXNhYmxlIHRoZSBjb250cm9scyBzbyB0aGF0IG1vdXNlIGV2ZW50cyBjYW4gZ28gZG93biB0byBmbGFzaCAocG9pbnRlci1ldmVudHMpCiAgICAgICAgICAgICAgICAgV2UgdGhlbiBwdXQgYSBkaXZzIG92ZXIgdGhlIHZpZGVvIGFuZCBvbiBlaXRoZXIgc2lkZSBvZiB0aGUgZnVsbHNjcmVlbiBidXR0b24KICAgICAgICAgICAgICAgICB0byBjYXB0dXJlIG1vdXNlIG1vdmVtZW50IGFuZCByZXN0b3JlIHRoZSBjb250cm9scyBvbmNlIHRoZSBtb3VzZSBtb3ZlcyBvdXRzaWRlIG9mIHRoZSBmdWxsc2NyZWVuIGJ1dHRvbgogICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgdmFyIGZ1bGxzY3JlZW5Jc0Rpc2FibGVkID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xzID0gZnVuY3Rpb24gcmVzdG9yZUNvbnRyb2xzKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZnVsbHNjcmVlbklzRGlzYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGhpZGUgdGhlIGhvdmVycwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBob3ZlckRpdnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBob3ZlckRpdnNbaV0uaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlc3RvcmUgdGhlIGNvbnRyb2wgYmFyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmZ1bGxzY3JlZW5CdG4uY3NzKCdwb2ludGVyLWV2ZW50cycsICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuY29udHJvbHMuY3NzKCdwb2ludGVyLWV2ZW50cycsICcnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwcmV2ZW50IGNsaWNrcyBmcm9tIHBhdXNpbmcgdmlkZW8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0LmNsaWNrVG9QbGF5UGF1c2VDYWxsYmFjayk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3RvcmUgZm9yIGxhdGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdWxsc2NyZWVuSXNEaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBob3ZlckRpdnMgPSB7fSwKICAgICAgICAgICAgICAgICAgICBob3ZlckRpdk5hbWVzID0gWyd0b3AnLCAnbGVmdCcsICdyaWdodCcsICdib3R0b20nXSwKICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbkhvdmVyRGl2cyA9IGZ1bmN0aW9uIHBvc2l0aW9uSG92ZXJEaXZzKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZnVsbFNjcmVlbkJ0bk9mZnNldExlZnQgPSBmdWxsc2NyZWVuQnRuLm9mZnNldCgpLmxlZnQgLSB0LmNvbnRhaW5lci5vZmZzZXQoKS5sZWZ0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVsbFNjcmVlbkJ0bk9mZnNldFRvcCA9IGZ1bGxzY3JlZW5CdG4ub2Zmc2V0KCkudG9wIC0gdC5jb250YWluZXIub2Zmc2V0KCkudG9wLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVsbFNjcmVlbkJ0bldpZHRoID0gZnVsbHNjcmVlbkJ0bi5vdXRlcldpZHRoKHRydWUpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVsbFNjcmVlbkJ0bkhlaWdodCA9IGZ1bGxzY3JlZW5CdG4ub3V0ZXJIZWlnaHQodHJ1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJXaWR0aCA9IHQuY29udGFpbmVyLndpZHRoKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJIZWlnaHQgPSB0LmNvbnRhaW5lci5oZWlnaHQoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGhvdmVyIGluIGhvdmVyRGl2cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaG92ZXIuY3NzKHtwb3NpdGlvbjogJ2Fic29sdXRlJywgdG9wOiAwLCBsZWZ0OiAwfSk7IC8vLCBiYWNrZ3JvdW5kQ29sb3I6ICcjZjAwJ30pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBvdmVyIHZpZGVvLCBidXQgbm90IGNvbnRyb2xzCiAgICAgICAgICAgICAgICAgICAgICAgIGhvdmVyRGl2cy50b3Aud2lkdGgoY29udGFpbmVyV2lkdGgpLmhlaWdodChmdWxsU2NyZWVuQnRuT2Zmc2V0VG9wKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG92ZXIgY29udHJvbHMsIGJ1dCBub3QgdGhlIGZ1bGxzY3JlZW4gYnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIGhvdmVyRGl2cy5sZWZ0LndpZHRoKGZ1bGxTY3JlZW5CdG5PZmZzZXRMZWZ0KS5oZWlnaHQoZnVsbFNjcmVlbkJ0bkhlaWdodCkuY3NzKHt0b3A6IGZ1bGxTY3JlZW5CdG5PZmZzZXRUb3B9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFmdGVyIHRoZSBmdWxsc2NyZWVuIGJ1dHRvbgogICAgICAgICAgICAgICAgICAgICAgICBob3ZlckRpdnMucmlnaHQud2lkdGgoY29udGFpbmVyV2lkdGggLSBmdWxsU2NyZWVuQnRuT2Zmc2V0TGVmdCAtIGZ1bGxTY3JlZW5CdG5XaWR0aCkuaGVpZ2h0KGZ1bGxTY3JlZW5CdG5IZWlnaHQpLmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3A6IGZ1bGxTY3JlZW5CdG5PZmZzZXRUb3AsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0OiBmdWxsU2NyZWVuQnRuT2Zmc2V0TGVmdCArIGZ1bGxTY3JlZW5CdG5XaWR0aAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHVuZGVyIHRoZSBmdWxsc2NyZWVuIGJ1dHRvbgogICAgICAgICAgICAgICAgICAgICAgICBob3ZlckRpdnMuYm90dG9tLndpZHRoKGNvbnRhaW5lcldpZHRoKS5oZWlnaHQoY29udGFpbmVySGVpZ2h0IC0gZnVsbFNjcmVlbkJ0bkhlaWdodCAtIGZ1bGxTY3JlZW5CdG5PZmZzZXRUb3ApLmNzcyh7dG9wOiBmdWxsU2NyZWVuQnRuT2Zmc2V0VG9wICsgZnVsbFNjcmVlbkJ0bkhlaWdodH0pOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdC5nbG9iYWxCaW5kKCdyZXNpemUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25Ib3ZlckRpdnMoKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBob3ZlckRpdk5hbWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaG92ZXJEaXZzW2hvdmVyRGl2TmFtZXNbaV1dID0gJCgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdmdWxsc2NyZWVuLWhvdmVyIiAvPicpLmFwcGVuZFRvKHQuY29udGFpbmVyKS5tb3VzZW92ZXIocmVzdG9yZUNvbnRyb2xzKS5oaWRlKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gb24gaG92ZXIsIGtpbGwgdGhlIGZ1bGxzY3JlZW4gYnV0dG9uJ3MgSFRNTCBoYW5kbGluZywgYWxsb3dpbmcgY2xpY2tzIGRvd24gdG8gRmxhc2gKICAgICAgICAgICAgICAgIGZ1bGxzY3JlZW5CdG4ub24oJ21vdXNlb3ZlcicsIGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCF0LmlzRnVsbFNjcmVlbikgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvblBvcyA9IGZ1bGxzY3JlZW5CdG4ub2Zmc2V0KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJQb3MgPSBwbGF5ZXIuY29udGFpbmVyLm9mZnNldCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbW92ZSB0aGUgYnV0dG9uIGluIEZsYXNoIGludG8gcGxhY2UKICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEucG9zaXRpb25GdWxsc2NyZWVuQnV0dG9uKGJ1dHRvblBvcy5sZWZ0IC0gY29udGFpbmVyUG9zLmxlZnQsIGJ1dHRvblBvcy50b3AgLSBjb250YWluZXJQb3MudG9wLCBmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbGxvd3MgY2xpY2sgdGhyb3VnaAogICAgICAgICAgICAgICAgICAgICAgICB0LmZ1bGxzY3JlZW5CdG4uY3NzKCdwb2ludGVyLWV2ZW50cycsICdub25lJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuY29udHJvbHMuY3NzKCdwb2ludGVyLWV2ZW50cycsICdub25lJyk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyByZXN0b3JlIGNsaWNrLXRvLXBsYXkKICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHQuY2xpY2tUb1BsYXlQYXVzZUNhbGxiYWNrKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNob3cgdGhlIGRpdnMgdGhhdCB3aWxsIHJlc3RvcmUgdGhpbmdzCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIF9pIGluIGhvdmVyRGl2cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaG92ZXJEaXZzW19pXS5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uSG92ZXJEaXZzKCk7CgogICAgICAgICAgICAgICAgICAgICAgICBmdWxsc2NyZWVuSXNEaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gcmVzdG9yZSBjb250cm9scyBhbnl0aW1lIHRoZSB1c2VyIGVudGVycyBvciBsZWF2ZXMgZnVsbHNjcmVlbgogICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcignZnVsbHNjcmVlbmNoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0LmlzRnVsbFNjcmVlbiA9ICF0LmlzRnVsbFNjcmVlbjsKICAgICAgICAgICAgICAgICAgICAvLyBkb24ndCBhbGxvdyBwbHVnaW4gY2xpY2sgdG8gcGF1c2UgdmlkZW8gLSBtZXNzZXMgd2l0aAogICAgICAgICAgICAgICAgICAgIC8vIHBsdWdpbidzIGNvbnRyb2xzCiAgICAgICAgICAgICAgICAgICAgaWYgKHQuaXNGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0LmNsaWNrVG9QbGF5UGF1c2VDYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHQuY2xpY2tUb1BsYXlQYXVzZUNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmVzdG9yZUNvbnRyb2xzKCk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyB0aGUgbW91c2VvdXQgZXZlbnQgZG9lc24ndCB3b3JrIG9uIHRoZSBmdWxsc2NyZW4gYnV0dG9uLCBiZWNhdXNlIHdlIGFscmVhZHkga2lsbGVkIHRoZSBwb2ludGVyLWV2ZW50cwogICAgICAgICAgICAgICAgLy8gc28gd2UgdXNlIHRoZSBkb2N1bWVudC5tb3VzZW1vdmUgZXZlbnQgdG8gcmVzdG9yZSBjb250cm9scyB3aGVuIHRoZSBtb3VzZSBtb3ZlcyBvdXRzaWRlIHRoZSBmdWxsc2NyZWVuIGJ1dHRvbgoKICAgICAgICAgICAgICAgIHQuZ2xvYmFsQmluZCgnbW91c2Vtb3ZlJywgZnVuY3Rpb24gKGUpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIG1vdXNlIGlzIGFueXdoZXJlIGJ1dCB0aGUgZnVsbHNjZWVuIGJ1dHRvbiwgdGhlbiByZXN0b3JlIGl0IGFsbAogICAgICAgICAgICAgICAgICAgIGlmIChmdWxsc2NyZWVuSXNEaXNhYmxlZCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZ1bGxzY3JlZW5CdG5Qb3MgPSBmdWxsc2NyZWVuQnRuLm9mZnNldCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUucGFnZVkgPCBmdWxsc2NyZWVuQnRuUG9zLnRvcCB8fCBlLnBhZ2VZID4gZnVsbHNjcmVlbkJ0blBvcy50b3AgKyBmdWxsc2NyZWVuQnRuLm91dGVySGVpZ2h0KHRydWUpIHx8IGUucGFnZVggPCBmdWxsc2NyZWVuQnRuUG9zLmxlZnQgfHwgZS5wYWdlWCA+IGZ1bGxzY3JlZW5CdG5Qb3MubGVmdCArIGZ1bGxzY3JlZW5CdG4ub3V0ZXJXaWR0aCh0cnVlKSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ1bGxzY3JlZW5CdG4uY3NzKCdwb2ludGVyLWV2ZW50cycsICcnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuY29udHJvbHMuY3NzKCdwb2ludGVyLWV2ZW50cycsICcnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdWxsc2NyZWVuSXNEaXNhYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgdC5pc1BsdWdpbkNsaWNrVGhyb3VnaENyZWF0ZWQgPSB0cnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRmVhdHVyZSBkZXN0cnVjdG9yLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBBbHdheXMgaGFzIHRvIGJlIHByZWZpeGVkIHdpdGggYGNsZWFuYCBhbmQgdGhlIG5hbWUgdGhhdCB3YXMgdXNlZCBpbiBmZWF0dXJlcyBsaXN0CiAgICAgICAgICAgICAqIEBwYXJhbSB7TWVkaWFFbGVtZW50UGxheWVyfSBwbGF5ZXIKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNsZWFuZnVsbHNjcmVlbjogZnVuY3Rpb24gY2xlYW5mdWxsc2NyZWVuKHBsYXllcikgewogICAgICAgICAgICAgICAgcGxheWVyLmV4aXRGdWxsU2NyZWVuKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGVudGVyRnVsbFNjcmVlbjogZnVuY3Rpb24gZW50ZXJGdWxsU2NyZWVuKCkgewoKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBpc05hdGl2ZSA9IHQubWVkaWEucmVuZGVyZXJOYW1lICE9PSBudWxsICYmIHQubWVkaWEucmVuZGVyZXJOYW1lLm1hdGNoKC8oaHRtbDV8bmF0aXZlKS8pICE9PSBudWxsOwoKICAgICAgICAgICAgICAgIGlmIChGZWF0dXJlcy5JU19JT1MgJiYgRmVhdHVyZXMuSEFTX0lPU19GVUxMU0NSRUVOICYmIHR5cGVvZiB0Lm1lZGlhLndlYmtpdEVudGVyRnVsbHNjcmVlbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgIHQubWVkaWEud2Via2l0RW50ZXJGdWxsc2NyZWVuKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHNldCBpdCB0byBub3Qgc2hvdyBzY3JvbGwgYmFycyBzbyAxMDAlIHdpbGwgd29yawogICAgICAgICAgICAgICAgJChfZG9jdW1lbnQyLmRlZmF1bHQuZG9jdW1lbnRFbGVtZW50KS5hZGRDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnZnVsbHNjcmVlbicpOwoKICAgICAgICAgICAgICAgIC8vIHN0b3JlIHNpemluZwogICAgICAgICAgICAgICAgdC5ub3JtYWxIZWlnaHQgPSB0LmNvbnRhaW5lci5oZWlnaHQoKTsKICAgICAgICAgICAgICAgIHQubm9ybWFsV2lkdGggPSB0LmNvbnRhaW5lci53aWR0aCgpOwoKICAgICAgICAgICAgICAgIC8vIGF0dGVtcHQgdG8gZG8gdHJ1ZSBmdWxsc2NyZWVuCiAgICAgICAgICAgICAgICBpZiAodC5mdWxsc2NyZWVuTW9kZSA9PT0gJ25hdGl2ZS1uYXRpdmUnIHx8IHQuZnVsbHNjcmVlbk1vZGUgPT09ICdwbHVnaW4tbmF0aXZlJykgewoKICAgICAgICAgICAgICAgICAgICBGZWF0dXJlcy5yZXF1ZXN0RnVsbFNjcmVlbih0LmNvbnRhaW5lclswXSk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0LmlzSW5JZnJhbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc29tZXRpbWVzIGV4aXRpbmcgZnJvbSBmdWxsc2NyZWVuIGRvZXNuJ3Qgd29yawogICAgICAgICAgICAgICAgICAgICAgICAvLyBub3RhYmx5IGluIENocm9tZSA8aWZyYW1lPi4gRml4ZWQgaW4gdmVyc2lvbiAxNwogICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uIGNoZWNrRnVsbHNjcmVlbigpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5pc05hdGl2ZUZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGVyY2VudEVycm9yTWFyZ2luID0gMC4wMDIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIDAuMiUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93V2lkdGggPSAkKF93aW5kb3cyLmRlZmF1bHQpLndpZHRoKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbldpZHRoID0gc2NyZWVuLndpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhYnNEaWZmID0gTWF0aC5hYnMoc2NyZWVuV2lkdGggLSB3aW5kb3dXaWR0aCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmdpbkVycm9yID0gc2NyZWVuV2lkdGggKiBwZXJjZW50RXJyb3JNYXJnaW47CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNoZWNrIGlmIHRoZSB2aWRlbyBpcyBzdWRkZW5seSBub3QgcmVhbGx5IGZ1bGxzY3JlZW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWJzRGlmZiA+IG1hcmdpbkVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1hbnVhbGx5IGV4aXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5leGl0RnVsbFNjcmVlbigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRlc3QgYWdhaW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChjaGVja0Z1bGxzY3JlZW4sIDUwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHQuZnVsbHNjcmVlTW9kZSA9PT0gJ2Z1bGx3aW5kb3cnKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBtb3ZlIGludG8gcG9zaXRpb24KCiAgICAgICAgICAgICAgICAvLyBtYWtlIGZ1bGwgc2l6ZQogICAgICAgICAgICAgICAgdC5jb250YWluZXIuYWRkQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NvbnRhaW5lci1mdWxsc2NyZWVuJykud2lkdGgoJzEwMCUnKS5oZWlnaHQoJzEwMCUnKTsKCiAgICAgICAgICAgICAgICAvLyBPbmx5IG5lZWRlZCBmb3Igc2FmYXJpIDUuMSBuYXRpdmUgZnVsbCBzY3JlZW4sIGNhbiBjYXVzZSBkaXNwbGF5IGlzc3VlcyBlbHNld2hlcmUKICAgICAgICAgICAgICAgIC8vIEFjdHVhbGx5LCBpdCBzZWVtcyB0byBiZSBuZWVkZWQgZm9yIElFOCwgdG9vCiAgICAgICAgICAgICAgICB0LmNvbnRhaW5lclNpemVUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdC5jb250YWluZXIuY3NzKHt3aWR0aDogJzEwMCUnLCBoZWlnaHQ6ICcxMDAlJ30pOwogICAgICAgICAgICAgICAgICAgIHQuc2V0Q29udHJvbHNTaXplKCk7CiAgICAgICAgICAgICAgICB9LCA1MDApOwoKICAgICAgICAgICAgICAgIGlmIChpc05hdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIHQuJG1lZGlhLndpZHRoKCcxMDAlJykuaGVpZ2h0KCcxMDAlJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLmZpbmQoJ2lmcmFtZSwgZW1iZWQsIG9iamVjdCwgdmlkZW8nKS53aWR0aCgnMTAwJScpLmhlaWdodCgnMTAwJScpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuc2V0RGltZW5zaW9ucyAmJiB0eXBlb2YgdC5tZWRpYS5zZXRTaXplID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5zZXRTaXplKHNjcmVlbi53aWR0aCwgc2NyZWVuLmhlaWdodCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdC5sYXllcnMuY2hpbGRyZW4oJ2RpdicpLndpZHRoKCcxMDAlJykuaGVpZ2h0KCcxMDAlJyk7CgogICAgICAgICAgICAgICAgaWYgKHQuZnVsbHNjcmVlbkJ0bikgewogICAgICAgICAgICAgICAgICAgIHQuZnVsbHNjcmVlbkJ0bi5yZW1vdmVDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnZnVsbHNjcmVlbicpLmFkZENsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd1bmZ1bGxzY3JlZW4nKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0LnNldENvbnRyb2xzU2l6ZSgpOwogICAgICAgICAgICAgICAgdC5pc0Z1bGxTY3JlZW4gPSB0cnVlOwoKICAgICAgICAgICAgICAgIHZhciB6b29tRmFjdG9yID0gTWF0aC5taW4oc2NyZWVuLndpZHRoIC8gdC53aWR0aCwgc2NyZWVuLmhlaWdodCAvIHQuaGVpZ2h0KTsKICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLXRleHQnKS5jc3MoJ2ZvbnQtc2l6ZScsIHpvb21GYWN0b3IgKiAxMDAgKyAnJScpOwogICAgICAgICAgICAgICAgdC5jb250YWluZXIuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2FwdGlvbnMtdGV4dCcpLmNzcygnbGluZS1oZWlnaHQnLCAnbm9ybWFsJyk7CiAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy1wb3NpdGlvbicpLmNzcygnYm90dG9tJywgJzQ1cHgnKTsKCiAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci50cmlnZ2VyKCdlbnRlcmVkZnVsbHNjcmVlbicpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBleGl0RnVsbFNjcmVlbjogZnVuY3Rpb24gZXhpdEZ1bGxTY3JlZW4oKSB7CgogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIGlzTmF0aXZlID0gdC5tZWRpYS5yZW5kZXJlck5hbWUgIT09IG51bGwgJiYgdC5tZWRpYS5yZW5kZXJlck5hbWUubWF0Y2goLyhuYXRpdmV8aHRtbDUpLykgIT09IG51bGw7CgogICAgICAgICAgICAgICAgLy8gUHJldmVudCBjb250YWluZXIgZnJvbSBhdHRlbXB0aW5nIHRvIHN0cmV0Y2ggYSBzZWNvbmQgdGltZQogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHQuY29udGFpbmVyU2l6ZVRpbWVvdXQpOwoKICAgICAgICAgICAgICAgIC8vIGNvbWUgb3V0IG9mIG5hdGl2ZSBmdWxsc2NyZWVuCiAgICAgICAgICAgICAgICBpZiAoRmVhdHVyZXMuSEFTX1RSVUVfTkFUSVZFX0ZVTExTQ1JFRU4gJiYgKEZlYXR1cmVzLklTX0ZVTExTQ1JFRU4gfHwgdC5pc0Z1bGxTY3JlZW4pKSB7CiAgICAgICAgICAgICAgICAgICAgRmVhdHVyZXMuY2FuY2VsRnVsbFNjcmVlbigpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHJlc3RvcmUgc2Nyb2xsIGJhcnMgdG8gZG9jdW1lbnQKICAgICAgICAgICAgICAgICQoX2RvY3VtZW50Mi5kZWZhdWx0LmRvY3VtZW50RWxlbWVudCkucmVtb3ZlQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2Z1bGxzY3JlZW4nKTsKCiAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci5yZW1vdmVDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY29udGFpbmVyLWZ1bGxzY3JlZW4nKTsKCiAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLnNldERpbWVuc2lvbnMpIHsKICAgICAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci53aWR0aCh0Lm5vcm1hbFdpZHRoKS5oZWlnaHQodC5ub3JtYWxIZWlnaHQpOwogICAgICAgICAgICAgICAgICAgIGlmIChpc05hdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0LiRtZWRpYS53aWR0aCh0Lm5vcm1hbFdpZHRoKS5oZWlnaHQodC5ub3JtYWxIZWlnaHQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLmZpbmQoJ2lmcmFtZSwgZW1iZWQsIG9iamVjdCwgdmlkZW8nKS53aWR0aCh0Lm5vcm1hbFdpZHRoKS5oZWlnaHQodC5ub3JtYWxIZWlnaHQpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0Lm1lZGlhLnNldFNpemUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5zZXRTaXplKHQubm9ybWFsV2lkdGgsIHQubm9ybWFsSGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHQubGF5ZXJzLmNoaWxkcmVuKCdkaXYnKS53aWR0aCh0Lm5vcm1hbFdpZHRoKS5oZWlnaHQodC5ub3JtYWxIZWlnaHQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHQuZnVsbHNjcmVlbkJ0bi5yZW1vdmVDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndW5mdWxsc2NyZWVuJykuYWRkQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2Z1bGxzY3JlZW4nKTsKCiAgICAgICAgICAgICAgICB0LnNldENvbnRyb2xzU2l6ZSgpOwogICAgICAgICAgICAgICAgdC5pc0Z1bGxTY3JlZW4gPSBmYWxzZTsKCiAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy10ZXh0JykuY3NzKCdmb250LXNpemUnLCAnJyk7CiAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy10ZXh0JykuY3NzKCdsaW5lLWhlaWdodCcsICcnKTsKICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLXBvc2l0aW9uJykuY3NzKCdib3R0b20nLCAnJyk7CgogICAgICAgICAgICAgICAgdC5jb250YWluZXIudHJpZ2dlcignZXhpdGVkZnVsbHNjcmVlbicpOwogICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy5zaG93SW5zaWdodHMpIHsKCiAgICAgICAgICAgICAgICAgICAgJCgnLnV4Y19fdGltZS1yYWlsJykuYWRkQ2xhc3MoJ21pbmknKTsKICAgICAgICAgICAgICAgICAgICAkKCcucHJvZ3Jlc3NfYmFyX3RpbWUnKS5jc3Moeyd3aWR0aCc6IChOdW1iZXIoJCgnLnV4Y19fdGltZS1yYWlsJykuYXR0cignc3R5bGUnKS5zcGxpdCgnOiAnKVsxXS5zcGxpdCgncHg7JylbMF0pICsgJ3B4Jyl9KTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHByb2dyZXNzX2Jhcl9lbCA9ICQoJy5wcm9ncmVzc19iYXJfdGltZScpLndpZHRoKCkgPiAwID8gJCgnLnByb2dyZXNzX2Jhcl90aW1lJykud2lkdGgoKSA6IDE7CiAgICAgICAgICAgICAgICAgICAgdmFyIHRpbWVBbGwgPSB0Lm9wdGlvbnMuZW5kSW5zaWdodCAtIHQub3B0aW9ucy5zdGFydEluc2lnaHQ7CiAgICAgICAgICAgICAgICAgICAgdmFyIHdpZHRoT25lU2VjID0gcHJvZ3Jlc3NfYmFyX2VsIC8gdGltZUFsbDsKICAgICAgICAgICAgICAgICAgICBpZiAodC5tZWRpYS5jdXJyZW50VGltZSA+IHQub3B0aW9ucy5lbmRJbnNpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEuc2V0Q3VycmVudFRpbWUodC5vcHRpb25zLnN0YXJ0SW5zaWdodCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0Lm1lZGlhLmN1cnJlbnRUaW1lIDwgdC5vcHRpb25zLnN0YXJ0SW5zaWdodCkgewogICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5zZXRDdXJyZW50VGltZSh0Lm9wdGlvbnMuc3RhcnRJbnNpZ2h0KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICQoJy5sb2FkcHJvZ3Jlc3MnKS5jc3Moeyd3aWR0aCc6ICh0Lm1lZGlhLmN1cnJlbnRUaW1lIC0gdC5vcHRpb25zLnN0YXJ0SW5zaWdodCkgKiB3aWR0aE9uZVNlY30pCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICB9LCB7IjE2IjogMTYsICIyIjogMiwgIjI3IjogMjcsICIzIjogMywgIjQiOiA0LCAiNiI6IDZ9XSwKICAgIDk6IFtmdW5jdGlvbiAoX2RlcmVxXywgbW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgCgogICAgICAgIHZhciBfcGxheWVyID0gX2RlcmVxXygxNik7CgogICAgICAgIHZhciBfcGxheWVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3BsYXllcik7CgogICAgICAgIHZhciBfaTE4biA9IF9kZXJlcV8oNCk7CgogICAgICAgIHZhciBfaTE4bjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9pMThuKTsKCiAgICAgICAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHtkZWZhdWx0OiBvYmp9OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogUGxheS9QYXVzZSBidXR0b24KICAgICAgICAgKgogICAgICAgICAqIFRoaXMgZmVhdHVyZSBlbmFibGVzIHRoZSBkaXNwbGF5aW5nIG9mIGEgUGxheSBidXR0b24gaW4gdGhlIGNvbnRyb2wgYmFyLCBhbmQgYWxzbyBjb250YWlucyBsb2dpYyB0byB0b2dnbGUgaXRzIHN0YXRlCiAgICAgICAgICogYmV0d2VlbiBwYXVzZWQgYW5kIHBsYXlpbmcuCiAgICAgICAgICovCgovLyBGZWF0dXJlIGNvbmZpZ3VyYXRpb24KICAgICAgICBPYmplY3QuYXNzaWduKF9wbGF5ZXIuY29uZmlnLCB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcGxheVRleHQ6ICcnLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHBhdXNlVGV4dDogJycKICAgICAgICB9KTsKCiAgICAgICAgT2JqZWN0LmFzc2lnbihfcGxheWVyMi5kZWZhdWx0LnByb3RvdHlwZSwgewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRmVhdHVyZSBjb25zdHJ1Y3Rvci4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQWx3YXlzIGhhcyB0byBiZSBwcmVmaXhlZCB3aXRoIGBidWlsZGAgYW5kIHRoZSBuYW1lIHRoYXQgd2lsbCBiZSB1c2VkIGluIE1lcERlZmF1bHRzLmZlYXR1cmVzIGxpc3QKICAgICAgICAgICAgICogQHBhcmFtIHtNZWRpYUVsZW1lbnRQbGF5ZXJ9IHBsYXllcgogICAgICAgICAgICAgKiBAcGFyYW0geyR9IGNvbnRyb2xzCiAgICAgICAgICAgICAqIEBwYXJhbSB7JH0gbGF5ZXJzCiAgICAgICAgICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IG1lZGlhCiAgICAgICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGJ1aWxkcGxheXBhdXNlOiBmdW5jdGlvbiBidWlsZHBsYXlwYXVzZShwbGF5ZXIsIGNvbnRyb2xzLCBsYXllcnMsIG1lZGlhKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgb3AgPSB0Lm9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgcGxheVRpdGxlID0gb3AucGxheVRleHQgPyBvcC5wbGF5VGV4dCA6IF9pMThuMi5kZWZhdWx0LnQoJ21lanMucGxheScpLAogICAgICAgICAgICAgICAgICAgIHBhdXNlVGl0bGUgPSBvcC5wYXVzZVRleHQgPyBvcC5wYXVzZVRleHQgOiBfaTE4bjIuZGVmYXVsdC50KCdtZWpzLnBhdXNlJyksCiAgICAgICAgICAgICAgICAgICAgcGxheSA9ICQoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnYnV0dG9uICcgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAncGxheXBhdXNlLWJ1dHRvbiAnICsgKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdwbGF5Ij4nKSArICgnPGJ1dHRvbiB0eXBlPSJidXR0b24iIGRhdGEtdG9nZ2xlPSJwbGF5ZXItdG9vbHRpcCIgYXJpYS1jb250cm9scz0iJyArIHQuaWQgKyAnIiB0aXRsZT0iJyArIHBsYXlUaXRsZSArICciIGFyaWEtbGFiZWw9IicgKyBwYXVzZVRpdGxlICsgJyI+PC9idXR0b24+JykgKyAnPC9kaXY+JykuYXBwZW5kVG8oY29udHJvbHMpLmNsaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lZGlhLnBhdXNlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEucGxheSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgIHBsYXlfYnRuID0gcGxheS5maW5kKCdidXR0b24nKTsKCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gd2hpY2ggLSB0b2tlbiB0byBkZXRlcm1pbmUgbmV3IHN0YXRlIG9mIGJ1dHRvbgogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiB0b2dnbGVQbGF5UGF1c2Uod2hpY2gpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoJ3BsYXknID09PSB3aGljaCkgewogICAgICAgICAgICAgICAgICAgICAgICBwbGF5LnJlbW92ZUNsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdwbGF5JykucmVtb3ZlQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3JlcGxheScpLmFkZENsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdwYXVzZScpOwogICAgICAgICAgICAgICAgICAgICAgICBwbGF5X2J0bi5hdHRyKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICd0aXRsZSc6IHBhdXNlVGl0bGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXJpYS1sYWJlbCc6IHBhdXNlVGl0bGUKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxheS5yZW1vdmVDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAncGF1c2UnKS5yZW1vdmVDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAncmVwbGF5JykuYWRkQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3BsYXknKTsKICAgICAgICAgICAgICAgICAgICAgICAgcGxheV9idG4uYXR0cih7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndGl0bGUnOiBwbGF5VGl0bGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXJpYS1sYWJlbCc6IHBsYXlUaXRsZQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdG9nZ2xlUGxheVBhdXNlKCdwc2UnKTsKCiAgICAgICAgICAgICAgICBtZWRpYS5hZGRFdmVudExpc3RlbmVyKCdwbGF5JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVBsYXlQYXVzZSgncGxheScpOwogICAgICAgICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcigncGxheWluZycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0b2dnbGVQbGF5UGF1c2UoJ3BsYXknKTsKICAgICAgICAgICAgICAgIH0sIGZhbHNlKTsKCiAgICAgICAgICAgICAgICBtZWRpYS5hZGRFdmVudExpc3RlbmVyKCdwYXVzZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0b2dnbGVQbGF5UGF1c2UoJ3BzZScpOwogICAgICAgICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcigncGF1c2VkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHRvZ2dsZVBsYXlQYXVzZSgncHNlJyk7CiAgICAgICAgICAgICAgICB9LCBmYWxzZSk7CgogICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcignZW5kZWQnLCBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICAgICAgICAgIGlmICghcGxheWVyLm9wdGlvbnMubG9vcCkgewogICAgICAgICAgICAgICAgICAgICAgICBwbGF5LnJlbW92ZUNsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdwYXVzZScpLnJlbW92ZUNsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdwbGF5JykuYWRkQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3JlcGxheScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIE9iamVjdC5hc3NpZ24oX3BsYXllcjIuZGVmYXVsdC5wcm90b3R5cGUsIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEZlYXR1cmUgY29uc3RydWN0b3IuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEFsd2F5cyBoYXMgdG8gYmUgcHJlZml4ZWQgd2l0aCBgYnVpbGRgIGFuZCB0aGUgbmFtZSB0aGF0IHdpbGwgYmUgdXNlZCBpbiBNZXBEZWZhdWx0cy5mZWF0dXJlcyBsaXN0CiAgICAgICAgICAgICAqIEBwYXJhbSB7TWVkaWFFbGVtZW50UGxheWVyfSBwbGF5ZXIKICAgICAgICAgICAgICogQHBhcmFtIHskfSBjb250cm9scwogICAgICAgICAgICAgKiBAcGFyYW0geyR9IGxheWVycwogICAgICAgICAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBtZWRpYQogICAgICAgICAgICAgKiBAcHVibGljCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBidWlsZHRpbWVybmV4dDogZnVuY3Rpb24gYnVpbGR0aW1lcm5leHQocGxheWVyLCBjb250cm9scywgbGF5ZXJzLCBtZWRpYSkgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIG9wID0gdC5vcHRpb25zLAogICAgICAgICAgICAgICAgICAgIHRpbWVybmV4dFRpdGxlID0gX2kxOG4yLmRlZmF1bHQudCgnbWVqcy5wbGF5JyksCiAgICAgICAgICAgICAgICAgICAgdGltZXJuZXh0X2J1dHRvbiA9ICc8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgYXJpYS1jb250cm9scz0iJyArIHQuaWQgKyAnIiBkYXRhLXRvZ2dsZT0icGxheWVyLXRvb2x0aXAiIHRpdGxlPSInK3Qub3B0aW9ucy5UcmFuc2xhdGlvbi50cmFuc2xhdGUoJ1ZETy5WRE8xMDMnKSsnIj48L2J1dHRvbj4nLAogICAgICAgICAgICAgICAgICAgIHRpbWVybmV4dCA9ICQoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnYnV0dG9uICcgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZXJuZXh0LWJ1dHRvbiI+PC9kaXY+Jyk7CiAgICAgICAgICAgICAgICB0aW1lcm5leHQuYXBwZW5kVG8oY29udHJvbHMpLmNsaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBtZWRpYS5zZXRDdXJyZW50VGltZShtZWRpYS5nZXRDdXJyZW50VGltZSgpIC0gMTUpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRpbWVybmV4dC5odG1sKHRpbWVybmV4dF9idXR0b24pOwogICAgICAgICAgICB9LAogICAgICAgICAgICBidWlsZHRpbWVycHJldjogZnVuY3Rpb24gYnVpbGR0aW1lcm5leHQocGxheWVyLCBjb250cm9scywgbGF5ZXJzLCBtZWRpYSkgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIG9wID0gdC5vcHRpb25zLAogICAgICAgICAgICAgICAgICAgIHRpbWVybmV4dFRpdGxlID0gX2kxOG4yLmRlZmF1bHQudCgnbWVqcy5wbGF5JyksCiAgICAgICAgICAgICAgICAgICAgdGltZXJuZXh0X2J1dHRvbiA9ICc8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgYXJpYS1jb250cm9scz0iJyArIHQuaWQgKyAnIiBkYXRhLXRvZ2dsZT0icGxheWVyLXRvb2x0aXAiIHRpdGxlPSInK3Qub3B0aW9ucy5UcmFuc2xhdGlvbi50cmFuc2xhdGUoJ1ZETy5WRE8xMDQnKSsnIj48L2J1dHRvbj4nLAogICAgICAgICAgICAgICAgICAgIHRpbWVybmV4dCA9ICQoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnYnV0dG9uICcgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZXJwcmV2LWJ1dHRvbiI+PC9kaXY+Jyk7CiAgICAgICAgICAgICAgICB0aW1lcm5leHQuYXBwZW5kVG8oY29udHJvbHMpLmNsaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBtZWRpYS5zZXRDdXJyZW50VGltZShtZWRpYS5nZXRDdXJyZW50VGltZSgpICsgMTUpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHRpbWVybmV4dC5odG1sKHRpbWVybmV4dF9idXR0b24pOwogICAgICAgICAgICB9CgogICAgICAgIH0pOwoKICAgICAgICBPYmplY3QuYXNzaWduKF9wbGF5ZXIyLmRlZmF1bHQucHJvdG90eXBlLCB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBGZWF0dXJlIGNvbnN0cnVjdG9yLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBBbHdheXMgaGFzIHRvIGJlIHByZWZpeGVkIHdpdGggYGJ1aWxkYCBhbmQgdGhlIG5hbWUgdGhhdCB3aWxsIGJlIHVzZWQgaW4gTWVwRGVmYXVsdHMuZmVhdHVyZXMgbGlzdAogICAgICAgICAgICAgKiBAcGFyYW0ge01lZGlhRWxlbWVudFBsYXllcn0gcGxheWVyCiAgICAgICAgICAgICAqIEBwYXJhbSB7JH0gY29udHJvbHMKICAgICAgICAgICAgICogQHBhcmFtIHskfSBsYXllcnMKICAgICAgICAgICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gbWVkaWEKICAgICAgICAgICAgICogQHB1YmxpYwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgYnVpbGRhZGRub3RlOiBmdW5jdGlvbiBidWlsZHRpbWVybmV4dChwbGF5ZXIsIGNvbnRyb2xzLCBsYXllcnMsIG1lZGlhKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgb3AgPSB0Lm9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgdGltZXJuZXh0VGl0bGUgPSBfaTE4bjIuZGVmYXVsdC50KCdtZWpzLnBsYXknKSwKICAgICAgICAgICAgICAgICAgICB0aW1lcm5leHRfYnV0dG9uID0gJzxidXR0b24gdHlwZT0iYnV0dG9uIiBhcmlhLWNvbnRyb2xzPSInICsgdC5pZCArICciIGRhdGEtdG9nZ2xlPSJwbGF5ZXItdG9vbHRpcCIgdGl0bGU9IicrdC5vcHRpb25zLlRyYW5zbGF0aW9uLnRyYW5zbGF0ZSgnVkRPLlZETzEwNScpKyciPjwvYnV0dG9uPicsCiAgICAgICAgICAgICAgICAgICAgdGltZXJuZXh0ID0gJCgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdidXR0b24gJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdhZGRub3RlLWJ1dHRvbiI+PC9kaXY+Jyk7CiAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLnNob3dBZGROb3RlcykgewogICAgICAgICAgICAgICAgICAgIHRpbWVybmV4dC5hcHBlbmRUbyhjb250cm9scykuY2xpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVOb3RlKHBsYXllci5nZXRDdXJyZW50VGltZSgpKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB0aW1lcm5leHQuaHRtbCh0aW1lcm5leHRfYnV0dG9uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgYnVpbGRhZGRpbnNpZ2h0OiBmdW5jdGlvbiBidWlsZGluc2lnaHRuZXh0KHBsYXllciwgY29udHJvbHMsIGxheWVycywgbWVkaWEpIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBvcCA9IHQub3B0aW9ucywKICAgICAgICAgICAgICAgICAgICB0aW1lcm5leHRUaXRsZSA9IF9pMThuMi5kZWZhdWx0LnQoJ21lanMucGxheScpLAogICAgICAgICAgICAgICAgICAgIHRpbWVybmV4dF9idXR0b24gPSAnPGJ1dHRvbiB0eXBlPSJidXR0b24iIGFyaWEtY29udHJvbHM9IicgKyB0LmlkICsgJyIgZGF0YS10b2dnbGU9InBsYXllci10b29sdGlwIiB0aXRsZT0iJyt0Lm9wdGlvbnMuVHJhbnNsYXRpb24udHJhbnNsYXRlKCdWRE8uVkRPMTA2JykrJyI+PC9idXR0b24+JywKICAgICAgICAgICAgICAgICAgICB0aW1lcm5leHQgPSAkKCc8ZGl2IGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2J1dHRvbiAnICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2FkZGluc2lnaHQtYnV0dG9uIj48L2Rpdj4nKTsKICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuc2hvd0luc2lnaHRDb250cm9scykgewogICAgICAgICAgICAgICAgICAgIHRpbWVybmV4dC5hcHBlbmRUbyhjb250cm9scykuY2xpY2soZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gbWVkaWEuY3VycmVudFRpbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RvcCA9IG1lZGlhLmN1cnJlbnRUaW1lKzIwOwogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3A+bWVkaWEuZHVyYXRpb24pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcCA9IG1lZGlhLmR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0b3Atc3RhcnQ+Mil7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYS5zaG93SW5zaWdodExpbmUobWVkaWEsdCxudWxsLG51bGwsc3RhcnQsc3RvcCx0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB0aW1lcm5leHQuaHRtbCh0aW1lcm5leHRfYnV0dG9uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgYnVpbGRzaG93bG9nbzogZnVuY3Rpb24gYnVpbGRzaG93bG9nbyhwbGF5ZXIsIGNvbnRyb2xzLCBsYXllcnMsIG1lZGlhKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgb3AgPSB0Lm9wdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgdGltZXJuZXh0VGl0bGUgPSBfaTE4bjIuZGVmYXVsdC50KCdtZWpzLnBsYXknKSwKICAgICAgICAgICAgICAgICAgICB0aW1lcm5leHQgID0gJCgnPGEgIHRhcmdldD0iX2JsYW5rIiBkYXRhLXRvZ2dsZT0icGxheWVyLXRvb2x0aXAiIGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2J1dHRvbiAnICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2xvZ28tYnV0dG9uIiBhcmlhLWNvbnRyb2xzPSInICsgdC5pZCArICciIHRpdGxlPSInK3Qub3B0aW9ucy5UcmFuc2xhdGlvbi50cmFuc2xhdGUoJ1ZETy5WRE8xMDcnKSsnIiAgaHJlZj0iJyt0Lm9wdGlvbnMuaHJlZisnIj48L2E+JyksCiAgICAgICAgICAgICAgICAgICAgdGltZXJuZXh0X2J1dHRvbiA9ICc8ZGl2PjwvZGl2Pic7CiAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5wYXVzZSgpCiAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLnNob3dMb2dvKSB7CiAgICAgICAgICAgICAgICAgICAgdGltZXJuZXh0LmFwcGVuZFRvKGNvbnRyb2xzKS5jbGljayhmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB0aW1lcm5leHQuaHRtbCh0aW1lcm5leHRfYnV0dG9uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfSwgeyIxNiI6IDE2LCAiNCI6IDR9XSwKICAgIDEwOiBbZnVuY3Rpb24gKF9kZXJlcV8sIG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgIAoKICAgICAgICB2YXIgX3BsYXllciA9IF9kZXJlcV8oMTYpOwoKICAgICAgICB2YXIgX3BsYXllcjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9wbGF5ZXIpOwoKICAgICAgICB2YXIgX2kxOG4gPSBfZGVyZXFfKDQpOwoKICAgICAgICB2YXIgX2kxOG4yID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfaTE4bik7CgogICAgICAgIHZhciBfY29uc3RhbnRzID0gX2RlcmVxXygyNyk7CgogICAgICAgIHZhciBfdGltZSA9IF9kZXJlcV8oMzIpOwoKICAgICAgICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDoge2RlZmF1bHQ6IG9ian07CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBQcm9ncmVzcy9sb2FkZWQgYmFyCiAgICAgICAgICoKICAgICAgICAgKiBUaGlzIGZlYXR1cmUgY3JlYXRlcyBhIHByb2dyZXNzIGJhciB3aXRoIGEgc2xpZGVyIGluIHRoZSBjb250cm9sIGJhciwgYW5kIHVwZGF0ZXMgaXQgYmFzZWQgb24gbmF0aXZlIGV2ZW50cy4KICAgICAgICAgKi8KCi8vIEZlYXR1cmUgY29uZmlndXJhdGlvbgogICAgICAgIE9iamVjdC5hc3NpZ24oX3BsYXllci5jb25maWcsIHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEVuYWJsZSB0b29sdGlwIHRoYXQgc2hvd3MgdGltZSBpbiBwcm9ncmVzcyBiYXIKICAgICAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBlbmFibGVQcm9ncmVzc1Rvb2x0aXA6IHRydWUKICAgICAgICB9KTsKICAgICAgICBPYmplY3QuYXNzaWduKF9wbGF5ZXIyLmRlZmF1bHQucHJvdG90eXBlLCB7CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRmVhdHVyZSBjb25zdHJ1Y3Rvci4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQWx3YXlzIGhhcyB0byBiZSBwcmVmaXhlZCB3aXRoIGBidWlsZGAgYW5kIHRoZSBuYW1lIHRoYXQgd2lsbCBiZSB1c2VkIGluIE1lcERlZmF1bHRzLmZlYXR1cmVzIGxpc3QKICAgICAgICAgICAgICogQHBhcmFtIHtNZWRpYUVsZW1lbnRQbGF5ZXJ9IHBsYXllcgogICAgICAgICAgICAgKiBAcGFyYW0geyR9IGNvbnRyb2xzCiAgICAgICAgICAgICAqIEBwYXJhbSB7JH0gbGF5ZXJzCiAgICAgICAgICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IG1lZGlhCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBidWlsZHByb2dyZXNzOiBmdW5jdGlvbiBidWlsZHByb2dyZXNzKHBsYXllciwgY29udHJvbHMsIGxheWVycywgbWVkaWEpIHsKCiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgbW91c2VJc0Rvd24gPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBtb3VzZUlzT3ZlciA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGxhc3RLZXlQcmVzc1RpbWUgPSAwLAogICAgICAgICAgICAgICAgICAgIHN0YXJ0ZWRQYXVzZWQgPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBhdXRvUmV3aW5kSW5pdGlhbCA9IHBsYXllci5vcHRpb25zLmF1dG9SZXdpbmQsCiAgICAgICAgICAgICAgICAgICAgdG9vbHRpcCA9IHBsYXllci5vcHRpb25zLmVuYWJsZVByb2dyZXNzVG9vbHRpcCA/ICc8c3BhbiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd0aW1lLWZsb2F0Ij4nICsgKCc8c3BhbiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd0aW1lLWZsb2F0LWN1cnJlbnQiPjwvc3Bhbj4nKSArICgnPHNwYW4gY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1mbG9hdC1jb3JuZXIiPjwvc3Bhbj4nKSArICc8L3NwYW4+JyA6ICIiOwoKICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuc2hvd0luc2lnaHRzKSB7CiAgICAgICAgICAgICAgICAgICAgJCgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd0aW1lLXJhaWwgbWluaSI+JyArICgnPHNwYW4gY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS10b3RhbCAnICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3RpbWUtc2xpZGVyIj4nKSArICgnPHNwYW4gY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1idWZmZXJpbmciPjwvc3Bhbj4nKSArICgnPHNwYW4gY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1sb2FkZWQiPjwvc3Bhbj4nKSArICgnPHNwYW4gY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1jdXJyZW50Ij48L3NwYW4+JykgKyAoJzxzcGFuIGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3RpbWUtaGFuZGxlIj48L3NwYW4+JykgKyAoJycgKyB0b29sdGlwKSArICc8L3NwYW4+JyArICc8L2Rpdj4nKS5hcHBlbmRUbyhjb250cm9scyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICQoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1yYWlsIj4nICsgKCc8c3BhbiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd0aW1lLXRvdGFsICcgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1zbGlkZXIiPicpICsgKCc8c3BhbiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd0aW1lLWJ1ZmZlcmluZyI+PC9zcGFuPicpICsgKCc8c3BhbiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd0aW1lLWxvYWRlZCI+PC9zcGFuPicpICsgKCc8c3BhbiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd0aW1lLWN1cnJlbnQiPjwvc3Bhbj4nKSArICgnPHNwYW4gY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1oYW5kbGUiPjwvc3Bhbj4nKSArICgnJyArIHRvb2x0aXApICsgJzwvc3Bhbj4nICsgJzwvZGl2PicpLmFwcGVuZFRvKGNvbnRyb2xzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnRyb2xzLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3RpbWUtYnVmZmVyaW5nJykuaGlkZSgpOwoKICAgICAgICAgICAgICAgIHQucmFpbCA9IGNvbnRyb2xzLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3RpbWUtcmFpbCcpOwogICAgICAgICAgICAgICAgdC50b3RhbCA9IGNvbnRyb2xzLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3RpbWUtdG90YWwnKTsKICAgICAgICAgICAgICAgIHQubG9hZGVkID0gY29udHJvbHMuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1sb2FkZWQnKTsKICAgICAgICAgICAgICAgIHQuY3VycmVudCA9IGNvbnRyb2xzLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3RpbWUtY3VycmVudCcpOwogICAgICAgICAgICAgICAgdC5oYW5kbGUgPSBjb250cm9scy5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd0aW1lLWhhbmRsZScpOwogICAgICAgICAgICAgICAgdC50aW1lZmxvYXQgPSBjb250cm9scy5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd0aW1lLWZsb2F0Jyk7CiAgICAgICAgICAgICAgICB0LnRpbWVmbG9hdGN1cnJlbnQgPSBjb250cm9scy5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd0aW1lLWZsb2F0LWN1cnJlbnQnKTsKICAgICAgICAgICAgICAgIHQudGltZWZsb2F0Y29ybmVyID0gY29udHJvbHMuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1mbG9hdC1jb3JuZXInKTsKICAgICAgICAgICAgICAgIHQuc2xpZGVyID0gY29udHJvbHMuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1zbGlkZXInKTsKICAgICAgICAgICAgICAgIHQubmV3VGltZSA9IDA7CiAgICAgICAgICAgICAgICB0LmZvcmNlZEhhbmRsZVBhdXNlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcHJpdmF0ZQogICAgICAgICAgICAgICAgICogQHBhcmFtIHtFdmVudH0gZQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICB2YXIgaGFuZGxlTW91c2VNb3ZlID0gZnVuY3Rpb24gaGFuZGxlTW91c2VNb3ZlKGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvZmZzZXQgPSB0LnRvdGFsLm9mZnNldCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGggPSB0LnRvdGFsLndpZHRoKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZXJjZW50YWdlID0gMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcyA9IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ID0gdm9pZCAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbW91c2Ugb3IgdG91Y2ggcG9zaXRpb24gcmVsYXRpdmUgdG8gdGhlIG9iamVjdAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5vcmlnaW5hbEV2ZW50ICYmIGUub3JpZ2luYWxFdmVudC5jaGFuZ2VkVG91Y2hlcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeCA9IGUub3JpZ2luYWxFdmVudC5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWDsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlLmNoYW5nZWRUb3VjaGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmb3IgWmVwdG8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggPSBlLmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeCA9IGUucGFnZVg7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYS5kdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHggPCBvZmZzZXQubGVmdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHggPSBvZmZzZXQubGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoeCA+IHdpZHRoICsgb2Zmc2V0LmxlZnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4ID0gd2lkdGggKyBvZmZzZXQubGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3MgPSB4IC0gb2Zmc2V0LmxlZnQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGVyY2VudGFnZSA9IHBvcyAvIHdpZHRoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5uZXdUaW1lID0gcGVyY2VudGFnZSA8PSAwLjAyID8gMCA6IHBlcmNlbnRhZ2UgKiBtZWRpYS5kdXJhdGlvbjsKCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmFrZSBzZWVrIHRvIHdoZXJlIHRoZSBtb3VzZSBpcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vdXNlSXNEb3duICYmIHQubmV3VGltZS50b0ZpeGVkKDQpICE9PSBtZWRpYS5jdXJyZW50VGltZS50b0ZpeGVkKDQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5zZXRDdXJyZW50UmFpbEhhbmRsZSh0Lm5ld1RpbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQudXBkYXRlQ3VycmVudCh0Lm5ld1RpbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBvc2l0aW9uIGZsb2F0aW5nIHRpbWUgYm94CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2lmICghX2NvbnN0YW50cy5IQVNfVE9VQ0gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQudGltZWZsb2F0LmNzcygnbGVmdCcsIHBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLnNob3dIZWxwZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRleHRodG1sID0gcmVuZGVySGVscGVyKHBvcywgdC5uZXdUaW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGV4dGh0bWwgJiYgdGV4dGh0bWwubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnRpbWVmbG9hdGN1cnJlbnQuaHRtbCh0ZXh0aHRtbFswXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQudGltZWZsb2F0Y29ybmVyLmh0bWwoJyMnICsgKE51bWJlcih0ZXh0aHRtbFsxXSkgKyAxKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0ZXh0aHRtbFswXSAhPSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC50aW1lZmxvYXQuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogVXBkYXRlIGVsZW1lbnRzIGluIHByb2dyZXNzIGJhciBmb3IgYWNjZXNzaWJpbGl0eSBwdXJwb3NlcyBvbmx5IHdoZW4gcGxheWVyIGlzIHBhdXNlZC4KICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAqIFRoaXMgaXMgdG8gYXZvaWQgYXR0ZW1wdHMgdG8gcmVwZWF0IHRoZSB0aW1lIG92ZXIgYW5kIG92ZXIgYWdhaW4gd2hlbiBtZWRpYSBpcyBwbGF5aW5nLgogICAgICAgICAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlU2xpZGVyID0gZnVuY3Rpb24gdXBkYXRlU2xpZGVyKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNlY29uZHMgPSBtZWRpYS5jdXJyZW50VGltZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVTbGlkZXJUZXh0ID0gX2kxOG4yLmRlZmF1bHQudCgnbWVqcy50aW1lLXNsaWRlcicpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZSA9ICgwLCBfdGltZS5zZWNvbmRzVG9UaW1lQ29kZSkoc2Vjb25kcywgcGxheWVyLm9wdGlvbnMuYWx3YXlzU2hvd0hvdXJzKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uID0gbWVkaWEuZHVyYXRpb247CgogICAgICAgICAgICAgICAgICAgICAgICB0LnNsaWRlci5hdHRyKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdyb2xlJzogJ3NsaWRlcicsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndGFiaW5kZXgnOiAwCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVkaWEucGF1c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnNsaWRlci5hdHRyKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXJpYS1sYWJlbCc6IHRpbWVTbGlkZXJUZXh0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhcmlhLXZhbHVlbWluJzogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXJpYS12YWx1ZW1heCc6IGR1cmF0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhcmlhLXZhbHVlbm93Jzogc2Vjb25kcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXJpYS12YWx1ZXRleHQnOiB0aW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuc2xpZGVyLnJlbW92ZUF0dHIoJ2FyaWEtbGFiZWwgYXJpYS12YWx1ZW1pbiBhcmlhLXZhbHVlbWF4IGFyaWEtdmFsdWVub3cgYXJpYS12YWx1ZXRleHQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICByZXN0YXJ0UGxheWVyID0gZnVuY3Rpb24gcmVzdGFydFBsYXllcigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vdyA9IG5ldyBEYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub3cgLSBsYXN0S2V5UHJlc3NUaW1lID49IDEwMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnBsYXkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlTW91c2V1cCA9IGZ1bmN0aW9uIGhhbmRsZU1vdXNldXAoKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5mb3JjZWRIYW5kbGVQYXVzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vdXNlSXNEb3duICYmIHQubmV3VGltZS50b0ZpeGVkKDQpICE9PSBtZWRpYS5jdXJyZW50VGltZS50b0ZpeGVkKDQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYS5zZXRDdXJyZW50VGltZSh0Lm5ld1RpbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLnNldEN1cnJlbnRSYWlsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnVwZGF0ZUN1cnJlbnQodC5uZXdUaW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0LmZvcmNlZEhhbmRsZVBhdXNlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBFdmVudHMKICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuc2hvd0luc2lnaHQpIHsKICAgICAgICAgICAgICAgICAgICB0LnNsaWRlci5vbignZm9jdXMnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8qICBjb25zb2xlLmxvZygnZm9jdXMnKTsKICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5vcHRpb25zLmF1dG9SZXdpbmQgPSBmYWxzZTsqLwogICAgICAgICAgICAgICAgICAgIH0pLm9uKCdibHVyJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAvKiBjb25zb2xlLmxvZygnYmx1cicpOwogICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLm9wdGlvbnMuYXV0b1Jld2luZCA9IGF1dG9SZXdpbmRJbml0aWFsOyovCiAgICAgICAgICAgICAgICAgICAgfSkub24oJ2tleWRvd24nLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvKiBjb25zb2xlLmxvZygna2V5ZG93bicpOwogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ldyBEYXRlKCkgLSBsYXN0S2V5UHJlc3NUaW1lID49IDEwMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ZWRQYXVzZWQgPSBtZWRpYS5wYXVzZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLmtleUFjdGlvbnMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICB2YXIga2V5Q29kZSA9IGUud2hpY2ggfHwgZS5rZXlDb2RlIHx8IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbiA9IG1lZGlhLmR1cmF0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICAgc2Vla1RpbWUgPSBtZWRpYS5jdXJyZW50VGltZSwKICAgICAgICAgICAgICAgICAgICAgICAgIHNlZWtGb3J3YXJkID0gcGxheWVyLm9wdGlvbnMuZGVmYXVsdFNlZWtGb3J3YXJkSW50ZXJ2YWwobWVkaWEpLAogICAgICAgICAgICAgICAgICAgICAgICAgc2Vla0JhY2t3YXJkID0gcGxheWVyLm9wdGlvbnMuZGVmYXVsdFNlZWtCYWNrd2FyZEludGVydmFsKG1lZGlhKTsKICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoa2V5Q29kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzNzogLy8gbGVmdAogICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA0MDoKICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvd24KICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYS5kdXJhdGlvbiAhPT0gSW5maW5pdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHNlZWtUaW1lIC09IHNlZWtCYWNrd2FyZDsKICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzOTogLy8gUmlnaHQKICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzg6CiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBVcAogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lZGlhLmR1cmF0aW9uICE9PSBJbmZpbml0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgc2Vla1RpbWUgKz0gc2Vla0ZvcndhcmQ7CiAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzY6CiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBIb21lCiAgICAgICAgICAgICAgICAgICAgICAgICBzZWVrVGltZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzU6CiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBlbmQKICAgICAgICAgICAgICAgICAgICAgICAgIHNlZWtUaW1lID0gZHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzI6CiAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzcGFjZQogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFfY29uc3RhbnRzLklTX0ZJUkVGT1gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYS5wYXVzZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnBsYXkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYS5wYXVzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxMzoKICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVudGVyCiAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVkaWEucGF1c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYS5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgc2Vla1RpbWUgPSBzZWVrVGltZSA8IDAgPyAwIDogc2Vla1RpbWUgPj0gZHVyYXRpb24gPyBkdXJhdGlvbiA6IE1hdGguZmxvb3Ioc2Vla1RpbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEtleVByZXNzVGltZSA9IG5ldyBEYXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXN0YXJ0ZWRQYXVzZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnBhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlZWtUaW1lIDwgbWVkaWEuZHVyYXRpb24gJiYgIXN0YXJ0ZWRQYXVzZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQocmVzdGFydFBsYXllciwgMTEwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEuc2V0Q3VycmVudFRpbWUoc2Vla1RpbWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICB9Ki8KICAgICAgICAgICAgICAgICAgICB9KS5vbignY2xpY2snLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvKiAgY29uc29sZS5sb2coJ2NsaWNrJywgbWVkaWEuZHVyYXRpb24pOwogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lZGlhLmR1cmF0aW9uICE9PSBJbmZpbml0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhdXNlZCA9IG1lZGlhLnBhdXNlZDsKICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnBhdXNlKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgLy8gaGFuZGxlTW91c2VNb3ZlKGUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyovCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdC5vcHRpb25zLmlzX2FjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHQub3B0aW9ucy5pc19kcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIC8vIGhhbmRsZSBjbGlja3MKICAgICAgICAgICAgICAgICAgICB0LnJhaWwub24oJ21vdXNlZG93biB0b3VjaHN0YXJ0JywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQoZS5jdXJyZW50VGFyZ2V0KS5maW5kKCcucmlnaHRfcGFuZWwnKS5sZW5ndGg9PTAgfHwgIXQub3B0aW9ucy5pc19hY3RpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQub3B0aW9ucy5zdGF0dXNNb3VzZVVwID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcG9zID0gJCh0aGlzKS5vZmZzZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vINC/0L7Qu9C+0LbQtdC90LjQtSDQutGD0YDRgdC+0YDQsCDQstC90YPRgtGA0Lgg0Y3Qu9C10LzQtdC90YLQsAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIFhpbm5lciA9IGUucGFnZVggLSBwb3MubGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBZaW5uZXIgPSBlLnBhZ2VZIC0gcG9zLnRvcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQub3B0aW9ucy5tb3VzZWRvd25YWSA9IFtYaW5uZXIsIFlpbm5lcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm9wdGlvbnMubW91c2Vkb3duYnRuWFkgPSBbZS5wYWdlWCwgZS5wYWdlWV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmZvcmNlZEhhbmRsZVBhdXNlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVkaWEuZHVyYXRpb24gIT09IEluZmluaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gb25seSBoYW5kbGUgbGVmdCBjbGlja3Mgb3IgdG91Y2gKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS53aGljaCA9PT0gMSB8fCBlLndoaWNoID09PSAwKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3VzZUlzRG93biA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuc2hvd0luc2lnaHRDb250cm9scykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm9wdGlvbnMuaXNfZHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2RvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJteVAiKS5zdHlsZS5jdXJzb3IgPSAiZS1yZXNpemUiOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlcigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm9wdGlvbnMuaXNfZHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS51bmJpbmQoICJtb3VzZXVwIiApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiLnV4Y19fdGltZS10b3RhbCIpLmNzcygnY3Vyc29yJywgJ3BvaW50ZXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIi51eGNfX2NvbnRhaW5lciIpLmNzcygnY3Vyc29yJywgJ3BvaW50ZXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoIi51eGNfX3RpbWUtbG9hZGVkIikuY3NzKCdjdXJzb3InLCAncG9pbnRlcicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCAibW91c2V1cCIsIGhhbmRsZXIgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlTW91c2VNb3ZlKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQub3B0aW9ucy5pc19hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5vcHRpb25zLnN0YXR1c01vdXNlVXAgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSkub24oJ21vdXNlbW92ZScsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLmlzX2RyYWdnaW5nKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwb3MgPSAkKHRoaXMpLm9mZnNldCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiLnV4Y19fdGltZS10b3RhbCIpLmNzcygnY3Vyc29yJywgJ2UtcmVzaXplJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCIudXhjX19jb250YWluZXIiKS5jc3MoJ2N1cnNvcicsICdlLXJlc2l6ZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgiLnV4Y19fdGltZS1sb2FkZWQiKS5jc3MoJ2N1cnNvcicsICdlLXJlc2l6ZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8g0L/QvtC70L7QttC10L3QuNC1INC60YPRgNGB0L7RgNCwINCy0L3Rg9GC0YDQuCDRjdC70LXQvNC10L3RgtCwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgWGlubmVyID0gZS5wYWdlWCAtIHBvcy5sZWZ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIFlpbm5lciA9IGUucGFnZVkgLSBwb3MudG9wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy5tb3VzZWRvd25YWVswXSA9PSBYaW5uZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEuc2hvd0luc2lnaHRMaW5lKG1lZGlhLHQsWGlubmVyLFlpbm5lcixudWxsLG51bGwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pLm9uKCdtb3VzZXVwIHRvdWNoZW5kJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5vcHRpb25zLmlzX2FjdGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLmlzX2RyYWdnaW5nKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQub3B0aW9ucy5pc19kcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZU1vdXNlTW92ZShlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlTW91c2V1cCgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJChlLmN1cnJlbnRUYXJnZXQpLmZpbmQoJy5yaWdodF9wYW5lbCcpLmxlbmd0aD09MCAmJiAhdC5vcHRpb25zLnN0YXR1c01vdXNlVXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQub3B0aW9ucy5zdGF0dXNNb3VzZVVwID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcG9zID0gJCh0aGlzKS5vZmZzZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vINC/0L7Qu9C+0LbQtdC90LjQtSDQutGD0YDRgdC+0YDQsCDQstC90YPRgtGA0Lgg0Y3Qu9C10LzQtdC90YLQsAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIFhpbm5lciA9IGUucGFnZVggLSBwb3MubGVmdDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBZaW5uZXIgPSBlLnBhZ2VZIC0gcG9zLnRvcDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMubW91c2Vkb3duWFlbMF0gPT0gWGlubmVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lZGlhLmR1cmF0aW9uICE9PSBJbmZpbml0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3VzZUlzRG93biA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuZ2xvYmFsVW5iaW5kKCdtb3VzZW1vdmUuZHVyIHRvdWNobW92ZS5kdXIgbW91c2V1cC5kdXIgdG91Y2hlbmQuZHVyJyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhdXNlZCA9IG1lZGlhLnBhdXNlZDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXBhdXNlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEuc2hvd0luc2lnaHRMaW5lKG1lZGlhLHQsWGlubmVyLFlpbm5lcixudWxsLG51bGwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLyogaWYgKG1lZGlhLmR1cmF0aW9uICE9PSBJbmZpbml0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdXNlSXNPdmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lmdsb2JhbEJpbmQoJ21vdXNlbW92ZS5kdXInLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZU1vdXNlTW92ZShlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLnNob3dIZWxwZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQudGltZWZsb2F0ICE9PSB1bmRlZmluZWQgJiYgIV9jb25zdGFudHMuSEFTX1RPVUNIKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdC50aW1lZmxvYXQuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSovCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm9wdGlvbnMuc3RhdHVzTW91c2VVcCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KS5vbignbW91c2VlbnRlcicsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8qY29uc29sZS5sb2coJ21vdXNlZW50ZXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYS5kdXJhdGlvbiAhPT0gSW5maW5pdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIG1vdXNlSXNPdmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgIHQuZ2xvYmFsQmluZCgnbW91c2Vtb3ZlLmR1cicsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVNb3VzZU1vdmUoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuc2hvd0hlbHBlcnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0LnRpbWVmbG9hdCAhPT0gdW5kZWZpbmVkICYmICFfY29uc3RhbnRzLkhBU19UT1VDSCkgewogICAgICAgICAgICAgICAgICAgICAgICAgLy8gdC50aW1lZmxvYXQuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgfSovCiAgICAgICAgICAgICAgICAgICAgfSkub24oJ21vdXNlbGVhdmUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8qY29uc29sZS5sb2coJ21vdXNlbGVhdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYS5kdXJhdGlvbiAhPT0gSW5maW5pdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIG1vdXNlSXNPdmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW1vdXNlSXNEb3duKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICB0Lmdsb2JhbFVuYmluZCgnbW91c2Vtb3ZlLmR1cicpOwogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQudGltZWZsb2F0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIHQudGltZWZsb2F0LmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgIH0qLwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0LnNsaWRlci5vbignZm9jdXMnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5vcHRpb25zLmF1dG9SZXdpbmQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9KS5vbignYmx1cicsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLm9wdGlvbnMuYXV0b1Jld2luZCA9IGF1dG9SZXdpbmRJbml0aWFsOwogICAgICAgICAgICAgICAgICAgIH0pLm9uKCdrZXlkb3duJywgZnVuY3Rpb24gKGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXcgRGF0ZSgpIC0gbGFzdEtleVByZXNzVGltZSA+PSAxMDAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydGVkUGF1c2VkID0gbWVkaWEucGF1c2VkOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLmtleUFjdGlvbnMubGVuZ3RoKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGtleUNvZGUgPSBlLndoaWNoIHx8IGUua2V5Q29kZSB8fCAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uID0gbWVkaWEuZHVyYXRpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vla1RpbWUgPSBtZWRpYS5jdXJyZW50VGltZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWVrRm9yd2FyZCA9IHBsYXllci5vcHRpb25zLmRlZmF1bHRTZWVrRm9yd2FyZEludGVydmFsKG1lZGlhKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWVrQmFja3dhcmQgPSBwbGF5ZXIub3B0aW9ucy5kZWZhdWx0U2Vla0JhY2t3YXJkSW50ZXJ2YWwobWVkaWEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoa2V5Q29kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzc6IC8vIGxlZnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDQwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEb3duCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYS5kdXJhdGlvbiAhPT0gSW5maW5pdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZWtUaW1lIC09IHNlZWtCYWNrd2FyZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDM5OiAvLyBSaWdodAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzg6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYS5kdXJhdGlvbiAhPT0gSW5maW5pdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZWtUaW1lICs9IHNlZWtGb3J3YXJkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhvbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vla1RpbWUgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDM1OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBlbmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vla1RpbWUgPSBkdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzMjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3BhY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0Lm9wdGlvbnMuc2hvd01vZGFsSW5zaWdodCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFfY29uc3RhbnRzLklTX0ZJUkVGT1gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVkaWEucGF1c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnBsYXkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYS5wYXVzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxMzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZW50ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lZGlhLnBhdXNlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEucGxheSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlZWtUaW1lID0gc2Vla1RpbWUgPCAwID8gMCA6IHNlZWtUaW1lID49IGR1cmF0aW9uID8gZHVyYXRpb24gOiBNYXRoLmZsb29yKHNlZWtUaW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RLZXlQcmVzc1RpbWUgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdGFydGVkUGF1c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2Vla1RpbWUgPCBtZWRpYS5kdXJhdGlvbiAmJiAhc3RhcnRlZFBhdXNlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQocmVzdGFydFBsYXllciwgMTEwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEuc2V0Q3VycmVudFRpbWUoc2Vla1RpbWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KS5vbignY2xpY2snLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lZGlhLmR1cmF0aW9uICE9PSBJbmZpbml0eSkgewogICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhdXNlZCA9IG1lZGlhLnBhdXNlZDsKCiAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXBhdXNlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVNb3VzZU1vdmUoZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwYXVzZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnBsYXkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOyovCiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIGhhbmRsZSBjbGlja3MKICAgICAgICAgICAgICAgICAgICB0LnJhaWwub24oJ21vdXNlZG93biB0b3VjaHN0YXJ0JywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5mb3JjZWRIYW5kbGVQYXVzZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVkaWEuZHVyYXRpb24gIT09IEluZmluaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBvbmx5IGhhbmRsZSBsZWZ0IGNsaWNrcyBvciB0b3VjaAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUud2hpY2ggPT09IDEgfHwgZS53aGljaCA9PT0gMCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW1lZGlhLnBhdXNlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhLnBhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuZm9yY2VkSGFuZGxlUGF1c2UgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW91c2VJc0Rvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdC5vcHRpb25zLmlzX2FjdGl2ZSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZU1vdXNlTW92ZShlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5nbG9iYWxCaW5kKCdtb3VzZW1vdmUuZHVyIHRvdWNobW92ZS5kdXInLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVNb3VzZU1vdmUoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5nbG9iYWxCaW5kKCdtb3VzZXVwLmR1ciB0b3VjaGVuZC5kdXInLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZU1vdXNldXAoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW91c2VJc0Rvd24gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQudGltZWZsb2F0ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQudGltZWZsb2F0LmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lmdsb2JhbFVuYmluZCgnbW91c2Vtb3ZlLmR1ciB0b3VjaG1vdmUuZHVyIG1vdXNldXAuZHVyIHRvdWNoZW5kLmR1cicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSkub24oJ21vdXNlZW50ZXInLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVkaWEuZHVyYXRpb24gIT09IEluZmluaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb3VzZUlzT3ZlciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lmdsb2JhbEJpbmQoJ21vdXNlbW92ZS5kdXInLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZU1vdXNlTW92ZShlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy5zaG93SGVscGVycykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0LnRpbWVmbG9hdCAhPT0gdW5kZWZpbmVkICYmICFfY29uc3RhbnRzLkhBU19UT1VDSCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0LnRpbWVmbG9hdC5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSkub24oJ21vdXNlbGVhdmUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYS5kdXJhdGlvbiAhPT0gSW5maW5pdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vdXNlSXNPdmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW1vdXNlSXNEb3duKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5nbG9iYWxVbmJpbmQoJ21vdXNlbW92ZS5kdXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC50aW1lZmxvYXQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnRpbWVmbG9hdC5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gbG9hZGluZwogICAgICAgICAgICAgICAgLy8gSWYgbWVkaWEgaXMgZG9lcyBub3QgaGF2ZSBhIGZpbml0ZSBkdXJhdGlvbiwgcmVtb3ZlIHByb2dyZXNzIGJhciBpbnRlcmFjdGlvbgogICAgICAgICAgICAgICAgLy8gYW5kIGluZGljYXRlIHRoYXQgaXMgYSBsaXZlIGJyb2FkY2FzdAogICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcigncHJvZ3Jlc3MnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYS5kdXJhdGlvbiAhPT0gSW5maW5pdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLnNldFByb2dyZXNzUmFpbChlKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0LmZvcmNlZEhhbmRsZVBhdXNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuc2V0Q3VycmVudFJhaWwoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFjb250cm9scy5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdicm9hZGNhc3QnKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbHMuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1yYWlsJykuZW1wdHkoKS5odG1sKCc8c3BhbiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdicm9hZGNhc3QiPicgKyBtZWpzLmkxOG4udCgnbWVqcy5saXZlLWJyb2FkY2FzdCcpICsgJzwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCBmYWxzZSk7CgogICAgICAgICAgICAgICAgLy8gY3VycmVudCB0aW1lCiAgICAgICAgICAgICAgICBtZWRpYS5hZGRFdmVudExpc3RlbmVyKCd0aW1ldXBkYXRlJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWVkaWEuZHVyYXRpb24gIT09IEluZmluaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5zZXRQcm9ncmVzc1JhaWwoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdC5mb3JjZWRIYW5kbGVQYXVzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLnNldEN1cnJlbnRSYWlsKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZVNsaWRlcihlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFjb250cm9scy5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdicm9hZGNhc3QnKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbHMuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1yYWlsJykuZW1wdHkoKS5odG1sKCc8c3BhbiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdicm9hZGNhc3QiPicgKyBtZWpzLmkxOG4udCgnbWVqcy5saXZlLWJyb2FkY2FzdCcpICsgJzwvc3Bhbj4nKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCBmYWxzZSk7CgogICAgICAgICAgICAgICAgdC5jb250YWluZXIub24oJ2NvbnRyb2xzcmVzaXplJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWVkaWEuZHVyYXRpb24gIT09IEluZmluaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5zZXRQcm9ncmVzc1JhaWwoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdC5mb3JjZWRIYW5kbGVQYXVzZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLnNldEN1cnJlbnRSYWlsKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQ2FsY3VsYXRlIHRoZSBwcm9ncmVzcyBvbiB0aGUgbWVkaWEgYW5kIHVwZGF0ZSBwcm9ncmVzcyBiYXIncyB3aWR0aAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge0V2ZW50fSBlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBzZXRQcm9ncmVzc1JhaWw6IGZ1bmN0aW9uIHNldFByb2dyZXNzUmFpbChlKSB7CgogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIHRhcmdldCA9IGUgIT09IHVuZGVmaW5lZCA/IGUudGFyZ2V0IDogdC5tZWRpYSwKICAgICAgICAgICAgICAgICAgICBwZXJjZW50ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBuZXdlc3QgSFRNTDUgc3BlYyBoYXMgYnVmZmVyZWQgYXJyYXkgKEZGNCwgV2Via2l0KQogICAgICAgICAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQuYnVmZmVyZWQgJiYgdGFyZ2V0LmJ1ZmZlcmVkLmxlbmd0aCA+IDAgJiYgdGFyZ2V0LmJ1ZmZlcmVkLmVuZCAmJiB0YXJnZXQuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAvLyBhY2NvdW50IGZvciBhIHJlYWwgYXJyYXkgd2l0aCBtdWx0aXBsZSB2YWx1ZXMgLSBhbHdheXMgcmVhZCB0aGUgZW5kIG9mIHRoZSBsYXN0IGJ1ZmZlcgogICAgICAgICAgICAgICAgICAgIHBlcmNlbnQgPSB0YXJnZXQuYnVmZmVyZWQuZW5kKHRhcmdldC5idWZmZXJlZC5sZW5ndGggLSAxKSAvIHRhcmdldC5kdXJhdGlvbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFNvbWUgYnJvd3NlcnMgKGUuZy4sIEZGMy42IGFuZCBTYWZhcmkgNSkgY2Fubm90IGNhbGN1bGF0ZSB0YXJnZXQuYnVmZmVyZXJlZC5lbmQoKQogICAgICAgICAgICAgICAgLy8gdG8gYmUgYW55dGhpbmcgb3RoZXIgdGhhbiAwLiBJZiB0aGUgYnl0ZSBjb3VudCBpcyBhdmFpbGFibGUgd2UgdXNlIHRoaXMgaW5zdGVhZC4KICAgICAgICAgICAgICAgIC8vIEJyb3dzZXJzIHRoYXQgc3VwcG9ydCB0aGUgZWxzZSBpZiBkbyBub3Qgc2VlbSB0byBoYXZlIHRoZSBidWZmZXJlZEJ5dGVzIHZhbHVlIGFuZAogICAgICAgICAgICAgICAgLy8gc2hvdWxkIHNraXAgdG8gdGhlcmUuIFRlc3RlZCBpbiBTYWZhcmkgNSwgV2Via2l0IGhlYWQsIEZGMy42LCBDaHJvbWUgNiwgSUUgNy84LgogICAgICAgICAgICAgICAgZWxzZSBpZiAodGFyZ2V0ICYmIHRhcmdldC5ieXRlc1RvdGFsICE9PSB1bmRlZmluZWQgJiYgdGFyZ2V0LmJ5dGVzVG90YWwgPiAwICYmIHRhcmdldC5idWZmZXJlZEJ5dGVzICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBwZXJjZW50ID0gdGFyZ2V0LmJ1ZmZlcmVkQnl0ZXMgLyB0YXJnZXQuYnl0ZXNUb3RhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIEZpcmVmb3ggMyB3aXRoIGFuIE9nZyBmaWxlIHNlZW1zIHRvIGdvIHRoaXMgd2F5CiAgICAgICAgICAgICAgICBlbHNlIGlmIChlICYmIGUubGVuZ3RoQ29tcHV0YWJsZSAmJiBlLnRvdGFsICE9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcGVyY2VudCA9IGUubG9hZGVkIC8gZS50b3RhbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBmaW5hbGx5IHVwZGF0ZSB0aGUgcHJvZ3Jlc3MgYmFyCiAgICAgICAgICAgICAgICBpZiAocGVyY2VudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHBlcmNlbnQgPSBNYXRoLm1pbigxLCBNYXRoLm1heCgwLCBwZXJjZW50KSk7CiAgICAgICAgICAgICAgICAgICAgLy8gdXBkYXRlIGxvYWRlZCBiYXIKICAgICAgICAgICAgICAgICAgICBpZiAodC5sb2FkZWQgJiYgdC50b3RhbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0LmxvYWRlZC53aWR0aChwZXJjZW50ICogMTAwICsgJyUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBVcGRhdGUgdGhlIHNsaWRlcidzIHdpZHRoIGRlcGVuZGluZyBvbiB0aGUgdGltZSBhc3NpZ25lZAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge051bWJlcn0gZmFrZVRpbWUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHNldEN1cnJlbnRSYWlsSGFuZGxlOiBmdW5jdGlvbiBzZXRDdXJyZW50UmFpbEhhbmRsZShmYWtlVGltZSkgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwogICAgICAgICAgICAgICAgdC5zZXRDdXJyZW50UmFpbE1haW4odCwgZmFrZVRpbWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogVXBkYXRlIHRoZSBzbGlkZXIncyB3aWR0aCBkZXBlbmRpbmcgb24gdGhlIGN1cnJlbnQgdGltZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0Q3VycmVudFJhaWw6IGZ1bmN0aW9uIHNldEN1cnJlbnRSYWlsKCkgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwogICAgICAgICAgICAgICAgdC5zZXRDdXJyZW50UmFpbE1haW4odCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBNZXRob2QgdGhhdCBoYW5kbGVzIHRoZSBjYWxjdWxhdGlvbiBvZiB0aGUgd2lkdGggb2YgdGhlIHJhaWwuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7TWVkaWFFbGVtZW50UGxheWVyfSB0CiAgICAgICAgICAgICAqIEBwYXJhbSB7P051bWJlcn0gZmFrZVRpbWUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHNldEN1cnJlbnRSYWlsTWFpbjogZnVuY3Rpb24gc2V0Q3VycmVudFJhaWxNYWluKHQsIGZha2VUaW1lKSB7CiAgICAgICAgICAgICAgICBpZiAodC5tZWRpYS5jdXJyZW50VGltZSAhPT0gdW5kZWZpbmVkICYmIHQubWVkaWEuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICB2YXIgblRpbWUgPSB0eXBlb2YgZmFrZVRpbWUgPT09ICd1bmRlZmluZWQnID8gdC5tZWRpYS5jdXJyZW50VGltZSA6IGZha2VUaW1lOwoKICAgICAgICAgICAgICAgICAgICAvLyB1cGRhdGUgYmFyIGFuZCBoYW5kbGUKICAgICAgICAgICAgICAgICAgICBpZiAodC50b3RhbCAmJiB0LmhhbmRsZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3V2lkdGggPSBNYXRoLnJvdW5kKHQudG90YWwud2lkdGgoKSAqIG5UaW1lIC8gdC5tZWRpYS5kdXJhdGlvbiksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVQb3MgPSBuZXdXaWR0aCAtIE1hdGgucm91bmQodC5oYW5kbGUub3V0ZXJXaWR0aCh0cnVlKSAvIDIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgbmV3V2lkdGggPSBuVGltZSAvIHQubWVkaWEuZHVyYXRpb24gKiAxMDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuY3VycmVudC53aWR0aChuZXdXaWR0aCArICclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuaGFuZGxlLmNzcygnbGVmdCcsIGhhbmRsZVBvcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgfSwgeyIxNiI6IDE2LCAiMjciOiAyNywgIjMyIjogMzIsICI0IjogNH1dLAogICAgMTE6IFtmdW5jdGlvbiAoX2RlcmVxXywgbW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgCgogICAgICAgIHZhciBfcGxheWVyID0gX2RlcmVxXygxNik7CgogICAgICAgIHZhciBfcGxheWVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3BsYXllcik7CgogICAgICAgIHZhciBfdGltZSA9IF9kZXJlcV8oMzIpOwoKICAgICAgICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDoge2RlZmF1bHQ6IG9ian07CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBDdXJyZW50L2R1cmF0aW9uIHRpbWVzCiAgICAgICAgICoKICAgICAgICAgKiBUaGlzIGZlYXR1cmUgY3JlYXRlcy91cGRhdGVzIHRoZSBkdXJhdGlvbiBhbmQgcHJvZ3Jlc3MgdGltZXMgaW4gdGhlIGNvbnRyb2wgYmFyLCBiYXNlZCBvbiBuYXRpdmUgZXZlbnRzLgogICAgICAgICAqLwoKICAgICAgICBPYmplY3QuYXNzaWduKF9wbGF5ZXIyLmRlZmF1bHQucHJvdG90eXBlLCB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBGZWF0dXJlIGNvbnN0cnVjdG9yLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBBbHdheXMgaGFzIHRvIGJlIHByZWZpeGVkIHdpdGggYGJ1aWxkYCBhbmQgdGhlIG5hbWUgdGhhdCB3aWxsIGJlIHVzZWQgaW4gTWVwRGVmYXVsdHMuZmVhdHVyZXMgbGlzdAogICAgICAgICAgICAgKiBAcGFyYW0ge01lZGlhRWxlbWVudFBsYXllcn0gcGxheWVyCiAgICAgICAgICAgICAqIEBwYXJhbSB7JH0gY29udHJvbHMKICAgICAgICAgICAgICogQHBhcmFtIHskfSBsYXllcnMKICAgICAgICAgICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gbWVkaWEKICAgICAgICAgICAgICogQHB1YmxpYwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgYnVpbGRwcm9ncmVzc2luc2lnaHQ6IGZ1bmN0aW9uIGJ1aWxkdGltZXJuZXh0KHBsYXllciwgY29udHJvbHMsIGxheWVycywgbWVkaWEpIHsKICAgICAgICAgICAgICAgIHZhciBwcm9ncmVzc19iYXJfdGltZSA9ICQoJzxkaXYgY2xhc3M9InByb2dyZXNzX2Jhcl90aW1lIj48ZGl2IGNsYXNzPSJsb2FkcHJvZ3Jlc3MiPjwvZGl2PjwvZGl2PicpOwogICAgICAgICAgICAgICAgcHJvZ3Jlc3NfYmFyX3RpbWUuYXBwZW5kVG8oY29udHJvbHMpOwoKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBvcCA9IHQub3B0aW9ucywKICAgICAgICAgICAgICAgICAgICBodG1sRWwsCiAgICAgICAgICAgICAgICAgICAgdGltZUFsbCA9IHQub3B0aW9ucy5lbmRJbnNpZ2h0IC0gdC5vcHRpb25zLnN0YXJ0SW5zaWdodCwKICAgICAgICAgICAgICAgICAgICB3aWR0aE9uZVNlYywKICAgICAgICAgICAgICAgICAgICBjdXJyZW50VGltZXJFbCwKICAgICAgICAgICAgICAgICAgICBwcm9ncmVzc19iYXJfZWw7CiAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLnNob3dJbnNpZ2h0cykgewogICAgICAgICAgICAgICAgICAgIHByb2dyZXNzX2Jhcl90aW1lLmNsaWNrKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzX2Jhcl9lbCA9ICQoJy5wcm9ncmVzc19iYXJfdGltZScpLndpZHRoKCkgPiAwID8gJCgnLnByb2dyZXNzX2Jhcl90aW1lJykud2lkdGgoKSA6IDE7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoT25lU2VjID0gdGltZUFsbCAvIHByb2dyZXNzX2Jhcl9lbDsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFRpbWVyRWwgPSB0Lm9wdGlvbnMuc3RhcnRJbnNpZ2h0ICsgKHdpZHRoT25lU2VjICogZS5vZmZzZXRYKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy90Lm1lZGlhLmN1cnJlbnRUaW1lID0gY3VycmVudFRpbWVyRWw7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnNldEN1cnJlbnRUaW1lKE1hdGgucm91bmQoIGN1cnJlbnRUaW1lckVsICkpOwogICAgICAgICAgICAgICAgICAgICAgICAkKCcubG9hZHByb2dyZXNzJykuY3NzKHsnd2lkdGgnOiBlLm9mZnNldFh9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcigndGltZXVwZGF0ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3NfYmFyX2VsID0gJCgnLnByb2dyZXNzX2Jhcl90aW1lJykud2lkdGgoKSA+IDAgPyAkKCcucHJvZ3Jlc3NfYmFyX3RpbWUnKS53aWR0aCgpIDogMTsKICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGhPbmVTZWMgPSBwcm9ncmVzc19iYXJfZWwgLyB0aW1lQWxsOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5tZWRpYS5jdXJyZW50VGltZSA+IHQub3B0aW9ucy5lbmRJbnNpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhLnNldEN1cnJlbnRUaW1lKHQub3B0aW9ucy5zdGFydEluc2lnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0Lm1lZGlhLnN0b3AgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5wYXVzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm1lZGlhLmN1cnJlbnRUaW1lIDwgdC5vcHRpb25zLnN0YXJ0SW5zaWdodCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5zZXRDdXJyZW50VGltZSh0Lm9wdGlvbnMuc3RhcnRJbnNpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkKCcubG9hZHByb2dyZXNzJykuY3NzKHsnd2lkdGgnOiAodC5tZWRpYS5jdXJyZW50VGltZSAtIHQub3B0aW9ucy5zdGFydEluc2lnaHQpICogd2lkdGhPbmVTZWN9KQogICAgICAgICAgICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwoKLy8gRmVhdHVyZSBjb25maWd1cmF0aW9uCiAgICAgICAgT2JqZWN0LmFzc2lnbihfcGxheWVyLmNvbmZpZywgewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogVGhlIGluaXRpYWwgZHVyYXRpb24KICAgICAgICAgICAgICogQHR5cGUge051bWJlcn0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGR1cmF0aW9uOiAwLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHRpbWVBbmREdXJhdGlvblNlcGFyYXRvcjogJzxzcGFuPiB8IDwvc3Bhbj4nCiAgICAgICAgfSk7CgogICAgICAgIE9iamVjdC5hc3NpZ24oX3BsYXllcjIuZGVmYXVsdC5wcm90b3R5cGUsIHsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDdXJyZW50IHRpbWUgY29uc3RydWN0b3IuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEFsd2F5cyBoYXMgdG8gYmUgcHJlZml4ZWQgd2l0aCBgYnVpbGRgIGFuZCB0aGUgbmFtZSB0aGF0IHdpbGwgYmUgdXNlZCBpbiBNZXBEZWZhdWx0cy5mZWF0dXJlcyBsaXN0CiAgICAgICAgICAgICAqIEBwYXJhbSB7TWVkaWFFbGVtZW50UGxheWVyfSBwbGF5ZXIKICAgICAgICAgICAgICogQHBhcmFtIHskfSBjb250cm9scwogICAgICAgICAgICAgKiBAcGFyYW0geyR9IGxheWVycwogICAgICAgICAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBtZWRpYQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgYnVpbGRjdXJyZW50OiBmdW5jdGlvbiBidWlsZGN1cnJlbnQocGxheWVyLCBjb250cm9scywgbGF5ZXJzLCBtZWRpYSkgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwogICAgICAgICAgICAgICAgdmFyIGR1cmF0aW9uU3BhbjsKICAgICAgICAgICAgICAgIGlmIChpc05hTihtZWRpYS5kdXJhdGlvbikpewogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uU3BhbiA9ICcvJysnPHNwYW4gY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnZHVyYXRpb250aW1lIj4nICsgJzAwOjAwJyArICc8L3NwYW4+JzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb25TcGFuID0gJy8nKyc8c3BhbiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdkdXJhdGlvbnRpbWUiPicgK21lZGlhLmR1cmF0aW9uICsgJzwvc3Bhbj4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJCgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd0aW1lIiByb2xlPSJ0aW1lciIgYXJpYS1saXZlPSJvZmYiPicgKyAoJzxzcGFuIGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2N1cnJlbnR0aW1lIj4nICsgKDAsIF90aW1lLnNlY29uZHNUb1RpbWVDb2RlKSgwLCBwbGF5ZXIub3B0aW9ucy5hbHdheXNTaG93SG91cnMpICsgJzwvc3Bhbj4nICsgZHVyYXRpb25TcGFuKSArICc8L2Rpdj4nKS5hcHBlbmRUbyhjb250cm9scyk7CgogICAgICAgICAgICAgICAgdC5jdXJyZW50dGltZSA9IHQuY29udHJvbHMuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY3VycmVudHRpbWUnKTsKICAgICAgICAgICAgICAgIHQuZHVyYXRpb250aW1lID0gdC5jb250cm9scy5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdkdXJhdGlvbnRpbWUnKTsKCiAgICAgICAgICAgICAgICBtZWRpYS5hZGRFdmVudExpc3RlbmVyKCd0aW1ldXBkYXRlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci51cGRhdGVDdXJyZW50KCk7CiAgICAgICAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRHVyYXRpb24gdGltZSBjb25zdHJ1Y3Rvci4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQWx3YXlzIGhhcyB0byBiZSBwcmVmaXhlZCB3aXRoIGBidWlsZGAgYW5kIHRoZSBuYW1lIHRoYXQgd2lsbCBiZSB1c2VkIGluIE1lcERlZmF1bHRzLmZlYXR1cmVzIGxpc3QKICAgICAgICAgICAgICogQHBhcmFtIHtNZWRpYUVsZW1lbnRQbGF5ZXJ9IHBsYXllcgogICAgICAgICAgICAgKiBAcGFyYW0geyR9IGNvbnRyb2xzCiAgICAgICAgICAgICAqIEBwYXJhbSB7JH0gbGF5ZXJzCiAgICAgICAgICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IG1lZGlhCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBidWlsZGR1cmF0aW9uOiBmdW5jdGlvbiBidWlsZGR1cmF0aW9uKHBsYXllciwgY29udHJvbHMsIGxheWVycywgbWVkaWEpIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpczsKCiAgICAgICAgICAgICAgICBpZiAoY29udHJvbHMuY2hpbGRyZW4oKS5sYXN0KCkuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY3VycmVudHRpbWUnKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgJCh0Lm9wdGlvbnMudGltZUFuZER1cmF0aW9uU2VwYXJhdG9yICsgJzxzcGFuIGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2R1cmF0aW9uIj4nICsgKCgwLCBfdGltZS5zZWNvbmRzVG9UaW1lQ29kZSkodC5vcHRpb25zLmR1cmF0aW9uLCB0Lm9wdGlvbnMuYWx3YXlzU2hvd0hvdXJzKSArICc8L3NwYW4+JykpLmFwcGVuZFRvKGNvbnRyb2xzLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3RpbWUnKSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICAvLyBhZGQgY2xhc3MgdG8gY3VycmVudCB0aW1lCiAgICAgICAgICAgICAgICAgICAgY29udHJvbHMuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY3VycmVudHRpbWUnKS5wYXJlbnQoKS5hZGRDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY3VycmVudHRpbWUtY29udGFpbmVyJyk7CgogICAgICAgICAgICAgICAgICAgICQoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZSAnICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2R1cmF0aW9uLWNvbnRhaW5lciI+JyArICgnPHNwYW4gY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnZHVyYXRpb24iPicpICsgKCgwLCBfdGltZS5zZWNvbmRzVG9UaW1lQ29kZSkodC5vcHRpb25zLmR1cmF0aW9uLCB0Lm9wdGlvbnMuYWx3YXlzU2hvd0hvdXJzKSArICc8L3NwYW4+JykgKyAnPC9kaXY+JykuYXBwZW5kVG8oY29udHJvbHMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHQuZHVyYXRpb25EID0gdC5jb250cm9scy5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdkdXJhdGlvbicpOwoKICAgICAgICAgICAgICAgIG1lZGlhLmFkZEV2ZW50TGlzdGVuZXIoJ3RpbWV1cGRhdGUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQuY29udHJvbHNBcmVWaXNpYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci51cGRhdGVEdXJhdGlvbigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBVcGRhdGUgdGhlIGN1cnJlbnQgdGltZSBhbmQgb3V0cHV0IGl0IGluIGZvcm1hdCAwMDowMAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdXBkYXRlQ3VycmVudDogZnVuY3Rpb24gdXBkYXRlQ3VycmVudCgpIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpczsKCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSB0Lm1lZGlhLmN1cnJlbnRUaW1lOwogICAgICAgICAgICAgICAgdmFyIGR1cmF0aW9uVGltZSA9IHQubWVkaWEuZHVyYXRpb247CgogICAgICAgICAgICAgICAgaWYgKGlzTmFOKGN1cnJlbnRUaW1lKSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChpc05hTihkdXJhdGlvblRpbWUpKSB7CiAgICAgICAgICAgICAgICAgICBkdXJhdGlvblRpbWUgPSAwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0LmN1cnJlbnR0aW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdC5jdXJyZW50dGltZS5odG1sKCgwLCBfdGltZS5zZWNvbmRzVG9UaW1lQ29kZSkoY3VycmVudFRpbWUsIHQub3B0aW9ucy5hbHdheXNTaG93SG91cnMpKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodC5kdXJhdGlvbnRpbWUpIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy5zaG93SW5zaWdodER1cmF0aW9uKXsKICAgICAgICAgICAgICAgICAgICAgICAgdC5kdXJhdGlvbnRpbWUuaHRtbCgoMCwgX3RpbWUuc2Vjb25kc1RvVGltZUNvZGUpKHQub3B0aW9ucy5lbmRJbnNpZ2h0LCB0Lm9wdGlvbnMuYWx3YXlzU2hvd0hvdXJzKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5kdXJhdGlvbnRpbWUuaHRtbCgoMCwgX3RpbWUuc2Vjb25kc1RvVGltZUNvZGUpKGR1cmF0aW9uVGltZSwgdC5vcHRpb25zLmFsd2F5c1Nob3dIb3VycykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBVcGRhdGUgdGhlIGR1cmF0aW9uIHRpbWUgYW5kIG91dHB1dCBpdCBpbiBmb3JtYXQgMDA6MDAKICAgICAgICAgICAgICoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHVwZGF0ZUR1cmF0aW9uOiBmdW5jdGlvbiB1cGRhdGVEdXJhdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpczsKCiAgICAgICAgICAgICAgICB2YXIgZHVyYXRpb24gPSB0Lm1lZGlhLmR1cmF0aW9uOwoKICAgICAgICAgICAgICAgIGlmIChpc05hTihkdXJhdGlvbikgfHwgZHVyYXRpb24gPT09IEluZmluaXR5IHx8IGR1cmF0aW9uIDwgMCkgewogICAgICAgICAgICAgICAgICAgIHQubWVkaWEuZHVyYXRpb24gPSB0Lm9wdGlvbnMuZHVyYXRpb24gPSBkdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy5kdXJhdGlvbiA+IDApIHsKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbiA9IHQub3B0aW9ucy5kdXJhdGlvbjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvL1RvZ2dsZSB0aGUgbG9uZyB2aWRlbyBjbGFzcyBpZiB0aGUgdmlkZW8gaXMgbG9uZ2VyIHRoYW4gYW4gaG91ci4KICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLnRvZ2dsZUNsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdsb25nLXZpZGVvJywgZHVyYXRpb24gPiAzNjAwKTsKCiAgICAgICAgICAgICAgICBpZiAodC5kdXJhdGlvbkQgJiYgZHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdC5kdXJhdGlvbkQuaHRtbCgoMCwgX3RpbWUuc2Vjb25kc1RvVGltZUNvZGUpKGR1cmF0aW9uLCB0Lm9wdGlvbnMuYWx3YXlzU2hvd0hvdXJzKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICB9LCB7IjE2IjogMTYsICIzMiI6IDMyfV0sCiAgICAxMjogW2Z1bmN0aW9uIChfZGVyZXFfLCBtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAKCiAgICAgICAgdmFyIF9tZWpzID0gX2RlcmVxXyg2KTsKCiAgICAgICAgdmFyIF9tZWpzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX21lanMpOwoKICAgICAgICB2YXIgX2kxOG4gPSBfZGVyZXFfKDQpOwoKICAgICAgICB2YXIgX2kxOG4yID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfaTE4bik7CgogICAgICAgIHZhciBfcGxheWVyID0gX2RlcmVxXygxNik7CgogICAgICAgIHZhciBfcGxheWVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3BsYXllcik7CgogICAgICAgIHZhciBfdGltZSA9IF9kZXJlcV8oMzIpOwoKICAgICAgICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDoge2RlZmF1bHQ6IG9ian07CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBDbG9zZWQgQ2FwdGlvbnMgKENDKSBidXR0b24KICAgICAgICAgKgogICAgICAgICAqIFRoaXMgZmVhdHVyZSBlbmFibGVzIHRoZSBkaXNwbGF5aW5nIG9mIGEgQ0MgYnV0dG9uIGluIHRoZSBjb250cm9sIGJhciwgYW5kIGFsc28gY29udGFpbnMgdGhlIG1ldGhvZHMgdG8gc3RhcnQgbWVkaWEKICAgICAgICAgKiB3aXRoIGEgY2VydGFpbiBsYW5ndWFnZSAoaWYgYXZhaWxhYmxlKSwgdG9nZ2xlIGNhcHRpb25zLCBldGMuCiAgICAgICAgICovCgovLyBGZWF0dXJlIGNvbmZpZ3VyYXRpb24KICAgICAgICBPYmplY3QuYXNzaWduKF9wbGF5ZXIuY29uZmlnLCB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBEZWZhdWx0IGxhbmd1YWdlIHRvIHN0YXJ0IG1lZGlhIHVzaW5nIElTTyA2MzktMiBMYW5ndWFnZSBDb2RlIExpc3QgKGVuLCBlcywgaXQsIGV0Yy4pCiAgICAgICAgICAgICAqIElmIHRoZXJlIGFyZSBtdWx0aXBsZSB0cmFja3MgZm9yIG9uZSBsYW5ndWFnZSwgdGhlIGxhc3QgdHJhY2sgbm9kZSBmb3VuZCBpcyBhY3RpdmF0ZWQKICAgICAgICAgICAgICogQHNlZSBodHRwczovL3d3dy5sb2MuZ292L3N0YW5kYXJkcy9pc282MzktMi9waHAvY29kZV9saXN0LnBocAogICAgICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc3RhcnRMYW5ndWFnZTogJycsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdHJhY2tzVGV4dDogJycsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBBdm9pZCB0byBzY3JlZW4gcmVhZGVyIHNwZWFrIGNhcHRpb25zIG92ZXIgYW4gYXVkaW8gdHJhY2suCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdHJhY2tzQXJpYUxpdmU6IGZhbHNlLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUmVtb3ZlIHRoZSBbY2NdIGJ1dHRvbiB3aGVuIG5vIHRyYWNrIG5vZGVzIGFyZSBwcmVzZW50CiAgICAgICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaGlkZUNhcHRpb25zQnV0dG9uV2hlbkVtcHR5OiB0cnVlLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQ2hhbmdlIGNhcHRpb25zIHRvIHBvcC11cCBpZiB0cnVlIGFuZCBvbmx5IG9uZSB0cmFjayBub2RlIGlzIGZvdW5kCiAgICAgICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgdG9nZ2xlQ2FwdGlvbnNCdXR0b25XaGVuT25seU9uZTogZmFsc2UsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2xpZGVzU2VsZWN0b3I6ICcnCiAgICAgICAgfSk7CgogICAgICAgIE9iamVjdC5hc3NpZ24oX3BsYXllcjIuZGVmYXVsdC5wcm90b3R5cGUsIHsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGhhc0NoYXB0ZXJzOiBmYWxzZSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBGZWF0dXJlIGNvbnN0cnVjdG9yLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBBbHdheXMgaGFzIHRvIGJlIHByZWZpeGVkIHdpdGggYGJ1aWxkYCBhbmQgdGhlIG5hbWUgdGhhdCB3aWxsIGJlIHVzZWQgaW4gTWVwRGVmYXVsdHMuZmVhdHVyZXMgbGlzdAogICAgICAgICAgICAgKiBAcGFyYW0ge01lZGlhRWxlbWVudFBsYXllcn0gcGxheWVyCiAgICAgICAgICAgICAqIEBwYXJhbSB7JH0gY29udHJvbHMKICAgICAgICAgICAgICogQHBhcmFtIHskfSBsYXllcnMKICAgICAgICAgICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gbWVkaWEKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGJ1aWxkdHJhY2tzOiBmdW5jdGlvbiBidWlsZHRyYWNrcyhwbGF5ZXIsIGNvbnRyb2xzLCBsYXllcnMsIG1lZGlhKSB7CiAgICAgICAgICAgICAgICBpZiAocGxheWVyLnRyYWNrcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIGF0dHIgPSB0Lm9wdGlvbnMudHJhY2tzQXJpYUxpdmUgPyAnIHJvbGU9ImxvZyIgYXJpYS1saXZlPSJhc3NlcnRpdmUiIGFyaWEtYXRvbWljPSJmYWxzZSInIDogJycsCiAgICAgICAgICAgICAgICAgICAgdHJhY2tzVGl0bGUgPSB0Lm9wdGlvbnMudHJhY2tzVGV4dCA/IHQub3B0aW9ucy50cmFja3NUZXh0IDogX2kxOG4yLmRlZmF1bHQudCgnbWVqcy5jYXB0aW9ucy1zdWJ0aXRsZXMnKSwKICAgICAgICAgICAgICAgICAgICBpID0gdm9pZCAwLAogICAgICAgICAgICAgICAgICAgIGtpbmQgPSB2b2lkIDA7CgogICAgICAgICAgICAgICAgLy8gSWYgYnJvd3NlciB3aWxsIGRvIG5hdGl2ZSBjYXB0aW9ucywgcHJlZmVyIG1lanMgY2FwdGlvbnMsIGxvb3AgdGhyb3VnaCB0cmFja3MgYW5kIGhpZGUKICAgICAgICAgICAgICAgIGlmICh0LmRvbU5vZGUudGV4dFRyYWNrcykgewogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IHQuZG9tTm9kZS50ZXh0VHJhY2tzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuZG9tTm9kZS50ZXh0VHJhY2tzW2ldLm1vZGUgPSAnaGlkZGVuJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdC5jbGVhcnRyYWNrcyhwbGF5ZXIpOwogICAgICAgICAgICAgICAgcGxheWVyLmNoYXB0ZXJzID0gJCgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjaGFwdGVycyAnICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2xheWVyIj48L2Rpdj4nKS5wcmVwZW5kVG8obGF5ZXJzKS5oaWRlKCk7CiAgICAgICAgICAgICAgICBwbGF5ZXIuY2FwdGlvbnMgPSAkKCc8ZGl2IGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLWxheWVyICcgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnbGF5ZXIiPicgKyAoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2FwdGlvbnMtcG9zaXRpb24gJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy1wb3NpdGlvbi1ob3ZlciInICsgYXR0ciArICc+JykgKyAoJzxzcGFuIGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLXRleHQiPjwvc3Bhbj4nKSArICc8L2Rpdj4nICsgJzwvZGl2PicpLnByZXBlbmRUbyhsYXllcnMpLmhpZGUoKTsKICAgICAgICAgICAgICAgIHBsYXllci5jYXB0aW9uc1RleHQgPSBwbGF5ZXIuY2FwdGlvbnMuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2FwdGlvbnMtdGV4dCcpOwogICAgICAgICAgICAgICAgcGxheWVyLmNhcHRpb25zQnV0dG9uID0gJCgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdidXR0b24gJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy1idXR0b24iPicgKyAoJzxidXR0b24gdHlwZT0iYnV0dG9uIiBkYXRhLXRvZ2dsZT0icGxheWVyLXRvb2x0aXAiIGFyaWEtY29udHJvbHM9IicgKyB0LmlkICsgJyIgdGl0bGU9IicgKyB0cmFja3NUaXRsZSArICciIGFyaWEtbGFiZWw9IicgKyB0cmFja3NUaXRsZSArICciPjwvYnV0dG9uPicpICsgKCc8ZGl2IGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLXNlbGVjdG9yICcgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb2Zmc2NyZWVuIj4nKSArICgnPHVsIGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLXNlbGVjdG9yLWxpc3QiPicpICsgKCc8bGkgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2FwdGlvbnMtc2VsZWN0b3ItbGlzdC1pdGVtIj4nKSArICgnPGlucHV0IHR5cGU9InJhZGlvIiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy1zZWxlY3Rvci1pbnB1dCIgJykgKyAoJ25hbWU9IicgKyBwbGF5ZXIuaWQgKyAnX2NhcHRpb25zIiBpZD0iJyArIHBsYXllci5pZCArICdfY2FwdGlvbnNfbm9uZSIgJykgKyAndmFsdWU9Im5vbmUiIGNoZWNrZWQ9ImNoZWNrZWQiIC8+JyArICgnPGxhYmVsIGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLXNlbGVjdG9yLWxhYmVsICcpICsgKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy1zZWxlY3RlZCIgJykgKyAoJ2Zvcj0iJyArIHBsYXllci5pZCArICdfY2FwdGlvbnNfbm9uZSI+JyArIF9pMThuMi5kZWZhdWx0LnQoJ21lanMubm9uZScpICsgJzwvbGFiZWw+JykgKyAnPC9saT4nICsgJzwvdWw+JyArICc8L2Rpdj4nICsgJzwvZGl2PicpLmFwcGVuZFRvKGNvbnRyb2xzKTsKCiAgICAgICAgICAgICAgICB2YXIgc3VidGl0bGVDb3VudCA9IDAsCiAgICAgICAgICAgICAgICAgICAgdG90YWwgPSBwbGF5ZXIudHJhY2tzLmxlbmd0aDsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdG90YWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGtpbmQgPSBwbGF5ZXIudHJhY2tzW2ldLmtpbmQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGtpbmQgPT09ICdzdWJ0aXRsZXMnIHx8IGtpbmQgPT09ICdjYXB0aW9ucycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3VidGl0bGVDb3VudCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBpZiBvbmx5IG9uZSBsYW5ndWFnZSB0aGVuIGp1c3QgbWFrZSB0aGUgYnV0dG9uIGEgdG9nZ2xlCiAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLnRvZ2dsZUNhcHRpb25zQnV0dG9uV2hlbk9ubHlPbmUgJiYgc3VidGl0bGVDb3VudCA9PT0gMSkgewogICAgICAgICAgICAgICAgICAgIC8vIGNsaWNrCiAgICAgICAgICAgICAgICAgICAgcGxheWVyLmNhcHRpb25zQnV0dG9uLm9uKCdjbGljaycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRyYWNrSWQgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXIuc2VsZWN0ZWRUcmFjayA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tJZCA9IHBsYXllci50cmFja3NbMF0udHJhY2tJZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuc2V0VHJhY2sodHJhY2tJZCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIGhvdmVyIG9yIGtleWJvYXJkIGZvY3VzCiAgICAgICAgICAgICAgICAgICAgcGxheWVyLmNhcHRpb25zQnV0dG9uLm9uKCdtb3VzZWVudGVyIGZvY3VzaW4nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2FwdGlvbnMtc2VsZWN0b3InKS5yZW1vdmVDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb2Zmc2NyZWVuJyk7CiAgICAgICAgICAgICAgICAgICAgfSkub24oJ21vdXNlbGVhdmUgZm9jdXNvdXQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2FwdGlvbnMtc2VsZWN0b3InKS5hZGRDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb2Zmc2NyZWVuJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAvLyBoYW5kbGUgY2xpY2tzIHRvIHRoZSBsYW5ndWFnZSByYWRpbyBidXR0b25zCiAgICAgICAgICAgICAgICAgICAgICAgIC5vbignY2xpY2snLCAnaW5wdXRbdHlwZT1yYWRpb10nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB2YWx1ZSBpcyB0cmFja0lkLCBzYW1lIGFzIHRoZSBhY3R1YWwgaWQsIGFuZCB3ZSdyZSB1c2luZyBpdCBoZXJlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBiZWNhdXNlIHRoZSAibm9uZSIgY2hlY2tib3ggZG9lc24ndCBoYXZlIGEgdHJhY2tJZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG8gdXNlLCBidXQgd2Ugd2FudCB0byBrbm93IHdoZW4gIm5vbmUiIGlzIGNsaWNrZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5zZXRUcmFjayh0aGlzLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkub24oJ2NsaWNrJywgJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLXNlbGVjdG9yLWxhYmVsJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnNpYmxpbmdzKCdpbnB1dFt0eXBlPSJyYWRpbyJdJykudHJpZ2dlcignY2xpY2snKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC8vQWxsb3cgdXAvZG93biBhcnJvdyB0byBjaGFuZ2UgdGhlIHNlbGVjdGVkIHJhZGlvIHdpdGhvdXQgY2hhbmdpbmcgdGhlIHZvbHVtZS4KICAgICAgICAgICAgICAgICAgICAgICAgLm9uKCdrZXlkb3duJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICghcGxheWVyLm9wdGlvbnMuYWx3YXlzU2hvd0NvbnRyb2xzKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gbW92ZSB3aXRoIGNvbnRyb2xzCiAgICAgICAgICAgICAgICAgICAgcGxheWVyLmNvbnRhaW5lci5vbignY29udHJvbHNzaG93bicsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcHVzaCBjYXB0aW9ucyBhYm92ZSBjb250cm9scwogICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuY29udGFpbmVyLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLXBvc2l0aW9uJykuYWRkQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLXBvc2l0aW9uLWhvdmVyJyk7CiAgICAgICAgICAgICAgICAgICAgfSkub24oJ2NvbnRyb2xzaGlkZGVuJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW1lZGlhLnBhdXNlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbW92ZSBiYWNrIHRvIG5vcm1hbCBwbGFjZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLmNvbnRhaW5lci5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy1wb3NpdGlvbicpLnJlbW92ZUNsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy1wb3NpdGlvbi1ob3ZlcicpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5jb250YWluZXIuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2FwdGlvbnMtcG9zaXRpb24nKS5hZGRDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2FwdGlvbnMtcG9zaXRpb24taG92ZXInKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBwbGF5ZXIudHJhY2tUb0xvYWQgPSAtMTsKICAgICAgICAgICAgICAgIHBsYXllci5zZWxlY3RlZFRyYWNrID0gbnVsbDsKICAgICAgICAgICAgICAgIHBsYXllci5pc0xvYWRpbmdUcmFjayA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIC8vIGFkZCB0byBsaXN0CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdG90YWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGtpbmQgPSBwbGF5ZXIudHJhY2tzW2ldLmtpbmQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGtpbmQgPT09ICdzdWJ0aXRsZXMnIHx8IGtpbmQgPT09ICdjYXB0aW9ucycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLmFkZFRyYWNrQnV0dG9uKHBsYXllci50cmFja3NbaV0udHJhY2tJZCwgcGxheWVyLnRyYWNrc1tpXS5zcmNsYW5nLCBwbGF5ZXIudHJhY2tzW2ldLmxhYmVsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc3RhcnQgbG9hZGluZyB0cmFja3MKICAgICAgICAgICAgICAgIHBsYXllci5sb2FkTmV4dFRyYWNrKCk7CgogICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcigndGltZXVwZGF0ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuZGlzcGxheUNhcHRpb25zKCk7CiAgICAgICAgICAgICAgICB9LCBmYWxzZSk7CgogICAgICAgICAgICAgICAgaWYgKHBsYXllci5vcHRpb25zLnNsaWRlc1NlbGVjdG9yICE9PSAnJykgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5zbGlkZXNDb250YWluZXIgPSAkKHBsYXllci5vcHRpb25zLnNsaWRlc1NlbGVjdG9yKTsKCiAgICAgICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcigndGltZXVwZGF0ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLmRpc3BsYXlTbGlkZXMoKTsKICAgICAgICAgICAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcignbG9hZGVkbWV0YWRhdGEnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgcGxheWVyLmRpc3BsYXlDaGFwdGVycygpOwogICAgICAgICAgICAgICAgfSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgIHBsYXllci5jb250YWluZXIuaG92ZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIC8vIGNoYXB0ZXJzCiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYXllci5oYXNDaGFwdGVycykgewogICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuY2hhcHRlcnMucmVtb3ZlQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ29mZnNjcmVlbicpOwogICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuY2hhcHRlcnMuZmFkZUluKDIwMCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGYgPSAkKHRoaXMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWlnaHQoc2VsZi5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjaGFwdGVyJykub3V0ZXJIZWlnaHQoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyLmhhc0NoYXB0ZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYS5wYXVzZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5jaGFwdGVycy5mYWRlT3V0KDIwMCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ29mZnNjcmVlbicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuY2hhcHRlcnMuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgdC5jb250YWluZXIub24oJ2NvbnRyb2xzcmVzaXplJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHQuYWRqdXN0TGFuZ3VhZ2VCb3goKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIGNoZWNrIGZvciBhdXRvcGxheQogICAgICAgICAgICAgICAgaWYgKHBsYXllci5ub2RlLmdldEF0dHJpYnV0ZSgnYXV0b3BsYXknKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHBsYXllci5jaGFwdGVycy5hZGRDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb2Zmc2NyZWVuJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRmVhdHVyZSBkZXN0cnVjdG9yLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBBbHdheXMgaGFzIHRvIGJlIHByZWZpeGVkIHdpdGggYGNsZWFuYCBhbmQgdGhlIG5hbWUgdGhhdCB3YXMgdXNlZCBpbiBNZXBEZWZhdWx0cy5mZWF0dXJlcyBsaXN0CiAgICAgICAgICAgICAqIEBwYXJhbSB7TWVkaWFFbGVtZW50UGxheWVyfSBwbGF5ZXIKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNsZWFydHJhY2tzOiBmdW5jdGlvbiBjbGVhcnRyYWNrcyhwbGF5ZXIpIHsKICAgICAgICAgICAgICAgIGlmIChwbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyLmNhcHRpb25zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5jYXB0aW9ucy5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYXllci5jaGFwdGVycykgewogICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuY2hhcHRlcnMucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXIuY2FwdGlvbnNUZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5jYXB0aW9uc1RleHQucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXIuY2FwdGlvbnNCdXR0b24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLmNhcHRpb25zQnV0dG9uLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIHJlYnVpbGR0cmFja3M6IGZ1bmN0aW9uIHJlYnVpbGR0cmFja3MoKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXM7CiAgICAgICAgICAgICAgICB0LmZpbmRUcmFja3MoKTsKICAgICAgICAgICAgICAgIHQuYnVpbGR0cmFja3ModCwgdC5jb250cm9scywgdC5sYXllcnMsIHQubWVkaWEpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgZmluZFRyYWNrczogZnVuY3Rpb24gZmluZFRyYWNrcygpIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICB0cmFja3RhZ3MgPSB0LiRtZWRpYS5maW5kKCd0cmFjaycpOwoKICAgICAgICAgICAgICAgIC8vIHN0b3JlIGZvciB1c2UgYnkgcGx1Z2lucwogICAgICAgICAgICAgICAgdC50cmFja3MgPSBbXTsKICAgICAgICAgICAgICAgIHRyYWNrdGFncy5lYWNoKGZ1bmN0aW9uIChpbmRleCwgdHJhY2spIHsKCiAgICAgICAgICAgICAgICAgICAgdHJhY2sgPSAkKHRyYWNrKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHNyY2xhbmcgPSB0cmFjay5hdHRyKCdzcmNsYW5nJykgPyB0cmFjay5hdHRyKCdzcmNsYW5nJykudG9Mb3dlckNhc2UoKSA6ICcnOwogICAgICAgICAgICAgICAgICAgIHZhciB0cmFja0lkID0gdC5pZCArICdfdHJhY2tfJyArIGluZGV4ICsgJ18nICsgdHJhY2suYXR0cigna2luZCcpICsgJ18nICsgc3JjbGFuZzsKICAgICAgICAgICAgICAgICAgICB0LnRyYWNrcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2tJZDogdHJhY2tJZCwKICAgICAgICAgICAgICAgICAgICAgICAgc3JjbGFuZzogc3JjbGFuZywKICAgICAgICAgICAgICAgICAgICAgICAgc3JjOiB0cmFjay5hdHRyKCdzcmMnKSwKICAgICAgICAgICAgICAgICAgICAgICAga2luZDogdHJhY2suYXR0cigna2luZCcpLAogICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogdHJhY2suYXR0cignbGFiZWwnKSB8fCAnJywKICAgICAgICAgICAgICAgICAgICAgICAgZW50cmllczogW10sCiAgICAgICAgICAgICAgICAgICAgICAgIGlzTG9hZGVkOiBmYWxzZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRyYWNrSWQsIG9yICJub25lIiB0byBkaXNhYmxlIGNhcHRpb25zCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBzZXRUcmFjazogZnVuY3Rpb24gc2V0VHJhY2sodHJhY2tJZCkgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIGkgPSB2b2lkIDA7CgogICAgICAgICAgICAgICAgdC5jYXB0aW9uc0J1dHRvbi5maW5kKCdpbnB1dFt0eXBlPSJyYWRpbyJdJykucHJvcCgnY2hlY2tlZCcsIGZhbHNlKS5lbmQoKS5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy1zZWxlY3RlZCcpLnJlbW92ZUNsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy1zZWxlY3RlZCcpLmVuZCgpLmZpbmQoJ2lucHV0W3ZhbHVlPSInICsgdHJhY2tJZCArICciXScpLnByb3AoJ2NoZWNrZWQnLCB0cnVlKS5zaWJsaW5ncygnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2FwdGlvbnMtc2VsZWN0b3ItbGFiZWwnKS5hZGRDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2FwdGlvbnMtc2VsZWN0ZWQnKTsKCiAgICAgICAgICAgICAgICBpZiAodHJhY2tJZCA9PT0gJ25vbmUnKSB7CiAgICAgICAgICAgICAgICAgICAgdC5zZWxlY3RlZFRyYWNrID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0LmNhcHRpb25zQnV0dG9uLnJlbW92ZUNsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy1lbmFibGVkJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0LnRyYWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciB0cmFjayA9IHQudHJhY2tzW2ldOwogICAgICAgICAgICAgICAgICAgIGlmICh0cmFjay50cmFja0lkID09PSB0cmFja0lkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0LnNlbGVjdGVkVHJhY2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuY2FwdGlvbnNCdXR0b24uYWRkQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLWVuYWJsZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0LnNlbGVjdGVkVHJhY2sgPSB0cmFjazsKICAgICAgICAgICAgICAgICAgICAgICAgdC5jYXB0aW9ucy5hdHRyKCdsYW5nJywgdC5zZWxlY3RlZFRyYWNrLnNyY2xhbmcpOwogICAgICAgICAgICAgICAgICAgICAgICB0LmRpc3BsYXlDYXB0aW9ucygpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGxvYWROZXh0VHJhY2s6IGZ1bmN0aW9uIGxvYWROZXh0VHJhY2soKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXM7CgogICAgICAgICAgICAgICAgdC50cmFja1RvTG9hZCsrOwogICAgICAgICAgICAgICAgaWYgKHQudHJhY2tUb0xvYWQgPCB0LnRyYWNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICB0LmlzTG9hZGluZ1RyYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0LmxvYWRUcmFjayh0LnRyYWNrVG9Mb2FkKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gYWRkIGRvbmU/CiAgICAgICAgICAgICAgICAgICAgdC5pc0xvYWRpbmdUcmFjayA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICB0LmNoZWNrRm9yVHJhY2tzKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIGluZGV4CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBsb2FkVHJhY2s6IGZ1bmN0aW9uIGxvYWRUcmFjayhpbmRleCkgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIHRyYWNrID0gdC50cmFja3NbaW5kZXhdLAogICAgICAgICAgICAgICAgICAgIGFmdGVyID0gZnVuY3Rpb24gYWZ0ZXIoKSB7CgogICAgICAgICAgICAgICAgICAgICAgICB0cmFjay5pc0xvYWRlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICB0LmVuYWJsZVRyYWNrQnV0dG9uKHRyYWNrKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHQubG9hZE5leHRUcmFjaygpOwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaWYgKHRyYWNrICE9PSB1bmRlZmluZWQgJiYgKHRyYWNrLnNyYyAhPT0gdW5kZWZpbmVkIHx8IHRyYWNrLnNyYyAhPT0gIiIpKSB7CiAgICAgICAgICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB0cmFjay5zcmMsCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAndGV4dCcsCiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIHN1Y2Nlc3MoZCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBhcnNlIHRoZSBsb2FkZWQgZmlsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkID09PSAnc3RyaW5nJyAmJiAvPHR0XHMreG1sL2lnLmV4ZWMoZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFjay5lbnRyaWVzID0gX21lanMyLmRlZmF1bHQuVHJhY2tGb3JtYXRQYXJzZXIuZGZ4cC5wYXJzZShkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhY2suZW50cmllcyA9IF9tZWpzMi5kZWZhdWx0LlRyYWNrRm9ybWF0UGFyc2VyLndlYnZ0dC5wYXJzZShkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlcigpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFjay5raW5kID09PSAnY2hhcHRlcnMnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5hZGRFdmVudExpc3RlbmVyKCdwbGF5JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5tZWRpYS5kdXJhdGlvbiA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuZGlzcGxheUNoYXB0ZXJzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYWNrLmtpbmQgPT09ICdzbGlkZXMnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5zZXR1cFNsaWRlcyh0cmFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbiBlcnJvcigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQucmVtb3ZlVHJhY2tCdXR0b24odHJhY2sudHJhY2tJZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmxvYWROZXh0VHJhY2soKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0cmFjayAtIFRoZSBsYW5ndWFnZSBjb2RlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBlbmFibGVUcmFja0J1dHRvbjogZnVuY3Rpb24gZW5hYmxlVHJhY2tCdXR0b24odHJhY2spIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBsYW5nID0gdHJhY2suc3JjbGFuZywKICAgICAgICAgICAgICAgICAgICBsYWJlbCA9IHRyYWNrLmxhYmVsLAogICAgICAgICAgICAgICAgICAgIHRhcmdldCA9ICQoJyMnICsgdHJhY2sudHJhY2tJZCk7CgogICAgICAgICAgICAgICAgaWYgKGxhYmVsID09PSAnJykgewogICAgICAgICAgICAgICAgICAgIGxhYmVsID0gX2kxOG4yLmRlZmF1bHQudChfbWVqczIuZGVmYXVsdC5sYW5ndWFnZS5jb2Rlc1tsYW5nXSkgfHwgbGFuZzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0YXJnZXQucHJvcCgnZGlzYWJsZWQnLCBmYWxzZSkuc2libGluZ3MoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLXNlbGVjdG9yLWxhYmVsJykuaHRtbChsYWJlbCk7CgogICAgICAgICAgICAgICAgLy8gYXV0byBzZWxlY3QKICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuc3RhcnRMYW5ndWFnZSA9PT0gbGFuZykgewogICAgICAgICAgICAgICAgICAgIHRhcmdldC5wcm9wKCdjaGVja2VkJywgdHJ1ZSkudHJpZ2dlcignY2xpY2snKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0LmFkanVzdExhbmd1YWdlQm94KCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRyYWNrSWQKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHJlbW92ZVRyYWNrQnV0dG9uOiBmdW5jdGlvbiByZW1vdmVUcmFja0J1dHRvbih0cmFja0lkKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXM7CgogICAgICAgICAgICAgICAgdC5jYXB0aW9uc0J1dHRvbi5maW5kKCdpbnB1dFtpZD0nICsgdHJhY2tJZCArICddJykuY2xvc2VzdCgnbGknKS5yZW1vdmUoKTsKCiAgICAgICAgICAgICAgICB0LmFkanVzdExhbmd1YWdlQm94KCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRyYWNrSWQKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGxhbmcgLSBUaGUgbGFuZ3VhZ2UgY29kZQogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbGFiZWwKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGFkZFRyYWNrQnV0dG9uOiBmdW5jdGlvbiBhZGRUcmFja0J1dHRvbih0cmFja0lkLCBsYW5nLCBsYWJlbCkgewogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwogICAgICAgICAgICAgICAgaWYgKGxhYmVsID09PSAnJykgewogICAgICAgICAgICAgICAgICAgIGxhYmVsID0gX2kxOG4yLmRlZmF1bHQudChfbWVqczIuZGVmYXVsdC5sYW5ndWFnZS5jb2Rlc1tsYW5nXSkgfHwgbGFuZzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyB0cmFja0lkIGlzIHVzZWQgaW4gdGhlIHZhbHVlLCB0b28sIGJlY2F1c2UgdGhlICJub25lIgogICAgICAgICAgICAgICAgLy8gY2FwdGlvbiBvcHRpb24gZG9lc24ndCBoYXZlIGEgdHJhY2tJZCBidXQgd2UgbmVlZCB0byBiZSBhYmxlCiAgICAgICAgICAgICAgICAvLyB0byBzZXQgaXQsIHRvbwogICAgICAgICAgICAgICAgdC5jYXB0aW9uc0J1dHRvbi5maW5kKCd1bCcpLmFwcGVuZCgkKCc8bGkgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2FwdGlvbnMtc2VsZWN0b3ItbGlzdC1pdGVtIj4nICsgKCc8aW5wdXQgdHlwZT0icmFkaW8iIGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLXNlbGVjdG9yLWlucHV0IicpICsgKCduYW1lPSInICsgdC5pZCArICdfY2FwdGlvbnMiIGlkPSInICsgdHJhY2tJZCArICciIHZhbHVlPSInICsgdHJhY2tJZCArICciIGRpc2FibGVkPSJkaXNhYmxlZCIgLz4nKSArICgnPGxhYmVsIGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLXNlbGVjdG9yLWxhYmVsIj4nICsgbGFiZWwgKyAnIChsb2FkaW5nKTwvbGFiZWw+JykgKyAnPC9saT4nKSk7CgogICAgICAgICAgICAgICAgdC5hZGp1c3RMYW5ndWFnZUJveCgpOwoKICAgICAgICAgICAgICAgIC8vIHJlbW92ZSB0aGlzIGZyb20gdGhlIGRyb3Bkb3dubGlzdCAoaWYgaXQgZXhpc3RzKQogICAgICAgICAgICAgICAgdC5jb250YWluZXIuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2FwdGlvbnMtdHJhbnNsYXRpb25zIG9wdGlvblt2YWx1ZT0nICsgbGFuZyArICddJykucmVtb3ZlKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGFkanVzdExhbmd1YWdlQm94OiBmdW5jdGlvbiBhZGp1c3RMYW5ndWFnZUJveCgpIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpczsKICAgICAgICAgICAgICAgIC8vIGFkanVzdCB0aGUgc2l6ZSBvZiB0aGUgb3V0ZXIgYm94CiAgICAgICAgICAgICAgICB0LmNhcHRpb25zQnV0dG9uLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NhcHRpb25zLXNlbGVjdG9yJykuaGVpZ2h0KHQuY2FwdGlvbnNCdXR0b24uZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2FwdGlvbnMtc2VsZWN0b3ItbGlzdCcpLm91dGVySGVpZ2h0KHRydWUpICsgdC5jYXB0aW9uc0J1dHRvbi5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy10cmFuc2xhdGlvbnMnKS5vdXRlckhlaWdodCh0cnVlKSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNoZWNrRm9yVHJhY2tzOiBmdW5jdGlvbiBjaGVja0ZvclRyYWNrcygpIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBoYXNTdWJ0aXRsZXMgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAvLyBjaGVjayBpZiBhbnkgc3VidGl0bGVzCiAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLmhpZGVDYXB0aW9uc0J1dHRvbldoZW5FbXB0eSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCB0b3RhbCA9IHQudHJhY2tzLmxlbmd0aDsgaSA8IHRvdGFsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGtpbmQgPSB0LnRyYWNrc1tpXS5raW5kOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGtpbmQgPT09ICdzdWJ0aXRsZXMnIHx8IGtpbmQgPT09ICdjYXB0aW9ucycpICYmIHQudHJhY2tzW2ldLmlzTG9hZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNTdWJ0aXRsZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICghaGFzU3VidGl0bGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuY2FwdGlvbnNCdXR0b24uaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB0LnNldENvbnRyb2xzU2l6ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZGlzcGxheUNhcHRpb25zOiBmdW5jdGlvbiBkaXNwbGF5Q2FwdGlvbnMoKSB7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudHJhY2tzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIHRyYWNrID0gdC5zZWxlY3RlZFRyYWNrLAogICAgICAgICAgICAgICAgICAgIGkgPSB2b2lkIDA7CgogICAgICAgICAgICAgICAgaWYgKHRyYWNrICE9PSBudWxsICYmIHRyYWNrLmlzTG9hZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgaSA9IHQuc2VhcmNoVHJhY2tQb3NpdGlvbih0cmFjay5lbnRyaWVzLCB0Lm1lZGlhLmN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB0aGUgbGluZSBiZWZvcmUgdGhlIHRpbWVjb2RlIGFzIGEgY2xhc3Mgc28gdGhlIGN1ZSBjYW4gYmUgdGFyZ2V0ZWQgaWYgbmVlZGVkCiAgICAgICAgICAgICAgICAgICAgICAgIHQuY2FwdGlvbnNUZXh0Lmh0bWwodHJhY2suZW50cmllc1tpXS50ZXh0KS5hdHRyKCdjbGFzcycsIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjYXB0aW9ucy10ZXh0ICcgKyAodHJhY2suZW50cmllc1tpXS5pZGVudGlmaWVyIHx8ICcnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuY2FwdGlvbnMuc2hvdygpLmhlaWdodCgwKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOyAvLyBleGl0IG91dCBpZiBvbmUgaXMgdmlzaWJsZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHQuY2FwdGlvbnMuaGlkZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0LmNhcHRpb25zLmhpZGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSB0cmFjawogICAgICAgICAgICAgKi8KICAgICAgICAgICAgc2V0dXBTbGlkZXM6IGZ1bmN0aW9uIHNldHVwU2xpZGVzKHRyYWNrKSB7CiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXM7CgogICAgICAgICAgICAgICAgdC5zbGlkZXMgPSB0cmFjazsKICAgICAgICAgICAgICAgIHQuc2xpZGVzLmVudHJpZXMuaW1ncyA9IFt0LnNsaWRlcy5lbnRyaWVzLmxlbmd0aF07CiAgICAgICAgICAgICAgICB0LnNob3dTbGlkZSgwKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge051bWJlcn0gaW5kZXgKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHNob3dTbGlkZTogZnVuY3Rpb24gc2hvd1NsaWRlKGluZGV4KSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmFja3MgPT09IHVuZGVmaW5lZCB8fCB0aGlzLnNsaWRlc0NvbnRhaW5lciA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICB1cmwgPSB0LnNsaWRlcy5lbnRyaWVzW2luZGV4XS50ZXh0LAogICAgICAgICAgICAgICAgICAgIGltZyA9IHQuc2xpZGVzLmVudHJpZXNbaW5kZXhdLmltZ3M7CgogICAgICAgICAgICAgICAgaWYgKGltZyA9PT0gdW5kZWZpbmVkIHx8IGltZy5mYWRlSW4gPT09IHVuZGVmaW5lZCkgewoKICAgICAgICAgICAgICAgICAgICB0LnNsaWRlcy5lbnRyaWVzW2luZGV4XS5pbWdzID0gaW1nID0gJCgnPGltZyBzcmM9IicgKyB1cmwgKyAnIj4nKS5vbignbG9hZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW1nLmFwcGVuZFRvKHQuc2xpZGVzQ29udGFpbmVyKS5oaWRlKCkuZmFkZUluKCkuc2libGluZ3MoJzp2aXNpYmxlJykuZmFkZU91dCgpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFpbWcuaXMoJzp2aXNpYmxlJykgJiYgIWltZy5pcygnOmFuaW1hdGVkJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW1nLmZhZGVJbigpLnNpYmxpbmdzKCc6dmlzaWJsZScpLmZhZGVPdXQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGRpc3BsYXlTbGlkZXM6IGZ1bmN0aW9uIGRpc3BsYXlTbGlkZXMoKSB7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuc2xpZGVzID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIHNsaWRlcyA9IHQuc2xpZGVzLAogICAgICAgICAgICAgICAgICAgIGkgPSB0LnNlYXJjaFRyYWNrUG9zaXRpb24oc2xpZGVzLmVudHJpZXMsIHQubWVkaWEuY3VycmVudFRpbWUpOwoKICAgICAgICAgICAgICAgIGlmIChpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICB0LnNob3dTbGlkZShpKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47IC8vIGV4aXQgb3V0IGlmIG9uZSBpcyB2aXNpYmxlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBkaXNwbGF5Q2hhcHRlcnM6IGZ1bmN0aW9uIGRpc3BsYXlDaGFwdGVycygpIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpczsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgdG90YWwgPSB0LnRyYWNrcy5sZW5ndGg7IGkgPCB0b3RhbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQudHJhY2tzW2ldLmtpbmQgPT09ICdjaGFwdGVycycgJiYgdC50cmFja3NbaV0uaXNMb2FkZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5kcmF3Q2hhcHRlcnModC50cmFja3NbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICB0Lmhhc0NoYXB0ZXJzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBjaGFwdGVycwogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZHJhd0NoYXB0ZXJzOiBmdW5jdGlvbiBkcmF3Q2hhcHRlcnMoY2hhcHRlcnMpIHsKICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICBpID0gdm9pZCAwLAogICAgICAgICAgICAgICAgICAgIGR1ciA9IHZvaWQgMCwKICAgICAgICAgICAgICAgICAgICBwZXJjZW50ID0gMCwKICAgICAgICAgICAgICAgICAgICB1c2VkUGVyY2VudCA9IDAsCiAgICAgICAgICAgICAgICAgICAgdG90YWwgPSBjaGFwdGVycy5lbnRyaWVzLmxlbmd0aDsKCiAgICAgICAgICAgICAgICB0LmNoYXB0ZXJzLmVtcHR5KCk7CgogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRvdGFsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBkdXIgPSBjaGFwdGVycy5lbnRyaWVzW2ldLnN0b3AgLSBjaGFwdGVycy5lbnRyaWVzW2ldLnN0YXJ0OwogICAgICAgICAgICAgICAgICAgIHBlcmNlbnQgPSBNYXRoLmZsb29yKGR1ciAvIHQubWVkaWEuZHVyYXRpb24gKiAxMDApOwoKICAgICAgICAgICAgICAgICAgICAvLyB0b28gbGFyZ2Ugb3Igbm90IGdvaW5nIHRvIGZpbGwgaXQgaW4KICAgICAgICAgICAgICAgICAgICBpZiAocGVyY2VudCArIHVzZWRQZXJjZW50ID4gMTAwIHx8IGkgPT09IGNoYXB0ZXJzLmVudHJpZXMubGVuZ3RoIC0gMSAmJiBwZXJjZW50ICsgdXNlZFBlcmNlbnQgPCAxMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGVyY2VudCA9IDEwMCAtIHVzZWRQZXJjZW50OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdC5jaGFwdGVycy5hcHBlbmQoJCgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjaGFwdGVyIiByZWw9IicgKyBjaGFwdGVycy5lbnRyaWVzW2ldLnN0YXJ0ICsgJyIgc3R5bGU9ImxlZnQ6ICcgKyB1c2VkUGVyY2VudC50b1N0cmluZygpICsgJyU7IHdpZHRoOiAnICsgcGVyY2VudC50b1N0cmluZygpICsgJyU7Ij4nICsgKCc8ZGl2IGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NoYXB0ZXItYmxvY2snKSArICgoaSA9PT0gY2hhcHRlcnMuZW50cmllcy5sZW5ndGggLSAxID8gJyAnICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NoYXB0ZXItYmxvY2stbGFzdCcgOiAnJykgKyAnIj4nKSArICgnPHNwYW4gY2xhc3M9ImNoLXRpdGxlIj4nICsgY2hhcHRlcnMuZW50cmllc1tpXS50ZXh0ICsgJzwvc3Bhbj4nKSArICc8c3BhbiBjbGFzcz0iY2gtdGltZSI+JyArICgnJyArICgwLCBfdGltZS5zZWNvbmRzVG9UaW1lQ29kZSkoY2hhcHRlcnMuZW50cmllc1tpXS5zdGFydCwgdC5vcHRpb25zLmFsd2F5c1Nob3dIb3VycykpICsgJyZuZGFzaDsnICsgKCcnICsgKDAsIF90aW1lLnNlY29uZHNUb1RpbWVDb2RlKShjaGFwdGVycy5lbnRyaWVzW2ldLnN0b3AsIHQub3B0aW9ucy5hbHdheXNTaG93SG91cnMpKSArICc8L3NwYW4+JyArICc8L2Rpdj4nICsgJzwvZGl2PicpKTsKICAgICAgICAgICAgICAgICAgICB1c2VkUGVyY2VudCArPSBwZXJjZW50OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHQuY2hhcHRlcnMuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY2hhcHRlcicpLmNsaWNrKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhLnNldEN1cnJlbnRUaW1lKHBhcnNlRmxvYXQoJCh0aGlzKS5hdHRyKCdyZWwnKSkpOwogICAgICAgICAgICAgICAgICAgIGlmICh0Lm1lZGlhLnBhdXNlZCkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhLnBsYXkoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICB0LmNoYXB0ZXJzLnNob3coKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFBlcmZvcm0gYmluYXJ5IHNlYXJjaCB0byBsb29rIGZvciBwcm9wZXIgdHJhY2sgaW5kZXgKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3RbXX0gdHJhY2tzCiAgICAgICAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBjdXJyZW50VGltZQogICAgICAgICAgICAgKiBAcmV0dXJuIHtOdW1iZXJ9CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBzZWFyY2hUcmFja1Bvc2l0aW9uOiBmdW5jdGlvbiBzZWFyY2hUcmFja1Bvc2l0aW9uKHRyYWNrcywgY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgICAgIHZhciBsbyA9IDAsCiAgICAgICAgICAgICAgICAgICAgaGkgPSB0cmFja3MubGVuZ3RoIC0gMSwKICAgICAgICAgICAgICAgICAgICBtaWQgPSB2b2lkIDAsCiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB2b2lkIDAsCiAgICAgICAgICAgICAgICAgICAgc3RvcCA9IHZvaWQgMDsKCiAgICAgICAgICAgICAgICB3aGlsZSAobG8gPD0gaGkpIHsKICAgICAgICAgICAgICAgICAgICBtaWQgPSBsbyArIGhpID4+IDE7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSB0cmFja3NbbWlkXS5zdGFydDsKICAgICAgICAgICAgICAgICAgICBzdG9wID0gdHJhY2tzW21pZF0uc3RvcDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUaW1lID49IHN0YXJ0ICYmIGN1cnJlbnRUaW1lIDwgc3RvcCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWlkOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnQgPCBjdXJyZW50VGltZSkgewogICAgICAgICAgICAgICAgICAgICAgICBsbyA9IG1pZCArIDE7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydCA+IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhpID0gbWlkIC0gMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIC8qKgogICAgICAgICAqIE1hcCBhbGwgcG9zc2libGUgbGFuZ3VhZ2VzIHdpdGggdGhlaXIgcmVzcGVjdGl2ZSBjb2RlCiAgICAgICAgICoKICAgICAgICAgKiBAY29uc3RydWN0b3IKICAgICAgICAgKi8KICAgICAgICBfbWVqczIuZGVmYXVsdC5sYW5ndWFnZSA9IHsKICAgICAgICAgICAgY29kZXM6IHsKICAgICAgICAgICAgICAgIGFmOiAnbWVqcy5hZnJpa2FhbnMnLAogICAgICAgICAgICAgICAgc3E6ICdtZWpzLmFsYmFuaWFuJywKICAgICAgICAgICAgICAgIGFyOiAnbWVqcy5hcmFiaWMnLAogICAgICAgICAgICAgICAgYmU6ICdtZWpzLmJlbGFydXNpYW4nLAogICAgICAgICAgICAgICAgYmc6ICdtZWpzLmJ1bGdhcmlhbicsCiAgICAgICAgICAgICAgICBjYTogJ21lanMuY2F0YWxhbicsCiAgICAgICAgICAgICAgICB6aDogJ21lanMuY2hpbmVzZScsCiAgICAgICAgICAgICAgICAnemgtY24nOiAnbWVqcy5jaGluZXNlLXNpbXBsaWZpZWQnLAogICAgICAgICAgICAgICAgJ3poLXR3JzogJ21lanMuY2hpbmVzLXRyYWRpdGlvbmFsJywKICAgICAgICAgICAgICAgIGhyOiAnbWVqcy5jcm9hdGlhbicsCiAgICAgICAgICAgICAgICBjczogJ21lanMuY3plY2gnLAogICAgICAgICAgICAgICAgZGE6ICdtZWpzLmRhbmlzaCcsCiAgICAgICAgICAgICAgICBubDogJ21lanMuZHV0Y2gnLAogICAgICAgICAgICAgICAgZW46ICdtZWpzLmVuZ2xpc2gnLAogICAgICAgICAgICAgICAgZXQ6ICdtZWpzLmVzdG9uaWFuJywKICAgICAgICAgICAgICAgIGZsOiAnbWVqcy5maWxpcGlubycsCiAgICAgICAgICAgICAgICBmaTogJ21lanMuZmlubmlzaCcsCiAgICAgICAgICAgICAgICBmcjogJ21lanMuZnJlbmNoJywKICAgICAgICAgICAgICAgIGdsOiAnbWVqcy5nYWxpY2lhbicsCiAgICAgICAgICAgICAgICBkZTogJ21lanMuZ2VybWFuJywKICAgICAgICAgICAgICAgIGVsOiAnbWVqcy5ncmVlaycsCiAgICAgICAgICAgICAgICBodDogJ21lanMuaGFpdGlhbi1jcmVvbGUnLAogICAgICAgICAgICAgICAgaXc6ICdtZWpzLmhlYnJldycsCiAgICAgICAgICAgICAgICBoaTogJ21lanMuaGluZGknLAogICAgICAgICAgICAgICAgaHU6ICdtZWpzLmh1bmdhcmlhbicsCiAgICAgICAgICAgICAgICBpczogJ21lanMuaWNlbGFuZGljJywKICAgICAgICAgICAgICAgIGlkOiAnbWVqcy5pbmRvbmVzaWFuJywKICAgICAgICAgICAgICAgIGdhOiAnbWVqcy5pcmlzaCcsCiAgICAgICAgICAgICAgICBpdDogJ21lanMuaXRhbGlhbicsCiAgICAgICAgICAgICAgICBqYTogJ21lanMuamFwYW5lc2UnLAogICAgICAgICAgICAgICAga286ICdtZWpzLmtvcmVhbicsCiAgICAgICAgICAgICAgICBsdjogJ21lanMubGF0dmlhbicsCiAgICAgICAgICAgICAgICBsdDogJ21lanMubGl0aHVhbmlhbicsCiAgICAgICAgICAgICAgICBtazogJ21lanMubWFjZWRvbmlhbicsCiAgICAgICAgICAgICAgICBtczogJ21lanMubWFsYXknLAogICAgICAgICAgICAgICAgbXQ6ICdtZWpzLm1hbHRlc2UnLAogICAgICAgICAgICAgICAgbm86ICdtZWpzLm5vcndlZ2lhbicsCiAgICAgICAgICAgICAgICBmYTogJ21lanMucGVyc2lhbicsCiAgICAgICAgICAgICAgICBwbDogJ21lanMucG9saXNoJywKICAgICAgICAgICAgICAgIHB0OiAnbWVqcy5wb3J0dWd1ZXNlJywKICAgICAgICAgICAgICAgIHJvOiAnbWVqcy5yb21hbmlhbicsCiAgICAgICAgICAgICAgICBydTogJ21lanMucnVzc2lhbicsCiAgICAgICAgICAgICAgICBzcjogJ21lanMuc2VyYmlhbicsCiAgICAgICAgICAgICAgICBzazogJ21lanMuc2xvdmFrJywKICAgICAgICAgICAgICAgIHNsOiAnbWVqcy5zbG92ZW5pYW4nLAogICAgICAgICAgICAgICAgZXM6ICdtZWpzLnNwYW5pc2gnLAogICAgICAgICAgICAgICAgc3c6ICdtZWpzLnN3YWhpbGknLAogICAgICAgICAgICAgICAgc3Y6ICdtZWpzLnN3ZWRpc2gnLAogICAgICAgICAgICAgICAgdGw6ICdtZWpzLnRhZ2Fsb2cnLAogICAgICAgICAgICAgICAgdGg6ICdtZWpzLnRoYWknLAogICAgICAgICAgICAgICAgdHI6ICdtZWpzLnR1cmtpc2gnLAogICAgICAgICAgICAgICAgdWs6ICdtZWpzLnVrcmFpbmlhbicsCiAgICAgICAgICAgICAgICB2aTogJ21lanMudmlldG5hbWVzZScsCiAgICAgICAgICAgICAgICBjeTogJ21lanMud2Vsc2gnLAogICAgICAgICAgICAgICAgeWk6ICdtZWpzLnlpZGRpc2gnCiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKgogICAgICAgICBQYXJzZXMgV2ViVlRUIGZvcm1hdCB3aGljaCBzaG91bGQgYmUgZm9ybWF0dGVkIGFzCiAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgICAgIFdFQlZUVAoKICAgICAgICAgMQogICAgICAgICAwMDowMDowMSwxIC0tPiAwMDowMDowNSwwMDAKICAgICAgICAgQSBsaW5lIG9mIHRleHQKCiAgICAgICAgIDIKICAgICAgICAgMDA6MDE6MTUsMSAtLT4gMDA6MDI6MDUsMDAwCiAgICAgICAgIEEgc2Vjb25kIGxpbmUgb2YgdGV4dAoKICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKICAgICAgICAgQWRhcHRlZCBmcm9tOiBodHRwOi8vd3d3LmRlbHBoaWtpLmNvbS9odG1sNS9wbGF5cgogICAgICAgICAqLwogICAgICAgIF9tZWpzMi5kZWZhdWx0LlRyYWNrRm9ybWF0UGFyc2VyID0gewogICAgICAgICAgICB3ZWJ2dHQ6IHsKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgcGF0dGVybl90aW1lY29kZTogL14oKD86WzAtOV17MSwyfTopP1swLTldezJ9OlswLTldezJ9KFssLl1bMC05XXsxLDN9KT8pIC0tXD4gKCg/OlswLTldezEsMn06KT9bMC05XXsyfTpbMC05XXsyfShbLC5dWzAtOV17M30pPykoLiopJC8sCgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRyYWNrVGV4dAogICAgICAgICAgICAgICAgICogQHJldHVybnMge3t0ZXh0OiBBcnJheSwgdGltZXM6IEFycmF5fX0KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgcGFyc2U6IGZ1bmN0aW9uIHBhcnNlKHRyYWNrVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpID0gMCwKICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMgPSBfbWVqczIuZGVmYXVsdC5UcmFja0Zvcm1hdFBhcnNlci5zcGxpdDIodHJhY2tUZXh0LCAvXHI/XG4vKSwKICAgICAgICAgICAgICAgICAgICAgICAgZW50cmllcyA9IFtdLAogICAgICAgICAgICAgICAgICAgICAgICB0aW1lY29kZSA9IHZvaWQgMCwKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHZvaWQgMCwKICAgICAgICAgICAgICAgICAgICAgICAgaWRlbnRpZmllciA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVjb2RlID0gdGhpcy5wYXR0ZXJuX3RpbWVjb2RlLmV4ZWMobGluZXNbaV0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRpbWVjb2RlICYmIGkgPCBsaW5lcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpIC0gMSA+PSAwICYmIGxpbmVzW2kgLSAxXSAhPT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gbGluZXNbaSAtIDFdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZ3JhYiBhbGwgdGhlIChwb3NzaWJseSBtdWx0aS1saW5lKSB0ZXh0IHRoYXQgZm9sbG93cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9IGxpbmVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGxpbmVzW2ldICE9PSAnJyAmJiBpIDwgbGluZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHRleHQgKyAnXG4nICsgbGluZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9ICQudHJpbSh0ZXh0KS5yZXBsYWNlKC8oXGIoaHR0cHM/fGZ0cHxmaWxlKTpcL1wvWy1BLVowLTkrJkAjXC8lPz1+X3whOiwuO10qWy1BLVowLTkrJkAjXC8lPX5ffF0pL2lnLCAiPGEgaHJlZj0nJDEnIHRhcmdldD0nX2JsYW5rJz4kMTwvYT4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVudHJpZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWRlbnRpZmllcjogaWRlbnRpZmllciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogKDAsIF90aW1lLmNvbnZlcnRTTVBURXRvU2Vjb25kcykodGltZWNvZGVbMV0pID09PSAwID8gMC4yMDAgOiAoMCwgX3RpbWUuY29udmVydFNNUFRFdG9TZWNvbmRzKSh0aW1lY29kZVsxXSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RvcDogKDAsIF90aW1lLmNvbnZlcnRTTVBURXRvU2Vjb25kcykodGltZWNvZGVbM10pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IHRleHQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3M6IHRpbWVjb2RlWzVdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZGVudGlmaWVyID0gJyc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbnRyaWVzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAvLyBUaGFua3MgdG8gSnVzdGluIENhcGVsbGE6IGh0dHBzOi8vZ2l0aHViLmNvbS9qb2huZHllci9tZWRpYWVsZW1lbnQvcHVsbC80MjAKICAgICAgICAgICAgZGZ4cDogewogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRyYWNrVGV4dAogICAgICAgICAgICAgICAgICogQHJldHVybnMge3t0ZXh0OiBBcnJheSwgdGltZXM6IEFycmF5fX0KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgcGFyc2U6IGZ1bmN0aW9uIHBhcnNlKHRyYWNrVGV4dCkgewogICAgICAgICAgICAgICAgICAgIHRyYWNrVGV4dCA9ICQodHJhY2tUZXh0KS5maWx0ZXIoJ3R0Jyk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lciA9IHRyYWNrVGV4dC5jaGlsZHJlbignZGl2JykuZXEoMCksCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzID0gY29udGFpbmVyLmZpbmQoJ3AnKSwKICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGVOb2RlID0gdHJhY2tUZXh0LmZpbmQoJyMnICsgY29udGFpbmVyLmF0dHIoJ3N0eWxlJykpLAogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZXMgPSB2b2lkIDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGVudHJpZXMgPSBbXSwKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IHZvaWQgMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlTm9kZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZXMgPSBzdHlsZU5vZGUucmVtb3ZlQXR0cignaWQnKS5nZXQoMCkuYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBhdHRyaWJ1dGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGVzW2F0dHJpYnV0ZXNbaV0ubmFtZS5zcGxpdCgiOiIpWzFdXSA9IGF0dHJpYnV0ZXNbaV0udmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGUgPSB2b2lkIDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGVtcCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdG9wOiBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlOiBudWxsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IG51bGwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGluZXMuZXEoaSkuYXR0cignYmVnaW4nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RlbXAuc3RhcnQgPSAoMCwgX3RpbWUuY29udmVydFNNUFRFdG9TZWNvbmRzKShsaW5lcy5lcShpKS5hdHRyKCdiZWdpbicpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIV90ZW1wLnN0YXJ0ICYmIGxpbmVzLmVxKGkgLSAxKS5hdHRyKCdlbmQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RlbXAuc3RhcnQgPSAoMCwgX3RpbWUuY29udmVydFNNUFRFdG9TZWNvbmRzKShsaW5lcy5lcShpIC0gMSkuYXR0cignZW5kJykpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsaW5lcy5lcShpKS5hdHRyKCdlbmQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RlbXAuc3RvcCA9ICgwLCBfdGltZS5jb252ZXJ0U01QVEV0b1NlY29uZHMpKGxpbmVzLmVxKGkpLmF0dHIoJ2VuZCcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIV90ZW1wLnN0b3AgJiYgbGluZXMuZXEoaSArIDEpLmF0dHIoJ2JlZ2luJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90ZW1wLnN0b3AgPSAoMCwgX3RpbWUuY29udmVydFNNUFRFdG9TZWNvbmRzKShsaW5lcy5lcShpICsgMSkuYXR0cignYmVnaW4nKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHlsZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBfc3R5bGUgaW4gc3R5bGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGUgKz0gX3N0eWxlICsgJzonICsgc3R5bGVzW19zdHlsZV0gKyAnOyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGVtcC5zdHlsZSA9IHN0eWxlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGVtcC5zdGFydCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RlbXAuc3RhcnQgPSAwLjIwMDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBfdGVtcC50ZXh0ID0gJC50cmltKGxpbmVzLmVxKGkpLmh0bWwoKSkucmVwbGFjZSgvKFxiKGh0dHBzP3xmdHB8ZmlsZSk6XC9cL1stQS1aMC05KyZAI1wvJT89fl98ITosLjtdKlstQS1aMC05KyZAI1wvJT1+X3xdKS9pZywgIjxhIGhyZWY9JyQxJyB0YXJnZXQ9J19ibGFuayc+JDE8L2E+Iik7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudHJpZXMucHVzaChfdGVtcCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbnRyaWVzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRleHQKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHJlZ2V4CiAgICAgICAgICAgICAqIEByZXR1cm5zIHtBcnJheX0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHNwbGl0MjogZnVuY3Rpb24gc3BsaXQyKHRleHQsIHJlZ2V4KSB7CiAgICAgICAgICAgICAgICAvLyBub3JtYWwgdmVyc2lvbiBmb3IgY29tcGxpYW50IGJyb3dzZXJzCiAgICAgICAgICAgICAgICAvLyBzZWUgYmVsb3cgZm9yIElFIGZpeAogICAgICAgICAgICAgICAgcmV0dXJuIHRleHQuc3BsaXQocmVnZXgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCi8vIHRlc3QgZm9yIGJyb3dzZXJzIHdpdGggYmFkIFN0cmluZy5zcGxpdCBtZXRob2QuCiAgICAgICAgaWYgKCd4XG5cbnknLnNwbGl0KC9cbi9naSkubGVuZ3RoICE9PSAzKSB7CiAgICAgICAgICAgIC8vIGFkZCBzdXBlciBzbG93IElFOCBhbmQgYmVsb3cgdmVyc2lvbgogICAgICAgICAgICBfbWVqczIuZGVmYXVsdC5UcmFja0Zvcm1hdFBhcnNlci5zcGxpdDIgPSBmdW5jdGlvbiAodGV4dCwgcmVnZXgpIHsKICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IFtdLAogICAgICAgICAgICAgICAgICAgIGNodW5rID0gJycsCiAgICAgICAgICAgICAgICAgICAgaSA9IHZvaWQgMDsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGV4dC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNodW5rICs9IHRleHQuc3Vic3RyaW5nKGksIGkgKyAxKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVnZXgudGVzdChjaHVuaykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMucHVzaChjaHVuay5yZXBsYWNlKHJlZ2V4LCAnJykpOwogICAgICAgICAgICAgICAgICAgICAgICBjaHVuayA9ICcnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhcnRzLnB1c2goY2h1bmspOwogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnRzOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICB9LCB7IjE2IjogMTYsICIzMiI6IDMyLCAiNCI6IDQsICI2IjogNn1dLAogICAgMTM6IFtmdW5jdGlvbiAoX2RlcmVxXywgbW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgCgogICAgICAgIHZhciBfcGxheWVyID0gX2RlcmVxXygxNik7CgogICAgICAgIHZhciBfcGxheWVyMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3BsYXllcik7CgogICAgICAgIHZhciBfaTE4biA9IF9kZXJlcV8oNCk7CgogICAgICAgIHZhciBfaTE4bjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9pMThuKTsKCiAgICAgICAgdmFyIF9jb25zdGFudHMgPSBfZGVyZXFfKDI3KTsKCiAgICAgICAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHtkZWZhdWx0OiBvYmp9OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogVm9sdW1lIGJ1dHRvbgogICAgICAgICAqCiAgICAgICAgICogVGhpcyBmZWF0dXJlIGVuYWJsZXMgdGhlIGRpc3BsYXlpbmcgb2YgYSBWb2x1bWUgYnV0dG9uIGluIHRoZSBjb250cm9sIGJhciwgYW5kIGFsc28gY29udGFpbnMgbG9naWMgdG8gbWFuaXB1bGF0ZSBpdHMKICAgICAgICAgKiBldmVudHMsIHN1Y2ggYXMgc2xpZGluZyB1cC9kb3duIChvciBsZWZ0L3JpZ2h0LCBpZiB2ZXJ0aWNhbCksIG11dGluZy91bm11dGluZyBtZWRpYSwgZXRjLgogICAgICAgICAqLwoKLy8gRmVhdHVyZSBjb25maWd1cmF0aW9uCiAgICAgICAgT2JqZWN0LmFzc2lnbihfcGxheWVyLmNvbmZpZywgewogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHR5cGUge1N0cmluZ30KICAgICAgICAgICAgICovCiAgICAgICAgICAgIG11dGVUZXh0OiAnJywKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBhbGx5Vm9sdW1lQ29udHJvbFRleHQ6ICcnLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHR5cGUge0Jvb2xlYW59CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBoaWRlVm9sdW1lT25Ub3VjaERldmljZXM6IHRydWUsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgYXVkaW9Wb2x1bWU6ICdob3Jpem9udGFsJywKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtTdHJpbmd9CiAgICAgICAgICAgICAqLwogICAgICAgICAgICB2aWRlb1ZvbHVtZTogJ3ZlcnRpY2FsJwogICAgICAgIH0pOwoKICAgICAgICBPYmplY3QuYXNzaWduKF9wbGF5ZXIyLmRlZmF1bHQucHJvdG90eXBlLCB7CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRmVhdHVyZSBjb25zdHJ1Y3Rvci4KICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQWx3YXlzIGhhcyB0byBiZSBwcmVmaXhlZCB3aXRoIGBidWlsZGAgYW5kIHRoZSBuYW1lIHRoYXQgd2lsbCBiZSB1c2VkIGluIE1lcERlZmF1bHRzLmZlYXR1cmVzIGxpc3QKICAgICAgICAgICAgICogQHBhcmFtIHtNZWRpYUVsZW1lbnRQbGF5ZXJ9IHBsYXllcgogICAgICAgICAgICAgKiBAcGFyYW0geyR9IGNvbnRyb2xzCiAgICAgICAgICAgICAqIEBwYXJhbSB7JH0gbGF5ZXJzCiAgICAgICAgICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IG1lZGlhCiAgICAgICAgICAgICAqIEBwdWJsaWMKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGJ1aWxkdm9sdW1lOiBmdW5jdGlvbiBidWlsZHZvbHVtZShwbGF5ZXIsIGNvbnRyb2xzLCBsYXllcnMsIG1lZGlhKSB7CgogICAgICAgICAgICAgICAgLy8gQW5kcm9pZCBhbmQgaU9TIGRvbid0IHN1cHBvcnQgdm9sdW1lIGNvbnRyb2xzCiAgICAgICAgICAgICAgICBpZiAoKF9jb25zdGFudHMuSVNfQU5EUk9JRCB8fCBfY29uc3RhbnRzLklTX0lPUykgJiYgdGhpcy5vcHRpb25zLmhpZGVWb2x1bWVPblRvdWNoRGV2aWNlcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgbW9kZSA9IHQuaXNWaWRlbyA/IHQub3B0aW9ucy52aWRlb1ZvbHVtZSA6IHQub3B0aW9ucy5hdWRpb1ZvbHVtZSwKICAgICAgICAgICAgICAgICAgICBtdXRlVGV4dCA9IHQub3B0aW9ucy5tdXRlVGV4dCA/IHQub3B0aW9ucy5tdXRlVGV4dCA6IF9pMThuMi5kZWZhdWx0LnQoJ21lanMubXV0ZS10b2dnbGUnKSwKICAgICAgICAgICAgICAgICAgICB2b2x1bWVDb250cm9sVGV4dCA9IHQub3B0aW9ucy5hbGx5Vm9sdW1lQ29udHJvbFRleHQgPyB0Lm9wdGlvbnMuYWxseVZvbHVtZUNvbnRyb2xUZXh0IDogX2kxOG4yLmRlZmF1bHQudCgnbWVqcy52b2x1bWUtaGVscC10ZXh0JyksCiAgICAgICAgICAgICAgICAgICAgbXV0ZSA9IG1vZGUgPT09ICdob3Jpem9udGFsJyA/CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBob3Jpem9udGFsIHZlcnNpb24KICAgICAgICAgICAgICAgICAgICAgICAgJCgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdidXR0b24gJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd2b2x1bWUtYnV0dG9uICcgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnbXV0ZSI+JyArICgnPGJ1dHRvbiB0eXBlPSJidXR0b24iIGRhdGEtdG9nZ2xlPSJwbGF5ZXItdG9vbHRpcCIgZGF0YS1wbGFjZW1lbnQ9ImxlZnQiICAgYXJpYS1jb250cm9scz0iJyArIHQuaWQgKyAnIiB0aXRsZT0iJyArIG11dGVUZXh0ICsgJyIgYXJpYS1sYWJlbD0iJyArIG11dGVUZXh0ICsgJyI+PC9idXR0b24+JykgKyAnPC9kaXY+JyArICgnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApOyIgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnaG9yaXpvbnRhbC12b2x1bWUtc2xpZGVyIj4nKSArICgnPHNwYW4gY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb2Zmc2NyZWVuIj4nICsgdm9sdW1lQ29udHJvbFRleHQgKyAnPC9zcGFuPicpICsgKCc8ZGl2IGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2hvcml6b250YWwtdm9sdW1lLXRvdGFsIj4nKSArICgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdob3Jpem9udGFsLXZvbHVtZS1jdXJyZW50Ij48L2Rpdj4nKSArICgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdob3Jpem9udGFsLXZvbHVtZS1oYW5kbGUiPjwvZGl2PicpICsgJzwvZGl2PicgKyAnPC9hPicpLmFwcGVuZFRvKGNvbnRyb2xzKSA6CgogICAgICAgICAgICAgICAgICAgICAgICAvLyB2ZXJ0aWNhbCB2ZXJzaW9uCiAgICAgICAgICAgICAgICAgICAgICAgICQoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnYnV0dG9uICcgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndm9sdW1lLWJ1dHRvbiAnICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ211dGUiPicgKyAoJzxidXR0b24gdHlwZT0iYnV0dG9uIiBhcmlhLWNvbnRyb2xzPSInICsgdC5pZCArICciICBkYXRhLXRvZ2dsZT0icGxheWVyLXRvb2x0aXAiIGRhdGEtcGxhY2VtZW50PSJsZWZ0IiB0aXRsZT0iJyArIG11dGVUZXh0ICsgJyIgYXJpYS1sYWJlbD0iJyArIG11dGVUZXh0ICsgJyI+PC9idXR0b24+JykgKyAoJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKTsiIGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3ZvbHVtZS1zbGlkZXIiPicpICsgKCc8c3BhbiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdvZmZzY3JlZW4iPicgKyB2b2x1bWVDb250cm9sVGV4dCArICc8L3NwYW4+JykgKyAoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndm9sdW1lLXRvdGFsIj4nKSArICgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd2b2x1bWUtY3VycmVudCI+PC9kaXY+JykgKyAoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndm9sdW1lLWhhbmRsZSI+PC9kaXY+JykgKyAnPC9kaXY+JyArICc8L2E+JyArICc8L2Rpdj4nKS5hcHBlbmRUbyhjb250cm9scyksCiAgICAgICAgICAgICAgICAgICAgdm9sdW1lU2xpZGVyID0gdC5jb250YWluZXIuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndm9sdW1lLXNsaWRlciwgXG5cdFx0XHRcdC4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2hvcml6b250YWwtdm9sdW1lLXNsaWRlcicpLAogICAgICAgICAgICAgICAgICAgIHZvbHVtZVRvdGFsID0gdC5jb250YWluZXIuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndm9sdW1lLXRvdGFsLCBcblx0XHRcdFx0LicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnaG9yaXpvbnRhbC12b2x1bWUtdG90YWwnKSwKICAgICAgICAgICAgICAgICAgICB2b2x1bWVDdXJyZW50ID0gdC5jb250YWluZXIuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndm9sdW1lLWN1cnJlbnQsIFxuXHRcdFx0XHQuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdob3Jpem9udGFsLXZvbHVtZS1jdXJyZW50JyksCiAgICAgICAgICAgICAgICAgICAgdm9sdW1lSGFuZGxlID0gdC5jb250YWluZXIuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndm9sdW1lLWhhbmRsZSwgXG5cdFx0XHRcdC4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2hvcml6b250YWwtdm9sdW1lLWhhbmRsZScpLAoKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge051bWJlcn0gdm9sdW1lCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25Wb2x1bWVIYW5kbGUgPSBmdW5jdGlvbiBwb3NpdGlvblZvbHVtZUhhbmRsZSh2b2x1bWUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvcnJlY3QgdG8gMC0xCiAgICAgICAgICAgICAgICAgICAgICAgIHZvbHVtZSA9IE1hdGgubWF4KDAsIHZvbHVtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZvbHVtZSA9IE1hdGgubWluKHZvbHVtZSwgMSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGp1c3QgbXV0ZSBidXR0b24gc3R5bGUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZvbHVtZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXV0ZS5yZW1vdmVDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnbXV0ZScpLmFkZENsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd1bm11dGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG11dGUuY2hpbGRyZW4oJ2J1dHRvbicpLmF0dHIoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiB0Lm9wdGlvbnMudW5tdXRlVGV4dCA/IHQub3B0aW9ucy51bm11dGVUZXh0IDogX2kxOG4yLmRlZmF1bHQudCgnbWVqcy51bm11dGUnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYXJpYS1sYWJlbCc6IHQub3B0aW9ucy51bm11dGVUZXh0ID8gdC5vcHRpb25zLnVubXV0ZVRleHQgOiBfaTE4bjIuZGVmYXVsdC50KCdtZWpzLnVubXV0ZScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG11dGUucmVtb3ZlQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3VubXV0ZScpLmFkZENsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdtdXRlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdXRlLmNoaWxkcmVuKCdidXR0b24nKS5hdHRyKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogdC5vcHRpb25zLm11dGVUZXh0ID8gdC5vcHRpb25zLm11dGVUZXh0IDogX2kxOG4yLmRlZmF1bHQudCgnbWVqcy5tdXRlJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2FyaWEtbGFiZWwnOiB0Lm9wdGlvbnMubXV0ZVRleHQgPyB0Lm9wdGlvbnMubXV0ZVRleHQgOiBfaTE4bjIuZGVmYXVsdC50KCdtZWpzLm11dGUnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2b2x1bWVQZXJjZW50YWdlID0gdm9sdW1lICogMTAwICsgJyUnOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcG9zaXRpb24gc2xpZGVyCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2RlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2x1bWVDdXJyZW50LmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm90dG9tOiAnMCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiB2b2x1bWVQZXJjZW50YWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZvbHVtZUhhbmRsZS5jc3MoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvdHRvbTogdm9sdW1lUGVyY2VudGFnZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJnaW5Cb3R0b206IC12b2x1bWVIYW5kbGUuaGVpZ2h0KCkgLyAyICsgJ3B4JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2x1bWVDdXJyZW50LmNzcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogJzAnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiB2b2x1bWVQZXJjZW50YWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZvbHVtZUhhbmRsZS5jc3MoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IHZvbHVtZVBlcmNlbnRhZ2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFyZ2luTGVmdDogLXZvbHVtZUhhbmRsZS53aWR0aCgpIC8gMiArICdweCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICBoYW5kbGVWb2x1bWVNb3ZlID0gZnVuY3Rpb24gaGFuZGxlVm9sdW1lTW92ZShlKSB7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdm9sdW1lID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsT2Zmc2V0ID0gdm9sdW1lVG90YWwub2Zmc2V0KCk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBjYWxjdWxhdGUgdGhlIG5ldyB2b2x1bWUgYmFzZWQgb24gdGhlIG1vc3QgcmVjZW50IHBvc2l0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2RlID09PSAndmVydGljYWwnKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJhaWxIZWlnaHQgPSB2b2x1bWVUb3RhbC5oZWlnaHQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdZID0gZS5wYWdlWSAtIHRvdGFsT2Zmc2V0LnRvcDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2x1bWUgPSAocmFpbEhlaWdodCAtIG5ld1kpIC8gcmFpbEhlaWdodDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgY29udHJvbHMganVzdCBoaWRlIHRoZW1zZWx2ZXMgKHVzdWFsbHkgd2hlbiBtb3VzZSBtb3ZlcyB0b28gZmFyIHVwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRvdGFsT2Zmc2V0LnRvcCA9PT0gMCB8fCB0b3RhbE9mZnNldC5sZWZ0ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJhaWxXaWR0aCA9IHZvbHVtZVRvdGFsLndpZHRoKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3WCA9IGUucGFnZVggLSB0b3RhbE9mZnNldC5sZWZ0OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZvbHVtZSA9IG5ld1ggLyByYWlsV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVuc3VyZSB0aGUgdm9sdW1lIGlzbid0IG91dHNpZGUgMC0xCiAgICAgICAgICAgICAgICAgICAgICAgIHZvbHVtZSA9IE1hdGgubWF4KDAsIHZvbHVtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZvbHVtZSA9IE1hdGgubWluKHZvbHVtZSwgMSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBwb3NpdGlvbiB0aGUgc2xpZGVyIGFuZCBoYW5kbGUKICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25Wb2x1bWVIYW5kbGUodm9sdW1lKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNldCB0aGUgbWVkaWEgb2JqZWN0ICh0aGlzIHdpbGwgdHJpZ2dlciB0aGUgYHZvbHVtZWNoYW5nZWRgIGV2ZW50KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodm9sdW1lID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYS5zZXRNdXRlZCh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnNldE11dGVkKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYS5zZXRWb2x1bWUodm9sdW1lKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIG1vdXNlSXNEb3duID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgbW91c2VJc092ZXIgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAvLyBTTElERVIKICAgICAgICAgICAgICAgIG11dGUub24oJ21vdXNlZW50ZXIgZm9jdXNpbicsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB2b2x1bWVTbGlkZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgIG1vdXNlSXNPdmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pLm9uKCdtb3VzZWxlYXZlIGZvY3Vzb3V0JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIG1vdXNlSXNPdmVyID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgIGlmICghbW91c2VJc0Rvd24gJiYgbW9kZSA9PT0gJ3ZlcnRpY2FsJykgewogICAgICAgICAgICAgICAgICAgICAgICB2b2x1bWVTbGlkZXIuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVZvbHVtZVNsaWRlciA9IGZ1bmN0aW9uIHVwZGF0ZVZvbHVtZVNsaWRlcigpIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHZvbHVtZSA9IE1hdGguZmxvb3IobWVkaWEudm9sdW1lICogMTAwKTsKCiAgICAgICAgICAgICAgICAgICAgdm9sdW1lU2xpZGVyLmF0dHIoewogICAgICAgICAgICAgICAgICAgICAgICAnYXJpYS1sYWJlbCc6IF9pMThuMi5kZWZhdWx0LnQoJ21lanMudm9sdW1lLXNsaWRlcicpLAogICAgICAgICAgICAgICAgICAgICAgICAnYXJpYS12YWx1ZW1pbic6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICdhcmlhLXZhbHVlbWF4JzogMTAwLAogICAgICAgICAgICAgICAgICAgICAgICAnYXJpYS12YWx1ZW5vdyc6IHZvbHVtZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2FyaWEtdmFsdWV0ZXh0Jzogdm9sdW1lICsgJyUnLAogICAgICAgICAgICAgICAgICAgICAgICAncm9sZSc6ICdzbGlkZXInLAogICAgICAgICAgICAgICAgICAgICAgICAndGFiaW5kZXgnOiAtMQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBFdmVudHMKICAgICAgICAgICAgICAgIHZvbHVtZVNsaWRlci5vbignbW91c2VvdmVyJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIG1vdXNlSXNPdmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0pLm9uKCdtb3VzZWRvd24nLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgIGhhbmRsZVZvbHVtZU1vdmUoZSk7CiAgICAgICAgICAgICAgICAgICAgdC5nbG9iYWxCaW5kKCdtb3VzZW1vdmUudm9sJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlVm9sdW1lTW92ZShlKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB0Lmdsb2JhbEJpbmQoJ21vdXNldXAudm9sJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBtb3VzZUlzRG93biA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0Lmdsb2JhbFVuYmluZCgnbW91c2Vtb3ZlLnZvbCBtb3VzZXVwLnZvbCcpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtb3VzZUlzT3ZlciAmJiBtb2RlID09PSAndmVydGljYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2x1bWVTbGlkZXIuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgbW91c2VJc0Rvd24gPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9KS5vbigna2V5ZG93bicsIGZ1bmN0aW9uIChlKSB7CgogICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMua2V5QWN0aW9ucy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGtleUNvZGUgPSBlLndoaWNoIHx8IGUua2V5Q29kZSB8fCAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdm9sdW1lID0gbWVkaWEudm9sdW1lOwogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGtleUNvZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzg6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVXAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2x1bWUgPSBNYXRoLm1pbih2b2x1bWUgKyAwLjEsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA0MDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBEb3duCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdm9sdW1lID0gTWF0aC5tYXgoMCwgdm9sdW1lIC0gMC4xKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIG1vdXNlSXNEb3duID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uVm9sdW1lSGFuZGxlKHZvbHVtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnNldFZvbHVtZSh2b2x1bWUpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gTVVURSBidXR0b24KICAgICAgICAgICAgICAgIG11dGUuZmluZCgnYnV0dG9uJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIG1lZGlhLnNldE11dGVkKCFtZWRpYS5tdXRlZCk7CiAgICAgICAgICAgICAgICB9KS5vbignZm9jdXMnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGUgPT09ICd2ZXJ0aWNhbCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdm9sdW1lU2xpZGVyLnNob3coKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KS5vbignYmx1cicsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobW9kZSA9PT0gJ3ZlcnRpY2FsJykgewogICAgICAgICAgICAgICAgICAgICAgICB2b2x1bWVTbGlkZXIuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIGxpc3RlbiBmb3Igdm9sdW1lIGNoYW5nZSBldmVudHMgZnJvbSBvdGhlciBzb3VyY2VzCiAgICAgICAgICAgICAgICBtZWRpYS5hZGRFdmVudExpc3RlbmVyKCd2b2x1bWVjaGFuZ2UnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgIGlmICghbW91c2VJc0Rvd24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lZGlhLm11dGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvblZvbHVtZUhhbmRsZSgwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG11dGUucmVtb3ZlQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ211dGUnKS5hZGRDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndW5tdXRlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvblZvbHVtZUhhbmRsZShtZWRpYS52b2x1bWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbXV0ZS5yZW1vdmVDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndW5tdXRlJykuYWRkQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ211dGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB1cGRhdGVWb2x1bWVTbGlkZXIoZSk7CiAgICAgICAgICAgICAgICB9LCBmYWxzZSk7CgogICAgICAgICAgICAgICAgLy8gbXV0ZXMgdGhlIG1lZGlhIGFuZCBzZXRzIHRoZSB2b2x1bWUgaWNvbiBtdXRlZCBpZiB0aGUgaW5pdGlhbCB2b2x1bWUgaXMgc2V0IHRvIDAKICAgICAgICAgICAgICAgIGlmIChwbGF5ZXIub3B0aW9ucy5zdGFydFZvbHVtZSA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIG1lZGlhLnNldE11dGVkKHRydWUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHNoaW0gZ2V0cyB0aGUgc3RhcnR2b2x1bWUgYXMgYSBwYXJhbWV0ZXIsIGJ1dCB3ZSBoYXZlIHRvIHNldCBpdCBvbiB0aGUgbmF0aXZlIDx2aWRlbz4gYW5kIDxhdWRpbz4gZWxlbWVudHMKICAgICAgICAgICAgICAgIHZhciBpc05hdGl2ZSA9IHQubWVkaWEucmVuZGVyZXJOYW1lICE9PSBudWxsICYmIHQubWVkaWEucmVuZGVyZXJOYW1lLm1hdGNoKC8obmF0aXZlfGh0bWw1KS8pICE9PSBudWxsOwoKICAgICAgICAgICAgICAgIGlmIChpc05hdGl2ZSkgewogICAgICAgICAgICAgICAgICAgIG1lZGlhLnNldFZvbHVtZShwbGF5ZXIub3B0aW9ucy5zdGFydFZvbHVtZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdC5jb250YWluZXIub24oJ2NvbnRyb2xzcmVzaXplJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYS5tdXRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvblZvbHVtZUhhbmRsZSgwKTsKICAgICAgICAgICAgICAgICAgICAgICAgbXV0ZS5yZW1vdmVDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnbXV0ZScpLmFkZENsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd1bm11dGUnKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvblZvbHVtZUhhbmRsZShtZWRpYS52b2x1bWUpOwogICAgICAgICAgICAgICAgICAgICAgICBtdXRlLnJlbW92ZUNsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICd1bm11dGUnKS5hZGRDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnbXV0ZScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgfSwgeyIxNiI6IDE2LCAiMjciOiAyNywgIjQiOiA0fV0sCiAgICAxNDogW2Z1bmN0aW9uIChfZGVyZXFfLCBtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAKCiAgICAgICAgLyohCiAgICAgICAgICogVGhpcyBpcyBhIGBpMThuYCBsYW5ndWFnZSBvYmplY3QuCiAgICAgICAgICoKICAgICAgICAgKiBFbmdsaXNoOyBUaGlzIGNhbiBzZXJ2ZSBhcyBhIHRlbXBsYXRlIGZvciBvdGhlciBsYW5ndWFnZXMgdG8gdHJhbnNsYXRlCiAgICAgICAgICoKICAgICAgICAgKiBAYXV0aG9yCiAgICAgICAgICogICBUQkQKICAgICAgICAgKiAgIFNhc2NoYSBHcmV1ZWwgKFR3aXR0ZXI6IEBTb2Z0Q3JlYXRSKQogICAgICAgICAqCiAgICAgICAgICogQHNlZSBjb3JlL2kxOG4uanMKICAgICAgICAgKi8KCiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgICAgICAgICB2YWx1ZTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIHZhciBFTiA9IGV4cG9ydHMuRU4gPSB7CiAgICAgICAgICAgICJtZWpzLnBsdXJhbC1mb3JtIjogNywKICAgICAgICAgICAgIm1lanMuaW5zdGFsbC1mbGFzaCI6ICJGbGFzaCBwbGF5ZXIg0LIg0LLQsNGI0LXQvCDQsdGA0LDRg9C30LXRgNC1INC90LUg0YPRgdGC0LDQvdC+0LLQu9C10L0g0LjQu9C4INC+0YLQutC70Y7Rh9C10L0uINCf0L7QttCw0LvRg9C50YHRgtCwINCy0LrQu9GO0YfQuNGC0LUg0LLQsNGIIEZsYXNoIHBsYXllciDQuNC70Lgg0YHQutCw0YfQsNC50YLQtSDQv9C+0YHQu9C10LTQvdGO0Y4g0LLQtdGA0YHQuNGOINC90LAgaHR0cHM6Ly9nZXQuYWRvYmUuY29tL2ZsYXNocGxheWVyLyIsCiAgICAgICAgICAgICJtZWpzLmZ1bGxzY3JlZW4tb2ZmIjogItCS0YvQutC70Y7Rh9C40YLRjCDQv9C+0LvQvdC+0Y3QutGA0LDQvdC90YvQuSDRgNC10LbQuNC8IiwKICAgICAgICAgICAgIm1lanMuZnVsbHNjcmVlbi1vbiI6ICLQn9C10YDQtdC50YLQuCDQsiDQv9C+0LvQvdC+0Y3QutGA0LDQvdC90YvQuSDRgNC10LbQuNC8IiwKICAgICAgICAgICAgIm1lanMuZG93bmxvYWQtdmlkZW8iOiAi0KHQutCw0YfQsNGC0Ywg0LLQuNC00LXQviIsCiAgICAgICAgICAgICJtZWpzLmZ1bGxzY3JlZW4iOiAi0J/QvtC70L3QvtGN0LrRgNCw0L3QvdGL0Lkg0YDQtdC20LjQvCIsCiAgICAgICAgICAgICJtZWpzLnRpbWUtanVtcC1mb3J3YXJkIjogWyLQn9C10YDQtdC50YLQuCDQstC/0LXRgNC10LQg0L3QsCAlMSDRgdC10LrRg9C90LTRgyIsICLQn9C10YDQtdC50YLQuCDQstC/0LXRgNC10LQg0L3QsCAlMSDRgdC10LrRg9C90LTRiyIsICLQn9C10YDQtdC50YLQuCDQstC/0LXRgNC10LQg0L3QsCAlMSDRgdC10LrRg9C90LQiXSwKICAgICAgICAgICAgIm1lanMubG9vcCI6ICLQl9Cw0YbQuNC60LvQuNGC0Ywg0LLQvtGB0L/RgNC+0LjQt9Cy0LXQtNC10L3QuNC1IiwKICAgICAgICAgICAgIm1lanMucGxheSI6ICLQktC+0YHQv9GA0L7QuNC30LLQtdGB0YLQuCIsCiAgICAgICAgICAgICJtZWpzLnBhdXNlIjogItCf0LDRg9C30LAiLAogICAgICAgICAgICAibWVqcy5jbG9zZSI6ICLQl9Cw0LrRgNGL0YLRjCIsCiAgICAgICAgICAgICJtZWpzLnRpbWUtc2xpZGVyIjogItCh0LvQsNC50LTQtdGAINCy0YDQtdC80LXQvdC4IiwKICAgICAgICAgICAgIm1lanMudGltZS1oZWxwLXRleHQiOiAi0JjRgdC/0L7Qu9GM0LfRg9C50YLQtSDQm9C10LLRg9GOL9Cf0YDQsNCy0YPRjiDQutC70LDQstC40YjQuCDRgdC+INGB0YLRgNC10LvQutCw0LzQuCwg0YfRgtC+0LHRiyDQv9GA0L7QtNCy0LjQvdGD0YLRjNGB0Y8g0L3QsCDQvtC00L3RgyDRgdC10LrRg9C90LTRgywg0LrQu9Cw0LLQuNGI0Lgg0YHQviDRgdGC0YDQtdC70LrQsNC80Lgg0JLQstC10YDRhS/QktC90LjQtywg0YfRgtC+0LHRiyDQv9GA0L7QtNCy0LjQvdGD0YLRjNGB0Y8g0L3QsCDQtNC10YHRj9GC0Ywg0YHQtdC60YPQvdC0LiIsCiAgICAgICAgICAgICJtZWpzLnRpbWUtc2tpcC1iYWNrIjogWyLQn9C10YDQtdC50YLQuCDQvdCw0LfQsNC0INC90LAgJTEg0YHQtdC60YPQvdC00YMiLCAi0J/QtdGA0LXQudGC0Lgg0L3QsNC30LDQtCDQvdCwICUxINGB0LXQutGD0L3QtNGLIiwgItCf0LXRgNC10LnRgtC4INC90LDQt9Cw0LQg0L3QsCAlMSDRgdC10LrRg9C90LQiXSwKICAgICAgICAgICAgIm1lanMuY2FwdGlvbnMtc3VidGl0bGVzIjogItCi0LjRgtGA0Ysv0KHRg9Cx0YLQuNGC0YDRiyIsCiAgICAgICAgICAgICJtZWpzLm5vbmUiOiAi0J3QtdGCIiwKICAgICAgICAgICAgIm1lanMubXV0ZS10b2dnbGUiOiAi0JHQtdC3INC30LLRg9C60LAiLAogICAgICAgICAgICAibWVqcy52b2x1bWUtaGVscC10ZXh0IjogItCY0YHQv9C+0LvRjNC30YPQudGC0LUg0LrQu9Cw0LLQuNGI0Lgg0YHQviDRgdGC0YDQtdC70LrQsNC80Lgg0JLQstC10YDRhS/QktC90LjQtywg0YfRgtC+0LHRiyDRg9Cy0LXQu9C40YfQuNGC0Ywg0LjQu9C4INGD0LzQtdC90YzRiNC40YLRjCDQs9GA0L7QvNC60L7RgdGC0YwuIiwKICAgICAgICAgICAgIm1lanMudW5tdXRlIjogItCS0LrQu9GO0YfQuNGC0Ywg0LfQstGD0LoiLAogICAgICAgICAgICAibWVqcy5tdXRlIjogItCe0YLQutC70Y7Rh9C40YLRjCDQt9Cy0YPQuiIsCiAgICAgICAgICAgICJtZWpzLnZvbHVtZS1zbGlkZXIiOiAi0KHQu9Cw0LnQtNC10YAg0LPRgNC+0LzQutC+0YHRgtC4IiwKICAgICAgICAgICAgIm1lanMudmlkZW8tcGxheWVyIjogItCS0LjQtNC10L7Qv9C70LXQtdGAIiwKICAgICAgICAgICAgIm1lanMuYXVkaW8tcGxheWVyIjogItCQ0YPQtNC40L7Qv9C70LXQtdGAIiwKICAgICAgICAgICAgIm1lanMuYWQtc2tpcCI6ICLQn9GA0L7Qv9GD0YHRgtC40YLRjCDRgNC10LrQu9Cw0LzRgyIsCiAgICAgICAgICAgICJtZWpzLmFkLXNraXAtaW5mbyI6IFsi0J/RgNC+0L/Rg9GB0YLQuNGC0Ywg0YfQtdGA0LXQtyAlMSDRgdC10LrRg9C90LTRgyIsICLQn9GA0L7Qv9GD0YHRgtC40YLRjCDRh9C10YDQtdC3ICUxINGB0LXQutGD0L3QtNGLIiwgItCf0YDQvtC/0YPRgdGC0LjRgtGMINGH0LXRgNC10LcgJTEg0YHQtdC60YPQvdC0Il0sCiAgICAgICAgICAgICJtZWpzLnNvdXJjZS1jaG9vc2VyIjogItCf0LXRgNC10LrQu9GO0YfQsNGC0LXQu9GMINC40YHRgtC+0YfQvdC40LrQsCIsCiAgICAgICAgICAgICJtZWpzLnN0b3AiOiAi0J7RgdGC0LDQvdC+0LLQuNGC0YwiLAogICAgICAgICAgICAibWVqcy5zcGVlZC1yYXRlIjogItCh0LrQvtGA0L7RgdGC0Ywg0LLQvtGB0L/RgNC+0LjQt9Cy0LXQtNC10L3QuNGPIiwKICAgICAgICAgICAgIm1lanMubGl2ZS1icm9hZGNhc3QiOiAi0J/RgNGP0LzQsNGPINGC0YDQsNC90YHQu9GP0YbQuNGPIiwKICAgICAgICAgICAgIm1lanMuYWZyaWthYW5zIjogItCQ0YTRgNC40LrQsNC90YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5hbGJhbmlhbiI6ICLQkNC70LHQsNC90YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5hcmFiaWMiOiAi0JDRgNCw0LHRgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLmJlbGFydXNpYW4iOiAi0JHQtdC70L7RgNGD0YHRgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLmJ1bGdhcmlhbiI6ICLQkdC+0LvQs9Cw0YDRgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLmNhdGFsYW4iOiAi0JrQsNGC0LDQu9C+0L3RgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLmNoaW5lc2UiOiAi0JrQuNGC0LDQudGB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMuY2hpbmVzZS1zaW1wbGlmaWVkIjogItCa0LjRgtCw0LnRgdC60LjQuSAo0YPQv9GA0L7RidC10L3QvdGL0LkpIiwKICAgICAgICAgICAgIm1lanMuY2hpbmVzZS10cmFkaXRpb25hbCI6ICJDaGluZXNlICjRgtGA0LDQtNC40YbQuNC+0L3QvdGL0LkpIiwKICAgICAgICAgICAgIm1lanMuY3JvYXRpYW4iOiAi0KXQvtGA0LLQsNGC0YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5jemVjaCI6ICLQp9C10YjRgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLmRhbmlzaCI6ICLQlNCw0YLRgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLmR1dGNoIjogItCT0L7Qu9C70LDQvdC00YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5lbmdsaXNoIjogItCQ0L3Qs9C70LjQudGB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMuZXN0b25pYW4iOiAi0K3RgdGC0L7QvdGB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMuZmlsaXBpbm8iOiAi0KTQuNC70LjQv9C/0LjQvdGB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMuZmlubmlzaCI6ICLQpNC40L3RgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLmZyZW5jaCI6ICLQpNGA0LDQvdGG0YPQt9GB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMuZ2FsaWNpYW4iOiAi0JPQsNC70LjRgdC40LnRgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLmdlcm1hbiI6ICLQndC10LzQtdGG0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMuZ3JlZWsiOiAi0JPRgNC10YfQtdGB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMuaGFpdGlhbi1jcmVvbGUiOiAi0JPQsNC40YLRj9C90YHQutC40Lkg0LrRgNC10L7Qu9GM0YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5oZWJyZXciOiAi0JjQstGA0LjRgiIsCiAgICAgICAgICAgICJtZWpzLmhpbmRpIjogItCl0LjQvdC00LgiLAogICAgICAgICAgICAibWVqcy5odW5nYXJpYW4iOiAi0JLQtdC90LPQtdGA0YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5pY2VsYW5kaWMiOiAi0JjRgdC70LDQvdC00YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5pbmRvbmVzaWFuIjogItCY0L3QtNC+0L3QtdC30LjQudGB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMuaXJpc2giOiAi0JjRgNC70LDQvdC00YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5pdGFsaWFuIjogItCY0YLQsNC70YzRj9C90YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5qYXBhbmVzZSI6ICLQr9C/0L7QvdGB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMua29yZWFuIjogItCa0L7RgNC10LnRgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLmxhdHZpYW4iOiAi0JvQsNGC0YvRiNGB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMubGl0aHVhbmlhbiI6ICLQm9C40YLQvtCy0YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5tYWNlZG9uaWFuIjogItCc0LDQutC10LTQvtC90YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5tYWxheSI6ICLQnNCw0LvQsNC50YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5tYWx0ZXNlIjogItCc0LDQu9GM0YLQuNC50YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5ub3J3ZWdpYW4iOiAi0J3QvtGA0LLQtdC20YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5wZXJzaWFuIjogItCf0LXRgNGB0LjQtNGB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMucG9saXNoIjogItCf0L7Qu9GM0YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5wb3J0dWd1ZXNlIjogItCf0L7RgNGC0YPQs9Cw0LvRjNGB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMucm9tYW5pYW4iOiAi0KDRg9C80YvQvdGB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMucnVzc2lhbiI6ICLQoNGD0YHRgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLnNlcmJpYW4iOiAi0KHQtdGA0LHRgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLnNsb3ZhayI6ICLQodC70L7QstCw0YbQutC40LkiLAogICAgICAgICAgICAibWVqcy5zbG92ZW5pYW4iOiAi0KHQu9C+0LLQtdC90YHQutC40LkiLAogICAgICAgICAgICAibWVqcy5zcGFuaXNoIjogItCY0YHQv9Cw0L3RgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLnN3YWhpbGkiOiAi0KHRg9Cw0YXQuNC70LgiLAogICAgICAgICAgICAibWVqcy5zd2VkaXNoIjogItCo0LLQtdC00YHQutC40LkiLAogICAgICAgICAgICAibWVqcy50YWdhbG9nIjogItCi0LDQs9Cw0LvRjNGB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMudGhhaSI6ICLQotCw0LnRgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLnR1cmtpc2giOiAi0KLRg9GA0LXRhtC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLnVrcmFpbmlhbiI6ICLQo9C60YDQsNC40L3RgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLnZpZXRuYW1lc2UiOiAi0JLRjNC10YLQvdCw0LzRgdC60LjQuSIsCiAgICAgICAgICAgICJtZWpzLndlbHNoIjogItCS0LDQu9C70LjQudGB0LrQuNC5IiwKICAgICAgICAgICAgIm1lanMueWlkZGlzaCI6ICLQmNC00LjRiCIKICAgICAgICB9OwoKICAgIH0sIHt9XSwKICAgIDE1OiBbZnVuY3Rpb24gKF9kZXJlcV8sIG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgIAoKICAgICAgICB2YXIgX3dpbmRvdyA9IF9kZXJlcV8oMyk7CgogICAgICAgIHZhciBfd2luZG93MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3dpbmRvdyk7CgogICAgICAgIHZhciBfbWVqcyA9IF9kZXJlcV8oNik7CgogICAgICAgIHZhciBfbWVqczIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9tZWpzKTsKCiAgICAgICAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHtkZWZhdWx0OiBvYmp9OwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBqUXVlcnkgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIF9tZWpzMi5kZWZhdWx0LiQgPSBfd2luZG93Mi5kZWZhdWx0LmpRdWVyeSA9IF93aW5kb3cyLmRlZmF1bHQuJCA9IGpRdWVyeTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBaZXB0byAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgX21lanMyLmRlZmF1bHQuJCA9IF93aW5kb3cyLmRlZmF1bHQuWmVwdG8gPSBfd2luZG93Mi5kZWZhdWx0LiQgPSBaZXB0bzsKCiAgICAgICAgICAgIC8vIGRlZmluZSBgb3V0ZXJXaWR0aGAgbWV0aG9kIHdoaWNoIGhhcyBub3QgYmVlbiByZWFsaXplZCBpbiBaZXB0bwogICAgICAgICAgICBaZXB0by5mbi5vdXRlcldpZHRoID0gZnVuY3Rpb24gKGluY2x1ZGVNYXJnaW4pIHsKICAgICAgICAgICAgICAgIHZhciB3aWR0aCA9ICQodGhpcykud2lkdGgoKTsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlTWFyZ2luKSB7CiAgICAgICAgICAgICAgICAgICAgd2lkdGggKz0gcGFyc2VJbnQoJCh0aGlzKS5jc3MoJ21hcmdpbi1yaWdodCcpLCAxMCk7CiAgICAgICAgICAgICAgICAgICAgd2lkdGggKz0gcGFyc2VJbnQoJCh0aGlzKS5jc3MoJ21hcmdpbi1sZWZ0JyksIDEwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB3aWR0aDsKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBlbmRlciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgX21lanMyLmRlZmF1bHQuJCA9IF93aW5kb3cyLmRlZmF1bHQuZW5kZXIgPSBfd2luZG93Mi5kZWZhdWx0LiQgPSBlbmRlcjsKICAgICAgICB9CgogICAgfSwgeyIzIjogMywgIjYiOiA2fV0sCiAgICAxNjogW2Z1bmN0aW9uIChfZGVyZXFfLCBtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAKCiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgICAgICAgICB2YWx1ZTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIGV4cG9ydHMuY29uZmlnID0gdW5kZWZpbmVkOwoKICAgICAgICB2YXIgX3R5cGVvZiA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA9PT0gInN5bWJvbCIgPyBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIG9iajsKICAgICAgICAgICAgfSA6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiBvYmogJiYgdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBvYmouY29uc3RydWN0b3IgPT09IFN5bWJvbCAmJiBvYmogIT09IFN5bWJvbC5wcm90b3R5cGUgPyAic3ltYm9sIiA6IHR5cGVvZiBvYmo7CiAgICAgICAgICAgIH07CgogICAgICAgIHZhciBfY3JlYXRlQ2xhc3MgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07CiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CiAgICAgICAgICAgICAgICBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOwogICAgICAgICAgICAgICAgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7CiAgICAgICAgICAgICAgICByZXR1cm4gQ29uc3RydWN0b3I7CiAgICAgICAgICAgIH07CiAgICAgICAgfSgpOwoKICAgICAgICB2YXIgX3dpbmRvdyA9IF9kZXJlcV8oMyk7CgogICAgICAgIHZhciBfd2luZG93MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3dpbmRvdyk7CgogICAgICAgIHZhciBfZG9jdW1lbnQgPSBfZGVyZXFfKDIpOwoKICAgICAgICB2YXIgX2RvY3VtZW50MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2RvY3VtZW50KTsKCiAgICAgICAgdmFyIF9tZWpzID0gX2RlcmVxXyg2KTsKCiAgICAgICAgdmFyIF9tZWpzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX21lanMpOwoKICAgICAgICB2YXIgX21lZGlhZWxlbWVudCA9IF9kZXJlcV8oNSk7CgogICAgICAgIHZhciBfbWVkaWFlbGVtZW50MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX21lZGlhZWxlbWVudCk7CgogICAgICAgIHZhciBfaTE4biA9IF9kZXJlcV8oNCk7CgogICAgICAgIHZhciBfaTE4bjIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9pMThuKTsKCiAgICAgICAgdmFyIF9jb25zdGFudHMgPSBfZGVyZXFfKDI3KTsKCiAgICAgICAgdmFyIF9nZW5lcmFsID0gX2RlcmVxXygyOSk7CgogICAgICAgIHZhciBfdGltZSA9IF9kZXJlcV8oMzIpOwoKICAgICAgICB2YXIgX2RvbSA9IF9kZXJlcV8oMjgpOwoKICAgICAgICB2YXIgX21lZGlhID0gX2RlcmVxXygzMCk7CgogICAgICAgIGZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ZGVmYXVsdDogb2JqfTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsKICAgICAgICAgICAgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBfbWVqczIuZGVmYXVsdC5tZXBJbmRleCA9IDA7CgogICAgICAgIF9tZWpzMi5kZWZhdWx0LnBsYXllcnMgPSB7fTsKCi8vIGRlZmF1bHQgcGxheWVyIHZhbHVlcwogICAgICAgIHZhciBjb25maWcgPSBleHBvcnRzLmNvbmZpZyA9IHsKICAgICAgICAgICAgLy8gdXJsIHRvIHBvc3RlciAodG8gZml4IGlPUyAzLngpCiAgICAgICAgICAgIHBvc3RlcjogJycsCiAgICAgICAgICAgIC8vIFdoZW4gdGhlIHZpZGVvIGlzIGVuZGVkLCBzaG93IHRoZSBwb3N0ZXIuCiAgICAgICAgICAgIHNob3dQb3N0ZXJXaGVuRW5kZWQ6IGZhbHNlLAogICAgICAgICAgICAvLyBXaGVuIHRoZSB2aWRlbyBpcyBwYXVzZWQsIHNob3cgdGhlIHBvc3Rlci4KICAgICAgICAgICAgc2hvd1Bvc3RlcldoZW5QYXVzZWQ6IGZhbHNlLAogICAgICAgICAgICAvLyBEZWZhdWx0IGlmIHRoZSA8dmlkZW8gd2lkdGg+IGlzIG5vdCBzcGVjaWZpZWQKICAgICAgICAgICAgZGVmYXVsdFZpZGVvV2lkdGg6IDQ4MCwKICAgICAgICAgICAgLy8gRGVmYXVsdCBpZiB0aGUgPHZpZGVvIGhlaWdodD4gaXMgbm90IHNwZWNpZmllZAogICAgICAgICAgICBkZWZhdWx0VmlkZW9IZWlnaHQ6IDI3MCwKICAgICAgICAgICAgLy8gSWYgc2V0LCBvdmVycmlkZXMgPHZpZGVvIHdpZHRoPgogICAgICAgICAgICB2aWRlb1dpZHRoOiAtMSwKICAgICAgICAgICAgLy8gSWYgc2V0LCBvdmVycmlkZXMgPHZpZGVvIGhlaWdodD4KICAgICAgICAgICAgdmlkZW9IZWlnaHQ6IC0xLAogICAgICAgICAgICAvLyBEZWZhdWx0IGlmIHRoZSB1c2VyIGRvZXNuJ3Qgc3BlY2lmeQogICAgICAgICAgICBkZWZhdWx0QXVkaW9XaWR0aDogNDAwLAogICAgICAgICAgICAvLyBEZWZhdWx0IGlmIHRoZSB1c2VyIGRvZXNuJ3Qgc3BlY2lmeQogICAgICAgICAgICBkZWZhdWx0QXVkaW9IZWlnaHQ6IDQwLAogICAgICAgICAgICAvLyBEZWZhdWx0IGFtb3VudCB0byBtb3ZlIGJhY2sgd2hlbiBiYWNrIGtleSBpcyBwcmVzc2VkCiAgICAgICAgICAgIGRlZmF1bHRTZWVrQmFja3dhcmRJbnRlcnZhbDogZnVuY3Rpb24gZGVmYXVsdFNlZWtCYWNrd2FyZEludGVydmFsKG1lZGlhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gNTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgLy8gRGVmYXVsdCBhbW91bnQgdG8gbW92ZSBmb3J3YXJkIHdoZW4gZm9yd2FyZCBrZXkgaXMgcHJlc3NlZAogICAgICAgICAgICBkZWZhdWx0U2Vla0ZvcndhcmRJbnRlcnZhbDogZnVuY3Rpb24gZGVmYXVsdFNlZWtGb3J3YXJkSW50ZXJ2YWwobWVkaWEpIHsKICAgICAgICAgICAgICAgIHJldHVybiA1OwogICAgICAgICAgICB9LAogICAgICAgICAgICAvLyBTZXQgZGltZW5zaW9ucyB2aWEgSlMgaW5zdGVhZCBvZiBDU1MKICAgICAgICAgICAgc2V0RGltZW5zaW9uczogdHJ1ZSwKICAgICAgICAgICAgLy8gV2lkdGggb2YgYXVkaW8gcGxheWVyCiAgICAgICAgICAgIGF1ZGlvV2lkdGg6IC0xLAogICAgICAgICAgICAvLyBIZWlnaHQgb2YgYXVkaW8gcGxheWVyCiAgICAgICAgICAgIGF1ZGlvSGVpZ2h0OiAtMSwKICAgICAgICAgICAgLy8gSW5pdGlhbCB2b2x1bWUgd2hlbiB0aGUgcGxheWVyIHN0YXJ0cyAob3ZlcnJpZGRlbiBieSB1c2VyIGNvb2tpZSkKICAgICAgICAgICAgc3RhcnRWb2x1bWU6IDAuOCwKICAgICAgICAgICAgLy8gVXNlZnVsIGZvciA8YXVkaW8+IHBsYXllciBsb29wcwogICAgICAgICAgICBsb29wOiBmYWxzZSwKICAgICAgICAgICAgLy8gUmV3aW5kIHRvIGJlZ2lubmluZyB3aGVuIG1lZGlhIGVuZHMKICAgICAgICAgICAgYXV0b1Jld2luZDogZmFsc2UsCiAgICAgICAgICAgIC8vIFJlc2l6ZSB0byBtZWRpYSBkaW1lbnNpb25zCiAgICAgICAgICAgIGVuYWJsZUF1dG9zaXplOiB0cnVlLAogICAgICAgICAgICAvKgogICAgICAgICAgICAgKiBUaW1lIGZvcm1hdCB0byB1c2UuIERlZmF1bHQ6ICdtbTpzcycKICAgICAgICAgICAgICogU3VwcG9ydGVkIHVuaXRzOgogICAgICAgICAgICAgKiAgIGg6IGhvdXIKICAgICAgICAgICAgICogICBtOiBtaW51dGUKICAgICAgICAgICAgICogICBzOiBzZWNvbmQKICAgICAgICAgICAgICogICBmOiBmcmFtZSBjb3VudAogICAgICAgICAgICAgKiBXaGVuIHVzaW5nICdoaCcsICdtbScsICdzcycgb3IgJ2ZmJyB3ZSBhbHdheXMgZGlzcGxheSAyIGRpZ2l0cy4KICAgICAgICAgICAgICogSWYgeW91IHVzZSAnaCcsICdtJywgJ3MnIG9yICdmJyB3ZSBkaXNwbGF5IDEgZGlnaXQgaWYgcG9zc2libGUuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEV4YW1wbGUgdG8gZGlzcGxheSA3NSBzZWNvbmRzOgogICAgICAgICAgICAgKiBGb3JtYXQgJ21tOnNzJzogMDE6MTUKICAgICAgICAgICAgICogRm9ybWF0ICdtOnNzJzogMToxNQogICAgICAgICAgICAgKiBGb3JtYXQgJ206cyc6IDE6MTUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIHRpbWVGb3JtYXQ6ICcnLAogICAgICAgICAgICAvLyBGb3JjZSB0aGUgaG91ciBtYXJrZXIgKCMjOjAwOjAwKQogICAgICAgICAgICBhbHdheXNTaG93SG91cnM6IGZhbHNlLAogICAgICAgICAgICAvLyBTaG93IGZyYW1lY291bnQgaW4gdGltZWNvZGUgKCMjOjAwOjAwOjAwKQogICAgICAgICAgICBzaG93VGltZWNvZGVGcmFtZUNvdW50OiBmYWxzZSwKICAgICAgICAgICAgLy8gVXNlZCB3aGVuIHNob3dUaW1lY29kZUZyYW1lQ291bnQgaXMgc2V0IHRvIHRydWUKICAgICAgICAgICAgZnJhbWVzUGVyU2Vjb25kOiAyNSwKICAgICAgICAgICAgLy8gSGlkZSBjb250cm9scyB3aGVuIHBsYXlpbmcgYW5kIG1vdXNlIGlzIG5vdCBvdmVyIHRoZSB2aWRlbwogICAgICAgICAgICBhbHdheXNTaG93Q29udHJvbHM6IGZhbHNlLAogICAgICAgICAgICAvLyBEaXNwbGF5IHRoZSB2aWRlbyBjb250cm9sIHdoZW4gbWVkaWEgaXMgbG9hZGluZwogICAgICAgICAgICBoaWRlVmlkZW9Db250cm9sc09uTG9hZDogZmFsc2UsCiAgICAgICAgICAgIC8vIERpc3BsYXkgdGhlIHZpZGVvIGNvbnRyb2xzIHdoZW4gbWVkaWEgaXMgcGF1c2VkCiAgICAgICAgICAgIGhpZGVWaWRlb0NvbnRyb2xzT25QYXVzZTogZmFsc2UsCiAgICAgICAgICAgIC8vIEVuYWJsZSBjbGljayB2aWRlbyBlbGVtZW50IHRvIHRvZ2dsZSBwbGF5L3BhdXNlCiAgICAgICAgICAgIGNsaWNrVG9QbGF5UGF1c2U6IHRydWUsCiAgICAgICAgICAgIC8vIFRpbWUgaW4gbXMgdG8gaGlkZSBjb250cm9scwogICAgICAgICAgICBjb250cm9sc1RpbWVvdXREZWZhdWx0OiAxNTAwLAogICAgICAgICAgICAvLyBUaW1lIGluIG1zIHRvIHRyaWdnZXIgdGhlIHRpbWVyIHdoZW4gbW91c2UgbW92ZXMKICAgICAgICAgICAgY29udHJvbHNUaW1lb3V0TW91c2VFbnRlcjogMjUwMCwKICAgICAgICAgICAgLy8gVGltZSBpbiBtcyB0byB0cmlnZ2VyIHRoZSB0aW1lciB3aGVuIG1vdXNlIGxlYXZlcwogICAgICAgICAgICBjb250cm9sc1RpbWVvdXRNb3VzZUxlYXZlOiAxMDAwLAogICAgICAgICAgICAvLyBGb3JjZSBpUGFkJ3MgbmF0aXZlIGNvbnRyb2xzCiAgICAgICAgICAgIGlQYWRVc2VOYXRpdmVDb250cm9sczogZmFsc2UsCiAgICAgICAgICAgIC8vIEZvcmNlIGlQaG9uZSdzIG5hdGl2ZSBjb250cm9scwogICAgICAgICAgICBpUGhvbmVVc2VOYXRpdmVDb250cm9sczogZmFsc2UsCiAgICAgICAgICAgIC8vIEZvcmNlIEFuZHJvaWQncyBuYXRpdmUgY29udHJvbHMKICAgICAgICAgICAgQW5kcm9pZFVzZU5hdGl2ZUNvbnRyb2xzOiBmYWxzZSwKICAgICAgICAgICAgLy8gRmVhdHVyZXMgdG8gc2hvdwogICAgICAgICAgICBmZWF0dXJlczogWydwbGF5cGF1c2UnLCAndGltZXJuZXh0JywgJ3RpbWVycHJldicsICdwcm9ncmVzcycsICdwcm9ncmVzc2luc2lnaHQnLCAnY3VycmVudCcsICd2b2x1bWUnLCAnYWRkaW5zaWdodCcsICdhZGRub3RlJywgJ3Nob3dsb2dvJywgJ2Z1bGxzY3JlZW4nXSwKICAgICAgICAgICAgLy8gT25seSBmb3IgZHluYW1pYwogICAgICAgICAgICBpc1ZpZGVvOiB0cnVlLAogICAgICAgICAgICAvL9C/0L7QutCw0LfRi9Cy0LDRgtGMINC40LvQuCDQvdC10YIg0YLQtdC60YHRgiDRiNCw0LPQsAogICAgICAgICAgICBzaG93SGVscGVyczogZmFsc2UsCiAgICAgICAgICAgIC8v0L/QvtC60LDQt9GL0LLQsNGC0Ywg0LvQuCDQuNC90YHQsNC50YLRiyDQuCDRgdC+0LHRi9GC0LjRjyDQtNC70Y8g0L3QuNGFCiAgICAgICAgICAgIHNob3dJbnNpZ2h0OiBmYWxzZSwKICAgICAgICAgICAgLy/Qv9C+0LrQsNC30YvQstCw0YLRjCDQu9C4INC40L3RgdCw0LnRgtGLINC4INGB0L7QsdGL0YLQuNGPINC00LvRjyDQvdC40YUKICAgICAgICAgICAgc2hvd0luc2lnaHREdXJhdGlvbjogZmFsc2UsCiAgICAgICAgICAgIC8v0L/QvtC60LDQt9GL0LLQsNGC0Ywg0LvQuCDQvtGC0L7QsdGA0LDQttC10L3QuNC1INC40L3RgdCw0LnRgtC+0LIg0Lgg0YHQvtCx0YvRgtC40Y8g0LTQu9GPINC90LjRhQogICAgICAgICAgICBzaG93SW5zaWdodHM6IGZhbHNlLAogICAgICAgICAgICAvLyBTdHJldGNoaW5nIG1vZGVzIChhdXRvLCBmaWxsLCByZXNwb25zaXZlLCBub25lKQogICAgICAgICAgICBzdHJldGNoaW5nOiAnYXV0bycsCiAgICAgICAgICAgIC8vIFByZWZpeCBjbGFzcyBuYW1lcyBvbiBlbGVtZW50cwogICAgICAgICAgICBjbGFzc1ByZWZpeDogJ3V4Y19fJywKICAgICAgICAgICAgLy8gVHVybiBrZXlib2FyZCBzdXBwb3J0IG9uIGFuZCBvZmYgZm9yIHRoaXMgaW5zdGFuY2UKICAgICAgICAgICAgZW5hYmxlS2V5Ym9hcmQ6IHRydWUsCiAgICAgICAgICAgIC8v0L/QvtC60LDQt9GL0LLQsNGC0Ywg0LrQvdC+0L/QutGDINC00L7QsdCw0LLQuNGC0Ywg0LfQsNC80LXRgtC60YMKICAgICAgICAgICAgc2hvd0FkZE5vdGVzOiB0cnVlLAogICAgICAgICAgICAvLyBXaGVuIHRoaXMgcGxheWVyIHN0YXJ0cywgaXQgd2lsbCBwYXVzZSBvdGhlciBwbGF5ZXJzCiAgICAgICAgICAgIC8vINCy0YDQtdC80Y8g0L3QsNGH0LDQu9CwINC40L3RgdCw0LnRgtCwIChzZWMpCiAgICAgICAgICAgIHN0YXJ0SW5zaWdodDogMCwKICAgICAgICAgICAgLy8g0LLRgNC10LzRjyDQvtC60L7QvdGH0LDQvdC40Y8g0LjQvdGB0LDQudGC0LAgKHNlYykKICAgICAgICAgICAgZW5kSW5zaWdodDogMCwKICAgICAgICAgICAgLy/QvNCw0YHRgdC40LIg0L3QsNC20LDRgtC40Y8g0LvQutC8CiAgICAgICAgICAgIG1vdXNlZG93blhZOiBbMCwgMF0sCiAgICAgICAgICAgIC8v0L7RgtGA0LjRgdC+0LLQutCwINC60L7QvdGC0YDQvtC70LvQtdGA0L7QsiDQuNC90YHQsNC50YLQsAogICAgICAgICAgICBzaG93SW5zaWdodENvbnRyb2xzOiBmYWxzZSwKICAgICAgICAgICAgLy/QvNCw0YHRgdC40LIg0LrQvtC+0YDQtNC40L3QsNGCINC30LDQttCw0YLQuNGPINC70LrQvAogICAgICAgICAgICBtb3VzZWRvd25idG5YWTogWzAsIDBdLAogICAgICAgICAgICAvL9C30LDQttCw0YIg0LvQuCDQu9C60Lwg0L3QsNC0INC40L3QtNC10LrQsNGC0L7RgNC+0Lwg0LrRgNCw0LXQsiDRgtCw0LnQvNC70LDQudC90LAg0LjQvdGB0LDQudGC0LAKICAgICAgICAgICAgc3RhdHVzTW91c2VVcDogZmFsc2UsCiAgICAgICAgICAgIC8v0L7RgtC60YDRi9GCINC70Lgg0LzQvtC00LDQu9GM0L3QuNC6INGBINC40L3RgdCw0LnRgtC+0LwKICAgICAgICAgICAgc2hvd01vZGFsSW5zaWdodDogZmFsc2UsCiAgICAgICAgICAgIC8vIEFycmF5IG9mIGtleWJvYXJkIGFjdGlvbnMgc3VjaCBhcyBwbGF5L3BhdXNlCiAgICAgICAgICAgIGtleUFjdGlvbnM6IFt7CiAgICAgICAgICAgICAgICBrZXlzOiBbMzhdLCAvLyBVUAogICAgICAgICAgICAgICAgYWN0aW9uOiBmdW5jdGlvbiBhY3Rpb24ocGxheWVyLCBtZWRpYSkgewoKICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyLmNvbnRhaW5lci5maW5kKCcuJyArIGNvbmZpZy5jbGFzc1ByZWZpeCArICd2b2x1bWUtYnV0dG9uPmJ1dHRvbicpLmlzKCc6Zm9jdXMnKSB8fCBwbGF5ZXIuY29udGFpbmVyLmZpbmQoJy4nICsgY29uZmlnLmNsYXNzUHJlZml4ICsgJ3ZvbHVtZS1zbGlkZXInKS5pcygnOmZvY3VzJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLmNvbnRhaW5lci5maW5kKCcuJyArIGNvbmZpZy5jbGFzc1ByZWZpeCArICd2b2x1bWUtc2xpZGVyJykuY3NzKCdkaXNwbGF5JywgJ2Jsb2NrJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXIuaXNWaWRlbykgewogICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuc2hvd0NvbnRyb2xzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5zdGFydENvbnRyb2xzVGltZXIoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBuZXdWb2x1bWUgPSBNYXRoLm1pbihtZWRpYS52b2x1bWUgKyAwLjEsIDEpOwogICAgICAgICAgICAgICAgICAgIG1lZGlhLnNldFZvbHVtZShuZXdWb2x1bWUpOwogICAgICAgICAgICAgICAgICAgIGlmIChuZXdWb2x1bWUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnNldE11dGVkKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleXM6IFs0MF0sIC8vIERPV04KICAgICAgICAgICAgICAgIGFjdGlvbjogZnVuY3Rpb24gYWN0aW9uKHBsYXllciwgbWVkaWEpIHsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYXllci5jb250YWluZXIuZmluZCgnLicgKyBjb25maWcuY2xhc3NQcmVmaXggKyAndm9sdW1lLWJ1dHRvbj5idXR0b24nKS5pcygnOmZvY3VzJykgfHwgcGxheWVyLmNvbnRhaW5lci5maW5kKCcuJyArIGNvbmZpZy5jbGFzc1ByZWZpeCArICd2b2x1bWUtc2xpZGVyJykuaXMoJzpmb2N1cycpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5jb250YWluZXIuZmluZCgnLicgKyBjb25maWcuY2xhc3NQcmVmaXggKyAndm9sdW1lLXNsaWRlcicpLmNzcygnZGlzcGxheScsICdibG9jaycpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHBsYXllci5pc1ZpZGVvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5zaG93Q29udHJvbHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLnN0YXJ0Q29udHJvbHNUaW1lcigpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1ZvbHVtZSA9IE1hdGgubWF4KG1lZGlhLnZvbHVtZSAtIDAuMSwgMCk7CiAgICAgICAgICAgICAgICAgICAgbWVkaWEuc2V0Vm9sdW1lKG5ld1ZvbHVtZSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChuZXdWb2x1bWUgPD0gMC4xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnNldE11dGVkKHRydWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAga2V5czogWzM3LCAvLyBMRUZUCiAgICAgICAgICAgICAgICAgICAgMjI3IC8vIEdvb2dsZSBUViByZXdpbmQKICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICBhY3Rpb246IGZ1bmN0aW9uIGFjdGlvbihwbGF5ZXIsIG1lZGlhLCBrZXljb2RlLCBlLCB0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy4kaW5zaWdodFBhbmVsQWN0aXZlIT1udWxsICYmIHQub3B0aW9ucy4kaW5zaWdodFBhbmVsQWN0aXZlLmlzKCc6Zm9jdXMnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuJGluc2lnaHRQYW5lbEFjdGl2ZS5oYXNDbGFzcygncmlnaHRfcGFuZWwnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5jdHJsS2V5KXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYS5zaG93SW5zaWdodExpbmUobWVkaWEsdCxudWxsLG51bGwsdC5vcHRpb25zLmN1cnJlbnRUaW1lclN0YXJ0LHQub3B0aW9ucy5jdXJyZW50VGltZXJTdG9wLTEsdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnNob3dJbnNpZ2h0TGluZShtZWRpYSx0LG51bGwsbnVsbCx0Lm9wdGlvbnMuY3VycmVudFRpbWVyU3RhcnQsdC5vcHRpb25zLmN1cnJlbnRUaW1lclN0b3AtNSx0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLiRpbnNpZ2h0UGFuZWxBY3RpdmUhPW51bGwgJiYgdC5vcHRpb25zLiRpbnNpZ2h0UGFuZWxBY3RpdmUuaGFzQ2xhc3MoJ2xlZnRfcGFuZWwnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5jdHJsS2V5KXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYS5zaG93SW5zaWdodExpbmUobWVkaWEsdCxudWxsLG51bGwsdC5vcHRpb25zLmN1cnJlbnRUaW1lclN0YXJ0LTEsdC5vcHRpb25zLmN1cnJlbnRUaW1lclN0b3AsdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnNob3dJbnNpZ2h0TGluZShtZWRpYSx0LG51bGwsbnVsbCx0Lm9wdGlvbnMuY3VycmVudFRpbWVyU3RhcnQtNSx0Lm9wdGlvbnMuY3VycmVudFRpbWVyU3RvcCx0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICghaXNOYU4obWVkaWEuZHVyYXRpb24pICYmIG1lZGlhLmR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyLmlzVmlkZW8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5zaG93Q29udHJvbHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5zdGFydENvbnRyb2xzVGltZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VGltZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUuY3RybEtleSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdUaW1lID0gTWF0aC5taW4obWVkaWEuY3VycmVudFRpbWUgLSAxLCBtZWRpYS5kdXJhdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdUaW1lID0gTWF0aC5tYXgobWVkaWEuY3VycmVudFRpbWUgLSBwbGF5ZXIub3B0aW9ucy5kZWZhdWx0U2Vla0JhY2t3YXJkSW50ZXJ2YWwobWVkaWEpLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYS5zZXRDdXJyZW50VGltZShuZXdUaW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleXM6IFszOSwgLy8gUklHSFQKICAgICAgICAgICAgICAgICAgICAyMjggLy8gR29vZ2xlIFRWIGZvcndhcmQKICAgICAgICAgICAgICAgIF0sCiAgICAgICAgICAgICAgICBhY3Rpb246IGZ1bmN0aW9uIGFjdGlvbihwbGF5ZXIsIG1lZGlhLCBrZXljb2RlLCBlLCB0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy4kaW5zaWdodFBhbmVsQWN0aXZlIT1udWxsICYmIHQub3B0aW9ucy4kaW5zaWdodFBhbmVsQWN0aXZlLmlzKCc6Zm9jdXMnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuJGluc2lnaHRQYW5lbEFjdGl2ZS5oYXNDbGFzcygncmlnaHRfcGFuZWwnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5jdHJsS2V5KXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYS5zaG93SW5zaWdodExpbmUobWVkaWEsdCxudWxsLG51bGwsdC5vcHRpb25zLmN1cnJlbnRUaW1lclN0YXJ0LHQub3B0aW9ucy5jdXJyZW50VGltZXJTdG9wKzEsdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnNob3dJbnNpZ2h0TGluZShtZWRpYSx0LG51bGwsbnVsbCx0Lm9wdGlvbnMuY3VycmVudFRpbWVyU3RhcnQsdC5vcHRpb25zLmN1cnJlbnRUaW1lclN0b3ArNSx0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLiRpbnNpZ2h0UGFuZWxBY3RpdmUhPW51bGwgJiYgdC5vcHRpb25zLiRpbnNpZ2h0UGFuZWxBY3RpdmUuaGFzQ2xhc3MoJ2xlZnRfcGFuZWwnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5jdHJsS2V5KXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYS5zaG93SW5zaWdodExpbmUobWVkaWEsdCxudWxsLG51bGwsdC5vcHRpb25zLmN1cnJlbnRUaW1lclN0YXJ0KzEsdC5vcHRpb25zLmN1cnJlbnRUaW1lclN0b3AsdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnNob3dJbnNpZ2h0TGluZShtZWRpYSx0LG51bGwsbnVsbCx0Lm9wdGlvbnMuY3VycmVudFRpbWVyU3RhcnQrNSx0Lm9wdGlvbnMuY3VycmVudFRpbWVyU3RvcCx0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICghaXNOYU4obWVkaWEuZHVyYXRpb24pICYmIG1lZGlhLmR1cmF0aW9uID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyLmlzVmlkZW8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5zaG93Q29udHJvbHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXllci5zdGFydENvbnRyb2xzVGltZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VGltZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUuY3RybEtleSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdUaW1lID0gTWF0aC5taW4obWVkaWEuY3VycmVudFRpbWUgKyAxLCBtZWRpYS5kdXJhdGlvbik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdUaW1lID0gTWF0aC5taW4obWVkaWEuY3VycmVudFRpbWUgKyBwbGF5ZXIub3B0aW9ucy5kZWZhdWx0U2Vla0ZvcndhcmRJbnRlcnZhbChtZWRpYSksIG1lZGlhLmR1cmF0aW9uKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYS5zZXRDdXJyZW50VGltZShuZXdUaW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgXQogICAgICAgIH07CgogICAgICAgIF9tZWpzMi5kZWZhdWx0Lk1lcERlZmF1bHRzID0gY29uZmlnOwoKICAgICAgICAvKioKICAgICAgICAgKiBXcmFwIGEgTWVkaWFFbGVtZW50IG9iamVjdCBpbiBwbGF5ZXIgY29udHJvbHMKICAgICAgICAgKgogICAgICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IG5vZGUKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gbwogICAgICAgICAqIEByZXR1cm4gez9NZWRpYUVsZW1lbnRQbGF5ZXJ9CiAgICAgICAgICovCgogICAgICAgIHZhciBNZWRpYUVsZW1lbnRQbGF5ZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIE1lZGlhRWxlbWVudFBsYXllcihub2RlLCBvKSB7CiAgICAgICAgICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgTWVkaWFFbGVtZW50UGxheWVyKTsKCiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXM7CgogICAgICAgICAgICAgICAgdC5oYXNGb2N1cyA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIHQuY29udHJvbHNBcmVWaXNpYmxlID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICB0LmNvbnRyb2xzRW5hYmxlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgdC5jb250cm9sc1RpbWVyID0gbnVsbDsKCiAgICAgICAgICAgICAgICAvLyBlbmZvcmNlIG9iamVjdCwgZXZlbiB3aXRob3V0ICJuZXciICh2aWEgSm9obiBSZXNpZykKICAgICAgICAgICAgICAgIGlmICghKHQgaW5zdGFuY2VvZiBNZWRpYUVsZW1lbnRQbGF5ZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBNZWRpYUVsZW1lbnRQbGF5ZXIobm9kZSwgbyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gdGhlc2Ugd2lsbCBiZSByZXNldCBhZnRlciB0aGUgTWVkaWFFbGVtZW50LnN1Y2Nlc3MgZmlyZXMKICAgICAgICAgICAgICAgIHQuJG1lZGlhID0gdC4kbm9kZSA9ICQobm9kZSk7CiAgICAgICAgICAgICAgICB0Lm5vZGUgPSB0Lm1lZGlhID0gdC4kbWVkaWFbMF07CgogICAgICAgICAgICAgICAgaWYgKCF0Lm5vZGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gY2hlY2sgZm9yIGV4aXN0aW5nIHBsYXllcgogICAgICAgICAgICAgICAgaWYgKHQubm9kZS5wbGF5ZXIgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0Lm5vZGUucGxheWVyOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHRyeSB0byBnZXQgb3B0aW9ucyBmcm9tIGRhdGEtbWVqc29wdGlvbnMKICAgICAgICAgICAgICAgIGlmIChvID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBvID0gdC4kbm9kZS5kYXRhKCdtZWpzb3B0aW9ucycpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGV4dGVuZCBkZWZhdWx0IG9wdGlvbnMKICAgICAgICAgICAgICAgIHQub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIGNvbmZpZywgbyk7CgogICAgICAgICAgICAgICAgaWYgKCF0Lm9wdGlvbnMudGltZUZvcm1hdCkgewogICAgICAgICAgICAgICAgICAgIC8vIEdlbmVyYXRlIHRoZSB0aW1lIGZvcm1hdCBhY2NvcmRpbmcgdG8gb3B0aW9ucwogICAgICAgICAgICAgICAgICAgIHQub3B0aW9ucy50aW1lRm9ybWF0ID0gJ21tOnNzJzsKICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLmFsd2F5c1Nob3dIb3VycykgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9wdGlvbnMudGltZUZvcm1hdCA9ICdoaDptbTpzcyc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuc2hvd1RpbWVjb2RlRnJhbWVDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9wdGlvbnMudGltZUZvcm1hdCArPSAnOmZmJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgKDAsIF90aW1lLmNhbGN1bGF0ZVRpbWVGb3JtYXQpKDAsIHQub3B0aW9ucywgdC5vcHRpb25zLmZyYW1lc1BlclNlY29uZCB8fCAyNSk7CgogICAgICAgICAgICAgICAgLy8gdW5pcXVlIElECiAgICAgICAgICAgICAgICB0LmlkID0gJ21lcF8nICsgX21lanMyLmRlZmF1bHQubWVwSW5kZXgrKzsKCiAgICAgICAgICAgICAgICAvLyBhZGQgdG8gcGxheWVyIGFycmF5IChmb3IgZm9jdXMgZXZlbnRzKQogICAgICAgICAgICAgICAgX21lanMyLmRlZmF1bHQucGxheWVyc1t0LmlkXSA9IHQ7CgogICAgICAgICAgICAgICAgLy8gc3RhcnQgdXAKICAgICAgICAgICAgICAgIHZhciBtZU9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCB0Lm9wdGlvbnMsIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gc3VjY2VzcyhtZWRpYSwgZG9tTm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5fbWVSZWFkeShtZWRpYSwgZG9tTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbiBlcnJvcihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Ll9oYW5kbGVFcnJvcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0Lm1lZGlhLnRhZ05hbWUudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgICAgICAgICAvLyBnZXQgdmlkZW8gZnJvbSBzcmMgb3IgaHJlZj8KICAgICAgICAgICAgICAgIHQuaXNEeW5hbWljID0gdGFnTmFtZSAhPT0gJ2F1ZGlvJyAmJiB0YWdOYW1lICE9PSAndmlkZW8nOwogICAgICAgICAgICAgICAgdC5pc1ZpZGVvID0gdC5pc0R5bmFtaWMgPyB0Lm9wdGlvbnMuaXNWaWRlbyA6IHRhZ05hbWUgIT09ICdhdWRpbycgJiYgdC5vcHRpb25zLmlzVmlkZW87CgogICAgICAgICAgICAgICAgLy8gdXNlIG5hdGl2ZSBjb250cm9scyBpbiBpUGFkLCBpUGhvbmUsIGFuZCBBbmRyb2lkCiAgICAgICAgICAgICAgICBpZiAoX2NvbnN0YW50cy5JU19JUEFEICYmIHQub3B0aW9ucy5pUGFkVXNlTmF0aXZlQ29udHJvbHMgfHwgX2NvbnN0YW50cy5JU19JUEhPTkUgJiYgdC5vcHRpb25zLmlQaG9uZVVzZU5hdGl2ZUNvbnRyb2xzKSB7CgogICAgICAgICAgICAgICAgICAgIC8vIGFkZCBjb250cm9scyBhbmQgc3RvcAogICAgICAgICAgICAgICAgICAgIHQuJG1lZGlhLmF0dHIoJ2NvbnRyb2xzJywgJ2NvbnRyb2xzJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIG92ZXJyaWRlIEFwcGxlJ3MgYXV0b3BsYXkgb3ZlcnJpZGUgZm9yIGlQYWRzCiAgICAgICAgICAgICAgICAgICAgaWYgKF9jb25zdGFudHMuSVNfSVBBRCAmJiB0Lm1lZGlhLmdldEF0dHJpYnV0ZSgnYXV0b3BsYXknKSkgewogICAgICAgICAgICAgICAgICAgICAgICB0LnBsYXkoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKF9jb25zdGFudHMuSVNfQU5EUk9JRCAmJiB0Lm9wdGlvbnMuQW5kcm9pZFVzZU5hdGl2ZUNvbnRyb2xzKSB7CgogICAgICAgICAgICAgICAgICAgIC8vIGxlYXZlIGRlZmF1bHQgcGxheWVyCgogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0LmlzVmlkZW8gfHwgIXQuaXNWaWRlbyAmJiB0Lm9wdGlvbnMuZmVhdHVyZXMubGVuZ3RoKSB7CgogICAgICAgICAgICAgICAgICAgIC8vIERFU0tUT1A6IHVzZSBNZWRpYUVsZW1lbnRQbGF5ZXIgY29udHJvbHMKCiAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIG5hdGl2ZSBjb250cm9scwogICAgICAgICAgICAgICAgICAgIHQuJG1lZGlhLnJlbW92ZUF0dHIoJ2NvbnRyb2xzJyk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHZpZGVvUGxheWVyVGl0bGUgPSB0LmlzVmlkZW8gPyBfaTE4bjIuZGVmYXVsdC50KCdtZWpzLnZpZGVvLXBsYXllcicpIDogX2kxOG4yLmRlZmF1bHQudCgnbWVqcy5hdWRpby1wbGF5ZXInKTsKICAgICAgICAgICAgICAgICAgICAvLyBpbnNlcnQgZGVzY3JpcHRpb24gZm9yIHNjcmVlbiByZWFkZXJzCiAgICAgICAgICAgICAgICAgICAgJCgnPHNwYW4gY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb2Zmc2NyZWVuIj4nICsgdmlkZW9QbGF5ZXJUaXRsZSArICc8L3NwYW4+JykuaW5zZXJ0QmVmb3JlKHQuJG1lZGlhKTsKICAgICAgICAgICAgICAgICAgICAvLyBidWlsZCBjb250YWluZXIKICAgICAgICAgICAgICAgICAgICB0LmNvbnRhaW5lciA9ICQoJzxkaXYgaWQ9IicgKyB0LmlkICsgJyIgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY29udGFpbmVyICcgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY29udGFpbmVyLWtleWJvYXJkLWluYWN0aXZlIicgKyAoJ3RhYmluZGV4PSIwIiByb2xlPSJhcHBsaWNhdGlvbiIgYXJpYS1sYWJlbD0iJyArIHZpZGVvUGxheWVyVGl0bGUgKyAnIj4nKSArICgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdpbm5lciI+JykgKyAoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnbWVkaWFlbGVtZW50Ij48L2Rpdj4nKSArICgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdsYXllcnMiPjwvZGl2PicpICsgKCc8ZGl2IGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NvbnRyb2xzIj48L2Rpdj4nKSArICgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjbGVhciI+PC9kaXY+JykgKyAnPC9kaXY+JyArICc8L2Rpdj4nKS5hZGRDbGFzcyh0LiRtZWRpYVswXS5jbGFzc05hbWUpLmluc2VydEJlZm9yZSh0LiRtZWRpYSkuZm9jdXMoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0LmNvbnRyb2xzQXJlVmlzaWJsZSAmJiAhdC5oYXNGb2N1cyAmJiB0LmNvbnRyb2xzRW5hYmxlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5zaG93Q29udHJvbHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbiB2ZXJzaW9ucyBvbGRlciB0aGFuIElFMTEsIHRoZSBmb2N1cyBjYXVzZXMgdGhlIHBsYXliYXIgdG8gYmUgZGlzcGxheWVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB1c2VyIGNsaWNrcyBvbiB0aGUgUGxheS9QYXVzZSBidXR0b24gaW4gdGhlIGNvbnRyb2wgYmFyIG9uY2UgaXQgYXR0ZW1wdHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvIGhpZGUgaXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghX2NvbnN0YW50cy5IQVNfTVNfTkFUSVZFX0ZVTExTQ1JFRU4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiBlLnJlbGF0ZWRUYXJnZXQgYXBwZWFycyBiZWZvcmUgY29udGFpbmVyLCBzZW5kIGZvY3VzIHRvIHBsYXkgYnV0dG9uLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVsc2Ugc2VuZCBmb2N1cyB0byBsYXN0IGNvbnRyb2wgYnV0dG9uLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBidG5TZWxlY3RvciA9ICcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdwbGF5cGF1c2UtYnV0dG9uID4gYnV0dG9uJzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCgwLCBfZG9tLmlzTm9kZUFmdGVyKShlLnJlbGF0ZWRUYXJnZXQsIHQuY29udGFpbmVyWzBdKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidG5TZWxlY3RvciA9ICcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjb250cm9scyAuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdidXR0b246bGFzdC1jaGlsZCA+IGJ1dHRvbic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYnV0dG9uID0gdC5jb250YWluZXIuZmluZChidG5TZWxlY3Rvcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uLmZvY3VzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gV2hlbiBubyBlbGVtZW50cyBpbiBjb250cm9scywgaGlkZSBiYXIgY29tcGxldGVseQogICAgICAgICAgICAgICAgICAgIGlmICghdC5vcHRpb25zLmZlYXR1cmVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci5jc3MoJ2JhY2tncm91bmQnLCAndHJhbnNwYXJlbnQnKS5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjb250cm9scycpLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0LmlzVmlkZW8gJiYgdC5vcHRpb25zLnN0cmV0Y2hpbmcgPT09ICdmaWxsJyAmJiAhdC5jb250YWluZXIucGFyZW50KCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdmaWxsLWNvbnRhaW5lcicpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBvdXRlciBjb250YWluZXIKICAgICAgICAgICAgICAgICAgICAgICAgdC5vdXRlckNvbnRhaW5lciA9IHQuJG1lZGlhLnBhcmVudCgpOwogICAgICAgICAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci53cmFwKCc8ZGl2IGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2ZpbGwtY29udGFpbmVyIi8+Jyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBhZGQgY2xhc3NlcyBmb3IgdXNlciBhbmQgY29udGVudAogICAgICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLmFkZENsYXNzKChfY29uc3RhbnRzLklTX0FORFJPSUQgPyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnYW5kcm9pZCAnIDogJycpICsgKF9jb25zdGFudHMuSVNfSU9TID8gdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2lvcyAnIDogJycpICsgKF9jb25zdGFudHMuSVNfSVBBRCA/IHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdpcGFkICcgOiAnJykgKyAoX2NvbnN0YW50cy5JU19JUEhPTkUgPyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnaXBob25lICcgOiAnJykgKyAodC5pc1ZpZGVvID8gdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3ZpZGVvICcgOiB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnYXVkaW8gJykpOwoKICAgICAgICAgICAgICAgICAgICAvLyBtb3ZlIHRoZSA8dmlkZW8vdmlkZW8+IHRhZyBpbnRvIHRoZSByaWdodCBzcG90CiAgICAgICAgICAgICAgICAgICAgdC5jb250YWluZXIuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnbWVkaWFlbGVtZW50JykuYXBwZW5kKHQuJG1lZGlhKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gbmVlZHMgdG8gYmUgYXNzaWduZWQgaGVyZSwgYWZ0ZXIgaU9TIHJlbWFwCiAgICAgICAgICAgICAgICAgICAgdC5ub2RlLnBsYXllciA9IHQ7CgogICAgICAgICAgICAgICAgICAgIC8vIGZpbmQgcGFydHMKICAgICAgICAgICAgICAgICAgICB0LmNvbnRyb2xzID0gdC5jb250YWluZXIuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY29udHJvbHMnKTsKICAgICAgICAgICAgICAgICAgICB0LmxheWVycyA9IHQuY29udGFpbmVyLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2xheWVycycpOwoKICAgICAgICAgICAgICAgICAgICAvLyBkZXRlcm1pbmUgdGhlIHNpemUKCiAgICAgICAgICAgICAgICAgICAgLyogc2l6ZSBwcmlvcml0eToKICAgICAgICAgICAgICAgICAgICAgKDEpIHZpZGVvV2lkdGggKGZvcmNlZCksCiAgICAgICAgICAgICAgICAgICAgICgyKSBzdHlsZT0id2lkdGg7aGVpZ2h0OyIKICAgICAgICAgICAgICAgICAgICAgKDMpIHdpZHRoIGF0dHJpYnV0ZSwKICAgICAgICAgICAgICAgICAgICAgKDQpIGRlZmF1bHRWaWRlb1dpZHRoIChmb3IgdW5zcGVjaWZpZWQgY2FzZXMpCiAgICAgICAgICAgICAgICAgICAgICovCgogICAgICAgICAgICAgICAgICAgIHZhciB0YWdUeXBlID0gdC5pc1ZpZGVvID8gJ3ZpZGVvJyA6ICdhdWRpbycsCiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHNUYWdOYW1lID0gdGFnVHlwZS5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHRhZ1R5cGUuc3Vic3RyaW5nKDEpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zW3RhZ1R5cGUgKyAnV2lkdGgnXSA+IDAgfHwgdC5vcHRpb25zW3RhZ1R5cGUgKyAnV2lkdGgnXS50b1N0cmluZygpLmluZGV4T2YoJyUnKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQud2lkdGggPSB0Lm9wdGlvbnNbdGFnVHlwZSArICdXaWR0aCddOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodC5tZWRpYS5zdHlsZS53aWR0aCAhPT0gJycgJiYgdC5tZWRpYS5zdHlsZS53aWR0aCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0LndpZHRoID0gdC5tZWRpYS5zdHlsZS53aWR0aDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHQubWVkaWEuZ2V0QXR0cmlidXRlKCd3aWR0aCcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQud2lkdGggPSB0LiRtZWRpYS5hdHRyKCd3aWR0aCcpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQud2lkdGggPSB0Lm9wdGlvbnNbJ2RlZmF1bHQnICsgY2Fwc1RhZ05hbWUgKyAnV2lkdGgnXTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnNbdGFnVHlwZSArICdIZWlnaHQnXSA+IDAgfHwgdC5vcHRpb25zW3RhZ1R5cGUgKyAnSGVpZ2h0J10udG9TdHJpbmcoKS5pbmRleE9mKCclJykgPiAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICB0LmhlaWdodCA9IHQub3B0aW9uc1t0YWdUeXBlICsgJ0hlaWdodCddOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodC5tZWRpYS5zdHlsZS5oZWlnaHQgIT09ICcnICYmIHQubWVkaWEuc3R5bGUuaGVpZ2h0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuaGVpZ2h0ID0gdC5tZWRpYS5zdHlsZS5oZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0LiRtZWRpYVswXS5nZXRBdHRyaWJ1dGUoJ2hlaWdodCcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuaGVpZ2h0ID0gdC4kbWVkaWEuYXR0cignaGVpZ2h0Jyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5oZWlnaHQgPSB0Lm9wdGlvbnNbJ2RlZmF1bHQnICsgY2Fwc1RhZ05hbWUgKyAnSGVpZ2h0J107CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0LmluaXRpYWxBc3BlY3RSYXRpbyA9IHQuaGVpZ2h0ID49IHQud2lkdGggPyB0LndpZHRoIC8gdC5oZWlnaHQgOiB0LmhlaWdodCAvIHQud2lkdGg7CgogICAgICAgICAgICAgICAgICAgIC8vIHNldCB0aGUgc2l6ZSwgd2hpbGUgd2Ugd2FpdCBmb3IgdGhlIHBsdWdpbnMgdG8gbG9hZCBiZWxvdwogICAgICAgICAgICAgICAgICAgIHQuc2V0UGxheWVyU2l6ZSh0LndpZHRoLCB0LmhlaWdodCk7CgogICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBNZWRpYUVsZW1lbnRTaGltCiAgICAgICAgICAgICAgICAgICAgbWVPcHRpb25zLnBsdWdpbldpZHRoID0gdC53aWR0aDsKICAgICAgICAgICAgICAgICAgICBtZU9wdGlvbnMucGx1Z2luSGVpZ2h0ID0gdC5oZWlnaHQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBIaWRlIG1lZGlhIGNvbXBsZXRlbHkgZm9yIGF1ZGlvIHRoYXQgZG9lc24ndCBoYXZlIGFueSBmZWF0dXJlcwogICAgICAgICAgICAgICAgZWxzZSBpZiAoIXQuaXNWaWRlbyAmJiAhdC5vcHRpb25zLmZlYXR1cmVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIHQuJG1lZGlhLmhpZGUoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBjcmVhdGUgTWVkaWFFbGVtZW50IHNoaW0KICAgICAgICAgICAgICAgIG5ldyBfbWVkaWFlbGVtZW50Mi5kZWZhdWx0KHQuJG1lZGlhWzBdLCBtZU9wdGlvbnMpOwoKICAgICAgICAgICAgICAgIGlmICh0LmNvbnRhaW5lciAhPT0gdW5kZWZpbmVkICYmIHQub3B0aW9ucy5mZWF0dXJlcy5sZW5ndGggJiYgdC5jb250cm9sc0FyZVZpc2libGUgJiYgIXQub3B0aW9ucy5oaWRlVmlkZW9Db250cm9sc09uTG9hZCkgewogICAgICAgICAgICAgICAgICAgIC8vIGNvbnRyb2xzIGFyZSBzaG93biB3aGVuIGxvYWRlZAogICAgICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLnRyaWdnZXIoJ2NvbnRyb2xzc2hvd24nKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgX2NyZWF0ZUNsYXNzKE1lZGlhRWxlbWVudFBsYXllciwgW3sKICAgICAgICAgICAgICAgIGtleTogJ3Nob3dDb250cm9scycsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gc2hvd0NvbnRyb2xzKGRvQW5pbWF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICBkb0FuaW1hdGlvbiA9IGRvQW5pbWF0aW9uID09PSB1bmRlZmluZWQgfHwgZG9BbmltYXRpb247CgogICAgICAgICAgICAgICAgICAgIGlmICh0LmNvbnRyb2xzQXJlVmlzaWJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZG9BbmltYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5jb250cm9scy5yZW1vdmVDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb2Zmc2NyZWVuJykuc3RvcCh0cnVlLCB0cnVlKS5mYWRlSW4oMjAwLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmNvbnRyb2xzQXJlVmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci50cmlnZ2VyKCdjb250cm9sc3Nob3duJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW55IGFkZGl0aW9uYWwgY29udHJvbHMgcGVvcGxlIG1pZ2h0IGFkZCBhbmQgd2FudCB0byBoaWRlCiAgICAgICAgICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NvbnRyb2wnKS5yZW1vdmVDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb2Zmc2NyZWVuJykuc3RvcCh0cnVlLCB0cnVlKS5mYWRlSW4oMjAwLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmNvbnRyb2xzQXJlVmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuY29udHJvbHMucmVtb3ZlQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ29mZnNjcmVlbicpLmNzcygnZGlzcGxheScsICdibG9jaycpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW55IGFkZGl0aW9uYWwgY29udHJvbHMgcGVvcGxlIG1pZ2h0IGFkZCBhbmQgd2FudCB0byBoaWRlCiAgICAgICAgICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NvbnRyb2wnKS5yZW1vdmVDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb2Zmc2NyZWVuJykuY3NzKCdkaXNwbGF5JywgJ2Jsb2NrJyk7CgogICAgICAgICAgICAgICAgICAgICAgICB0LmNvbnRyb2xzQXJlVmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLnRyaWdnZXIoJ2NvbnRyb2xzc2hvd24nKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHQuc2V0Q29udHJvbHNTaXplKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ2hpZGVDb250cm9scycsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gaGlkZUNvbnRyb2xzKGRvQW5pbWF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICBkb0FuaW1hdGlvbiA9IGRvQW5pbWF0aW9uID09PSB1bmRlZmluZWQgfHwgZG9BbmltYXRpb247CgogICAgICAgICAgICAgICAgICAgIGlmICghdC5jb250cm9sc0FyZVZpc2libGUgfHwgdC5vcHRpb25zLmFsd2F5c1Nob3dDb250cm9scyB8fCB0LmtleWJvYXJkQWN0aW9uIHx8IHQubWVkaWEucGF1c2VkICYmIHQubWVkaWEucmVhZHlTdGF0ZSA9PT0gNCAmJiAoIXQub3B0aW9ucy5oaWRlVmlkZW9Db250cm9sc09uTG9hZCAmJiB0Lm1lZGlhLmN1cnJlbnRUaW1lIDw9IDAgfHwgIXQub3B0aW9ucy5oaWRlVmlkZW9Db250cm9sc09uUGF1c2UgJiYgdC5tZWRpYS5jdXJyZW50VGltZSA+IDApIHx8IHQuaXNWaWRlbyAmJiAhdC5vcHRpb25zLmhpZGVWaWRlb0NvbnRyb2xzT25Mb2FkICYmICF0Lm1lZGlhLnJlYWR5U3RhdGUgfHwgdC5tZWRpYS5lbmRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoZG9BbmltYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmFkZSBvdXQgbWFpbiBjb250cm9scwogICAgICAgICAgICAgICAgICAgICAgICB0LmNvbnRyb2xzLnN0b3AodHJ1ZSwgdHJ1ZSkuZmFkZU91dCgyMDAsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ29mZnNjcmVlbicpLmNzcygnZGlzcGxheScsICdibG9jaycpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuY29udHJvbHNBcmVWaXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci50cmlnZ2VyKCdjb250cm9sc2hpZGRlbicpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFueSBhZGRpdGlvbmFsIGNvbnRyb2xzIHBlb3BsZSBtaWdodCBhZGQgYW5kIHdhbnQgdG8gaGlkZQogICAgICAgICAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjb250cm9sJykuc3RvcCh0cnVlLCB0cnVlKS5mYWRlT3V0KDIwMCwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb2Zmc2NyZWVuJykuY3NzKCdkaXNwbGF5JywgJ2Jsb2NrJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBoaWRlIG1haW4gY29udHJvbHMKICAgICAgICAgICAgICAgICAgICAgICAgdC5jb250cm9scy5hZGRDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb2Zmc2NyZWVuJykuY3NzKCdkaXNwbGF5JywgJ2Jsb2NrJyk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBoaWRlIG90aGVycwogICAgICAgICAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjb250cm9sJykuYWRkQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ29mZnNjcmVlbicpLmNzcygnZGlzcGxheScsICdibG9jaycpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdC5jb250cm9sc0FyZVZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdC5jb250YWluZXIudHJpZ2dlcignY29udHJvbHNoaWRkZW4nKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ3N0YXJ0Q29udHJvbHNUaW1lcicsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gc3RhcnRDb250cm9sc1RpbWVyKHRpbWVvdXQpIHsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gdHlwZW9mIHRpbWVvdXQgIT09ICd1bmRlZmluZWQnID8gdGltZW91dCA6IHQub3B0aW9ucy5jb250cm9sc1RpbWVvdXREZWZhdWx0OwoKICAgICAgICAgICAgICAgICAgICB0LmtpbGxDb250cm9sc1RpbWVyKCdzdGFydCcpOwoKICAgICAgICAgICAgICAgICAgICB0LmNvbnRyb2xzVGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5oaWRlQ29udHJvbHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdC5raWxsQ29udHJvbHNUaW1lcignaGlkZScpOwogICAgICAgICAgICAgICAgICAgIH0sIHRpbWVvdXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBrZXk6ICdraWxsQ29udHJvbHNUaW1lcicsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24ga2lsbENvbnRyb2xzVGltZXIoKSB7CgogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpczsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHQuY29udHJvbHNUaW1lciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodC5jb250cm9sc1RpbWVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHQuY29udHJvbHNUaW1lcjsKICAgICAgICAgICAgICAgICAgICAgICAgdC5jb250cm9sc1RpbWVyID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ2Rpc2FibGVDb250cm9scycsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZGlzYWJsZUNvbnRyb2xzKCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpczsKCiAgICAgICAgICAgICAgICAgICAgdC5raWxsQ29udHJvbHNUaW1lcigpOwogICAgICAgICAgICAgICAgICAgIHQuaGlkZUNvbnRyb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xzRW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBrZXk6ICdlbmFibGVDb250cm9scycsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZW5hYmxlQ29udHJvbHMoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICB0LnNob3dDb250cm9scyhmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgIHQuY29udHJvbHNFbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIFNldCB1cCBhbGwgY29udHJvbHMgYW5kIGV2ZW50cwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSBtZWRpYQogICAgICAgICAgICAgICAgICogQHBhcmFtIGRvbU5vZGUKICAgICAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ19tZVJlYWR5JywKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBfbWVSZWFkeShtZWRpYSwgZG9tTm9kZSkgewoKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9wbGF5QXR0ciA9IGRvbU5vZGUuZ2V0QXR0cmlidXRlKCdhdXRvcGxheScpLAogICAgICAgICAgICAgICAgICAgICAgICBhdXRvcGxheSA9ICEoYXV0b3BsYXlBdHRyID09PSB1bmRlZmluZWQgfHwgYXV0b3BsYXlBdHRyID09PSBudWxsIHx8IGF1dG9wbGF5QXR0ciA9PT0gJ2ZhbHNlJyksCiAgICAgICAgICAgICAgICAgICAgICAgIGlzTmF0aXZlID0gbWVkaWEucmVuZGVyZXJOYW1lICE9PSBudWxsICYmIG1lZGlhLnJlbmRlcmVyTmFtZS5tYXRjaCgvKG5hdGl2ZXxodG1sNSkvKSAhPT0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgLy8gbWFrZSBzdXJlIGl0IGNhbid0IGNyZWF0ZSBpdHNlbGYgYWdhaW4gaWYgYSBwbHVnaW4gcmVsb2FkcwogICAgICAgICAgICAgICAgICAgIGlmICh0LmNyZWF0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdC5jcmVhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhID0gbWVkaWE7CiAgICAgICAgICAgICAgICAgICAgdC5kb21Ob2RlID0gZG9tTm9kZTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCEoX2NvbnN0YW50cy5JU19BTkRST0lEICYmIHQub3B0aW9ucy5BbmRyb2lkVXNlTmF0aXZlQ29udHJvbHMpICYmICEoX2NvbnN0YW50cy5JU19JUEFEICYmIHQub3B0aW9ucy5pUGFkVXNlTmF0aXZlQ29udHJvbHMpICYmICEoX2NvbnN0YW50cy5JU19JUEhPTkUgJiYgdC5vcHRpb25zLmlQaG9uZVVzZU5hdGl2ZUNvbnRyb2xzKSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX3JldCA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJbiB0aGUgZXZlbnQgdGhhdCBubyBmZWF0dXJlcyBhcmUgc3BlY2lmaWVkIGZvciBhdWRpbywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBvbmx5IE1lZGlhRWxlbWVudCBpbnN0YW5jZSByYXRoZXIgdGhhbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZG9pbmcgYWxsIHRoZSB3b3JrIHRvIGNyZWF0ZSBhIGZ1bGwgcGxheWVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXQuaXNWaWRlbyAmJiAhdC5vcHRpb25zLmZlYXR1cmVzLmxlbmd0aCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmb3JjZSBhdXRvcGxheSBmb3IgSFRNTDUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXV0b3BsYXkgJiYgaXNOYXRpdmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLnN1Y2Nlc3MpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdC5vcHRpb25zLnN1Y2Nlc3MgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfd2luZG93Mi5kZWZhdWx0W3Qub3B0aW9ucy5zdWNjZXNzXSh0Lm1lZGlhLCB0LmRvbU5vZGUsIHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5vcHRpb25zLnN1Y2Nlc3ModC5tZWRpYSwgdC5kb21Ob2RlLCB0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjogdm9pZCAwCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0d28gYnVpbHQgaW4gZmVhdHVyZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuYnVpbGRwb3N0ZXIodCwgdC5jb250cm9scywgdC5sYXllcnMsIHQubWVkaWEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5idWlsZGtleWJvYXJkKHQsIHQuY29udHJvbHMsIHQubGF5ZXJzLCB0Lm1lZGlhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuYnVpbGRvdmVybGF5cyh0LCB0LmNvbnRyb2xzLCB0LmxheWVycywgdC5tZWRpYSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZ3JhYiBmb3IgdXNlIGJ5IGZlYXR1cmVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmZpbmRUcmFja3MoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGQgdXNlci1kZWZpbmVkIGZlYXR1cmVzL2NvbnRyb2xzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBmZWF0dXJlSW5kZXggaW4gdC5vcHRpb25zLmZlYXR1cmVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZlYXR1cmUgPSB0Lm9wdGlvbnMuZmVhdHVyZXNbZmVhdHVyZUluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodFsnYnVpbGQnICsgZmVhdHVyZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRbJ2J1aWxkJyArIGZlYXR1cmVdKHQsIHQuY29udHJvbHMsIHQubGF5ZXJzLCB0Lm1lZGlhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogcmVwb3J0IGNvbnRyb2wgZXJyb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ2Vycm9yIGJ1aWxkaW5nICcgKyBmZWF0dXJlLCBlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfY29uc3RhbnRzLklTX0lQQUQgfHwgX2NvbnN0YW50cy5JU19JUEhPTkUpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJ1tkYXRhLXRvZ2dsZT0icGxheWVyLXRvb2x0aXAiXScpLnRvb2x0aXAoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG15OiAiY2VudGVyIHRvcCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXQ6ICJjZW50ZXIgYm90dG9tKzUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246ICJmYXN0IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoaWRlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWZmZWN0OiAiaGlkZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci50cmlnZ2VyKCdjb250cm9sc3JlYWR5Jyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVzZXQgYWxsIGxheWVycyBhbmQgY29udHJvbHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuc2V0UGxheWVyU2l6ZSh0LndpZHRoLCB0LmhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnNldENvbnRyb2xzU2l6ZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnRyb2xzIGZhZGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0LmlzVmlkZW8pIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9jb25zdGFudHMuSEFTX1RPVUNIICYmICF0Lm9wdGlvbnMuYWx3YXlzU2hvd0NvbnRyb2xzKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmb3IgdG91Y2ggZGV2aWNlcyAoaU9TLCBBbmRyb2lkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzaG93L2hpZGUgd2l0aG91dCBhbmltYXRpb24gb24gdG91Y2gKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuJG1lZGlhLm9uKCd0b3VjaHN0YXJ0JywgZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvZ2dsZSBjb250cm9scwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQuY29udHJvbHNBcmVWaXNpYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5oaWRlQ29udHJvbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5jb250cm9sc0VuYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5zaG93Q29udHJvbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBjYWxsYmFjayBoZXJlIHNpbmNlIGl0IG5lZWRzIGFjY2VzcyB0byBjdXJyZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1lZGlhRWxlbWVudCBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5jbGlja1RvUGxheVBhdXNlQ2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy5jbGlja1RvUGxheVBhdXNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvbiA9IHQuJG1lZGlhLmNsb3Nlc3QoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NvbnRhaW5lcicpLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ292ZXJsYXktYnV0dG9uJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXNzZWQgPSBidXR0b24uYXR0cignYXJpYS1wcmVzc2VkJyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm1lZGlhLnBhdXNlZCAmJiBwcmVzc2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHQubWVkaWEucGF1c2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQucGxheSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbi5hdHRyKCdhcmlhLXByZXNzZWQnLCAhcHJlc3NlZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjbGljayB0byBwbGF5L3BhdXNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0LmNsaWNrVG9QbGF5UGF1c2VDYWxsYmFjaywgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0LmlmcmFtZU1vdXNlT3ZlciA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2hvdy9oaWRlIGNvbnRyb2xzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLm9uKCdtb3VzZWVudGVyJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQuY29udHJvbHNFbmFibGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0Lm9wdGlvbnMuYWx3YXlzU2hvd0NvbnRyb2xzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQua2lsbENvbnRyb2xzVGltZXIoJ2VudGVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuc2hvd0NvbnRyb2xzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuc3RhcnRDb250cm9sc1RpbWVyKHQub3B0aW9ucy5jb250cm9sc1RpbWVvdXRNb3VzZUVudGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLm9uKCdtb3VzZW1vdmUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5jb250cm9sc0VuYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXQuY29udHJvbHNBcmVWaXNpYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuc2hvd0NvbnRyb2xzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdC5vcHRpb25zLmFsd2F5c1Nob3dDb250cm9scykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnN0YXJ0Q29udHJvbHNUaW1lcih0Lm9wdGlvbnMuY29udHJvbHNUaW1lb3V0TW91c2VFbnRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5vbignbW91c2VsZWF2ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0LmNvbnRyb2xzRW5hYmxlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdC5tZWRpYS5wYXVzZWQgJiYgIXQub3B0aW9ucy5hbHdheXNTaG93Q29udHJvbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5zdGFydENvbnRyb2xzVGltZXIodC5vcHRpb25zLmNvbnRyb2xzVGltZW91dE1vdXNlTGVhdmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIH0pLm9uKCdtb3VzZW92ZXInLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIAl0LmlmcmFtZU1vdXNlT3ZlciA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIH0pLm9uKCdtb3VzZW91dCcsICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gCXQuaWZyYW1lTW91c2VPdmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zdCBtb25pdG9yID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gCWNvbnN0IGVsZW0gPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAJaWYgKGVsZW0gJiYgZWxlbS50YWdOYW1lID09PSAnSUZSQU1FJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyAJCXQuY2xpY2tUb1BsYXlQYXVzZUNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIAkJY2xlYXJJbnRlcnZhbChtb25pdG9yKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gCX0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gfSwgNTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy5oaWRlVmlkZW9Db250cm9sc09uTG9hZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmhpZGVDb250cm9scyhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayBmb3IgYXV0b3BsYXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXV0b3BsYXkgJiYgIXQub3B0aW9ucy5hbHdheXNTaG93Q29udHJvbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5oaWRlQ29udHJvbHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlc2l6ZXIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLmVuYWJsZUF1dG9zaXplKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEuYWRkRXZlbnRMaXN0ZW5lcignbG9hZGVkbWV0YWRhdGEnLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIDx2aWRlbyBoZWlnaHQ+IHdhcyBub3Qgc2V0IGFuZCB0aGUgb3B0aW9ucy52aWRlb0hlaWdodCB3YXMgbm90IHNldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlbiByZXNpemUgdG8gdGhlIHJlYWwgZGltZW5zaW9ucwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy52aWRlb0hlaWdodCA8PSAwICYmICF0LmRvbU5vZGUuZ2V0QXR0cmlidXRlKCdoZWlnaHQnKSAmJiAhaXNOYU4oZS50YXJnZXQudmlkZW9IZWlnaHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5zZXRQbGF5ZXJTaXplKGUudGFyZ2V0LnZpZGVvV2lkdGgsIGUudGFyZ2V0LnZpZGVvSGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnNldENvbnRyb2xzU2l6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEuc2V0U2l6ZShlLnRhcmdldC52aWRlb1dpZHRoLCBlLnRhcmdldC52aWRlb0hlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRVZFTlRTCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRk9DVVM6IHdoZW4gYSB2aWRlbyBzdGFydHMgcGxheWluZywgaXQgdGFrZXMgZm9jdXMgZnJvbSBvdGhlciBwbGF5ZXJzIChwb3NzaWJseSBwYXVzaW5nIHRoZW0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhLmFkZEV2ZW50TGlzdGVuZXIoJ3BsYXknLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5oYXNGb2N1cyA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGdvIHRocm91Z2ggYWxsIG90aGVyIHBsYXllcnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBwbGF5ZXJJbmRleCBpbiBfbWVqczIuZGVmYXVsdC5wbGF5ZXJzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwID0gX21lanMyLmRlZmF1bHQucGxheWVyc1twbGF5ZXJJbmRleF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLmlkICE9PSB0LmlkICYmIHQub3B0aW9ucy5wYXVzZU90aGVyUGxheWVycyAmJiAhcC5wYXVzZWQgJiYgIXAuZW5kZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuaGFzRm9jdXMgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZhbHNlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBlbmRlZCBmb3IgYWxsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhLmFkZEV2ZW50TGlzdGVuZXIoJ2VuZGVkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuYXV0b1Jld2luZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5zZXRDdXJyZW50VGltZSgwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpeGluZyBhbiBBbmRyb2lkIHN0b2NrIGJyb3dzZXIgYnVnLCB3aGVyZSAic2Vla2VkIiBpc24ndCBmaXJlZCBjb3JyZWN0bHkgYWZ0ZXIgZW5kaW5nIHRoZSB2aWRlbyBhbmQganVtcGluZyB0byB0aGUgYmVnaW5uaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfd2luZG93Mi5kZWZhdWx0LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodC5jb250YWluZXIpLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ292ZXJsYXktbG9hZGluZycpLnBhcmVudCgpLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDIwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXhwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdC5tZWRpYS5zdG9wID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0LnNldFByb2dyZXNzUmFpbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnNldFByb2dyZXNzUmFpbCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5zZXRDdXJyZW50UmFpbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnNldEN1cnJlbnRSYWlsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLmxvb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdC5vcHRpb25zLmFsd2F5c1Nob3dDb250cm9scyAmJiB0LmNvbnRyb2xzRW5hYmxlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnNob3dDb250cm9scygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZhbHNlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZXNpemUgb24gdGhlIGZpcnN0IHBsYXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEuYWRkRXZlbnRMaXN0ZW5lcignbG9hZGVkbWV0YWRhdGEnLCBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgwLCBfdGltZS5jYWxjdWxhdGVUaW1lRm9ybWF0KSh0LmR1cmF0aW9uLCB0Lm9wdGlvbnMsIHQub3B0aW9ucy5mcmFtZXNQZXJTZWNvbmQgfHwgMjUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC51cGRhdGVEdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnVwZGF0ZUR1cmF0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0LnVwZGF0ZUN1cnJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC51cGRhdGVDdXJyZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXQuaXNGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuc2V0UGxheWVyU2l6ZSh0LndpZHRoLCB0LmhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuc2V0Q29udHJvbHNTaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgY2hhbmdlIHRoZSB0aW1lIGZvcm1hdCB3aGVuIG5lY2Vzc2FyeQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGR1cmF0aW9uID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEuYWRkRXZlbnRMaXN0ZW5lcigndGltZXVwZGF0ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZHVyYXRpb24gIT09IHQubWVkaWEuZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYXRpb24gPSB0Lm1lZGlhLmR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoMCwgX3RpbWUuY2FsY3VsYXRlVGltZUZvcm1hdCkoZHVyYXRpb24sIHQub3B0aW9ucywgdC5vcHRpb25zLmZyYW1lc1BlclNlY29uZCB8fCAyNSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBtYWtlIHN1cmUgdG8gZmlsbCBpbiBhbmQgcmVzaXplIHRoZSBjb250cm9scyAoZS5nLiwgMDA6MDAgPT4gMDE6MTM6MTUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQudXBkYXRlRHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQudXBkYXRlRHVyYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC51cGRhdGVDdXJyZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnVwZGF0ZUN1cnJlbnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnNldENvbnRyb2xzU2l6ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZhbHNlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci5mb2N1c291dChmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlLnJlbGF0ZWRUYXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9GRiBpcyB3b3JraW5nIG9uIHN1cHBvcnRpbmcgZm9jdXNvdXQgaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9Njg3Nzg3CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkdGFyZ2V0ID0gJChlLnJlbGF0ZWRUYXJnZXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5rZXlib2FyZEFjdGlvbiAmJiAkdGFyZ2V0LnBhcmVudHMoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NvbnRhaW5lcicpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5rZXlib2FyZEFjdGlvbiA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQuaXNWaWRlbyAmJiAhdC5vcHRpb25zLmFsd2F5c1Nob3dDb250cm9scykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuaGlkZUNvbnRyb2xzKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2Via2l0IGhhcyB0cm91YmxlIGRvaW5nIHRoaXMgd2l0aG91dCBhIGRlbGF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnNldFBsYXllclNpemUodC53aWR0aCwgdC5oZWlnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuc2V0Q29udHJvbHNTaXplKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCA1MCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYWRqdXN0IGNvbnRyb2xzIHdoZW5ldmVyIHdpbmRvdyBzaXplcyAodXNlZCB0byBiZSBpbiBmdWxsc2NyZWVuIG9ubHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lmdsb2JhbEJpbmQoJ3Jlc2l6ZScsIGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZG9uJ3QgcmVzaXplIGZvciBmdWxsc2NyZWVuIG1vZGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoISh0LmlzRnVsbFNjcmVlbiB8fCBfY29uc3RhbnRzLkhBU19UUlVFX05BVElWRV9GVUxMU0NSRUVOICYmIF9kb2N1bWVudDIuZGVmYXVsdC53ZWJraXRJc0Z1bGxTY3JlZW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuc2V0UGxheWVyU2l6ZSh0LndpZHRoLCB0LmhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhbHdheXMgYWRqdXN0IGNvbnRyb2xzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5zZXRDb250cm9sc1NpemUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERpc2FibGUgZm9jdXMgb3V0bGluZSB0byBpbXByb3ZlIGxvb2stYW5kLWZlZWwgZm9yIHJlZ3VsYXIgdXNlcnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuZ2xvYmFsQmluZCgnY2xpY2snLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKGUudGFyZ2V0KS5pcygnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY29udGFpbmVyJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJChlLnRhcmdldCkuYWRkQ2xhc3ModC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NvbnRhaW5lci1rZXlib2FyZC1pbmFjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJChlLnRhcmdldCkuY2xvc2VzdCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY29udGFpbmVyJykubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZS50YXJnZXQpLmNsb3Nlc3QoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NvbnRhaW5lcicpLmFkZENsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjb250YWluZXIta2V5Ym9hcmQtaW5hY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBFbmFibGUgZm9jdXMgb3V0bGluZSBmb3IgQWNjZXNzaWJpbGl0eSBwdXJwb3NlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5nbG9iYWxCaW5kKCdrZXlkb3duJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJChlLnRhcmdldCkuaXMoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NvbnRhaW5lcicpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoZS50YXJnZXQpLnJlbW92ZUNsYXNzKHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjb250YWluZXIta2V5Ym9hcmQtaW5hY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQoZS50YXJnZXQpLmNsb3Nlc3QoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NvbnRhaW5lcicpLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGUudGFyZ2V0KS5jbG9zZXN0KCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdjb250YWluZXInKS5yZW1vdmVDbGFzcyh0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY29udGFpbmVyLWtleWJvYXJkLWluYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhIHdvcmstYXJvdW5kIGZvciBhIGJ1ZyBpbiB0aGUgWW91VHViZSBpRnJhbWUgcGxheWVyLCB3aGljaCBtZWFucwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8Jd2UgY2FuJ3QgdXNlIHRoZSBwbGF5KCkgQVBJIGZvciB0aGUgaW5pdGlhbCBwbGF5YmFjayBvbiBpT1Mgb3IgQW5kcm9pZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vCXVzZXIgaGFzIHRvIHN0YXJ0IHBsYXliYWNrIGRpcmVjdGx5IGJ5IHRhcHBpbmcgb24gdGhlIGlGcmFtZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm1lZGlhLnJlbmRlcmVyTmFtZSAhPT0gbnVsbCAmJiB0Lm1lZGlhLnJlbmRlcmVyTmFtZS5tYXRjaCgveW91dHViZS8pICYmIChfY29uc3RhbnRzLklTX0lPUyB8fCBfY29uc3RhbnRzLklTX0FORFJPSUQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5jb250YWluZXIuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb3ZlcmxheS1wbGF5JykuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3Bvc3RlcicpLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCh0eXBlb2YgX3JldCA9PT0gJ3VuZGVmaW5lZCcgPyAndW5kZWZpbmVkJyA6IF90eXBlb2YoX3JldCkpID09PSAib2JqZWN0IikgcmV0dXJuIF9yZXQudjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGZvcmNlIGF1dG9wbGF5IGZvciBIVE1MNQogICAgICAgICAgICAgICAgICAgIGlmIChhdXRvcGxheSAmJiBpc05hdGl2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0LnBsYXkoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0Lm9wdGlvbnMuc3VjY2VzcykgewoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0Lm9wdGlvbnMuc3VjY2VzcyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF93aW5kb3cyLmRlZmF1bHRbdC5vcHRpb25zLnN1Y2Nlc3NdKHQubWVkaWEsIHQuZG9tTm9kZSwgdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0Lm9wdGlvbnMuc3VjY2Vzcyh0Lm1lZGlhLCB0LmRvbU5vZGUsIHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7RXZlbnR9IGUKICAgICAgICAgICAgICAgICAqIEBwcml2YXRlCiAgICAgICAgICAgICAgICAgKi8KCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ19oYW5kbGVFcnJvcicsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gX2hhbmRsZUVycm9yKGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXM7CgogICAgICAgICAgICAgICAgICAgIGlmICh0LmNvbnRyb2xzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuZGlzYWJsZUNvbnRyb2xzKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBUZWxsIHVzZXIgdGhhdCB0aGUgZmlsZSBjYW5ub3QgYmUgcGxheWVkCiAgICAgICAgICAgICAgICAgICAgaWYgKHQub3B0aW9ucy5lcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm9wdGlvbnMuZXJyb3IoZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBrZXk6ICdzZXRQbGF5ZXJTaXplJywKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRQbGF5ZXJTaXplKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXM7CgogICAgICAgICAgICAgICAgICAgIGlmICghdC5vcHRpb25zLnNldERpbWVuc2lvbnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB3aWR0aCAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC53aWR0aCA9IHdpZHRoOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBoZWlnaHQgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBGQiAhPT0gJ3VuZGVmaW5lZCcgJiYgdC5pc1ZpZGVvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIEZCLkV2ZW50LnN1YnNjcmliZSgneGZibWwucmVhZHknLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gJCh0Lm1lZGlhKS5jaGlsZHJlbignLmZiLXZpZGVvJyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC53aWR0aCA9IHRhcmdldC53aWR0aCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5oZWlnaHQgPSB0YXJnZXQuaGVpZ2h0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnNldERpbWVuc2lvbnModC53aWR0aCwgdC5oZWlnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSAkKHQubWVkaWEpLmNoaWxkcmVuKCcuZmItdmlkZW8nKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LndpZHRoID0gdGFyZ2V0LndpZHRoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmhlaWdodCA9IHRhcmdldC5oZWlnaHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgc3RyZXRjaGluZyBtb2RlcwogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodC5vcHRpb25zLnN0cmV0Y2hpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZmlsbCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgJ2ZpbGwnIGVmZmVjdCBvbmx5IG1ha2VzIHNlbnNlIG9uIHZpZGVvOyBmb3IgYXVkaW8gd2Ugd2lsbCBzZXQgdGhlIGRpbWVuc2lvbnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0LmlzVmlkZW8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnNldEZpbGxNb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuc2V0RGltZW5zaW9ucyh0LndpZHRoLCB0LmhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncmVzcG9uc2l2ZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnNldFJlc3BvbnNpdmVNb2RlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbm9uZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LnNldERpbWVuc2lvbnModC53aWR0aCwgdC5oZWlnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgdGhlICdhdXRvJyBtb2RlCiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5oYXNGbHVpZE1vZGUoKSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuc2V0UmVzcG9uc2l2ZU1vZGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5zZXREaW1lbnNpb25zKHQud2lkdGgsIHQuaGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAga2V5OiAnaGFzRmx1aWRNb2RlJywKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBoYXNGbHVpZE1vZGUoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICAvLyBkZXRlY3QgMTAwJSBtb2RlIC0gdXNlIGN1cnJlbnRTdHlsZSBmb3IgSUUgc2luY2UgY3NzKCkgZG9lc24ndCByZXR1cm4gcGVyY2VudGFnZXMKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdC5oZWlnaHQudG9TdHJpbmcoKS5pbmNsdWRlcygnJScpIHx8IHQuJG5vZGUuY3NzKCdtYXgtd2lkdGgnKSAhPT0gJ25vbmUnICYmIHQuJG5vZGUuY3NzKCdtYXgtd2lkdGgnKSAhPT0gdC53aWR0aCB8fCB0LiRub2RlWzBdLmN1cnJlbnRTdHlsZSAmJiB0LiRub2RlWzBdLmN1cnJlbnRTdHlsZS5tYXhXaWR0aCA9PT0gJzEwMCUnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBrZXk6ICdzZXRSZXNwb25zaXZlTW9kZScsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gc2V0UmVzcG9uc2l2ZU1vZGUoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICAvLyBkbyB3ZSBoYXZlIHRoZSBuYXRpdmUgZGltZW5zaW9ucyB5ZXQ/CiAgICAgICAgICAgICAgICAgICAgdmFyIG5hdGl2ZVdpZHRoID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5pc1ZpZGVvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5tZWRpYS52aWRlb1dpZHRoICYmIHQubWVkaWEudmlkZW9XaWR0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdC5tZWRpYS52aWRlb1dpZHRoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0Lm1lZGlhLmdldEF0dHJpYnV0ZSgnd2lkdGgnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0Lm1lZGlhLmdldEF0dHJpYnV0ZSgnd2lkdGgnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHQub3B0aW9ucy5kZWZhdWx0VmlkZW9XaWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0Lm9wdGlvbnMuZGVmYXVsdEF1ZGlvV2lkdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KCk7CgogICAgICAgICAgICAgICAgICAgIHZhciBuYXRpdmVIZWlnaHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0LmlzVmlkZW8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm1lZGlhLnZpZGVvSGVpZ2h0ICYmIHQubWVkaWEudmlkZW9IZWlnaHQgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHQubWVkaWEudmlkZW9IZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHQubWVkaWEuZ2V0QXR0cmlidXRlKCdoZWlnaHQnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0Lm1lZGlhLmdldEF0dHJpYnV0ZSgnaGVpZ2h0Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0Lm9wdGlvbnMuZGVmYXVsdFZpZGVvSGVpZ2h0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHQub3B0aW9ucy5kZWZhdWx0QXVkaW9IZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KCk7CgogICAgICAgICAgICAgICAgICAgIC8vIFVzZSBtZWRpYSBhc3BlY3QgcmF0aW8gaWYgcmVjZWl2ZWQ7IG90aGVyd2lzZSwgdGhlIGluaXRpYWxseSBzdG9yZWQgaW5pdGlhbCBhc3BlY3QgcmF0aW8KICAgICAgICAgICAgICAgICAgICB2YXIgYXNwZWN0UmF0aW8gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmF0aW8gPSAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0LmlzVmlkZW8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQubWVkaWEudmlkZW9XaWR0aCAmJiB0Lm1lZGlhLnZpZGVvV2lkdGggPiAwICYmIHQubWVkaWEudmlkZW9IZWlnaHQgJiYgdC5tZWRpYS52aWRlb0hlaWdodCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByYXRpbyA9IHQuaGVpZ2h0ID49IHQud2lkdGggPyB0Lm1lZGlhLnZpZGVvV2lkdGggLyB0Lm1lZGlhLnZpZGVvSGVpZ2h0IDogdC5tZWRpYS52aWRlb0hlaWdodCAvIHQubWVkaWEudmlkZW9XaWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmF0aW8gPSB0LmluaXRpYWxBc3BlY3RSYXRpbzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNOYU4ocmF0aW8pIHx8IHJhdGlvIDwgMC4wMSB8fCByYXRpbyA+IDEwMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhdGlvID0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmF0aW87CiAgICAgICAgICAgICAgICAgICAgICAgIH0oKSwKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50V2lkdGggPSB0LmNvbnRhaW5lci5wYXJlbnQoKS5jbG9zZXN0KCc6dmlzaWJsZScpLndpZHRoKCksCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEhlaWdodCA9IHQuY29udGFpbmVyLnBhcmVudCgpLmNsb3Nlc3QoJzp2aXNpYmxlJykuaGVpZ2h0KCksCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0hlaWdodCA9IHZvaWQgMDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHQuaXNWaWRlbykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNwb25zaXZlIHZpZGVvIGlzIGJhc2VkIG9uIHdpZHRoOiAxMDAlIGFuZCBoZWlnaHQ6IDEwMCUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQuaGVpZ2h0ID09PSAnMTAwJScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0hlaWdodCA9IHBhcnNlSW50KHBhcmVudFdpZHRoICogbmF0aXZlSGVpZ2h0IC8gbmF0aXZlV2lkdGgsIDEwKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0hlaWdodCA9IHQuaGVpZ2h0ID49IHQud2lkdGggPyBwYXJzZUludChwYXJlbnRXaWR0aCAvIGFzcGVjdFJhdGlvLCAxMCkgOiBwYXJzZUludChwYXJlbnRXaWR0aCAqIGFzcGVjdFJhdGlvLCAxMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBuZXdIZWlnaHQgPSBuYXRpdmVIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBJZiB3ZSB3ZXJlIHVuYWJsZSB0byBjb21wdXRlIG5ld0hlaWdodCwgZ2V0IHRoZSBjb250YWluZXIgaGVpZ2h0IGluc3RlYWQKICAgICAgICAgICAgICAgICAgICBpZiAoaXNOYU4obmV3SGVpZ2h0KSkgewogICAgICAgICAgICAgICAgICAgICAgICBuZXdIZWlnaHQgPSBwYXJlbnRIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAodC5jb250YWluZXIucGFyZW50KCkubGVuZ3RoID4gMCAmJiB0LmNvbnRhaW5lci5wYXJlbnQoKVswXS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdib2R5JykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyAmJiB0LmNvbnRhaW5lci5zaWJsaW5ncygpLmNvdW50ID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50V2lkdGggPSAkKF93aW5kb3cyLmRlZmF1bHQpLndpZHRoKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0hlaWdodCA9ICQoX3dpbmRvdzIuZGVmYXVsdCkuaGVpZ2h0KCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAobmV3SGVpZ2h0ICYmIHBhcmVudFdpZHRoKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBzZXQgb3V0ZXIgY29udGFpbmVyIHNpemUKICAgICAgICAgICAgICAgICAgICAgICAgdC5jb250YWluZXIud2lkdGgocGFyZW50V2lkdGgpLmhlaWdodChuZXdIZWlnaHQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0IG5hdGl2ZSA8dmlkZW8+IG9yIDxhdWRpbz4gYW5kIHNoaW1zCiAgICAgICAgICAgICAgICAgICAgICAgIHQuJG1lZGlhLndpZHRoKCcxMDAlJykuaGVpZ2h0KCcxMDAlJyk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiBzaGltIGlzIHJlYWR5LCBzZW5kIHRoZSBzaXplIHRvIHRoZSBlbWJlZGRlZCBwbHVnaW4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQuaXNWaWRlbykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQubWVkaWEuc2V0U2l6ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEuc2V0U2l6ZShwYXJlbnRXaWR0aCwgbmV3SGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0IHRoZSBsYXllcnMKICAgICAgICAgICAgICAgICAgICAgICAgdC5sYXllcnMuY2hpbGRyZW4oJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2xheWVyJykud2lkdGgoJzEwMCUnKS5oZWlnaHQoJzEwMCUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ3NldEZpbGxNb2RlJywKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRGaWxsTW9kZSgpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudCA9IHQub3V0ZXJDb250YWluZXI7CgogICAgICAgICAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgcmVzcG9uc2l2ZSBhdHRyaWJ1dGVzIGluIHRoZSBldmVudCB0aGV5IGFyZSB0aGVyZQogICAgICAgICAgICAgICAgICAgIGlmICh0LiRub2RlLmNzcygnaGVpZ2h0JykgIT09ICdub25lJyAmJiB0LiRub2RlLmNzcygnaGVpZ2h0JykgIT09IHQuaGVpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuJG5vZGUuY3NzKCdoZWlnaHQnLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0LiRub2RlLmNzcygnbWF4LXdpZHRoJykgIT09ICdub25lJyAmJiB0LiRub2RlLmNzcygnbWF4LXdpZHRoJykgIT09IHQud2lkdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC4kbm9kZS5jc3MoJ21heC13aWR0aCcsICcnKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICh0LiRub2RlLmNzcygnbWF4LWhlaWdodCcpICE9PSAnbm9uZScgJiYgdC4kbm9kZS5jc3MoJ21heC1oZWlnaHQnKSAhPT0gdC5oZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC4kbm9kZS5jc3MoJ21heC1oZWlnaHQnLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAodC4kbm9kZVswXS5jdXJyZW50U3R5bGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQuJG5vZGVbMF0uY3VycmVudFN0eWxlLmhlaWdodCA9PT0gJzEwMCUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LiRub2RlWzBdLmN1cnJlbnRTdHlsZS5oZWlnaHQgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodC4kbm9kZVswXS5jdXJyZW50U3R5bGUubWF4V2lkdGggPT09ICcxMDAlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC4kbm9kZVswXS5jdXJyZW50U3R5bGUubWF4V2lkdGggPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodC4kbm9kZVswXS5jdXJyZW50U3R5bGUubWF4SGVpZ2h0ID09PSAnMTAwJScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuJG5vZGVbMF0uY3VycmVudFN0eWxlLm1heEhlaWdodCA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoIXBhcmVudC53aWR0aCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5oZWlnaHQodC4kbWVkaWEud2lkdGgoKSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoIXBhcmVudC5oZWlnaHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaGVpZ2h0KHQuJG1lZGlhLmhlaWdodCgpKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRXaWR0aCA9IHBhcmVudC53aWR0aCgpLAogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRIZWlnaHQgPSBwYXJlbnQuaGVpZ2h0KCk7CgogICAgICAgICAgICAgICAgICAgIHQuc2V0RGltZW5zaW9ucygnMTAwJScsICcxMDAlJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgcHJldmVudHMgYW4gaXNzdWUgd2hlbiBkaXNwbGF5aW5nIHBvc3RlcgogICAgICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3Bvc3RlciBpbWcnKS5jc3MoJ2Rpc3BsYXknLCAnYmxvY2snKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gY2FsY3VsYXRlIG5ldyB3aWR0aCBhbmQgaGVpZ2h0CiAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldEVsZW1lbnQgPSB0LmNvbnRhaW5lci5maW5kKCdvYmplY3QsIGVtYmVkLCBpZnJhbWUsIHZpZGVvJyksCiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRIZWlnaHQgPSB0LmhlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgaW5pdFdpZHRoID0gdC53aWR0aCwKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNjYWxlIHRvIHRoZSB0YXJnZXQgd2lkdGgKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGVYMSA9IHBhcmVudFdpZHRoLAogICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVkxID0gaW5pdEhlaWdodCAqIHBhcmVudFdpZHRoIC8gaW5pdFdpZHRoLAoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2NhbGUgdG8gdGhlIHRhcmdldCBoZWlnaHQKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGVYMiA9IGluaXRXaWR0aCAqIHBhcmVudEhlaWdodCAvIGluaXRIZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlWTIgPSBwYXJlbnRIZWlnaHQsCgogICAgICAgICAgICAgICAgICAgICAgICAvLyBub3cgZmlndXJlIG91dCB3aGljaCBvbmUgd2Ugc2hvdWxkIHVzZQogICAgICAgICAgICAgICAgICAgICAgICBiU2NhbGVPbldpZHRoID0gc2NhbGVYMiA+IHBhcmVudFdpZHRoID09PSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxXaWR0aCA9IGJTY2FsZU9uV2lkdGggPyBNYXRoLmZsb29yKHNjYWxlWDEpIDogTWF0aC5mbG9vcihzY2FsZVgyKSwKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxIZWlnaHQgPSBiU2NhbGVPbldpZHRoID8gTWF0aC5mbG9vcihzY2FsZVkxKSA6IE1hdGguZmxvb3Ioc2NhbGVZMik7CgogICAgICAgICAgICAgICAgICAgIGlmIChiU2NhbGVPbldpZHRoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldEVsZW1lbnQuaGVpZ2h0KGZpbmFsSGVpZ2h0KS53aWR0aChwYXJlbnRXaWR0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm1lZGlhLnNldFNpemUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEuc2V0U2l6ZShwYXJlbnRXaWR0aCwgZmluYWxIZWlnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RWxlbWVudC5oZWlnaHQocGFyZW50SGVpZ2h0KS53aWR0aChmaW5hbFdpZHRoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQubWVkaWEuc2V0U2l6ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5zZXRTaXplKGZpbmFsV2lkdGgsIHBhcmVudEhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRhcmdldEVsZW1lbnQuY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgJ21hcmdpbi1sZWZ0JzogTWF0aC5mbG9vcigocGFyZW50V2lkdGggLSBmaW5hbFdpZHRoKSAvIDIpLAogICAgICAgICAgICAgICAgICAgICAgICAnbWFyZ2luLXRvcCc6IDAKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAga2V5OiAnc2V0RGltZW5zaW9ucycsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gc2V0RGltZW5zaW9ucyh3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICB0LmNvbnRhaW5lci53aWR0aCh3aWR0aCkuaGVpZ2h0KGhlaWdodCk7CgogICAgICAgICAgICAgICAgICAgIHQubGF5ZXJzLmNoaWxkcmVuKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdsYXllcicpLndpZHRoKHdpZHRoKS5oZWlnaHQoaGVpZ2h0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAga2V5OiAnc2V0Q29udHJvbHNTaXplJywKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRDb250cm9sc1NpemUoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICAvLyBza2lwIGNhbGN1bGF0aW9uIGlmIGhpZGRlbgogICAgICAgICAgICAgICAgICAgIGlmICghdC5jb250YWluZXIuaXMoJzp2aXNpYmxlJykgfHwgIXQucmFpbCB8fCAhdC5yYWlsLmxlbmd0aCB8fCAhdC5yYWlsLmlzKCc6dmlzaWJsZScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciByYWlsTWFyZ2luID0gcGFyc2VGbG9hdCh0LnJhaWwuY3NzKCdtYXJnaW4tbGVmdCcpKSArIHBhcnNlRmxvYXQodC5yYWlsLmNzcygnbWFyZ2luLXJpZ2h0JykpLAogICAgICAgICAgICAgICAgICAgICAgICB0b3RhbE1hcmdpbiA9IHBhcnNlRmxvYXQodC50b3RhbC5jc3MoJ21hcmdpbi1sZWZ0JykpICsgcGFyc2VGbG9hdCh0LnRvdGFsLmNzcygnbWFyZ2luLXJpZ2h0JykpIHx8IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHNpYmxpbmdzV2lkdGggPSAwOwoKICAgICAgICAgICAgICAgICAgICB0LnJhaWwuc2libGluZ3MoKS5lYWNoKGZ1bmN0aW9uIChpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNpYmxpbmdzV2lkdGggKz0gcGFyc2VGbG9hdCgkKG9iamVjdCkub3V0ZXJXaWR0aCh0cnVlKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgoKICAgICAgICAgICAgICAgICAgICBzaWJsaW5nc1dpZHRoICs9IHRvdGFsTWFyZ2luICsgcmFpbE1hcmdpbiArIDE7CgogICAgICAgICAgICAgICAgICAgIC8vIFN1YnN0cmFjdCB0aGUgd2lkdGggb2YgdGhlIGZlYXR1cmUgc2libGluZ3MgZnJvbSB0aW1lIHJhaWwKICAgICAgICAgICAgICAgICAgICB0LnJhaWwud2lkdGgodC5jb250cm9scy53aWR0aCgpIC0gc2libGluZ3NXaWR0aCk7CiAgICAgICAgICAgICAgICAgICAgdC5jb250YWluZXIudHJpZ2dlcignY29udHJvbHNyZXNpemUnKTsKICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLnNob3dJbnNpZ2h0cykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNGdWxsU2NyZWVuID0gdC5pc0Z1bGxTY3JlZW47CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bGxTY3JlZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChOdW1iZXIoJCgnLnV4Y19fdGltZS1yYWlsJykuYXR0cignc3R5bGUnKS5zcGxpdCgnOiAnKVsxXS5zcGxpdCgncHg7JylbMF0pID4gMTIwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnLnByb2dyZXNzX2Jhcl90aW1lJykud2lkdGgoTnVtYmVyKCQoJy51eGNfX3RpbWUtcmFpbCcpLmF0dHIoJ3N0eWxlJykuc3BsaXQoJzogJylbMV0uc3BsaXQoJ3B4OycpWzBdKSArICdweCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb2dyZXNzX2Jhcl9lbCA9ICQoJy5wcm9ncmVzc19iYXJfdGltZScpLndpZHRoKCkgPiAwID8gJCgnLnByb2dyZXNzX2Jhcl90aW1lJykud2lkdGgoKSA6IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGltZUFsbCA9IHQub3B0aW9ucy5lbmRJbnNpZ2h0IC0gdC5vcHRpb25zLnN0YXJ0SW5zaWdodDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3aWR0aE9uZVNlYyA9IHByb2dyZXNzX2Jhcl9lbCAvIHRpbWVBbGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5tZWRpYS5jdXJyZW50VGltZSA+IHQub3B0aW9ucy5lbmRJbnNpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5zZXRDdXJyZW50VGltZSh0Lm9wdGlvbnMuc3RhcnRJbnNpZ2h0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm1lZGlhLmN1cnJlbnRUaW1lIDwgdC5vcHRpb25zLnN0YXJ0SW5zaWdodCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQubWVkaWEuc2V0Q3VycmVudFRpbWUodC5vcHRpb25zLnN0YXJ0SW5zaWdodCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnLmxvYWRwcm9ncmVzcycpLmNzcyh7J3dpZHRoJzogKHQubWVkaWEuY3VycmVudFRpbWUgLSB0Lm9wdGlvbnMuc3RhcnRJbnNpZ2h0KSAqIHdpZHRoT25lU2VjfSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAga2V5OiAncmVzZXRTaXplJywKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiByZXNldFNpemUoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwogICAgICAgICAgICAgICAgICAgIC8vIHdlYmtpdCBoYXMgdHJvdWJsZSBkb2luZyB0aGlzIHdpdGhvdXQgYSBkZWxheQogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0LnNldFBsYXllclNpemUodC53aWR0aCwgdC5oZWlnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICB0LnNldENvbnRyb2xzU2l6ZSgpOwogICAgICAgICAgICAgICAgICAgIH0sIDUwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAga2V5OiAnc2V0UG9zdGVyJywKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRQb3N0ZXIodXJsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgICAgICBwb3N0ZXJEaXYgPSB0LmNvbnRhaW5lci5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdwb3N0ZXInKSwKICAgICAgICAgICAgICAgICAgICAgICAgcG9zdGVySW1nID0gcG9zdGVyRGl2LmZpbmQoJ2ltZycpOwoKICAgICAgICAgICAgICAgICAgICBpZiAocG9zdGVySW1nLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBwb3N0ZXJJbWcgPSAkKCc8aW1nIGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3Bvc3Rlci1pbWciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGFsdD0iIiAvPicpLmFwcGVuZFRvKHBvc3RlckRpdik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBwb3N0ZXJJbWcuYXR0cignc3JjJywgdXJsKTsKICAgICAgICAgICAgICAgICAgICBwb3N0ZXJEaXYuY3NzKHsnYmFja2dyb3VuZC1pbWFnZSc6ICd1cmwoIicgKyB1cmwgKyAnIiknfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ2NoYW5nZVNraW4nLAogICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGNoYW5nZVNraW4oY2xhc3NOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICB0LmNvbnRhaW5lclswXS5jbGFzc05hbWUgPSB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY29udGFpbmVyICcgKyBjbGFzc05hbWU7CiAgICAgICAgICAgICAgICAgICAgdC5zZXRQbGF5ZXJTaXplKHQud2lkdGgsIHQuaGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICB0LnNldENvbnRyb2xzU2l6ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBrZXk6ICdnbG9iYWxCaW5kJywKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBnbG9iYWxCaW5kKGV2ZW50cywgZGF0YSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGRvYyA9IHQubm9kZSA/IHQubm9kZS5vd25lckRvY3VtZW50IDogX2RvY3VtZW50Mi5kZWZhdWx0OwoKICAgICAgICAgICAgICAgICAgICBldmVudHMgPSAoMCwgX2dlbmVyYWwuc3BsaXRFdmVudHMpKGV2ZW50cywgdC5pZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50cy5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoZG9jKS5vbihldmVudHMuZCwgZGF0YSwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnRzLncpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJChfd2luZG93Mi5kZWZhdWx0KS5vbihldmVudHMudywgZGF0YSwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAga2V5OiAnZ2xvYmFsVW5iaW5kJywKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBnbG9iYWxVbmJpbmQoZXZlbnRzLCBjYWxsYmFjaykgewoKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGRvYyA9IHQubm9kZSA/IHQubm9kZS5vd25lckRvY3VtZW50IDogX2RvY3VtZW50Mi5kZWZhdWx0OwoKICAgICAgICAgICAgICAgICAgICBldmVudHMgPSAoMCwgX2dlbmVyYWwuc3BsaXRFdmVudHMpKGV2ZW50cywgdC5pZCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50cy5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoZG9jKS5vZmYoZXZlbnRzLmQsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50cy53KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICQoX3dpbmRvdzIuZGVmYXVsdCkub2ZmKGV2ZW50cy53LCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBrZXk6ICdidWlsZHBvc3RlcicsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gYnVpbGRwb3N0ZXIocGxheWVyLCBjb250cm9scywgbGF5ZXJzLCBtZWRpYSkgewoKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIHBvc3RlciA9ICQoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAncG9zdGVyICcgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnbGF5ZXIiPjwvZGl2PicpLmFwcGVuZFRvKGxheWVycyksCiAgICAgICAgICAgICAgICAgICAgICAgIHBvc3RlclVybCA9IHBsYXllci4kbWVkaWEuYXR0cigncG9zdGVyJyk7CgogICAgICAgICAgICAgICAgICAgIC8vIHByaW9yaXR5IGdvZXMgdG8gb3B0aW9uICh0aGlzIGlzIHVzZWZ1bCBpZiB5b3UgbmVlZCB0byBzdXBwb3J0IGlPUyAzLnggKGlPUyBjb21wbGV0ZWx5IGZhaWxzIHdpdGggcG9zdGVyKQogICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXIub3B0aW9ucy5wb3N0ZXIgIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvc3RlclVybCA9IHBsYXllci5vcHRpb25zLnBvc3RlcjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIHNlY29uZCwgdHJ5IHRoZSByZWFsIHBvc3RlcgogICAgICAgICAgICAgICAgICAgIGlmIChwb3N0ZXJVcmwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5zZXRQb3N0ZXIocG9zdGVyVXJsKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBwb3N0ZXIuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcigncGxheScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcG9zdGVyLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICB9LCBmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXIub3B0aW9ucy5zaG93UG9zdGVyV2hlbkVuZGVkICYmIHBsYXllci5vcHRpb25zLmF1dG9SZXdpbmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcignZW5kZWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0ZXIuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyLm9wdGlvbnMuc2hvd1Bvc3RlcldoZW5QYXVzZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcigncGF1c2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUbyBhdm9pZCBkaXNwbGF5aW5nIHRoZSBwb3N0ZXIgd2hlbiB2aWRlbyBlbmRlZCwgc2luY2UgaXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRyaWdnZXJzIGEgcGF1c2UgZXZlbnQgYXMgd2VsbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtZWRpYS5lbmRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3Rlci5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ2J1aWxkb3ZlcmxheXMnLAogICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGJ1aWxkb3ZlcmxheXMocGxheWVyLCBjb250cm9scywgbGF5ZXJzLCBtZWRpYSkgewoKICAgICAgICAgICAgICAgICAgICBpZiAoIXBsYXllci5pc1ZpZGVvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpcywKICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGluZyA9ICQoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb3ZlcmxheSAnICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2xheWVyIj4nICsgKCc8ZGl2IGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ292ZXJsYXktbG9hZGluZyI+JykgKyAoJzxzcGFuIGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ292ZXJsYXktbG9hZGluZy1iZy1pbWciPjwvc3Bhbj4nKSArICc8L2Rpdj4nICsgJzwvZGl2PicpLmhpZGUoKSAvLyBzdGFydCBvdXQgaGlkZGVuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYXBwZW5kVG8obGF5ZXJzKSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IgPSAkKCc8ZGl2IGNsYXNzPSInICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ292ZXJsYXkgJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdsYXllciI+JyArICgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdvdmVybGF5LWVycm9yIj48L2Rpdj4nKSArICc8L2Rpdj4nKS5oaWRlKCkgLy8gc3RhcnQgb3V0IGhpZGRlbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFwcGVuZFRvKGxheWVycyksCgogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIG5lZWRzIHRvIGNvbWUgbGFzdCBzbyBpdCdzIG9uIHRvcAogICAgICAgICAgICAgICAgICAgICAgICBiaWdQbGF5ID0gJCgnPGRpdiBjbGFzcz0iJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdvdmVybGF5ICcgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnbGF5ZXIgJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdvdmVybGF5LXBsYXkiPicgKyAoJzxkaXYgY2xhc3M9IicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb3ZlcmxheS1idXR0b24iIHJvbGU9ImJ1dHRvbiIgJykgKyAoJ2FyaWEtbGFiZWw9IicgKyB0Lm9wdGlvbnMucGxheVRleHQgPyB0Lm9wdGlvbnMucGxheVRleHQgOiBfaTE4bjIuZGVmYXVsdC50KCdtZWpzLnBsYXknKSArICciIGFyaWEtcHJlc3NlZD0iZmFsc2UiPicpICsgJzwvZGl2PicgKyAnPC9kaXY+JykuYXBwZW5kVG8obGF5ZXJzKS5vbignY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSZW1vdmVkICd0b3VjaHN0YXJ0JyBkdWUgaXNzdWVzIG9uIFNhbXN1bmcgQW5kcm9pZCBkZXZpY2VzIHdoZXJlIGEgdGFwIG9uIGJpZ1BsYXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0YXJ0ZWQgYW5kIGltbWVkaWF0ZWx5IHN0b3BwZWQgdGhlIHZpZGVvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodC5vcHRpb25zLmNsaWNrVG9QbGF5UGF1c2UpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvbiA9IHQuJG1lZGlhLmNsb3Nlc3QoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NvbnRhaW5lcicpLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ292ZXJsYXktYnV0dG9uJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXNzZWQgPSBidXR0b24uYXR0cignYXJpYS1wcmVzc2VkJyk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZWRpYS5wYXVzZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWEucGxheSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLnBhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b24uYXR0cignYXJpYS1wcmVzc2VkJywgISFwcmVzc2VkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIGlmICh0Lm9wdGlvbnMuc3VwcG9ydFZSIHx8ICh0Lm1lZGlhLnJlbmRlcmVyTmFtZSAhPT0gbnVsbCAmJiB0Lm1lZGlhLnJlbmRlcmVyTmFtZS5tYXRjaCgvKHlvdXR1YmV8ZmFjZWJvb2spLykpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHQubWVkaWEucmVuZGVyZXJOYW1lICE9PSBudWxsICYmIHQubWVkaWEucmVuZGVyZXJOYW1lLm1hdGNoKC8oeW91dHViZXxmYWNlYm9vaykvKSkgewogICAgICAgICAgICAgICAgICAgICAgICBiaWdQbGF5LmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIHNob3cvaGlkZSBiaWcgcGxheSBidXR0b24KICAgICAgICAgICAgICAgICAgICBtZWRpYS5hZGRFdmVudExpc3RlbmVyKCdwbGF5JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBiaWdQbGF5LmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGluZy5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xzLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3RpbWUtYnVmZmVyaW5nJykuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvci5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgfSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgICAgICAvKm1lZGlhLmFkZEV2ZW50TGlzdGVuZXIoJ3BsYXlpbmcnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJpZ1BsYXkuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBsb2FkaW5nLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbHMuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1idWZmZXJpbmcnKS5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yLmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICB9LCBmYWxzZSk7Ki8KCiAgICAgICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcignc2Vla2luZycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy9sb2FkaW5nLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbHMuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1idWZmZXJpbmcnKS5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgfSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgICAgICBtZWRpYS5hZGRFdmVudExpc3RlbmVyKCdzZWVrZWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vbG9hZGluZy5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xzLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3RpbWUtYnVmZmVyaW5nJykuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgIH0sIGZhbHNlKTsKCiAgICAgICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcigncGF1c2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJpZ1BsYXkuc2hvdygpOwogICAgICAgICAgICAgICAgICAgIH0sIGZhbHNlKTsKCiAgICAgICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcignd2FpdGluZycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAvLyBsb2FkaW5nLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbHMuZmluZCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAndGltZS1idWZmZXJpbmcnKS5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgfSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgICAgICAvLyBzaG93L2hpZGUgbG9hZGluZwogICAgICAgICAgICAgICAgICAgIG1lZGlhLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWRlZGRhdGEnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvciBzb21lIHJlYXNvbiBDaHJvbWUgaXMgZmlyaW5nIHRoaXMgZXZlbnQKICAgICAgICAgICAgICAgICAgICAgICAgLy9pZiAobWVqcy5NZWRpYUZlYXR1cmVzLmlzQ2hyb21lICYmIG1lZGlhLmdldEF0dHJpYnV0ZSAmJiBtZWRpYS5nZXRBdHRyaWJ1dGUoJ3ByZWxvYWQnKSA9PT0gJ25vbmUnKQogICAgICAgICAgICAgICAgICAgICAgICAvLwlyZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIC8vbG9hZGluZy5zaG93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xzLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3RpbWUtYnVmZmVyaW5nJykuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBGaXJpbmcgdGhlICdjYW5wbGF5JyBldmVudCBhZnRlciBhIHRpbWVvdXQgd2hpY2ggaXNuJ3QgZ2V0dGluZyBmaXJlZCBvbiBzb21lIEFuZHJvaWQgNC4xIGRldmljZXMKICAgICAgICAgICAgICAgICAgICAgICAgLy8gKGh0dHBzOi8vZ2l0aHViLmNvbS9qb2huZHllci9tZWRpYWVsZW1lbnQvaXNzdWVzLzEzMDUpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfY29uc3RhbnRzLklTX0FORFJPSUQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhLmNhbnBsYXlUaW1lb3V0ID0gX3dpbmRvdzIuZGVmYXVsdC5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2RvY3VtZW50Mi5kZWZhdWx0LmNyZWF0ZUV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldnQgPSBfZG9jdW1lbnQyLmRlZmF1bHQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZ0LmluaXRFdmVudCgnY2FucGxheScsIHRydWUsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWVkaWEuZGlzcGF0Y2hFdmVudChldnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDMwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcignY2FucGxheScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9hZGluZy5oaWRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xzLmZpbmQoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ3RpbWUtYnVmZmVyaW5nJykuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciB0aW1lb3V0IGluc2lnaHQgJ2xvYWRlZGRhdGEnIHRvIHByZXZlbnQgJ2NhbnBsYXknIGZyb20gZmlyaW5nIHR3aWNlCiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChtZWRpYS5jYW5wbGF5VGltZW91dCk7CiAgICAgICAgICAgICAgICAgICAgfSwgZmFsc2UpOwoKICAgICAgICAgICAgICAgICAgICAvLyBlcnJvciBoYW5kbGluZwogICAgICAgICAgICAgICAgICAgIG1lZGlhLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5faGFuZGxlRXJyb3IoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRpbmcuaGlkZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBiaWdQbGF5LmhpZGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3Iuc2hvdygpOwogICAgICAgICAgICAgICAgICAgICAgICBlcnJvci5maW5kKCcuJyArIHQub3B0aW9ucy5jbGFzc1ByZWZpeCArICdvdmVybGF5LWVycm9yJykuaHRtbChlLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgIH0sIGZhbHNlKTsKCiAgICAgICAgICAgICAgICAgICAgbWVkaWEuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQub25rZXlkb3duKHBsYXllciwgbWVkaWEsIGUpOwogICAgICAgICAgICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAga2V5OiAnYnVpbGRrZXlib2FyZCcsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gYnVpbGRrZXlib2FyZChwbGF5ZXIsIGNvbnRyb2xzLCBsYXllcnMsIG1lZGlhKSB7CgogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpczsKCiAgICAgICAgICAgICAgICAgICAgdC5jb250YWluZXIua2V5ZG93bihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQua2V5Ym9hcmRBY3Rpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAvLyBsaXN0ZW4gZm9yIGtleSBwcmVzc2VzCiAgICAgICAgICAgICAgICAgICAgdC5nbG9iYWxCaW5kKCdrZXlkb3duJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciAkY29udGFpbmVyID0gJChldmVudC50YXJnZXQpLmNsb3Nlc3QoJy4nICsgdC5vcHRpb25zLmNsYXNzUHJlZml4ICsgJ2NvbnRhaW5lcicpOwogICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuaGFzRm9jdXMgPSAkY29udGFpbmVyLmxlbmd0aCAhPT0gMCAmJiAkY29udGFpbmVyLmF0dHIoJ2lkJykgPT09IHBsYXllci4kbWVkaWEuY2xvc2VzdCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY29udGFpbmVyJykuYXR0cignaWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHQub25rZXlkb3duKHBsYXllciwgbWVkaWEsIGV2ZW50LCB0KTsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgc29tZW9uZSBjbGlja2VkIG91dHNpZGUgYSBwbGF5ZXIgcmVnaW9uLCB0aGVuIGtpbGwgaXRzIGZvY3VzCiAgICAgICAgICAgICAgICAgICAgdC5nbG9iYWxCaW5kKCdjbGljaycsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgICAgICBwbGF5ZXIuaGFzRm9jdXMgPSAkKGV2ZW50LnRhcmdldCkuY2xvc2VzdCgnLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnY29udGFpbmVyJykubGVuZ3RoICE9PSAwOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBrZXk6ICdvbmtleWRvd24nLAogICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIG9ua2V5ZG93bihwbGF5ZXIsIG1lZGlhLCBlLCB0KSB7CgogICAgICAgICAgICAgICAgICAgIGlmIChwbGF5ZXIuaGFzRm9jdXMgJiYgcGxheWVyLm9wdGlvbnMuZW5hYmxlS2V5Ym9hcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmluZCBhIG1hdGNoaW5nIGtleQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgaWwgPSBwbGF5ZXIub3B0aW9ucy5rZXlBY3Rpb25zLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBrZXlBY3Rpb24gPSBwbGF5ZXIub3B0aW9ucy5rZXlBY3Rpb25zW2ldOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwLCBqbCA9IGtleUFjdGlvbi5rZXlzLmxlbmd0aDsgaiA8IGpsOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5rZXlDb2RlID09PSBrZXlBY3Rpb24ua2V5c1tqXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXlBY3Rpb24uYWN0aW9uKHBsYXllciwgbWVkaWEsIGUua2V5Q29kZSwgZSwgdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBrZXk6ICdwbGF5JywKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBwbGF5KCkgewogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gdGhpczsKCiAgICAgICAgICAgICAgICAgICAgLy8gb25seSBsb2FkIGlmIHRoZSBjdXJyZW50IHRpbWUgaXMgMCB0byBlbnN1cmUgcHJvcGVyIHBsYXlpbmcKICAgICAgICAgICAgICAgICAgICBpZiAodC5tZWRpYS5nZXRDdXJyZW50VGltZSgpIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5sb2FkKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHQubWVkaWEucGxheSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBrZXk6ICdwYXVzZScsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gcGF1c2UoKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5tZWRpYS5wYXVzZSgpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ2xvYWQnLAogICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGxvYWQoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSB0aGlzOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIXQuaXNMb2FkZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5sb2FkKCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB0LmlzTG9hZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAga2V5OiAnc2V0TXV0ZWQnLAogICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldE11dGVkKG11dGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZWRpYS5zZXRNdXRlZChtdXRlZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ3NldEN1cnJlbnRUaW1lJywKICAgICAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRDdXJyZW50VGltZSh0aW1lKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZWRpYS5zZXRDdXJyZW50VGltZSh0aW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAga2V5OiAnZ2V0Q3VycmVudFRpbWUnLAogICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldEN1cnJlbnRUaW1lKCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1lZGlhLmN1cnJlbnRUaW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBrZXk6ICdzZXRWb2x1bWUnLAogICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHNldFZvbHVtZSh2b2x1bWUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1lZGlhLnNldFZvbHVtZSh2b2x1bWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB7CiAgICAgICAgICAgICAgICBrZXk6ICdnZXRWb2x1bWUnLAogICAgICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFZvbHVtZSgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tZWRpYS52b2x1bWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ3NldFNyYycsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gc2V0U3JjKHNyYykgewogICAgICAgICAgICAgICAgICAgIHRoaXMubWVkaWEuc2V0U3JjKHNyYyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgIGtleTogJ3JlbW92ZScsCiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlKCkgewoKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbmRlcmVyTmFtZSA9IHQubWVkaWEucmVuZGVyZXJOYW1lOwoKICAgICAgICAgICAgICAgICAgICAvLyBTdG9wIGNvbXBsZXRlbHkgbWVkaWEgcGxheWluZwogICAgICAgICAgICAgICAgICAgIGlmICghdC5tZWRpYS5wYXVzZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5wYXVzZSgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIHNyYyA9IHQubWVkaWEub3JpZ2luYWxOb2RlLmdldEF0dHJpYnV0ZSgnc3JjJyk7CiAgICAgICAgICAgICAgICAgICAgdC5tZWRpYS5zZXRTcmMoJycpOwoKICAgICAgICAgICAgICAgICAgICAvLyBpbnZva2UgZmVhdHVyZXMgY2xlYW51cAogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGZlYXR1cmVJbmRleCBpbiB0Lm9wdGlvbnMuZmVhdHVyZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZlYXR1cmUgPSB0Lm9wdGlvbnMuZmVhdHVyZXNbZmVhdHVyZUluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRbJ2NsZWFuJyArIGZlYXR1cmVdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRbJ2NsZWFuJyArIGZlYXR1cmVdKHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEB0b2RvOiByZXBvcnQgY29udHJvbCBlcnJvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ2Vycm9yIGNsZWFuaW5nICcgKyBmZWF0dXJlLCBlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gcmVzZXQgZGltZW5zaW9ucwogICAgICAgICAgICAgICAgICAgIHQuJG5vZGUuY3NzKHsKICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHQuJG5vZGUuYXR0cignd2lkdGgnKSB8fCAnYXV0bycsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogdC4kbm9kZS5hdHRyKCdoZWlnaHQnKSB8fCAnYXV0bycKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gZ3JhYiB2aWRlbyBhbmQgcHV0IGl0IGJhY2sgaW4gcGxhY2UKICAgICAgICAgICAgICAgICAgICBpZiAoIXQuaXNEeW5hbWljKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuJG1lZGlhLnByb3AoJ2NvbnRyb2xzJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRldGFjaCBldmVudHMgZnJvbSB0aGUgdmlkZW8KICAgICAgICAgICAgICAgICAgICAgICAgLy8gQHRvZG86IGRldGFjaCBldmVudCBsaXN0ZW5lcnMgYmV0dGVyIHRoYW4gdGhpczsgYWxzbyBkZXRhY2ggT05MWSB0aGUgZXZlbnRzIGF0dGFjaGVkIGJ5IHRoaXMgcGx1Z2luIQogICAgICAgICAgICAgICAgICAgICAgICB0LiRub2RlLmF0dHIoJ2lkJywgdC4kbm9kZS5hdHRyKCdpZCcpLnJlcGxhY2UoJ18nICsgcmVuZGVyZXJOYW1lLCAnJykpOwogICAgICAgICAgICAgICAgICAgICAgICB0LiRub2RlLmF0dHIoJ2lkJywgdC4kbm9kZS5hdHRyKCdpZCcpLnJlcGxhY2UoJ19mcm9tX21lanMnLCAnJykpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGBhdXRvcGxheWAgKG5vdCB3b3J0aCBicmluZ2luZyBpdCBiYWNrIG9uY2UgcGxheWVyIGlzIGRlc3Ryb3llZCkKICAgICAgICAgICAgICAgICAgICAgICAgdC4kbm9kZS5yZW1vdmVQcm9wKCdhdXRvcGxheScpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVpbnRlZ3JhdGUgZmlsZSBpZiBpdCBjYW4gYmUgcGxheWVkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0Lm1lZGlhLmNhblBsYXlUeXBlKCgwLCBfbWVkaWEuZ2V0VHlwZUZyb21GaWxlKShzcmMpKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC4kbm9kZS5hdHRyKCdzcmMnLCBzcmMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHQuJG5vZGUuY2xvbmUoKS5pbnNlcnRCZWZvcmUodC5jb250YWluZXIpLnNob3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgdC4kbm9kZS5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0LiRub2RlLmluc2VydEJlZm9yZSh0LmNvbnRhaW5lcik7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHQubWVkaWEuZGVzdHJveSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICAgICB0Lm1lZGlhLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFJlbW92ZSB0aGUgcGxheWVyIGZyb20gdGhlIG1lanMucGxheWVycyBvYmplY3Qgc28gdGhhdCBwYXVzZU90aGVyUGxheWVycyBkb2Vzbid0IGJsb3cgdXAgd2hlbiB0cnlpbmcgdG8KICAgICAgICAgICAgICAgICAgICAvLyBwYXVzZSBhIG5vbiBleGlzdGVudCBGbGFzaCBBUEkuCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIF9tZWpzMi5kZWZhdWx0LnBsYXllcnNbdC5pZF07CgogICAgICAgICAgICAgICAgICAgIGlmIChfdHlwZW9mKHQuY29udGFpbmVyKSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5jb250YWluZXIucHJldignLicgKyB0Lm9wdGlvbnMuY2xhc3NQcmVmaXggKyAnb2Zmc2NyZWVuJykucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHQuY29udGFpbmVyLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0Lmdsb2JhbFVuYmluZCgpOwoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgdC5ub2RlLnBsYXllcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfV0pOwoKICAgICAgICAgICAgcmV0dXJuIE1lZGlhRWxlbWVudFBsYXllcjsKICAgICAgICB9KCk7CgogICAgICAgIF93aW5kb3cyLmRlZmF1bHQuTWVkaWFFbGVtZW50UGxheWVyID0gTWVkaWFFbGVtZW50UGxheWVyOwoKICAgICAgICBleHBvcnRzLmRlZmF1bHQgPSBNZWRpYUVsZW1lbnRQbGF5ZXI7CgovLyB0dXJuIGludG8gcGx1Z2luCgogICAgICAgIChmdW5jdGlvbiAoJCkgewoKICAgICAgICAgICAgaWYgKHR5cGVvZiAkICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgJC5mbi5tZWRpYWVsZW1lbnRwbGF5ZXIgPSBmdW5jdGlvbiAob3B0aW9ucykgewogICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBsYXllciA9ICQodGhpcykuZGF0YSgnbWVkaWFlbGVtZW50cGxheWVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGxheWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyLnJlbW92ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5yZW1vdmVEYXRhKCdtZWRpYWVsZW1lbnRwbGF5ZXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykuZGF0YSgnbWVkaWFlbGVtZW50cGxheWVyJywgbmV3IE1lZGlhRWxlbWVudFBsYXllcih0aGlzLCBvcHRpb25zKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgJChfZG9jdW1lbnQyLmRlZmF1bHQpLnJlYWR5KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAvLyBhdXRvIGVuYWJsZSB1c2luZyBKU09OIGF0dHJpYnV0ZQogICAgICAgICAgICAgICAgICAgICQoJy4nICsgY29uZmlnLmNsYXNzUHJlZml4ICsgJ3BsYXllcicpLm1lZGlhZWxlbWVudHBsYXllcigpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KShfbWVqczIuZGVmYXVsdC4kKTsKCiAgICB9LCB7IjIiOiAyLCAiMjciOiAyNywgIjI4IjogMjgsICIyOSI6IDI5LCAiMyI6IDMsICIzMCI6IDMwLCAiMzIiOiAzMiwgIjQiOiA0LCAiNSI6IDUsICI2IjogNn1dLAogICAgMTc6IFtmdW5jdGlvbiAoX2RlcmVxXywgbW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgCgogICAgICAgIHZhciBfdHlwZW9mID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID09PSAic3ltYm9sIiA/IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqOwogICAgICAgICAgICB9IDogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG9iaiAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsKICAgICAgICAgICAgfTsKCiAgICAgICAgdmFyIF93aW5kb3cgPSBfZGVyZXFfKDMpOwoKICAgICAgICB2YXIgX3dpbmRvdzIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF93aW5kb3cpOwoKICAgICAgICB2YXIgX2RvY3VtZW50ID0gX2RlcmVxXygyKTsKCiAgICAgICAgdmFyIF9kb2N1bWVudDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9kb2N1bWVudCk7CgogICAgICAgIHZhciBfbWVqcyA9IF9kZXJlcV8oNik7CgogICAgICAgIHZhciBfbWVqczIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9tZWpzKTsKCiAgICAgICAgdmFyIF9yZW5kZXJlciA9IF9kZXJlcV8oNyk7CgogICAgICAgIHZhciBfZG9tID0gX2RlcmVxXygyOCk7CgogICAgICAgIHZhciBfbWVkaWEgPSBfZGVyZXFfKDMwKTsKCiAgICAgICAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHtkZWZhdWx0OiBvYmp9OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogRGFpbHlNb3Rpb24gcmVuZGVyZXIKICAgICAgICAgKgogICAgICAgICAqIFVzZXMgPGlmcmFtZT4gYXBwcm9hY2ggYW5kIHVzZXMgRGFpbHlNb3Rpb24gQVBJIHRvIG1hbmlwdWxhdGUgaXQuCiAgICAgICAgICogQHNlZSBodHRwczovL2RldmVsb3Blci5kYWlseW1vdGlvbi5jb20vcGxheWVyCiAgICAgICAgICoKICAgICAgICAgKi8KICAgICAgICB2YXIgRGFpbHlNb3Rpb25BcGkgPSB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGlzU0RLU3RhcnRlZDogZmFsc2UsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGlzU0RLTG9hZGVkOiBmYWxzZSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGlmcmFtZVF1ZXVlOiBbXSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGUgYSBxdWV1ZSB0byBwcmVwYXJlIHRoZSBjcmVhdGlvbiBvZiA8aWZyYW1lPgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgLSBhbiBvYmplY3Qgd2l0aCBzZXR0aW5ncyBuZWVkZWQgdG8gY3JlYXRlIDxpZnJhbWU+CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBlbnF1ZXVlSWZyYW1lOiBmdW5jdGlvbiBlbnF1ZXVlSWZyYW1lKHNldHRpbmdzKSB7CgogICAgICAgICAgICAgICAgaWYgKERhaWx5TW90aW9uQXBpLmlzTG9hZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgRGFpbHlNb3Rpb25BcGkuY3JlYXRlSWZyYW1lKHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgRGFpbHlNb3Rpb25BcGkubG9hZElmcmFtZUFwaSgpOwogICAgICAgICAgICAgICAgICAgIERhaWx5TW90aW9uQXBpLmlmcmFtZVF1ZXVlLnB1c2goc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIExvYWQgRGFpbHlNb3Rpb24gQVBJIHNjcmlwdCBvbiB0aGUgaGVhZGVyIG9mIHRoZSBkb2N1bWVudAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgbG9hZElmcmFtZUFwaTogZnVuY3Rpb24gbG9hZElmcmFtZUFwaSgpIHsKICAgICAgICAgICAgICAgIGlmICghRGFpbHlNb3Rpb25BcGkuaXNTREtTdGFydGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGUgPSBfZG9jdW1lbnQyLmRlZmF1bHQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgICAgICAgICAgICAgICAgICAgZS5hc3luYyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZS5zcmMgPSAnLy9hcGkuZG1jZG4ubmV0L2FsbC5qcyc7CiAgICAgICAgICAgICAgICAgICAgdmFyIHMgPSBfZG9jdW1lbnQyLmRlZmF1bHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpWzBdOwogICAgICAgICAgICAgICAgICAgIHMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoZSwgcyk7CiAgICAgICAgICAgICAgICAgICAgRGFpbHlNb3Rpb25BcGkuaXNTREtTdGFydGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBQcm9jZXNzIHF1ZXVlIG9mIERhaWx5TW90aW9uIDxpZnJhbWU+IGVsZW1lbnQgY3JlYXRpb24KICAgICAgICAgICAgICoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGFwaVJlYWR5OiBmdW5jdGlvbiBhcGlSZWFkeSgpIHsKCiAgICAgICAgICAgICAgICBEYWlseU1vdGlvbkFwaS5pc0xvYWRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBEYWlseU1vdGlvbkFwaS5pc1NES0xvYWRlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgd2hpbGUgKERhaWx5TW90aW9uQXBpLmlmcmFtZVF1ZXVlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2V0dGluZ3MgPSBEYWlseU1vdGlvbkFwaS5pZnJhbWVRdWV1ZS5wb3AoKTsKICAgICAgICAgICAgICAgICAgICBEYWlseU1vdGlvbkFwaS5jcmVhdGVJZnJhbWUoc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBEYWlseU1vdGlvbiBBUEkgcGxheWVyIGFuZCB0cmlnZ2VyIGEgY3VzdG9tIGV2ZW50IHRvIGluaXRpYWxpemUgaXQKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIC0gYW4gb2JqZWN0IHdpdGggc2V0dGluZ3MgbmVlZGVkIHRvIGNyZWF0ZSA8aWZyYW1lPgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY3JlYXRlSWZyYW1lOiBmdW5jdGlvbiBjcmVhdGVJZnJhbWUoc2V0dGluZ3MpIHsKCiAgICAgICAgICAgICAgICB2YXIgcGxheWVyID0gRE0ucGxheWVyKHNldHRpbmdzLmNvbnRhaW5lciwgewogICAgICAgICAgICAgICAgICAgIGhlaWdodDogc2V0dGluZ3MuaGVpZ2h0IHx8ICcxMDAlJywKICAgICAgICAgICAgICAgICAgICB3aWR0aDogc2V0dGluZ3Mud2lkdGggfHwgJzEwMCUnLAogICAgICAgICAgICAgICAgICAgIHZpZGVvOiBzZXR0aW5ncy52aWRlb0lkLAogICAgICAgICAgICAgICAgICAgIHBhcmFtczogT2JqZWN0LmFzc2lnbih7YXBpOiB0cnVlfSwgc2V0dGluZ3MucGFyYW1zKSwKICAgICAgICAgICAgICAgICAgICBvcmlnaW46IGxvY2F0aW9uLmhvc3QKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHBsYXllci5hZGRFdmVudExpc3RlbmVyKCdhcGlyZWFkeScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBfd2luZG93Mi5kZWZhdWx0WydfX3JlYWR5X18nICsgc2V0dGluZ3MuaWRdKHBsYXllciwge3BhdXNlZDogdHJ1ZSwgZW5kZWQ6IGZhbHNlfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBFeHRyYWN0IElEIGZyb20gRGFpbHlNb3Rpb24ncyBVUkwgdG8gYmUgbG9hZGVkIHRocm91Z2ggQVBJCiAgICAgICAgICAgICAqIFZhbGlkIFVSTCBmb3JtYXQocyk6CiAgICAgICAgICAgICAqIC0gaHR0cDovL3d3dy5kYWlseW1vdGlvbi5jb20vZW1iZWQvdmlkZW8veDM1eWF3eQogICAgICAgICAgICAgKiAtIGh0dHA6Ly9kYWkubHkveDM1eWF3eQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsCiAgICAgICAgICAgICAqIEByZXR1cm4ge1N0cmluZ30KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldERhaWx5TW90aW9uSWQ6IGZ1bmN0aW9uIGdldERhaWx5TW90aW9uSWQodXJsKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFydHMgPSB1cmwuc3BsaXQoJy8nKSwKICAgICAgICAgICAgICAgICAgICBsYXN0UGFydCA9IHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdLAogICAgICAgICAgICAgICAgICAgIGRhc2hQYXJ0cyA9IGxhc3RQYXJ0LnNwbGl0KCdfJyk7CgogICAgICAgICAgICAgICAgcmV0dXJuIGRhc2hQYXJ0c1swXTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBEYWlseU1vdGlvbklmcmFtZVJlbmRlcmVyID0gewogICAgICAgICAgICBuYW1lOiAnZGFpbHltb3Rpb25faWZyYW1lJywKCiAgICAgICAgICAgIG9wdGlvbnM6IHsKICAgICAgICAgICAgICAgIHByZWZpeDogJ2RhaWx5bW90aW9uX2lmcmFtZScsCgogICAgICAgICAgICAgICAgZGFpbHltb3Rpb246IHsKICAgICAgICAgICAgICAgICAgICB3aWR0aDogJzEwMCUnLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogJzEwMCUnLAogICAgICAgICAgICAgICAgICAgIHBhcmFtczogewogICAgICAgICAgICAgICAgICAgICAgICBhdXRvcGxheTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGNocm9tZWxlc3M6IDEsCiAgICAgICAgICAgICAgICAgICAgICAgIGluZm86IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ286IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlbGF0ZWQ6IDAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRGV0ZXJtaW5lIGlmIGEgc3BlY2lmaWMgZWxlbWVudCB0eXBlIGNhbiBiZSBwbGF5ZWQgd2l0aCB0aGlzIHJlbmRlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY2FuUGxheVR5cGU6IGZ1bmN0aW9uIGNhblBsYXlUeXBlKHR5cGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbJ3ZpZGVvL2RhaWx5bW90aW9uJywgJ3ZpZGVvL3gtZGFpbHltb3Rpb24nXS5pbmNsdWRlcyh0eXBlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGUgdGhlIHBsYXllciBpbnN0YW5jZSBhbmQgYWRkIGFsbCBuYXRpdmUgZXZlbnRzL21ldGhvZHMvcHJvcGVydGllcyBhcyBwb3NzaWJsZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge01lZGlhRWxlbWVudH0gbWVkaWFFbGVtZW50IEluc3RhbmNlIG9mIG1lanMuTWVkaWFFbGVtZW50IGFscmVhZHkgY3JlYXRlZAogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBBbGwgdGhlIHBsYXllciBjb25maWd1cmF0aW9uIG9wdGlvbnMgcGFzc2VkIHRocm91Z2ggY29uc3RydWN0b3IKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3RbXX0gbWVkaWFGaWxlcyBMaXN0IG9mIHNvdXJjZXMgd2l0aCBmb3JtYXQ6IHtzcmM6IHVybCwgdHlwZTogeC95LXp9CiAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNyZWF0ZTogZnVuY3Rpb24gY3JlYXRlKG1lZGlhRWxlbWVudCwgb3B0aW9ucywgbWVkaWFGaWxlcykgewoKICAgICAgICAgICAgICAgIHZhciBkbSA9IHt9OwoKICAgICAgICAgICAgICAgIGRtLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgICAgICAgZG0uaWQgPSBtZWRpYUVsZW1lbnQuaWQgKyAnXycgKyBvcHRpb25zLnByZWZpeDsKICAgICAgICAgICAgICAgIGRtLm1lZGlhRWxlbWVudCA9IG1lZGlhRWxlbWVudDsKCiAgICAgICAgICAgICAgICB2YXIgYXBpU3RhY2sgPSBbXSwKICAgICAgICAgICAgICAgICAgICBkbVBsYXllclJlYWR5ID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZG1QbGF5ZXIgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIGRtSWZyYW1lID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICBldmVudHMgPSB2b2lkIDAsCiAgICAgICAgICAgICAgICAgICAgcmVhZHlTdGF0ZSA9IDQsCiAgICAgICAgICAgICAgICAgICAgaSA9IHZvaWQgMCwKICAgICAgICAgICAgICAgICAgICBpbCA9IHZvaWQgMDsKCiAgICAgICAgICAgICAgICAvLyB3cmFwcGVycyBmb3IgZ2V0L3NldAogICAgICAgICAgICAgICAgdmFyIHByb3BzID0gX21lanMyLmRlZmF1bHQuaHRtbDVtZWRpYS5wcm9wZXJ0aWVzLAogICAgICAgICAgICAgICAgICAgIGFzc2lnbkdldHRlcnNTZXR0ZXJzID0gZnVuY3Rpb24gYXNzaWduR2V0dGVyc1NldHRlcnMocHJvcE5hbWUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFkZCB0byBmbGFzaCBzdGF0ZSB0aGF0IHdlIHdpbGwgc3RvcmUKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYXBOYW1lID0gJycgKyBwcm9wTmFtZS5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHByb3BOYW1lLnN1YnN0cmluZygxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGRtWydnZXQnICsgY2FwTmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZG1QbGF5ZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmaWd1cmUgb3V0IGhvdyB0byBnZXQgZG0gZHRhIGhlcmUKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9yZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocHJvcE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2N1cnJlbnRUaW1lJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2OiBkbVBsYXllci5jdXJyZW50VGltZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZHVyYXRpb24nOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHY6IGlzTmFOKGRtUGxheWVyLmR1cmF0aW9uKSA/IDAgOiBkbVBsYXllci5kdXJhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAndm9sdW1lJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2OiBkbVBsYXllci52b2x1bWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3BhdXNlZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjogZG1QbGF5ZXIucGF1c2VkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdlbmRlZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjogZG1QbGF5ZXIuZW5kZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ211dGVkJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2OiBkbVBsYXllci5tdXRlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYnVmZmVyZWQnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwZXJjZW50TG9hZGVkID0gZG1QbGF5ZXIuYnVmZmVyZWRUaW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbiA9IGRtUGxheWVyLmR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHY6IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBmdW5jdGlvbiBzdGFydCgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmQ6IGZ1bmN0aW9uIGVuZCgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGVyY2VudExvYWRlZCAvIGR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aDogMQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NyYyc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjogbWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZS5nZXRBdHRyaWJ1dGUoJ3NyYycpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdyZWFkeVN0YXRlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2OiByZWFkeVN0YXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0oKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCh0eXBlb2YgX3JldCA9PT0gJ3VuZGVmaW5lZCcgPyAndW5kZWZpbmVkJyA6IF90eXBlb2YoX3JldCkpID09PSAib2JqZWN0IikgcmV0dXJuIF9yZXQudjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgZG1bJ3NldCcgKyBjYXBOYW1lXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRtUGxheWVyICE9PSBudWxsKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocHJvcE5hbWUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NyYyc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXJsID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHZhbHVlIDogdmFsdWVbMF0uc3JjOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRtUGxheWVyLmxvYWQoRGFpbHlNb3Rpb25BcGkuZ2V0RGFpbHlNb3Rpb25JZCh1cmwpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY3VycmVudFRpbWUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG1QbGF5ZXIuc2Vlayh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ211dGVkJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRtUGxheWVyLnNldE11dGVkKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbVBsYXllci5zZXRNdXRlZChmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ3ZvbHVtZWNoYW5nZScsIGRtKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3ZvbHVtZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbVBsYXllci5zZXRWb2x1bWUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCd2b2x1bWVjaGFuZ2UnLCBkbSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgNTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdyZWFkeVN0YXRlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgnY2FucGxheScsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdG9yZSBmb3IgYWZ0ZXIgIlJFQURZIiBldmVudCBmaXJlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwaVN0YWNrLnB1c2goe3R5cGU6ICdzZXQnLCBwcm9wTmFtZTogcHJvcE5hbWUsIHZhbHVlOiB2YWx1ZX0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBwcm9wcy5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYXNzaWduR2V0dGVyc1NldHRlcnMocHJvcHNbaV0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGFkZCB3cmFwcGVycyBmb3IgbmF0aXZlIG1ldGhvZHMKICAgICAgICAgICAgICAgIHZhciBtZXRob2RzID0gX21lanMyLmRlZmF1bHQuaHRtbDVtZWRpYS5tZXRob2RzLAogICAgICAgICAgICAgICAgICAgIGFzc2lnbk1ldGhvZHMgPSBmdW5jdGlvbiBhc3NpZ25NZXRob2RzKG1ldGhvZE5hbWUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJ1biB0aGUgbWV0aG9kIG9uIHRoZSBuYXRpdmUgSFRNTE1lZGlhRWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBkbVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkbVBsYXllciAhPT0gbnVsbCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBETyBtZXRob2QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG1ldGhvZE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncGxheSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZG1QbGF5ZXIucGxheSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdwYXVzZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZG1QbGF5ZXIucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbG9hZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcGlTdGFjay5wdXNoKHt0eXBlOiAnY2FsbCcsIG1ldGhvZE5hbWU6IG1ldGhvZE5hbWV9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYXNzaWduTWV0aG9kcyhtZXRob2RzW2ldKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBJbml0aWFsIG1ldGhvZCB0byByZWdpc3RlciBhbGwgRGFpbHlNb3Rpb24gZXZlbnRzIHdoZW4gaW5pdGlhbGl6aW5nIDxpZnJhbWU+CiAgICAgICAgICAgICAgICBfd2luZG93Mi5kZWZhdWx0WydfX3JlYWR5X18nICsgZG0uaWRdID0gZnVuY3Rpb24gKF9kbVBsYXllcikgewoKICAgICAgICAgICAgICAgICAgICBkbVBsYXllclJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZG1QbGF5ZXIgPSBkbVBsYXllciA9IF9kbVBsYXllcjsKCiAgICAgICAgICAgICAgICAgICAgLy8gZG8gY2FsbCBzdGFjawogICAgICAgICAgICAgICAgICAgIGlmIChhcGlTdGFjay5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBhcGlTdGFjay5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YWNrSXRlbSA9IGFwaVN0YWNrW2ldOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGFja0l0ZW0udHlwZSA9PT0gJ3NldCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcE5hbWUgPSBzdGFja0l0ZW0ucHJvcE5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhcE5hbWUgPSAnJyArIHByb3BOYW1lLnN1YnN0cmluZygwLCAxKS50b1VwcGVyQ2FzZSgpICsgcHJvcE5hbWUuc3Vic3RyaW5nKDEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbVsnc2V0JyArIGNhcE5hbWVdKHN0YWNrSXRlbS52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YWNrSXRlbS50eXBlID09PSAnY2FsbCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbVtzdGFja0l0ZW0ubWV0aG9kTmFtZV0oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZG1JZnJhbWUgPSBfZG9jdW1lbnQyLmRlZmF1bHQuZ2V0RWxlbWVudEJ5SWQoZG0uaWQpOwoKICAgICAgICAgICAgICAgICAgICAvLyBhIGZldyBtb3JlIGV2ZW50cwogICAgICAgICAgICAgICAgICAgIGV2ZW50cyA9IFsnbW91c2VvdmVyJywgJ21vdXNlb3V0J107CiAgICAgICAgICAgICAgICAgICAgdmFyIGFzc2lnbkV2ZW50ID0gZnVuY3Rpb24gYXNzaWduRXZlbnQoZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoZS50eXBlLCBkbSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqIGluIGV2ZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICAoMCwgX2RvbS5hZGRFdmVudCkoZG1JZnJhbWUsIGV2ZW50c1tqXSwgYXNzaWduRXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gQlVCQkxFIEVWRU5UUyB1cAogICAgICAgICAgICAgICAgICAgIGV2ZW50cyA9IF9tZWpzMi5kZWZhdWx0Lmh0bWw1bWVkaWEuZXZlbnRzOwogICAgICAgICAgICAgICAgICAgIGV2ZW50cyA9IGV2ZW50cy5jb25jYXQoWydjbGljaycsICdtb3VzZW92ZXInLCAnbW91c2VvdXQnXSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGFzc2lnbk5hdGl2ZUV2ZW50cyA9IGZ1bmN0aW9uIGFzc2lnbk5hdGl2ZUV2ZW50cyhldmVudE5hbWUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlcHJlY2F0ZWQgZXZlbnQ7IG5vdCBjb25zaWRlciBpdAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnROYW1lICE9PSAnZW5kZWQnKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZG1QbGF5ZXIuYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKGUudHlwZSwgZG1QbGF5ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBldmVudHMubGVuZ3RoOyBpIDwgaWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBhc3NpZ25OYXRpdmVFdmVudHMoZXZlbnRzW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIEN1c3RvbSBEYWlseU1vdGlvbiBldmVudHMKICAgICAgICAgICAgICAgICAgICBkbVBsYXllci5hZGRFdmVudExpc3RlbmVyKCdhZF9zdGFydCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCdwbGF5JywgZG1QbGF5ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CgogICAgICAgICAgICAgICAgICAgICAgICBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgncHJvZ3Jlc3MnLCBkbVBsYXllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCd0aW1ldXBkYXRlJywgZG1QbGF5ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgZG1QbGF5ZXIuYWRkRXZlbnRMaXN0ZW5lcignYWRfdGltZXVwZGF0ZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCd0aW1ldXBkYXRlJywgZG1QbGF5ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgZG1QbGF5ZXIuYWRkRXZlbnRMaXN0ZW5lcignYWRfcGF1c2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgncGF1c2UnLCBkbVBsYXllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBkbVBsYXllci5hZGRFdmVudExpc3RlbmVyKCdhZF9lbmQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgnZW5kZWQnLCBkbVBsYXllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBkbVBsYXllci5hZGRFdmVudExpc3RlbmVyKCd2aWRlb19zdGFydCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCdwbGF5JywgZG1QbGF5ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CgogICAgICAgICAgICAgICAgICAgICAgICBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgndGltZXVwZGF0ZScsIGRtUGxheWVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGRtUGxheWVyLmFkZEV2ZW50TGlzdGVuZXIoJ3ZpZGVvX2VuZCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCdlbmRlZCcsIGRtUGxheWVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGRtUGxheWVyLmFkZEV2ZW50TGlzdGVuZXIoJ3Byb2dyZXNzJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ3RpbWV1cGRhdGUnLCBkbVBsYXllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBkbVBsYXllci5hZGRFdmVudExpc3RlbmVyKCdkdXJhdGlvbmNoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCd0aW1ldXBkYXRlJywgZG1QbGF5ZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIGdpdmUgaW5pdGlhbCBldmVudHMKICAgICAgICAgICAgICAgICAgICB2YXIgaW5pdEV2ZW50cyA9IFsncmVuZGVyZXJyZWFkeScsICdsb2FkZWRkYXRhJywgJ2xvYWRlZG1ldGFkYXRhJywgJ2NhbnBsYXknXTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBpbml0RXZlbnRzLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKGluaXRFdmVudHNbaV0sIGRtKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdmFyIGRtQ29udGFpbmVyID0gX2RvY3VtZW50Mi5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgICAgZG1Db250YWluZXIuaWQgPSBkbS5pZDsKICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5hcHBlbmRDaGlsZChkbUNvbnRhaW5lcik7CiAgICAgICAgICAgICAgICBpZiAobWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZSkgewogICAgICAgICAgICAgICAgICAgIGRtQ29udGFpbmVyLnN0eWxlLndpZHRoID0gbWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZS5zdHlsZS53aWR0aDsKICAgICAgICAgICAgICAgICAgICBkbUNvbnRhaW5lci5zdHlsZS5oZWlnaHQgPSBtZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlLnN0eWxlLmhlaWdodDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5vcmlnaW5hbE5vZGUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKCiAgICAgICAgICAgICAgICB2YXIgdmlkZW9JZCA9IERhaWx5TW90aW9uQXBpLmdldERhaWx5TW90aW9uSWQobWVkaWFGaWxlc1swXS5zcmMpLAogICAgICAgICAgICAgICAgICAgIGRtU2V0dGluZ3MgPSBPYmplY3QuYXNzaWduKHsKICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGRtLmlkLAogICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXI6IGRtQ29udGFpbmVyLAogICAgICAgICAgICAgICAgICAgICAgICB2aWRlb0lkOiB2aWRlb0lkLAogICAgICAgICAgICAgICAgICAgICAgICBhdXRvcGxheTogISFtZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlLmdldEF0dHJpYnV0ZSgnYXV0b3BsYXknKQogICAgICAgICAgICAgICAgICAgIH0sIGRtLm9wdGlvbnMuZGFpbHltb3Rpb24pOwoKICAgICAgICAgICAgICAgIERhaWx5TW90aW9uQXBpLmVucXVldWVJZnJhbWUoZG1TZXR0aW5ncyk7CgogICAgICAgICAgICAgICAgZG0uaGlkZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBkbS5zdG9wSW50ZXJ2YWwoKTsKICAgICAgICAgICAgICAgICAgICBkbS5wYXVzZSgpOwogICAgICAgICAgICAgICAgICAgIGlmIChkbUlmcmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBkbUlmcmFtZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBkbS5zaG93ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChkbUlmcmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICBkbUlmcmFtZS5zdHlsZS5kaXNwbGF5ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGRtLnNldFNpemUgPSBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewogICAgICAgICAgICAgICAgICAgIGRtSWZyYW1lLndpZHRoID0gd2lkdGg7CiAgICAgICAgICAgICAgICAgICAgZG1JZnJhbWUuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGRtLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZG1QbGF5ZXIuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGRtLmludGVydmFsID0gbnVsbDsKCiAgICAgICAgICAgICAgICBkbS5zdGFydEludGVydmFsID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGRtLmludGVydmFsID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBEYWlseU1vdGlvbkFwaS5zZW5kRXZlbnQoZG0uaWQsIGRtUGxheWVyLCAndGltZXVwZGF0ZScsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdXNlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRlZDogZmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSwgMjUwKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBkbS5zdG9wSW50ZXJ2YWwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRtLmludGVydmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoZG0uaW50ZXJ2YWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgcmV0dXJuIGRtOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLyoKICAgICAgICAgKiBSZWdpc3RlciBEYWlseU1vdGlvbiBldmVudCBnbG9iYWxseQogICAgICAgICAqCiAgICAgICAgICovCiAgICAgICAgX21lZGlhLnR5cGVDaGVja3MucHVzaChmdW5jdGlvbiAodXJsKSB7CiAgICAgICAgICAgIHVybCA9IHVybC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICByZXR1cm4gdXJsLmluY2x1ZGVzKCcvL2RhaWx5bW90aW9uLmNvbScpIHx8IHVybC5pbmNsdWRlcygnd3d3LmRhaWx5bW90aW9uLmNvbScpIHx8IHVybC5pbmNsdWRlcygnLy9kYWkubHknKSA/ICd2aWRlby94LWRhaWx5bW90aW9uJyA6IG51bGw7CiAgICAgICAgfSk7CgogICAgICAgIF93aW5kb3cyLmRlZmF1bHQuZG1Bc3luY0luaXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIERhaWx5TW90aW9uQXBpLmFwaVJlYWR5KCk7CiAgICAgICAgfTsKCiAgICAgICAgX3JlbmRlcmVyLnJlbmRlcmVyLmFkZChEYWlseU1vdGlvbklmcmFtZVJlbmRlcmVyKTsKCiAgICB9LCB7IjIiOiAyLCAiMjgiOiAyOCwgIjMiOiAzLCAiMzAiOiAzMCwgIjYiOiA2LCAiNyI6IDd9XSwKICAgIDE4OiBbZnVuY3Rpb24gKF9kZXJlcV8sIG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgIAoKICAgICAgICB2YXIgX3dpbmRvdyA9IF9kZXJlcV8oMyk7CgogICAgICAgIHZhciBfd2luZG93MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3dpbmRvdyk7CgogICAgICAgIHZhciBfZG9jdW1lbnQgPSBfZGVyZXFfKDIpOwoKICAgICAgICB2YXIgX2RvY3VtZW50MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2RvY3VtZW50KTsKCiAgICAgICAgdmFyIF9tZWpzID0gX2RlcmVxXyg2KTsKCiAgICAgICAgdmFyIF9tZWpzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX21lanMpOwoKICAgICAgICB2YXIgX3JlbmRlcmVyID0gX2RlcmVxXyg3KTsKCiAgICAgICAgdmFyIF9kb20gPSBfZGVyZXFfKDI4KTsKCiAgICAgICAgdmFyIF9tZWRpYSA9IF9kZXJlcV8oMzApOwoKICAgICAgICB2YXIgX2NvbnN0YW50cyA9IF9kZXJlcV8oMjcpOwoKICAgICAgICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDoge2RlZmF1bHQ6IG9ian07CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBOYXRpdmUgTShQRUcpLURhc2ggcmVuZGVyZXIKICAgICAgICAgKgogICAgICAgICAqIFVzZXMgZGFzaC5qcywgYSByZWZlcmVuY2UgY2xpZW50IGltcGxlbWVudGF0aW9uIGZvciB0aGUgcGxheWJhY2sgb2YgTShQRUcpLURBU0ggdmlhIEphdmFzY3JpcHQgYW5kIGNvbXBsaWFudCBicm93c2Vycy4KICAgICAgICAgKiBJdCByZWxpZXMgb24gSFRNTDUgdmlkZW8gYW5kIE1lZGlhU291cmNlIEV4dGVuc2lvbnMgZm9yIHBsYXliYWNrLgogICAgICAgICAqIFRoaXMgcmVuZGVyZXIgaW50ZWdyYXRlcyBuZXcgZXZlbnRzIGFzc29jaWF0ZWQgd2l0aCBtcGQgZmlsZXMuCiAgICAgICAgICogQHNlZSBodHRwczovL2dpdGh1Yi5jb20vRGFzaC1JbmR1c3RyeS1Gb3J1bS9kYXNoLmpzCiAgICAgICAgICoKICAgICAgICAgKi8KICAgICAgICB2YXIgTmF0aXZlRGFzaCA9IHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNNZWRpYUxvYWRlZDogZmFsc2UsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjcmVhdGlvblF1ZXVlOiBbXSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGUgYSBxdWV1ZSB0byBwcmVwYXJlIHRoZSBsb2FkaW5nIG9mIGFuIERBU0ggc291cmNlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyAtIGFuIG9iamVjdCB3aXRoIHNldHRpbmdzIG5lZWRlZCB0byBsb2FkIGFuIERBU0ggcGxheWVyIGluc3RhbmNlCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBwcmVwYXJlU2V0dGluZ3M6IGZ1bmN0aW9uIHByZXBhcmVTZXR0aW5ncyhzZXR0aW5ncykgewogICAgICAgICAgICAgICAgaWYgKE5hdGl2ZURhc2guaXNMb2FkZWQpIHsKICAgICAgICAgICAgICAgICAgICBOYXRpdmVEYXNoLmNyZWF0ZUluc3RhbmNlKHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgTmF0aXZlRGFzaC5sb2FkU2NyaXB0KHNldHRpbmdzKTsKICAgICAgICAgICAgICAgICAgICBOYXRpdmVEYXNoLmNyZWF0aW9uUXVldWUucHVzaChzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogTG9hZCBkYXNoLm1lZGlhcGxheWVyLmpzIHNjcmlwdCBvbiB0aGUgaGVhZGVyIG9mIHRoZSBkb2N1bWVudAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgLSBhbiBvYmplY3Qgd2l0aCBzZXR0aW5ncyBuZWVkZWQgdG8gbG9hZCBhbiBEQVNIIHBsYXllciBpbnN0YW5jZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgbG9hZFNjcmlwdDogZnVuY3Rpb24gbG9hZFNjcmlwdChzZXR0aW5ncykgewogICAgICAgICAgICAgICAgaWYgKCFOYXRpdmVEYXNoLmlzU2NyaXB0TG9hZGVkKSB7CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZGFzaGpzICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgICAgICAgICBOYXRpdmVEYXNoLmNyZWF0ZUluc3RhbmNlKHNldHRpbmdzKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldHRpbmdzLm9wdGlvbnMucGF0aCA9IHR5cGVvZiBzZXR0aW5ncy5vcHRpb25zLnBhdGggPT09ICdzdHJpbmcnID8gc2V0dGluZ3Mub3B0aW9ucy5wYXRoIDogJy8vY2RuLmRhc2hqcy5vcmcvbGF0ZXN0L2Rhc2gubWVkaWFwbGF5ZXIubWluLmpzJzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2NyaXB0ID0gX2RvY3VtZW50Mi5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0U2NyaXB0VGFnID0gX2RvY3VtZW50Mi5kZWZhdWx0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0LnNyYyA9IHNldHRpbmdzLm9wdGlvbnMucGF0aDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBdHRhY2ggaGFuZGxlcnMgZm9yIGFsbCBicm93c2VycwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0Lm9ubG9hZCA9IHNjcmlwdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkb25lICYmICghdGhpcy5yZWFkeVN0YXRlIHx8IHRoaXMucmVhZHlTdGF0ZSA9PT0gdW5kZWZpbmVkIHx8IHRoaXMucmVhZHlTdGF0ZSA9PT0gJ2xvYWRlZCcgfHwgdGhpcy5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTmF0aXZlRGFzaC5tZWRpYVJlYWR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0U2NyaXB0VGFnLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHNjcmlwdCwgZmlyc3RTY3JpcHRUYWcpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBOYXRpdmVEYXNoLmlzU2NyaXB0TG9hZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBQcm9jZXNzIHF1ZXVlIG9mIERBU0ggcGxheWVyIGNyZWF0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBtZWRpYVJlYWR5OiBmdW5jdGlvbiBtZWRpYVJlYWR5KCkgewoKICAgICAgICAgICAgICAgIE5hdGl2ZURhc2guaXNMb2FkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgTmF0aXZlRGFzaC5pc1NjcmlwdExvYWRlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgd2hpbGUgKE5hdGl2ZURhc2guY3JlYXRpb25RdWV1ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNldHRpbmdzID0gTmF0aXZlRGFzaC5jcmVhdGlvblF1ZXVlLnBvcCgpOwogICAgICAgICAgICAgICAgICAgIE5hdGl2ZURhc2guY3JlYXRlSW5zdGFuY2Uoc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBEQVNIIHBsYXllciBhbmQgdHJpZ2dlciBhIGN1c3RvbSBldmVudCB0byBpbml0aWFsaXplIGl0CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyAtIGFuIG9iamVjdCB3aXRoIHNldHRpbmdzIG5lZWRlZCB0byBpbnN0YW50aWF0ZSBEQVNIIG9iamVjdAogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY3JlYXRlSW5zdGFuY2U6IGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlKHNldHRpbmdzKSB7CgogICAgICAgICAgICAgICAgdmFyIHBsYXllciA9IGRhc2hqcy5NZWRpYVBsYXllcigpLmNyZWF0ZSgpOwogICAgICAgICAgICAgICAgX3dpbmRvdzIuZGVmYXVsdFsnX19yZWFkeV9fJyArIHNldHRpbmdzLmlkXShwbGF5ZXIpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgdmFyIERhc2hOYXRpdmVSZW5kZXJlciA9IHsKICAgICAgICAgICAgbmFtZTogJ25hdGl2ZV9kYXNoJywKCiAgICAgICAgICAgIG9wdGlvbnM6IHsKICAgICAgICAgICAgICAgIHByZWZpeDogJ25hdGl2ZV9kYXNoJywKICAgICAgICAgICAgICAgIGRhc2g6IHsKICAgICAgICAgICAgICAgICAgICAvLyBTcGVjaWFsIGNvbmZpZzogdXNlZCB0byBzZXQgdGhlIGxvY2FsIHBhdGgvVVJMIG9mIGRhc2guanMgbWVkaWFwbGF5ZXIgbGlicmFyeQogICAgICAgICAgICAgICAgICAgIHBhdGg6ICcvL2Nkbi5kYXNoanMub3JnL2xhdGVzdC9kYXNoLm1lZGlhcGxheWVyLm1pbi5qcycsCiAgICAgICAgICAgICAgICAgICAgZGVidWc6IGZhbHNlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBEZXRlcm1pbmUgaWYgYSBzcGVjaWZpYyBlbGVtZW50IHR5cGUgY2FuIGJlIHBsYXllZCB3aXRoIHRoaXMgcmVuZGVyCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAgICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjYW5QbGF5VHlwZTogZnVuY3Rpb24gY2FuUGxheVR5cGUodHlwZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIF9jb25zdGFudHMuSEFTX01TRSAmJiBbJ2FwcGxpY2F0aW9uL2Rhc2greG1sJ10uaW5jbHVkZXModHlwZSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQ3JlYXRlIHRoZSBwbGF5ZXIgaW5zdGFuY2UgYW5kIGFkZCBhbGwgbmF0aXZlIGV2ZW50cy9tZXRob2RzL3Byb3BlcnRpZXMgYXMgcG9zc2libGUKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtNZWRpYUVsZW1lbnR9IG1lZGlhRWxlbWVudCBJbnN0YW5jZSBvZiBtZWpzLk1lZGlhRWxlbWVudCBhbHJlYWR5IGNyZWF0ZWQKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgQWxsIHRoZSBwbGF5ZXIgY29uZmlndXJhdGlvbiBvcHRpb25zIHBhc3NlZCB0aHJvdWdoIGNvbnN0cnVjdG9yCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0W119IG1lZGlhRmlsZXMgTGlzdCBvZiBzb3VyY2VzIHdpdGggZm9ybWF0OiB7c3JjOiB1cmwsIHR5cGU6IHgveS16fQogICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uIGNyZWF0ZShtZWRpYUVsZW1lbnQsIG9wdGlvbnMsIG1lZGlhRmlsZXMpIHsKCiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxOb2RlID0gbWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZSwKICAgICAgICAgICAgICAgICAgICBpZCA9IG1lZGlhRWxlbWVudC5pZCArICdfJyArIG9wdGlvbnMucHJlZml4LAogICAgICAgICAgICAgICAgICAgIGRhc2hQbGF5ZXIgPSB2b2lkIDAsCiAgICAgICAgICAgICAgICAgICAgc3RhY2sgPSB7fSwKICAgICAgICAgICAgICAgICAgICBpID0gdm9pZCAwLAogICAgICAgICAgICAgICAgICAgIGlsID0gdm9pZCAwOwoKICAgICAgICAgICAgICAgIG5vZGUgPSBvcmlnaW5hbE5vZGUuY2xvbmVOb2RlKHRydWUpOwogICAgICAgICAgICAgICAgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24ob3B0aW9ucywgbWVkaWFFbGVtZW50Lm9wdGlvbnMpOwoKICAgICAgICAgICAgICAgIC8vIFdSQVBQRVJTIGZvciBQUk9QcwogICAgICAgICAgICAgICAgdmFyIHByb3BzID0gX21lanMyLmRlZmF1bHQuaHRtbDVtZWRpYS5wcm9wZXJ0aWVzLAogICAgICAgICAgICAgICAgICAgIGFzc2lnbkdldHRlcnNTZXR0ZXJzID0gZnVuY3Rpb24gYXNzaWduR2V0dGVyc1NldHRlcnMocHJvcE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNhcE5hbWUgPSAnJyArIHByb3BOYW1lLnN1YnN0cmluZygwLCAxKS50b1VwcGVyQ2FzZSgpICsgcHJvcE5hbWUuc3Vic3RyaW5nKDEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVsnZ2V0JyArIGNhcE5hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhc2hQbGF5ZXIgIT09IG51bGwgPyBub2RlW3Byb3BOYW1lXSA6IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBub2RlWydzZXQnICsgY2FwTmFtZV0gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghX21lanMyLmRlZmF1bHQuaHRtbDVtZWRpYS5yZWFkT25seVByb3BlcnRpZXMuaW5jbHVkZXMocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhc2hQbGF5ZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BOYW1lID09PSAnc3JjJykgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhc2hQbGF5ZXIuYXR0YWNoU291cmNlKHZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5nZXRBdHRyaWJ1dGUoJ2F1dG9wbGF5JykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnBsYXkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVtwcm9wTmFtZV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdG9yZSBmb3IgYWZ0ZXIgIlJFQURZIiBldmVudCBmaXJlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKHt0eXBlOiAnc2V0JywgcHJvcE5hbWU6IHByb3BOYW1lLCB2YWx1ZTogdmFsdWV9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IHByb3BzLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ25HZXR0ZXJzU2V0dGVycyhwcm9wc1tpXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW5pdGlhbCBtZXRob2QgdG8gcmVnaXN0ZXIgYWxsIE0tRGFzaCBldmVudHMKICAgICAgICAgICAgICAgIF93aW5kb3cyLmRlZmF1bHRbJ19fcmVhZHlfXycgKyBpZF0gPSBmdW5jdGlvbiAoX2Rhc2hQbGF5ZXIpIHsKCiAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRhc2hQbGF5ZXIgPSBkYXNoUGxheWVyID0gX2Rhc2hQbGF5ZXI7CgogICAgICAgICAgICAgICAgICAgIC8vIEJ5IGRlZmF1bHQsIGNvbnNvbGUgbG9nIGlzIG9mZgogICAgICAgICAgICAgICAgICAgIGRhc2hQbGF5ZXIuZ2V0RGVidWcoKS5zZXRMb2dUb0Jyb3dzZXJDb25zb2xlKG9wdGlvbnMuZGFzaC5kZWJ1Zyk7CgogICAgICAgICAgICAgICAgICAgIC8vIGRvIGNhbGwgc3RhY2sKICAgICAgICAgICAgICAgICAgICBpZiAoc3RhY2subGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsID0gc3RhY2subGVuZ3RoOyBpIDwgaWw7IGkrKykgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFja0l0ZW0gPSBzdGFja1tpXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhY2tJdGVtLnR5cGUgPT09ICdzZXQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BOYW1lID0gc3RhY2tJdGVtLnByb3BOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXBOYW1lID0gJycgKyBwcm9wTmFtZS5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHByb3BOYW1lLnN1YnN0cmluZygxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVsnc2V0JyArIGNhcE5hbWVdKHN0YWNrSXRlbS52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YWNrSXRlbS50eXBlID09PSAnY2FsbCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlW3N0YWNrSXRlbS5tZXRob2ROYW1lXSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBCVUJCTEUgRVZFTlRTCiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50cyA9IF9tZWpzMi5kZWZhdWx0Lmh0bWw1bWVkaWEuZXZlbnRzLAogICAgICAgICAgICAgICAgICAgICAgICBkYXNoRXZlbnRzID0gZGFzaGpzLk1lZGlhUGxheWVyLmV2ZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgYXNzaWduRXZlbnRzID0gZnVuY3Rpb24gYXNzaWduRXZlbnRzKGV2ZW50TmFtZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudE5hbWUgPT09ICdsb2FkZWRtZXRhZGF0YScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXNoUGxheWVyLmluaXRpYWxpemUobm9kZSwgbm9kZS5zcmMsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IF9kb2N1bWVudDIuZGVmYXVsdC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmluaXRFdmVudChlLnR5cGUsIGUuYnViYmxlcywgZS5jYW5jZWxhYmxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBAdG9kbyBDaGVjayB0aGlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZXZlbnQuc3JjRWxlbWVudCA9IGUuc3JjRWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBldmVudC50YXJnZXQgPSBlLnNyY0VsZW1lbnQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBldmVudHMgPSBldmVudHMuY29uY2F0KFsnY2xpY2snLCAnbW91c2VvdmVyJywgJ21vdXNlb3V0J10pOwoKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IGV2ZW50cy5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lnbkV2ZW50cyhldmVudHNbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogQ3VzdG9tIE0oUEVHKS1EQVNIIGV2ZW50cwogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlc2UgZXZlbnRzIGNhbiBiZSBhdHRhY2hlZCB0byB0aGUgb3JpZ2luYWwgbm9kZSB1c2luZyBhZGRFdmVudExpc3RlbmVyIGFuZCB0aGUgbmFtZSBvZiB0aGUgZXZlbnQsCiAgICAgICAgICAgICAgICAgICAgICogbm90IHVzaW5nIGRhc2hqcy5NZWRpYVBsYXllci5ldmVudHMgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICogQHNlZSBodHRwOi8vY2RuLmRhc2hqcy5vcmcvbGF0ZXN0L2pzZG9jL01lZGlhUGxheWVyRXZlbnRzLmh0bWwKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICB2YXIgYXNzaWduTWRhc2hFdmVudHMgPSBmdW5jdGlvbiBhc3NpZ25NZGFzaEV2ZW50cyhlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KShlLnR5cGUsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICBldmVudC5kYXRhID0gZTsKICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUudHlwZS50b0xvd2VyQ2FzZSgpID09PSAnZXJyb3InKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgZXZlbnRUeXBlIGluIGRhc2hFdmVudHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhc2hFdmVudHMuaGFzT3duUHJvcGVydHkoZXZlbnRUeXBlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGFzaFBsYXllci5vbihkYXNoRXZlbnRzW2V2ZW50VHlwZV0sIGFzc2lnbk1kYXNoRXZlbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaWYgKG1lZGlhRmlsZXMgJiYgbWVkaWFGaWxlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBtZWRpYUZpbGVzLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9yZW5kZXJlci5yZW5kZXJlci5yZW5kZXJlcnNbb3B0aW9ucy5wcmVmaXhdLmNhblBsYXlUeXBlKG1lZGlhRmlsZXNbaV0udHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKCdzcmMnLCBtZWRpYUZpbGVzW2ldLnNyYyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZSgnaWQnLCBpZCk7CgogICAgICAgICAgICAgICAgb3JpZ2luYWxOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5vZGUsIG9yaWdpbmFsTm9kZSk7CiAgICAgICAgICAgICAgICBvcmlnaW5hbE5vZGUucmVtb3ZlQXR0cmlidXRlKCdhdXRvcGxheScpOwogICAgICAgICAgICAgICAgb3JpZ2luYWxOb2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgogICAgICAgICAgICAgICAgTmF0aXZlRGFzaC5wcmVwYXJlU2V0dGluZ3MoewogICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMuZGFzaCwKICAgICAgICAgICAgICAgICAgICBpZDogaWQKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIEhFTFBFUiBNRVRIT0RTCiAgICAgICAgICAgICAgICBub2RlLnNldFNpemUgPSBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewogICAgICAgICAgICAgICAgICAgIG5vZGUuc3R5bGUud2lkdGggPSB3aWR0aCArICdweCc7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5zdHlsZS5oZWlnaHQgPSBoZWlnaHQgKyAncHgnOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgbm9kZS5oaWRlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIG5vZGUucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICBub2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIG5vZGUuc2hvdyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBub2RlLnN0eWxlLmRpc3BsYXkgPSAnJzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCdyZW5kZXJlcnJlYWR5Jywgbm9kZSk7CiAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CgogICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICAvKioKICAgICAgICAgKiBSZWdpc3RlciBOYXRpdmUgTShQRUcpLURhc2ggdHlwZSBiYXNlZCBvbiBVUkwgc3RydWN0dXJlCiAgICAgICAgICoKICAgICAgICAgKi8KICAgICAgICBfbWVkaWEudHlwZUNoZWNrcy5wdXNoKGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgdXJsID0gdXJsLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHJldHVybiB1cmwuaW5jbHVkZXMoJy5tcGQnKSA/ICdhcHBsaWNhdGlvbi9kYXNoK3htbCcgOiBudWxsOwogICAgICAgIH0pOwoKICAgICAgICBfcmVuZGVyZXIucmVuZGVyZXIuYWRkKERhc2hOYXRpdmVSZW5kZXJlcik7CgogICAgfSwgeyIyIjogMiwgIjI3IjogMjcsICIyOCI6IDI4LCAiMyI6IDMsICIzMCI6IDMwLCAiNiI6IDYsICI3IjogN31dLAogICAgMTk6IFtmdW5jdGlvbiAoX2RlcmVxXywgbW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgCgogICAgICAgIHZhciBfd2luZG93ID0gX2RlcmVxXygzKTsKCiAgICAgICAgdmFyIF93aW5kb3cyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfd2luZG93KTsKCiAgICAgICAgdmFyIF9kb2N1bWVudCA9IF9kZXJlcV8oMik7CgogICAgICAgIHZhciBfZG9jdW1lbnQyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfZG9jdW1lbnQpOwoKICAgICAgICB2YXIgX21lanMgPSBfZGVyZXFfKDYpOwoKICAgICAgICB2YXIgX21lanMyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfbWVqcyk7CgogICAgICAgIHZhciBfcmVuZGVyZXIgPSBfZGVyZXFfKDcpOwoKICAgICAgICB2YXIgX2dlbmVyYWwgPSBfZGVyZXFfKDI5KTsKCiAgICAgICAgdmFyIF9kb20gPSBfZGVyZXFfKDI4KTsKCiAgICAgICAgdmFyIF9tZWRpYSA9IF9kZXJlcV8oMzApOwoKICAgICAgICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDoge2RlZmF1bHQ6IG9ian07CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBGYWNlYm9vayByZW5kZXJlcgogICAgICAgICAqCiAgICAgICAgICogSXQgY3JlYXRlcyBhbiA8aWZyYW1lPiBmcm9tIGEgPGRpdj4gd2l0aCBzcGVjaWZpYyBjb25maWd1cmF0aW9uLgogICAgICAgICAqIEBzZWUgaHR0cHM6Ly9kZXZlbG9wZXJzLmZhY2Vib29rLmNvbS9kb2NzL3BsdWdpbnMvZW1iZWRkZWQtdmlkZW8tcGxheWVyCiAgICAgICAgICovCiAgICAgICAgdmFyIEZhY2Vib29rUmVuZGVyZXIgPSB7CiAgICAgICAgICAgIG5hbWU6ICdmYWNlYm9vaycsCgogICAgICAgICAgICBvcHRpb25zOiB7CiAgICAgICAgICAgICAgICBwcmVmaXg6ICdmYWNlYm9vaycsCiAgICAgICAgICAgICAgICBmYWNlYm9vazogewogICAgICAgICAgICAgICAgICAgIGFwcElkOiAne3lvdXItYXBwLWlkfScsCiAgICAgICAgICAgICAgICAgICAgeGZibWw6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgdmVyc2lvbjogJ3YyLjYnCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRGV0ZXJtaW5lIGlmIGEgc3BlY2lmaWMgZWxlbWVudCB0eXBlIGNhbiBiZSBwbGF5ZWQgd2l0aCB0aGlzIHJlbmRlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY2FuUGxheVR5cGU6IGZ1bmN0aW9uIGNhblBsYXlUeXBlKHR5cGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbJ3ZpZGVvL2ZhY2Vib29rJywgJ3ZpZGVvL3gtZmFjZWJvb2snXS5pbmNsdWRlcyh0eXBlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGUgdGhlIHBsYXllciBpbnN0YW5jZSBhbmQgYWRkIGFsbCBuYXRpdmUgZXZlbnRzL21ldGhvZHMvcHJvcGVydGllcyBhcyBwb3NzaWJsZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge01lZGlhRWxlbWVudH0gbWVkaWFFbGVtZW50IEluc3RhbmNlIG9mIG1lanMuTWVkaWFFbGVtZW50IGFscmVhZHkgY3JlYXRlZAogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBBbGwgdGhlIHBsYXllciBjb25maWd1cmF0aW9uIG9wdGlvbnMgcGFzc2VkIHRocm91Z2ggY29uc3RydWN0b3IKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3RbXX0gbWVkaWFGaWxlcyBMaXN0IG9mIHNvdXJjZXMgd2l0aCBmb3JtYXQ6IHtzcmM6IHVybCwgdHlwZTogeC95LXp9CiAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNyZWF0ZTogZnVuY3Rpb24gY3JlYXRlKG1lZGlhRWxlbWVudCwgb3B0aW9ucywgbWVkaWFGaWxlcykgewoKICAgICAgICAgICAgICAgIHZhciBmYldyYXBwZXIgPSB7fSwKICAgICAgICAgICAgICAgICAgICBmYkFwaSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgZmJEaXYgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIGFwaVN0YWNrID0gW10sCiAgICAgICAgICAgICAgICAgICAgcGF1c2VkID0gdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlbmRlZCA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGhhc1N0YXJ0ZWRQbGF5aW5nID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgc3JjID0gJycsCiAgICAgICAgICAgICAgICAgICAgZXZlbnRIYW5kbGVyID0ge30sCiAgICAgICAgICAgICAgICAgICAgcmVhZHlTdGF0ZSA9IDQsCiAgICAgICAgICAgICAgICAgICAgaSA9IHZvaWQgMCwKICAgICAgICAgICAgICAgICAgICBpbCA9IHZvaWQgMDsKCiAgICAgICAgICAgICAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbihvcHRpb25zLCBtZWRpYUVsZW1lbnQub3B0aW9ucyk7CiAgICAgICAgICAgICAgICBmYldyYXBwZXIub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgICAgICAgICBmYldyYXBwZXIuaWQgPSBtZWRpYUVsZW1lbnQuaWQgKyAnXycgKyBvcHRpb25zLnByZWZpeDsKICAgICAgICAgICAgICAgIGZiV3JhcHBlci5tZWRpYUVsZW1lbnQgPSBtZWRpYUVsZW1lbnQ7CgogICAgICAgICAgICAgICAgLy8gd3JhcHBlcnMgZm9yIGdldC9zZXQKICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IF9tZWpzMi5kZWZhdWx0Lmh0bWw1bWVkaWEucHJvcGVydGllcywKICAgICAgICAgICAgICAgICAgICBhc3NpZ25HZXR0ZXJzU2V0dGVycyA9IGZ1bmN0aW9uIGFzc2lnbkdldHRlcnNTZXR0ZXJzKHByb3BOYW1lKSB7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2FwTmFtZSA9ICcnICsgcHJvcE5hbWUuc3Vic3RyaW5nKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyBwcm9wTmFtZS5zdWJzdHJpbmcoMSk7CgogICAgICAgICAgICAgICAgICAgICAgICBmYldyYXBwZXJbJ2dldCcgKyBjYXBOYW1lXSA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmJBcGkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmaWd1cmUgb3V0IGhvdyB0byBnZXQgeW91dHViZSBkdGEgaGVyZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocHJvcE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY3VycmVudFRpbWUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZiQXBpLmdldEN1cnJlbnRQb3NpdGlvbigpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZHVyYXRpb24nOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZiQXBpLmdldER1cmF0aW9uKCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2b2x1bWUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZiQXBpLmdldFZvbHVtZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncGF1c2VkJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXVzZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdlbmRlZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW5kZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdtdXRlZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmJBcGkuaXNNdXRlZCgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYnVmZmVyZWQnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogZnVuY3Rpb24gc3RhcnQoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kOiBmdW5jdGlvbiBlbmQoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoOiAxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzcmMnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNyYzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JlYWR5U3RhdGUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlYWR5U3RhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgZmJXcmFwcGVyWydzZXQnICsgY2FwTmFtZV0gPSBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmJBcGkgIT09IG51bGwpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChwcm9wTmFtZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3JjJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1cmwgPSB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gdmFsdWUgOiB2YWx1ZVswXS5zcmM7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gT25seSB3YXkgaXMgdG8gZGVzdHJveSBpbnN0YW5jZSBhbmQgYWxsIHRoZSBldmVudHMgZmlyZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgY3JlYXRlIG5ldyBvbmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZiRGl2LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZmJEaXYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlRmFjZWJvb2tFbWJlZCh1cmwsIG9wdGlvbnMuZmFjZWJvb2spOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgbWV0aG9kIHJlbG9hZHMgdmlkZW8gb24tZGVtYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGQi5YRkJNTC5wYXJzZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY3VycmVudFRpbWUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmJBcGkuc2Vlayh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ211dGVkJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZiQXBpLm11dGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmJBcGkudW5tdXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ3ZvbHVtZWNoYW5nZScsIGZiV3JhcHBlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgNTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2b2x1bWUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmJBcGkuc2V0Vm9sdW1lKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgndm9sdW1lY2hhbmdlJywgZmJXcmFwcGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JlYWR5U3RhdGUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCdjYW5wbGF5JywgdmltZW8pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0b3JlIGZvciBhZnRlciAiUkVBRFkiIGV2ZW50IGZpcmVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBpU3RhY2sucHVzaCh7dHlwZTogJ3NldCcsIHByb3BOYW1lOiBwcm9wTmFtZSwgdmFsdWU6IHZhbHVlfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IHByb3BzLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ25HZXR0ZXJzU2V0dGVycyhwcm9wc1tpXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYWRkIHdyYXBwZXJzIGZvciBuYXRpdmUgbWV0aG9kcwogICAgICAgICAgICAgICAgdmFyIG1ldGhvZHMgPSBfbWVqczIuZGVmYXVsdC5odG1sNW1lZGlhLm1ldGhvZHMsCiAgICAgICAgICAgICAgICAgICAgYXNzaWduTWV0aG9kcyA9IGZ1bmN0aW9uIGFzc2lnbk1ldGhvZHMobWV0aG9kTmFtZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcnVuIHRoZSBtZXRob2Qgb24gdGhlIG5hdGl2ZSBIVE1MTWVkaWFFbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgIGZiV3JhcHBlclttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmJBcGkgIT09IG51bGwpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRE8gbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChtZXRob2ROYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3BsYXknOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZiQXBpLnBsYXkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncGF1c2UnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZiQXBpLnBhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2xvYWQnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBpU3RhY2sucHVzaCh7dHlwZTogJ2NhbGwnLCBtZXRob2ROYW1lOiBtZXRob2ROYW1lfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IG1ldGhvZHMubGVuZ3RoOyBpIDwgaWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbk1ldGhvZHMobWV0aG9kc1tpXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBEaXNwYXRjaCBhIGxpc3Qgb2YgZXZlbnRzCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHByaXZhdGUKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7QXJyYXl9IGV2ZW50cwogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzZW5kRXZlbnRzKGV2ZW50cykgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIF9pID0gMCwgX2lsID0gZXZlbnRzLmxlbmd0aDsgX2kgPCBfaWw7IF9pKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gX21lanMyLmRlZmF1bHQuVXRpbHMuY3JlYXRlRXZlbnQoZXZlbnRzW19pXSwgZmJXcmFwcGVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIENyZWF0ZSBhIG5ldyBGYWNlYm9vayBwbGF5ZXIgYW5kIGF0dGFjaCBhbGwgaXRzIGV2ZW50cwogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIFRoaXMgbWV0aG9kIGNyZWF0ZXMgYSA8ZGl2PiBlbGVtZW50IHRoYXQsIG9uY2UgdGhlIEFQSSBpcyBhdmFpbGFibGUsIHdpbGwgZ2VuZXJhdGUgYW4gPGlmcmFtZT4uCiAgICAgICAgICAgICAgICAgKiBWYWxpZCBVUkwgZm9ybWF0KHMpOgogICAgICAgICAgICAgICAgICogIC0gaHR0cHM6Ly93d3cuZmFjZWJvb2suY29tL2pvaG5keWVyL3ZpZGVvcy8xMDEwNzgxNjI0MzY4MTg4NC8KICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnCiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZhY2Vib29rRW1iZWQodXJsLCBjb25maWcpIHsKCiAgICAgICAgICAgICAgICAgICAgc3JjID0gdXJsOwoKICAgICAgICAgICAgICAgICAgICBmYkRpdiA9IF9kb2N1bWVudDIuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgICAgICAgICBmYkRpdi5pZCA9IGZiV3JhcHBlci5pZDsKICAgICAgICAgICAgICAgICAgICBmYkRpdi5jbGFzc05hbWUgPSAiZmItdmlkZW8iOwogICAgICAgICAgICAgICAgICAgIGZiRGl2LnNldEF0dHJpYnV0ZSgiZGF0YS1ocmVmIiwgdXJsKTsKICAgICAgICAgICAgICAgICAgICBmYkRpdi5zZXRBdHRyaWJ1dGUoImRhdGEtYWxsb3dmdWxsc2NyZWVuIiwgInRydWUiKTsKICAgICAgICAgICAgICAgICAgICBmYkRpdi5zZXRBdHRyaWJ1dGUoImRhdGEtY29udHJvbHMiLCAiZmFsc2UiKTsKCiAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShmYkRpdiwgbWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgICAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgICAqIFJlZ2lzdGVyIEZhY2Vib29rIEFQSSBldmVudCBnbG9iYWxseQogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgX3dpbmRvdzIuZGVmYXVsdC5mYkFzeW5jSW5pdCA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIEZCLmluaXQoY29uZmlnKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIEZCLkV2ZW50LnN1YnNjcmliZSgneGZibWwucmVhZHknLCBmdW5jdGlvbiAobXNnKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1zZy50eXBlID09PSAndmlkZW8nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZiQXBpID0gbXNnLmluc3RhbmNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2V0IHByb3BlciBzaXplIHNpbmNlIHBsYXllciBkaW1lbnNpb25zIGFyZSB1bmtub3duIGJlZm9yZSB0aGlzIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmYklmcmFtZSA9IGZiRGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdpZnJhbWUnKVswXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoID0gcGFyc2VJbnQoX3dpbmRvdzIuZGVmYXVsdC5nZXRDb21wdXRlZFN0eWxlKGZiSWZyYW1lLCBudWxsKS53aWR0aCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQgPSBwYXJzZUludChmYklmcmFtZS5zdHlsZS5oZWlnaHQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmJXcmFwcGVyLnNldFNpemUod2lkdGgsIGhlaWdodCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kRXZlbnRzKFsnbW91c2VvdmVyJywgJ21vdXNlb3V0J10pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIHByZXZpb3VzIGxpc3RlbmVycwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZmJFdmVudHMgPSBbJ3N0YXJ0ZWRQbGF5aW5nJywgJ3BhdXNlZCcsICdmaW5pc2hlZFBsYXlpbmcnLCAnc3RhcnRlZEJ1ZmZlcmluZycsICdmaW5pc2hlZEJ1ZmZlcmluZyddOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IGZiRXZlbnRzLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IGZiRXZlbnRzW2ldLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBldmVudEhhbmRsZXJbZXZlbnRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXIgIT09IHVuZGVmaW5lZCAmJiBoYW5kbGVyICE9PSBudWxsICYmICEoMCwgX2dlbmVyYWwuaXNPYmplY3RFbXB0eSkoaGFuZGxlcikgJiYgdHlwZW9mIGhhbmRsZXIucmVtb3ZlTGlzdGVuZXIgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnJlbW92ZUxpc3RlbmVyKGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZG8gY2FsbCBzdGFjawogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBpU3RhY2subGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IGFwaVN0YWNrLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YWNrSXRlbSA9IGFwaVN0YWNrW2ldOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhY2tJdGVtLnR5cGUgPT09ICdzZXQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcm9wTmFtZSA9IHN0YWNrSXRlbS5wcm9wTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhcE5hbWUgPSAnJyArIHByb3BOYW1lLnN1YnN0cmluZygwLCAxKS50b1VwcGVyQ2FzZSgpICsgcHJvcE5hbWUuc3Vic3RyaW5nKDEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmJXcmFwcGVyWydzZXQnICsgY2FwTmFtZV0oc3RhY2tJdGVtLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YWNrSXRlbS50eXBlID09PSAnY2FsbCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmJXcmFwcGVyW3N0YWNrSXRlbS5tZXRob2ROYW1lXSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VuZEV2ZW50cyhbJ3JlbmRlcmVycmVhZHknLCAncmVhZHknLCAnbG9hZGVkZGF0YScsICdjYW5wbGF5JywgJ3Byb2dyZXNzJ10pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kRXZlbnRzKFsnbG9hZGVkbWV0YWRhdGEnLCAndGltZXVwZGF0ZScsICdwcm9ncmVzcyddKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aW1lciA9IHZvaWQgMDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEN1c3RvbSBGYWNlYm9vayBldmVudHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRIYW5kbGVyLnN0YXJ0ZWRQbGF5aW5nID0gZmJBcGkuc3Vic2NyaWJlKCdzdGFydGVkUGxheWluZycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaGFzU3RhcnRlZFBsYXlpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNTdGFydGVkUGxheWluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXVzZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kRXZlbnRzKFsncGxheScsICdwbGF5aW5nJywgJ3RpbWV1cGRhdGUnXSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gV29ya2Fyb3VuZCB0byB1cGRhdGUgcHJvZ3Jlc3MgYmFyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lciA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYkFwaS5nZXRDdXJyZW50UG9zaXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kRXZlbnRzKFsndGltZXVwZGF0ZSddKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDI1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudEhhbmRsZXIucGF1c2VkID0gZmJBcGkuc3Vic2NyaWJlKCdwYXVzZWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXVzZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRFdmVudHMoWydwYXVzZWQnXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudEhhbmRsZXIuZmluaXNoZWRQbGF5aW5nID0gZmJBcGkuc3Vic2NyaWJlKCdmaW5pc2hlZFBsYXlpbmcnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXVzZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdvcmthcm91bmQgdG8gdXBkYXRlIHByb2dyZXNzIGJhciBvbmUgbGFzdCB0aW1lIGFuZCB0cmlnZ2VyIGVuZGVkIGV2ZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lciA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYkFwaS5nZXRDdXJyZW50UG9zaXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZW5kRXZlbnRzKFsndGltZXVwZGF0ZScsICdlbmRlZCddKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDI1MCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lciA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudEhhbmRsZXIuc3RhcnRlZEJ1ZmZlcmluZyA9IGZiQXBpLnN1YnNjcmliZSgnc3RhcnRlZEJ1ZmZlcmluZycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRFdmVudHMoWydwcm9ncmVzcycsICd0aW1ldXBkYXRlJ10pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRIYW5kbGVyLmZpbmlzaGVkQnVmZmVyaW5nID0gZmJBcGkuc3Vic2NyaWJlKCdmaW5pc2hlZEJ1ZmZlcmluZycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRFdmVudHMoWydwcm9ncmVzcycsICd0aW1ldXBkYXRlJ10pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKGQsIHMsIGlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBqcyA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZqcyA9IGQuZ2V0RWxlbWVudHNCeVRhZ05hbWUocylbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkLmdldEVsZW1lbnRCeUlkKGlkKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGpzID0gZC5jcmVhdGVFbGVtZW50KHMpOwogICAgICAgICAgICAgICAgICAgICAgICBqcy5pZCA9IGlkOwogICAgICAgICAgICAgICAgICAgICAgICBqcy5zcmMgPSAnLy9jb25uZWN0LmZhY2Vib29rLm5ldC9lbl9VUy9zZGsuanMnOwogICAgICAgICAgICAgICAgICAgICAgICBmanMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoanMsIGZqcyk7CiAgICAgICAgICAgICAgICAgICAgfSkoX2RvY3VtZW50Mi5kZWZhdWx0LCAnc2NyaXB0JywgJ2ZhY2Vib29rLWpzc2RrJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKG1lZGlhRmlsZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNyZWF0ZUZhY2Vib29rRW1iZWQobWVkaWFGaWxlc1swXS5zcmMsIGZiV3JhcHBlci5vcHRpb25zLmZhY2Vib29rKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmYldyYXBwZXIuaGlkZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBmYldyYXBwZXIuc3RvcEludGVydmFsKCk7CiAgICAgICAgICAgICAgICAgICAgZmJXcmFwcGVyLnBhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZiRGl2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZiRGl2LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGZiV3JhcHBlci5zaG93ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChmYkRpdikgewogICAgICAgICAgICAgICAgICAgICAgICBmYkRpdi5zdHlsZS5kaXNwbGF5ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGZiV3JhcHBlci5zZXRTaXplID0gZnVuY3Rpb24gKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmJBcGkgIT09IG51bGwgJiYgIWlzTmFOKHdpZHRoKSAmJiAhaXNOYU4oaGVpZ2h0KSkgewogICAgICAgICAgICAgICAgICAgICAgICBmYkRpdi5zZXRBdHRyaWJ1dGUoJ3dpZHRoJywgd2lkdGgpOwogICAgICAgICAgICAgICAgICAgICAgICBmYkRpdi5zZXRBdHRyaWJ1dGUoJ2hlaWdodCcsIGhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGZiV3JhcHBlci5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGZiV3JhcHBlci5pbnRlcnZhbCA9IG51bGw7CgogICAgICAgICAgICAgICAgZmJXcmFwcGVyLnN0YXJ0SW50ZXJ2YWwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gY3JlYXRlIHRpbWVyCiAgICAgICAgICAgICAgICAgICAgZmJXcmFwcGVyLmludGVydmFsID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ3RpbWV1cGRhdGUnLCBmYldyYXBwZXIpOwogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgfSwgMjUwKTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmYldyYXBwZXIuc3RvcEludGVydmFsID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChmYldyYXBwZXIuaW50ZXJ2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChmYldyYXBwZXIuaW50ZXJ2YWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgcmV0dXJuIGZiV3JhcHBlcjsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFJlZ2lzdGVyIEZhY2Vib29rIHR5cGUgYmFzZWQgb24gVVJMIHN0cnVjdHVyZQogICAgICAgICAqCiAgICAgICAgICovCiAgICAgICAgX21lZGlhLnR5cGVDaGVja3MucHVzaChmdW5jdGlvbiAodXJsKSB7CiAgICAgICAgICAgIHVybCA9IHVybC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICByZXR1cm4gdXJsLmluY2x1ZGVzKCcvL3d3dy5mYWNlYm9vaycpID8gJ3ZpZGVvL3gtZmFjZWJvb2snIDogbnVsbDsKICAgICAgICB9KTsKCiAgICAgICAgX3JlbmRlcmVyLnJlbmRlcmVyLmFkZChGYWNlYm9va1JlbmRlcmVyKTsKCiAgICB9LCB7IjIiOiAyLCAiMjgiOiAyOCwgIjI5IjogMjksICIzIjogMywgIjMwIjogMzAsICI2IjogNiwgIjciOiA3fV0sCiAgICAyMDogW2Z1bmN0aW9uIChfZGVyZXFfLCBtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAKCiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgICAgICAgICB2YWx1ZTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIGV4cG9ydHMuUGx1Z2luRGV0ZWN0b3IgPSB1bmRlZmluZWQ7CgogICAgICAgIHZhciBfdHlwZW9mID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID09PSAic3ltYm9sIiA/IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqOwogICAgICAgICAgICB9IDogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG9iaiAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsKICAgICAgICAgICAgfTsKCiAgICAgICAgdmFyIF93aW5kb3cgPSBfZGVyZXFfKDMpOwoKICAgICAgICB2YXIgX3dpbmRvdzIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF93aW5kb3cpOwoKICAgICAgICB2YXIgX2RvY3VtZW50ID0gX2RlcmVxXygyKTsKCiAgICAgICAgdmFyIF9kb2N1bWVudDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9kb2N1bWVudCk7CgogICAgICAgIHZhciBfbWVqcyA9IF9kZXJlcV8oNik7CgogICAgICAgIHZhciBfbWVqczIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9tZWpzKTsKCiAgICAgICAgdmFyIF9pMThuID0gX2RlcmVxXyg0KTsKCiAgICAgICAgdmFyIF9pMThuMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2kxOG4pOwoKICAgICAgICB2YXIgX3JlbmRlcmVyID0gX2RlcmVxXyg3KTsKCiAgICAgICAgdmFyIF9kb20gPSBfZGVyZXFfKDI4KTsKCiAgICAgICAgdmFyIF9jb25zdGFudHMgPSBfZGVyZXFfKDI3KTsKCiAgICAgICAgdmFyIF9tZWRpYSA9IF9kZXJlcV8oMzApOwoKICAgICAgICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDoge2RlZmF1bHQ6IG9ian07CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBTaGltIHRoYXQgZmFsbHMgYmFjayB0byBGbGFzaCBpZiBhIG1lZGlhIHR5cGUgaXMgbm90IHN1cHBvcnRlZC4KICAgICAgICAgKgogICAgICAgICAqIEFueSBmb3JtYXQgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgaW5jbHVkaW5nLCBSVE1QLCBGTFYsIEhMUyBhbmQgTShQRUcpLURBU0ggKGlmIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBNU0UpLAogICAgICAgICAqIHdpbGwgcGxheSB1c2luZyBGbGFzaC4KICAgICAgICAgKi8KCiAgICAgICAgLyoqCiAgICAgICAgICogQ29yZSBkZXRlY3RvciwgcGx1Z2lucyBhcmUgYWRkZWQgYmVsb3cKICAgICAgICAgKgogICAgICAgICAqLwogICAgICAgIHZhciBQbHVnaW5EZXRlY3RvciA9IGV4cG9ydHMuUGx1Z2luRGV0ZWN0b3IgPSB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDYWNoZWQgdmVyc2lvbiBudW1iZXJzCiAgICAgICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIHBsdWdpbnM6IFtdLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFRlc3QgYSBwbHVnaW4gdmVyc2lvbiBudW1iZXIKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHBsdWdpbiAtIEluIHRoaXMgc2NlbmFyaW8gJ2ZsYXNoJyB3aWxsIGJlIHRlc3RlZAogICAgICAgICAgICAgKiBAcGFyYW0ge0FycmF5fSB2IC0gQW4gYXJyYXkgY29udGFpbmluZyB0aGUgdmVyc2lvbiB1cCB0byAzIG51bWJlcnMgKG1ham9yLCBtaW5vciwgcmV2aXNpb24pCiAgICAgICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBoYXNQbHVnaW5WZXJzaW9uOiBmdW5jdGlvbiBoYXNQbHVnaW5WZXJzaW9uKHBsdWdpbiwgdikgewogICAgICAgICAgICAgICAgdmFyIHB2ID0gUGx1Z2luRGV0ZWN0b3IucGx1Z2luc1twbHVnaW5dOwogICAgICAgICAgICAgICAgdlsxXSA9IHZbMV0gfHwgMDsKICAgICAgICAgICAgICAgIHZbMl0gPSB2WzJdIHx8IDA7CiAgICAgICAgICAgICAgICByZXR1cm4gcHZbMF0gPiB2WzBdIHx8IHB2WzBdID09PSB2WzBdICYmIHB2WzFdID4gdlsxXSB8fCBwdlswXSA9PT0gdlswXSAmJiBwdlsxXSA9PT0gdlsxXSAmJiBwdlsyXSA+PSB2WzJdOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIERldGVjdCBwbHVnaW4gYW5kIHN0b3JlIGl0cyB2ZXJzaW9uIG51bWJlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAc2VlIFBsdWdpbkRldGVjdG9yLmRldGVjdFBsdWdpbgogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gcAogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gcGx1Z2luTmFtZQogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWltZVR5cGUKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGFjdGl2ZVgKICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gYXhEZXRlY3QKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGFkZFBsdWdpbjogZnVuY3Rpb24gYWRkUGx1Z2luKHAsIHBsdWdpbk5hbWUsIG1pbWVUeXBlLCBhY3RpdmVYLCBheERldGVjdCkgewogICAgICAgICAgICAgICAgUGx1Z2luRGV0ZWN0b3IucGx1Z2luc1twXSA9IFBsdWdpbkRldGVjdG9yLmRldGVjdFBsdWdpbihwbHVnaW5OYW1lLCBtaW1lVHlwZSwgYWN0aXZlWCwgYXhEZXRlY3QpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIE9idGFpbiB2ZXJzaW9uIG51bWJlciBmcm9tIHRoZSBtaW1lLXR5cGUgKGFsbCBidXQgSUUpIG9yIEFjdGl2ZVggKElFKQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gcGx1Z2luTmFtZQogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbWltZVR5cGUKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGFjdGl2ZVgKICAgICAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gYXhEZXRlY3QKICAgICAgICAgICAgICogQHJldHVybiB7aW50W119CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBkZXRlY3RQbHVnaW46IGZ1bmN0aW9uIGRldGVjdFBsdWdpbihwbHVnaW5OYW1lLCBtaW1lVHlwZSwgYWN0aXZlWCwgYXhEZXRlY3QpIHsKCiAgICAgICAgICAgICAgICB2YXIgdmVyc2lvbiA9IFswLCAwLCAwXSwKICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiA9IHZvaWQgMCwKICAgICAgICAgICAgICAgICAgICBheCA9IHZvaWQgMDsKCiAgICAgICAgICAgICAgICAvLyBGaXJlZm94LCBXZWJraXQsIE9wZXJhCiAgICAgICAgICAgICAgICBpZiAoX2NvbnN0YW50cy5OQVYucGx1Z2lucyAhPT0gdW5kZWZpbmVkICYmIF90eXBlb2YoX2NvbnN0YW50cy5OQVYucGx1Z2luc1twbHVnaW5OYW1lXSkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBfY29uc3RhbnRzLk5BVi5wbHVnaW5zW3BsdWdpbk5hbWVdLmRlc2NyaXB0aW9uOwogICAgICAgICAgICAgICAgICAgIGlmIChkZXNjcmlwdGlvbiAmJiAhKHR5cGVvZiBfY29uc3RhbnRzLk5BVi5taW1lVHlwZXMgIT09ICd1bmRlZmluZWQnICYmIF9jb25zdGFudHMuTkFWLm1pbWVUeXBlc1ttaW1lVHlwZV0gJiYgIV9jb25zdGFudHMuTkFWLm1pbWVUeXBlc1ttaW1lVHlwZV0uZW5hYmxlZFBsdWdpbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmVyc2lvbiA9IGRlc2NyaXB0aW9uLnJlcGxhY2UocGx1Z2luTmFtZSwgJycpLnJlcGxhY2UoL15ccysvLCAnJykucmVwbGFjZSgvXHNyL2dpLCAnLicpLnNwbGl0KCcuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmVyc2lvbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmVyc2lvbltpXSA9IHBhcnNlSW50KHZlcnNpb25baV0ubWF0Y2goL1xkKy8pLCAxMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gSW50ZXJuZXQgRXhwbG9yZXIgLyBBY3RpdmVYCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKF93aW5kb3cyLmRlZmF1bHQuQWN0aXZlWE9iamVjdCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgYXggPSBuZXcgQWN0aXZlWE9iamVjdChhY3RpdmVYKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uID0gYXhEZXRlY3QoYXgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB2ZXJzaW9uOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogQWRkIEZsYXNoIGRldGVjdGlvbgogICAgICAgICAqCiAgICAgICAgICovCiAgICAgICAgUGx1Z2luRGV0ZWN0b3IuYWRkUGx1Z2luKCdmbGFzaCcsICdTaG9ja3dhdmUgRmxhc2gnLCAnYXBwbGljYXRpb24veC1zaG9ja3dhdmUtZmxhc2gnLCAnU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2gnLCBmdW5jdGlvbiAoYXgpIHsKICAgICAgICAgICAgLy8gYWRhcHRlZCBmcm9tIFNXRk9iamVjdAogICAgICAgICAgICB2YXIgdmVyc2lvbiA9IFtdLAogICAgICAgICAgICAgICAgZCA9IGF4LkdldFZhcmlhYmxlKCIkdmVyc2lvbiIpOwogICAgICAgICAgICBpZiAoZCkgewogICAgICAgICAgICAgICAgZCA9IGQuc3BsaXQoIiAiKVsxXS5zcGxpdCgiLCIpOwogICAgICAgICAgICAgICAgdmVyc2lvbiA9IFtwYXJzZUludChkWzBdLCAxMCksIHBhcnNlSW50KGRbMV0sIDEwKSwgcGFyc2VJbnQoZFsyXSwgMTApXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmVyc2lvbjsKICAgICAgICB9KTsKCiAgICAgICAgdmFyIEZsYXNoTWVkaWFFbGVtZW50UmVuZGVyZXIgPSB7CgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQ3JlYXRlIHRoZSBwbGF5ZXIgaW5zdGFuY2UgYW5kIGFkZCBhbGwgbmF0aXZlIGV2ZW50cy9tZXRob2RzL3Byb3BlcnRpZXMgYXMgcG9zc2libGUKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtNZWRpYUVsZW1lbnR9IG1lZGlhRWxlbWVudCBJbnN0YW5jZSBvZiBtZWpzLk1lZGlhRWxlbWVudCBhbHJlYWR5IGNyZWF0ZWQKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgQWxsIHRoZSBwbGF5ZXIgY29uZmlndXJhdGlvbiBvcHRpb25zIHBhc3NlZCB0aHJvdWdoIGNvbnN0cnVjdG9yCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0W119IG1lZGlhRmlsZXMgTGlzdCBvZiBzb3VyY2VzIHdpdGggZm9ybWF0OiB7c3JjOiB1cmwsIHR5cGU6IHgveS16fQogICAgICAgICAgICAgKiBAcmV0dXJuIHtPYmplY3R9CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjcmVhdGU6IGZ1bmN0aW9uIGNyZWF0ZShtZWRpYUVsZW1lbnQsIG9wdGlvbnMsIG1lZGlhRmlsZXMpIHsKCiAgICAgICAgICAgICAgICB2YXIgZmxhc2ggPSB7fSwKICAgICAgICAgICAgICAgICAgICBpID0gdm9pZCAwLAogICAgICAgICAgICAgICAgICAgIGlsID0gdm9pZCAwOwoKICAgICAgICAgICAgICAgIC8vIHN0b3JlIG1haW4gdmFyaWFibGUKICAgICAgICAgICAgICAgIGZsYXNoLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgICAgICAgZmxhc2guaWQgPSBtZWRpYUVsZW1lbnQuaWQgKyAnXycgKyBmbGFzaC5vcHRpb25zLnByZWZpeDsKICAgICAgICAgICAgICAgIGZsYXNoLm1lZGlhRWxlbWVudCA9IG1lZGlhRWxlbWVudDsKCiAgICAgICAgICAgICAgICAvLyBpbnNlcnQgZGF0YQogICAgICAgICAgICAgICAgZmxhc2guZmxhc2hTdGF0ZSA9IHt9OwogICAgICAgICAgICAgICAgZmxhc2guZmxhc2hBcGkgPSBudWxsOwogICAgICAgICAgICAgICAgZmxhc2guZmxhc2hBcGlTdGFjayA9IFtdOwoKICAgICAgICAgICAgICAgIC8vIG1lZGlhRWxlbWVudHMgZm9yIGdldC9zZXQKICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IF9tZWpzMi5kZWZhdWx0Lmh0bWw1bWVkaWEucHJvcGVydGllcywKICAgICAgICAgICAgICAgICAgICBhc3NpZ25HZXR0ZXJzU2V0dGVycyA9IGZ1bmN0aW9uIGFzc2lnbkdldHRlcnNTZXR0ZXJzKHByb3BOYW1lKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGQgdG8gZmxhc2ggc3RhdGUgdGhhdCB3ZSB3aWxsIHN0b3JlCiAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoLmZsYXNoU3RhdGVbcHJvcE5hbWVdID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYXBOYW1lID0gJycgKyBwcm9wTmFtZS5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHByb3BOYW1lLnN1YnN0cmluZygxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoWydnZXQnICsgY2FwTmFtZV0gPSBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZsYXNoLmZsYXNoQXBpICE9PSBudWxsKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbGFzaC5mbGFzaEFwaVsnZ2V0XycgKyBwcm9wTmFtZV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgX3JldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGZsYXNoLmZsYXNoQXBpWydnZXRfJyArIHByb3BOYW1lXSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNwZWNpYWwgY2FzZSBmb3IgYnVmZmVyZWQgdG8gY29uZm9ybSB0byBIVE1MNSdzIG5ld2VzdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BOYW1lID09PSAnYnVmZmVyZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjogewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIHN0YXJ0KCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZDogZnVuY3Rpb24gZW5kKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGg6IDEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2OiB2YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCh0eXBlb2YgX3JldCA9PT0gJ3VuZGVmaW5lZCcgPyAndW5kZWZpbmVkJyA6IF90eXBlb2YoX3JldCkpID09PSAib2JqZWN0IikgcmV0dXJuIF9yZXQudjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgZmxhc2hbJ3NldCcgKyBjYXBOYW1lXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BOYW1lID09PSAnc3JjJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gKDAsIF9tZWRpYS5hYnNvbHV0aXplVXJsKSh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2VuZCB2YWx1ZSB0byBGbGFzaAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZsYXNoLmZsYXNoQXBpICE9PSBudWxsICYmIGZsYXNoLmZsYXNoQXBpWydzZXRfJyArIHByb3BOYW1lXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhc2guZmxhc2hBcGlbJ3NldF8nICsgcHJvcE5hbWVdKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3RvcmUgZm9yIGFmdGVyICJSRUFEWSIgZXZlbnQgZmlyZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGFzaC5mbGFzaEFwaVN0YWNrLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnc2V0JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcE5hbWU6IHByb3BOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsID0gcHJvcHMubGVuZ3RoOyBpIDwgaWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbkdldHRlcnNTZXR0ZXJzKHByb3BzW2ldKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBhZGQgbWVkaWFFbGVtZW50cyBmb3IgbmF0aXZlIG1ldGhvZHMKICAgICAgICAgICAgICAgIHZhciBtZXRob2RzID0gX21lanMyLmRlZmF1bHQuaHRtbDVtZWRpYS5tZXRob2RzLAogICAgICAgICAgICAgICAgICAgIGFzc2lnbk1ldGhvZHMgPSBmdW5jdGlvbiBhc3NpZ25NZXRob2RzKG1ldGhvZE5hbWUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJ1biB0aGUgbWV0aG9kIG9uIHRoZSBuYXRpdmUgSFRNTE1lZGlhRWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICBmbGFzaFttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmxhc2guZmxhc2hBcGkgIT09IG51bGwpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc2VuZCBjYWxsIHVwIHRvIEZsYXNoIEV4dGVybmFsSW50ZXJmYWNlIEFQSQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbGFzaC5mbGFzaEFwaVsnZmlyZV8nICsgbWV0aG9kTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoLmZsYXNoQXBpWydmaXJlXycgKyBtZXRob2ROYW1lXSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdG9yZSBmb3IgYWZ0ZXIgIlJFQURZIiBldmVudCBmaXJlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoLmZsYXNoQXBpU3RhY2sucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdjYWxsJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kTmFtZTogbWV0aG9kTmFtZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBtZXRob2RzLnB1c2goJ3N0b3AnKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYXNzaWduTWV0aG9kcyhtZXRob2RzW2ldKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBhZGQgYSByZWFkeSBtZXRob2QgdGhhdCBGbGFzaCBjYW4gY2FsbCB0bwogICAgICAgICAgICAgICAgX3dpbmRvdzIuZGVmYXVsdFsnX19yZWFkeV9fJyArIGZsYXNoLmlkXSA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgZmxhc2guZmxhc2hSZWFkeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZmxhc2guZmxhc2hBcGkgPSBfZG9jdW1lbnQyLmRlZmF1bHQuZ2V0RWxlbWVudEJ5SWQoJ19fJyArIGZsYXNoLmlkKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCdyZW5kZXJlcnJlYWR5JywgZmxhc2gpOwogICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gZG8gY2FsbCBzdGFjawogICAgICAgICAgICAgICAgICAgIGlmIChmbGFzaC5mbGFzaEFwaVN0YWNrLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBfaSA9IDAsIF9pbCA9IGZsYXNoLmZsYXNoQXBpU3RhY2subGVuZ3RoOyBfaSA8IF9pbDsgX2krKykgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFja0l0ZW0gPSBmbGFzaC5mbGFzaEFwaVN0YWNrW19pXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhY2tJdGVtLnR5cGUgPT09ICdzZXQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BOYW1lID0gc3RhY2tJdGVtLnByb3BOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXBOYW1lID0gJycgKyBwcm9wTmFtZS5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHByb3BOYW1lLnN1YnN0cmluZygxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhc2hbJ3NldCcgKyBjYXBOYW1lXShzdGFja0l0ZW0udmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFja0l0ZW0udHlwZSA9PT0gJ2NhbGwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhc2hbc3RhY2tJdGVtLm1ldGhvZE5hbWVdKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIF93aW5kb3cyLmRlZmF1bHRbJ19fZXZlbnRfXycgKyBmbGFzaC5pZF0gPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBtZXNzYWdlKSB7CgogICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KShldmVudE5hbWUsIGZsYXNoKTsKICAgICAgICAgICAgICAgICAgICBldmVudC5tZXNzYWdlID0gbWVzc2FnZSB8fCAnJzsKCiAgICAgICAgICAgICAgICAgICAgLy8gc2VuZCBldmVudCBmcm9tIEZsYXNoIHVwIHRvIHRoZSBtZWRpYUVsZW1lbnQKICAgICAgICAgICAgICAgICAgICBmbGFzaC5tZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIC8vIGluc2VydCBGbGFzaCBvYmplY3QKICAgICAgICAgICAgICAgIGZsYXNoLmZsYXNoV3JhcHBlciA9IF9kb2N1bWVudDIuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCiAgICAgICAgICAgICAgICB2YXIgYXV0b3BsYXkgPSAhIW1lZGlhRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2F1dG9wbGF5JyksCiAgICAgICAgICAgICAgICAgICAgZmxhc2hWYXJzID0gWyd1aWQ9JyArIGZsYXNoLmlkLCAnYXV0b3BsYXk9JyArIGF1dG9wbGF5XSwKICAgICAgICAgICAgICAgICAgICBpc1ZpZGVvID0gbWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZSAhPT0gbnVsbCAmJiBtZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlLnRhZ05hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3ZpZGVvJywKICAgICAgICAgICAgICAgICAgICBmbGFzaEhlaWdodCA9IGlzVmlkZW8gPyBtZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlLmhlaWdodCA6IDEsCiAgICAgICAgICAgICAgICAgICAgZmxhc2hXaWR0aCA9IGlzVmlkZW8gPyBtZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlLndpZHRoIDogMTsKCiAgICAgICAgICAgICAgICBpZiAoZmxhc2gub3B0aW9ucy5lbmFibGVQc2V1ZG9TdHJlYW1pbmcgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBmbGFzaFZhcnMucHVzaCgncHNldWRvc3RyZWFtc3RhcnQ9JyArIGZsYXNoLm9wdGlvbnMucHNldWRvU3RyZWFtaW5nU3RhcnRRdWVyeVBhcmFtKTsKICAgICAgICAgICAgICAgICAgICBmbGFzaFZhcnMucHVzaCgncHNldWRvc3RyZWFtdHlwZT0nICsgZmxhc2gub3B0aW9ucy5wc2V1ZG9TdHJlYW1pbmdUeXBlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuYXBwZW5kQ2hpbGQoZmxhc2guZmxhc2hXcmFwcGVyKTsKCiAgICAgICAgICAgICAgICBpZiAobWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5vcmlnaW5hbE5vZGUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgc2V0dGluZ3MgPSBbXTsKCiAgICAgICAgICAgICAgICBpZiAoX2NvbnN0YW50cy5JU19JRSkgewogICAgICAgICAgICAgICAgICAgIHZhciBzcGVjaWFsSUVDb250YWluZXIgPSBfZG9jdW1lbnQyLmRlZmF1bHQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICAgICAgZmxhc2guZmxhc2hXcmFwcGVyLmFwcGVuZENoaWxkKHNwZWNpYWxJRUNvbnRhaW5lcik7CgogICAgICAgICAgICAgICAgICAgIHNldHRpbmdzID0gWydjbGFzc2lkPSJjbHNpZDpEMjdDREI2RS1BRTZELTExY2YtOTZCOC00NDQ1NTM1NDAwMDAiJywgJ2NvZGViYXNlPSIvL2Rvd25sb2FkLm1hY3JvbWVkaWEuY29tL3B1Yi9zaG9ja3dhdmUvY2Ficy9mbGFzaC9zd2ZsYXNoLmNhYiInLCAnaWQ9Il9fJyArIGZsYXNoLmlkICsgJyInLCAnd2lkdGg9IicgKyBmbGFzaFdpZHRoICsgJyInLCAnaGVpZ2h0PSInICsgZmxhc2hIZWlnaHQgKyAnIiddOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzVmlkZW8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MucHVzaCgnc3R5bGU9ImNsaXA6IHJlY3QoMCAwIDAgMCk7IHBvc2l0aW9uOiBhYnNvbHV0ZTsiJyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBzcGVjaWFsSUVDb250YWluZXIub3V0ZXJIVE1MID0gJzxvYmplY3QgJyArIHNldHRpbmdzLmpvaW4oJyAnKSArICc+JyArICgnPHBhcmFtIG5hbWU9Im1vdmllIiB2YWx1ZT0iJyArIGZsYXNoLm9wdGlvbnMucGx1Z2luUGF0aCArIGZsYXNoLm9wdGlvbnMuZmlsZW5hbWUgKyAnP3g9JyArIG5ldyBEYXRlKCkgKyAnIiAvPicpICsgKCc8cGFyYW0gbmFtZT0iZmxhc2h2YXJzIiB2YWx1ZT0iJyArIGZsYXNoVmFycy5qb2luKCcmYW1wOycpICsgJyIgLz4nKSArICc8cGFyYW0gbmFtZT0icXVhbGl0eSIgdmFsdWU9ImhpZ2giIC8+JyArICc8cGFyYW0gbmFtZT0iYmdjb2xvciIgdmFsdWU9IiMwMDAwMDAiIC8+JyArICc8cGFyYW0gbmFtZT0id21vZGUiIHZhbHVlPSJ0cmFuc3BhcmVudCIgLz4nICsgJzxwYXJhbSBuYW1lPSJhbGxvd1NjcmlwdEFjY2VzcyIgdmFsdWU9ImFsd2F5cyIgLz4nICsgJzxwYXJhbSBuYW1lPSJhbGxvd0Z1bGxTY3JlZW4iIHZhbHVlPSJ0cnVlIiAvPicgKyAoJzxkaXY+JyArIF9pMThuMi5kZWZhdWx0LnQoJ21lanMuaW5zdGFsbC1mbGFzaCcpICsgJzwvZGl2PicpICsgJzwvb2JqZWN0Pic7CiAgICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICBzZXR0aW5ncyA9IFsnaWQ9Il9fJyArIGZsYXNoLmlkICsgJyInLCAnbmFtZT0iX18nICsgZmxhc2guaWQgKyAnIicsICdwbGF5PSJ0cnVlIicsICdsb29wPSJmYWxzZSInLCAncXVhbGl0eT0iaGlnaCInLCAnYmdjb2xvcj0iIzAwMDAwMCInLCAnd21vZGU9InRyYW5zcGFyZW50IicsICdhbGxvd1NjcmlwdEFjY2Vzcz0iYWx3YXlzIicsICdhbGxvd0Z1bGxTY3JlZW49InRydWUiJywgJ3R5cGU9ImFwcGxpY2F0aW9uL3gtc2hvY2t3YXZlLWZsYXNoIicsICdwbHVnaW5zcGFnZT0iLy93d3cubWFjcm9tZWRpYS5jb20vZ28vZ2V0Zmxhc2hwbGF5ZXIiJywgJ3NyYz0iJyArIGZsYXNoLm9wdGlvbnMucGx1Z2luUGF0aCArIGZsYXNoLm9wdGlvbnMuZmlsZW5hbWUgKyAnIicsICdmbGFzaHZhcnM9IicgKyBmbGFzaFZhcnMuam9pbignJicpICsgJyInLCAnd2lkdGg9IicgKyBmbGFzaFdpZHRoICsgJyInLCAnaGVpZ2h0PSInICsgZmxhc2hIZWlnaHQgKyAnIiddOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzVmlkZW8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MucHVzaCgnc3R5bGU9ImNsaXA6IHJlY3QoMCAwIDAgMCk7IHBvc2l0aW9uOiBhYnNvbHV0ZTsiJyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBmbGFzaC5mbGFzaFdyYXBwZXIuaW5uZXJIVE1MID0gJzxlbWJlZCAnICsgc2V0dGluZ3Muam9pbignICcpICsgJz4nOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZsYXNoLmZsYXNoTm9kZSA9IGZsYXNoLmZsYXNoV3JhcHBlci5sYXN0Q2hpbGQ7CgogICAgICAgICAgICAgICAgZmxhc2guaGlkZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNWaWRlbykgewogICAgICAgICAgICAgICAgICAgICAgICBmbGFzaC5mbGFzaE5vZGUuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnOwogICAgICAgICAgICAgICAgICAgICAgICBmbGFzaC5mbGFzaE5vZGUuc3R5bGUud2lkdGggPSAnMXB4JzsKICAgICAgICAgICAgICAgICAgICAgICAgZmxhc2guZmxhc2hOb2RlLnN0eWxlLmhlaWdodCA9ICcxcHgnOwogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhc2guZmxhc2hOb2RlLnN0eWxlLmNsaXAgPSAncmVjdCgwIDAgMCAwKTsnOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZmxhc2guc2hvdyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNWaWRlbykgewogICAgICAgICAgICAgICAgICAgICAgICBmbGFzaC5mbGFzaE5vZGUuc3R5bGUucG9zaXRpb24gPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgZmxhc2guZmxhc2hOb2RlLnN0eWxlLndpZHRoID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoLmZsYXNoTm9kZS5zdHlsZS5oZWlnaHQgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoLmZsYXNoTm9kZS5zdHlsZS5jbGlwID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmbGFzaC5zZXRTaXplID0gZnVuY3Rpb24gKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICBmbGFzaC5mbGFzaE5vZGUuc3R5bGUud2lkdGggPSB3aWR0aCArICdweCc7CiAgICAgICAgICAgICAgICAgICAgZmxhc2guZmxhc2hOb2RlLnN0eWxlLmhlaWdodCA9IGhlaWdodCArICdweCc7CgogICAgICAgICAgICAgICAgICAgIGlmIChmbGFzaC5mbGFzaEFwaSAhPT0gbnVsbCAmJiB0eXBlb2YgZmxhc2guZmxhc2hBcGkuZmlyZV9zZXRTaXplID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoLmZsYXNoQXBpLmZpcmVfc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGZsYXNoLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZmxhc2guZmxhc2hOb2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZmxhc2guZmxhc2hOb2RlKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaWYgKG1lZGlhRmlsZXMgJiYgbWVkaWFGaWxlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBtZWRpYUZpbGVzLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9yZW5kZXJlci5yZW5kZXJlci5yZW5kZXJlcnNbb3B0aW9ucy5wcmVmaXhdLmNhblBsYXlUeXBlKG1lZGlhRmlsZXNbaV0udHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsYXNoLnNldFNyYyhtZWRpYUZpbGVzW2ldLnNyYyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGFzaC5sb2FkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gZmxhc2g7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgaGFzRmxhc2ggPSBQbHVnaW5EZXRlY3Rvci5oYXNQbHVnaW5WZXJzaW9uKCdmbGFzaCcsIFsxMCwgMCwgMF0pOwoKICAgICAgICBpZiAoaGFzRmxhc2gpIHsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBSZWdpc3RlciBtZWRpYSB0eXBlIGJhc2VkIG9uIFVSTCBzdHJ1Y3R1cmUgaWYgRmxhc2ggaXMgZGV0ZWN0ZWQKICAgICAgICAgICAgICoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIF9tZWRpYS50eXBlQ2hlY2tzLnB1c2goZnVuY3Rpb24gKHVybCkgewoKICAgICAgICAgICAgICAgIHVybCA9IHVybC50b0xvd2VyQ2FzZSgpOwoKICAgICAgICAgICAgICAgIGlmICh1cmwuc3RhcnRzV2l0aCgncnRtcCcpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVybC5pbmNsdWRlcygnLm1wMycpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnYXVkaW8vcnRtcCc7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd2aWRlby9ydG1wJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHVybC5pbmNsdWRlcygnLm9nYScpIHx8IHVybC5pbmNsdWRlcygnLm9nZycpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdhdWRpby9vZ2cnOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghX2NvbnN0YW50cy5IQVNfTVNFICYmICFfY29uc3RhbnRzLlNVUFBPUlRTX05BVElWRV9ITFMgJiYgdXJsLmluY2x1ZGVzKCcubTN1OCcpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdhcHBsaWNhdGlvbi94LW1wZWdVUkwnOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghX2NvbnN0YW50cy5IQVNfTVNFICYmIHVybC5pbmNsdWRlcygnLm1wZCcpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdhcHBsaWNhdGlvbi9kYXNoK3htbCc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFZJREVPCiAgICAgICAgICAgIHZhciBGbGFzaE1lZGlhRWxlbWVudFZpZGVvUmVuZGVyZXIgPSB7CiAgICAgICAgICAgICAgICBuYW1lOiAnZmxhc2hfdmlkZW8nLAoKICAgICAgICAgICAgICAgIG9wdGlvbnM6IHsKICAgICAgICAgICAgICAgICAgICBwcmVmaXg6ICdmbGFzaF92aWRlbycsCiAgICAgICAgICAgICAgICAgICAgZmlsZW5hbWU6ICdtZWRpYWVsZW1lbnQtZmxhc2gtdmlkZW8uc3dmJywKICAgICAgICAgICAgICAgICAgICBlbmFibGVQc2V1ZG9TdHJlYW1pbmc6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIC8vIHN0YXJ0IHF1ZXJ5IHBhcmFtZXRlciBzZW50IHRvIHNlcnZlciBmb3IgcHNldWRvLXN0cmVhbWluZwogICAgICAgICAgICAgICAgICAgIHBzZXVkb1N0cmVhbWluZ1N0YXJ0UXVlcnlQYXJhbTogJ3N0YXJ0JywKICAgICAgICAgICAgICAgICAgICAvLyBwc2V1ZG8gc3RyZWFtaW5nIHR5cGU6IHVzZSBgdGltZWAgZm9yIHRpbWUgYmFzZWQgc2Vla2luZyAoTVA0KSBvciBgYnl0ZWAgZm9yIGZpbGUgYnl0ZSBwb3NpdGlvbiAoRkxWKQogICAgICAgICAgICAgICAgICAgIHBzZXVkb1N0cmVhbWluZ1R5cGU6ICdieXRlJwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgICAgICogRGV0ZXJtaW5lIGlmIGEgc3BlY2lmaWMgZWxlbWVudCB0eXBlIGNhbiBiZSBwbGF5ZWQgd2l0aCB0aGlzIHJlbmRlcgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAgICAgICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBjYW5QbGF5VHlwZTogZnVuY3Rpb24gY2FuUGxheVR5cGUodHlwZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBoYXNGbGFzaCAmJiBbJ3ZpZGVvL21wNCcsICd2aWRlby9mbHYnLCAndmlkZW8vcnRtcCcsICdhdWRpby9ydG1wJywgJ3J0bXAvbXA0JywgJ2F1ZGlvL21wNCddLmluY2x1ZGVzKHR5cGUpOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBjcmVhdGU6IEZsYXNoTWVkaWFFbGVtZW50UmVuZGVyZXIuY3JlYXRlCgogICAgICAgICAgICB9OwogICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyZXIuYWRkKEZsYXNoTWVkaWFFbGVtZW50VmlkZW9SZW5kZXJlcik7CgogICAgICAgICAgICAvLyBITFMKICAgICAgICAgICAgdmFyIEZsYXNoTWVkaWFFbGVtZW50SGxzVmlkZW9SZW5kZXJlciA9IHsKICAgICAgICAgICAgICAgIG5hbWU6ICdmbGFzaF9obHMnLAoKICAgICAgICAgICAgICAgIG9wdGlvbnM6IHsKICAgICAgICAgICAgICAgICAgICBwcmVmaXg6ICdmbGFzaF9obHMnLAogICAgICAgICAgICAgICAgICAgIGZpbGVuYW1lOiAnbWVkaWFlbGVtZW50LWZsYXNoLXZpZGVvLWhscy5zd2YnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBEZXRlcm1pbmUgaWYgYSBzcGVjaWZpYyBlbGVtZW50IHR5cGUgY2FuIGJlIHBsYXllZCB3aXRoIHRoaXMgcmVuZGVyCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAgICAgICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgIGNhblBsYXlUeXBlOiBmdW5jdGlvbiBjYW5QbGF5VHlwZSh0eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFfY29uc3RhbnRzLkhBU19NU0UgJiYgaGFzRmxhc2ggJiYgWydhcHBsaWNhdGlvbi94LW1wZWd1cmwnLCAndm5kLmFwcGxlLm1wZWd1cmwnLCAnYXVkaW8vbXBlZ3VybCcsICdhdWRpby9obHMnLCAndmlkZW8vaGxzJ10uaW5jbHVkZXModHlwZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgY3JlYXRlOiBGbGFzaE1lZGlhRWxlbWVudFJlbmRlcmVyLmNyZWF0ZQogICAgICAgICAgICB9OwogICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyZXIuYWRkKEZsYXNoTWVkaWFFbGVtZW50SGxzVmlkZW9SZW5kZXJlcik7CgogICAgICAgICAgICAvLyBNKFBFRyktREFTSAogICAgICAgICAgICB2YXIgRmxhc2hNZWRpYUVsZW1lbnRNZGFzaFZpZGVvUmVuZGVyZXIgPSB7CiAgICAgICAgICAgICAgICBuYW1lOiAnZmxhc2hfZGFzaCcsCgogICAgICAgICAgICAgICAgb3B0aW9uczogewogICAgICAgICAgICAgICAgICAgIHByZWZpeDogJ2ZsYXNoX2Rhc2gnLAogICAgICAgICAgICAgICAgICAgIGZpbGVuYW1lOiAnbWVkaWFlbGVtZW50LWZsYXNoLXZpZGVvLW1kYXNoLnN3ZicKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIERldGVybWluZSBpZiBhIHNwZWNpZmljIGVsZW1lbnQgdHlwZSBjYW4gYmUgcGxheWVkIHdpdGggdGhpcyByZW5kZXIKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICAgICAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY2FuUGxheVR5cGU6IGZ1bmN0aW9uIGNhblBsYXlUeXBlKHR5cGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIV9jb25zdGFudHMuSEFTX01TRSAmJiBoYXNGbGFzaCAmJiBbJ2FwcGxpY2F0aW9uL2Rhc2greG1sJ10uaW5jbHVkZXModHlwZSk7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIGNyZWF0ZTogRmxhc2hNZWRpYUVsZW1lbnRSZW5kZXJlci5jcmVhdGUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgX3JlbmRlcmVyLnJlbmRlcmVyLmFkZChGbGFzaE1lZGlhRWxlbWVudE1kYXNoVmlkZW9SZW5kZXJlcik7CgogICAgICAgICAgICAvLyBBVURJTwogICAgICAgICAgICB2YXIgRmxhc2hNZWRpYUVsZW1lbnRBdWRpb1JlbmRlcmVyID0gewogICAgICAgICAgICAgICAgbmFtZTogJ2ZsYXNoX2F1ZGlvJywKCiAgICAgICAgICAgICAgICBvcHRpb25zOiB7CiAgICAgICAgICAgICAgICAgICAgcHJlZml4OiAnZmxhc2hfYXVkaW8nLAogICAgICAgICAgICAgICAgICAgIGZpbGVuYW1lOiAnbWVkaWFlbGVtZW50LWZsYXNoLWF1ZGlvLnN3ZicKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIERldGVybWluZSBpZiBhIHNwZWNpZmljIGVsZW1lbnQgdHlwZSBjYW4gYmUgcGxheWVkIHdpdGggdGhpcyByZW5kZXIKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICAgICAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY2FuUGxheVR5cGU6IGZ1bmN0aW9uIGNhblBsYXlUeXBlKHR5cGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGFzRmxhc2ggJiYgWydhdWRpby9tcDMnXS5pbmNsdWRlcyh0eXBlKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgY3JlYXRlOiBGbGFzaE1lZGlhRWxlbWVudFJlbmRlcmVyLmNyZWF0ZQogICAgICAgICAgICB9OwogICAgICAgICAgICBfcmVuZGVyZXIucmVuZGVyZXIuYWRkKEZsYXNoTWVkaWFFbGVtZW50QXVkaW9SZW5kZXJlcik7CgogICAgICAgICAgICAvLyBBVURJTyAtIG9nZwogICAgICAgICAgICB2YXIgRmxhc2hNZWRpYUVsZW1lbnRBdWRpb09nZ1JlbmRlcmVyID0gewogICAgICAgICAgICAgICAgbmFtZTogJ2ZsYXNoX2F1ZGlvX29nZycsCgogICAgICAgICAgICAgICAgb3B0aW9uczogewogICAgICAgICAgICAgICAgICAgIHByZWZpeDogJ2ZsYXNoX2F1ZGlvX29nZycsCiAgICAgICAgICAgICAgICAgICAgZmlsZW5hbWU6ICdtZWRpYWVsZW1lbnQtZmxhc2gtYXVkaW8tb2dnLnN3ZicKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIERldGVybWluZSBpZiBhIHNwZWNpZmljIGVsZW1lbnQgdHlwZSBjYW4gYmUgcGxheWVkIHdpdGggdGhpcyByZW5kZXIKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICAgICAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgY2FuUGxheVR5cGU6IGZ1bmN0aW9uIGNhblBsYXlUeXBlKHR5cGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGFzRmxhc2ggJiYgWydhdWRpby9vZ2cnLCAnYXVkaW8vb2dhJywgJ2F1ZGlvL29ndiddLmluY2x1ZGVzKHR5cGUpOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBjcmVhdGU6IEZsYXNoTWVkaWFFbGVtZW50UmVuZGVyZXIuY3JlYXRlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIF9yZW5kZXJlci5yZW5kZXJlci5hZGQoRmxhc2hNZWRpYUVsZW1lbnRBdWRpb09nZ1JlbmRlcmVyKTsKICAgICAgICB9CgogICAgfSwgeyIyIjogMiwgIjI3IjogMjcsICIyOCI6IDI4LCAiMyI6IDMsICIzMCI6IDMwLCAiNCI6IDQsICI2IjogNiwgIjciOiA3fV0sCiAgICAyMTogW2Z1bmN0aW9uIChfZGVyZXFfLCBtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAKCiAgICAgICAgdmFyIF93aW5kb3cgPSBfZGVyZXFfKDMpOwoKICAgICAgICB2YXIgX3dpbmRvdzIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF93aW5kb3cpOwoKICAgICAgICB2YXIgX2RvY3VtZW50ID0gX2RlcmVxXygyKTsKCiAgICAgICAgdmFyIF9kb2N1bWVudDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9kb2N1bWVudCk7CgogICAgICAgIHZhciBfbWVqcyA9IF9kZXJlcV8oNik7CgogICAgICAgIHZhciBfbWVqczIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9tZWpzKTsKCiAgICAgICAgdmFyIF9yZW5kZXJlciA9IF9kZXJlcV8oNyk7CgogICAgICAgIHZhciBfZG9tID0gX2RlcmVxXygyOCk7CgogICAgICAgIHZhciBfY29uc3RhbnRzID0gX2RlcmVxXygyNyk7CgogICAgICAgIHZhciBfbWVkaWEgPSBfZGVyZXFfKDMwKTsKCiAgICAgICAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHtkZWZhdWx0OiBvYmp9OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogTmF0aXZlIEZMViByZW5kZXJlcgogICAgICAgICAqCiAgICAgICAgICogVXNlcyBmbHYuanMsIHdoaWNoIGlzIGEgSmF2YVNjcmlwdCBsaWJyYXJ5IHdoaWNoIGltcGxlbWVudHMgbWVjaGFuaXNtcyB0byBwbGF5IGZsdiBmaWxlcyBpbnNwaXJlZCBieSBmbHYuanMuCiAgICAgICAgICogSXQgcmVsaWVzIG9uIEhUTUw1IHZpZGVvIGFuZCBNZWRpYVNvdXJjZSBFeHRlbnNpb25zIGZvciBwbGF5YmFjay4KICAgICAgICAgKiBDdXJyZW50bHksIGl0IGNhbiBvbmx5IHBsYXkgZmlsZXMgd2l0aCB0aGUgc2FtZSBvcmlnaW4uCiAgICAgICAgICoKICAgICAgICAgKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9CaWxpYmlsaS9mbHYuanMKICAgICAgICAgKgogICAgICAgICAqLwogICAgICAgIHZhciBOYXRpdmVGbHYgPSB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGlzTWVkaWFTdGFydGVkOiBmYWxzZSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNNZWRpYUxvYWRlZDogZmFsc2UsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjcmVhdGlvblF1ZXVlOiBbXSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGUgYSBxdWV1ZSB0byBwcmVwYXJlIHRoZSBsb2FkaW5nIG9mIGFuIEZMViBzb3VyY2UKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIC0gYW4gb2JqZWN0IHdpdGggc2V0dGluZ3MgbmVlZGVkIHRvIGxvYWQgYW4gRkxWIHBsYXllciBpbnN0YW5jZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcHJlcGFyZVNldHRpbmdzOiBmdW5jdGlvbiBwcmVwYXJlU2V0dGluZ3Moc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIGlmIChOYXRpdmVGbHYuaXNMb2FkZWQpIHsKICAgICAgICAgICAgICAgICAgICBOYXRpdmVGbHYuY3JlYXRlSW5zdGFuY2Uoc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBOYXRpdmVGbHYubG9hZFNjcmlwdChzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAgICAgTmF0aXZlRmx2LmNyZWF0aW9uUXVldWUucHVzaChzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogTG9hZCBmbHYuanMgc2NyaXB0IG9uIHRoZSBoZWFkZXIgb2YgdGhlIGRvY3VtZW50CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyAtIGFuIG9iamVjdCB3aXRoIHNldHRpbmdzIG5lZWRlZCB0byBsb2FkIGFuIEZMViBwbGF5ZXIgaW5zdGFuY2UKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGxvYWRTY3JpcHQ6IGZ1bmN0aW9uIGxvYWRTY3JpcHQoc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIGlmICghTmF0aXZlRmx2LmlzTWVkaWFTdGFydGVkKSB7CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZmx2anMgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIE5hdGl2ZUZsdi5jcmVhdGVJbnN0YW5jZShzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXR0aW5ncy5vcHRpb25zLnBhdGggPSB0eXBlb2Ygc2V0dGluZ3Mub3B0aW9ucy5wYXRoID09PSAnc3RyaW5nJyA/IHNldHRpbmdzLm9wdGlvbnMucGF0aCA6ICcvL2NkbmpzLmNsb3VkZmxhcmUuY29tL2FqYXgvbGlicy9mbHYuanMvMS4xLjAvZmx2Lm1pbi5qcyc7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjcmlwdCA9IF9kb2N1bWVudDIuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdFNjcmlwdFRhZyA9IF9kb2N1bWVudDIuZGVmYXVsdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0JylbMF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdC5zcmMgPSBzZXR0aW5ncy5vcHRpb25zLnBhdGg7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXR0YWNoIGhhbmRsZXJzIGZvciBhbGwgYnJvd3NlcnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZG9uZSAmJiAoIXRoaXMucmVhZHlTdGF0ZSB8fCB0aGlzLnJlYWR5U3RhdGUgPT09IHVuZGVmaW5lZCB8fCB0aGlzLnJlYWR5U3RhdGUgPT09ICdsb2FkZWQnIHx8IHRoaXMucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE5hdGl2ZUZsdi5tZWRpYVJlYWR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0U2NyaXB0VGFnLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHNjcmlwdCwgZmlyc3RTY3JpcHRUYWcpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBOYXRpdmVGbHYuaXNNZWRpYVN0YXJ0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFByb2Nlc3MgcXVldWUgb2YgRkxWIHBsYXllciBjcmVhdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgbWVkaWFSZWFkeTogZnVuY3Rpb24gbWVkaWFSZWFkeSgpIHsKICAgICAgICAgICAgICAgIE5hdGl2ZUZsdi5pc0xvYWRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBOYXRpdmVGbHYuaXNNZWRpYUxvYWRlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgd2hpbGUgKE5hdGl2ZUZsdi5jcmVhdGlvblF1ZXVlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2V0dGluZ3MgPSBOYXRpdmVGbHYuY3JlYXRpb25RdWV1ZS5wb3AoKTsKICAgICAgICAgICAgICAgICAgICBOYXRpdmVGbHYuY3JlYXRlSW5zdGFuY2Uoc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBGTFYgcGxheWVyIGFuZCB0cmlnZ2VyIGEgY3VzdG9tIGV2ZW50IHRvIGluaXRpYWxpemUgaXQKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIC0gYW4gb2JqZWN0IHdpdGggc2V0dGluZ3MgbmVlZGVkIHRvIGluc3RhbnRpYXRlIEZMViBvYmplY3QKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNyZWF0ZUluc3RhbmNlOiBmdW5jdGlvbiBjcmVhdGVJbnN0YW5jZShzZXR0aW5ncykgewogICAgICAgICAgICAgICAgdmFyIHBsYXllciA9IGZsdmpzLmNyZWF0ZVBsYXllcihzZXR0aW5ncy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIF93aW5kb3cyLmRlZmF1bHRbJ19fcmVhZHlfXycgKyBzZXR0aW5ncy5pZF0ocGxheWVyKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBGbHZOYXRpdmVSZW5kZXJlciA9IHsKICAgICAgICAgICAgbmFtZTogJ25hdGl2ZV9mbHYnLAoKICAgICAgICAgICAgb3B0aW9uczogewogICAgICAgICAgICAgICAgcHJlZml4OiAnbmF0aXZlX2ZsdicsCiAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAqIEN1c3RvbSBjb25maWd1cmF0aW9uIGZvciBGTFYgcGxheWVyCiAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICogQHNlZSBodHRwczovL2dpdGh1Yi5jb20vQmlsaWJpbGkvZmx2LmpzL2Jsb2IvbWFzdGVyL2RvY3MvYXBpLm1kI2NvbmZpZwogICAgICAgICAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgZmx2OiB7CiAgICAgICAgICAgICAgICAgICAgLy8gU3BlY2lhbCBjb25maWc6IHVzZWQgdG8gc2V0IHRoZSBsb2NhbCBwYXRoL1VSTCBvZiBmbHYuanMgbGlicmFyeQogICAgICAgICAgICAgICAgICAgIHBhdGg6ICcvL2NkbmpzLmNsb3VkZmxhcmUuY29tL2FqYXgvbGlicy9mbHYuanMvMS4xLjAvZmx2Lm1pbi5qcycsCiAgICAgICAgICAgICAgICAgICAgY29yczogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlbmFibGVXb3JrZXI6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGVuYWJsZVN0YXNoQnVmZmVyOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIHN0YXNoSW5pdGlhbFNpemU6IHVuZGVmaW5lZCwKICAgICAgICAgICAgICAgICAgICBpc0xpdmU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGxhenlMb2FkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGxhenlMb2FkTWF4RHVyYXRpb246IDMgKiA2MCwKICAgICAgICAgICAgICAgICAgICBkZWZlckxvYWRBZnRlclNvdXJjZU9wZW46IHRydWUsCiAgICAgICAgICAgICAgICAgICAgc3RhdGlzdGljc0luZm9SZXBvcnRJbnRlcnZhbDogNjAwLAogICAgICAgICAgICAgICAgICAgIGFjY3VyYXRlU2VlazogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgc2Vla1R5cGU6ICdyYW5nZScsIC8vIFtyYW5nZSwgcGFyYW0sIGN1c3RvbV0KICAgICAgICAgICAgICAgICAgICBzZWVrUGFyYW1TdGFydDogJ2JzdGFydCcsCiAgICAgICAgICAgICAgICAgICAgc2Vla1BhcmFtRW5kOiAnYmVuZCcsCiAgICAgICAgICAgICAgICAgICAgcmFuZ2VMb2FkWmVyb1N0YXJ0OiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBjdXN0b21TZWVrSGFuZGxlcjogdW5kZWZpbmVkCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBEZXRlcm1pbmUgaWYgYSBzcGVjaWZpYyBlbGVtZW50IHR5cGUgY2FuIGJlIHBsYXllZCB3aXRoIHRoaXMgcmVuZGVyCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAgICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjYW5QbGF5VHlwZTogZnVuY3Rpb24gY2FuUGxheVR5cGUodHlwZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIF9jb25zdGFudHMuSEFTX01TRSAmJiBbJ3ZpZGVvL3gtZmx2JywgJ3ZpZGVvL2ZsdiddLmluY2x1ZGVzKHR5cGUpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENyZWF0ZSB0aGUgcGxheWVyIGluc3RhbmNlIGFuZCBhZGQgYWxsIG5hdGl2ZSBldmVudHMvbWV0aG9kcy9wcm9wZXJ0aWVzIGFzIHBvc3NpYmxlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7TWVkaWFFbGVtZW50fSBtZWRpYUVsZW1lbnQgSW5zdGFuY2Ugb2YgbWVqcy5NZWRpYUVsZW1lbnQgYWxyZWFkeSBjcmVhdGVkCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEFsbCB0aGUgcGxheWVyIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBwYXNzZWQgdGhyb3VnaCBjb25zdHJ1Y3RvcgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdFtdfSBtZWRpYUZpbGVzIExpc3Qgb2Ygc291cmNlcyB3aXRoIGZvcm1hdDoge3NyYzogdXJsLCB0eXBlOiB4L3kten0KICAgICAgICAgICAgICogQHJldHVybiB7T2JqZWN0fQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY3JlYXRlOiBmdW5jdGlvbiBjcmVhdGUobWVkaWFFbGVtZW50LCBvcHRpb25zLCBtZWRpYUZpbGVzKSB7CgogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsTm9kZSA9IG1lZGlhRWxlbWVudC5vcmlnaW5hbE5vZGUsCiAgICAgICAgICAgICAgICAgICAgaWQgPSBtZWRpYUVsZW1lbnQuaWQgKyAnXycgKyBvcHRpb25zLnByZWZpeCwKICAgICAgICAgICAgICAgICAgICBmbHZQbGF5ZXIgPSB2b2lkIDAsCiAgICAgICAgICAgICAgICAgICAgc3RhY2sgPSB7fSwKICAgICAgICAgICAgICAgICAgICBpID0gdm9pZCAwLAogICAgICAgICAgICAgICAgICAgIGlsID0gdm9pZCAwOwoKICAgICAgICAgICAgICAgIG5vZGUgPSBvcmlnaW5hbE5vZGUuY2xvbmVOb2RlKHRydWUpOwogICAgICAgICAgICAgICAgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24ob3B0aW9ucywgbWVkaWFFbGVtZW50Lm9wdGlvbnMpOwoKICAgICAgICAgICAgICAgIC8vIFdSQVBQRVJTIGZvciBQUk9QcwogICAgICAgICAgICAgICAgdmFyIHByb3BzID0gX21lanMyLmRlZmF1bHQuaHRtbDVtZWRpYS5wcm9wZXJ0aWVzLAogICAgICAgICAgICAgICAgICAgIGFzc2lnbkdldHRlcnNTZXR0ZXJzID0gZnVuY3Rpb24gYXNzaWduR2V0dGVyc1NldHRlcnMocHJvcE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNhcE5hbWUgPSAnJyArIHByb3BOYW1lLnN1YnN0cmluZygwLCAxKS50b1VwcGVyQ2FzZSgpICsgcHJvcE5hbWUuc3Vic3RyaW5nKDEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVsnZ2V0JyArIGNhcE5hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZsdlBsYXllciAhPT0gbnVsbCA/IG5vZGVbcHJvcE5hbWVdIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVbJ3NldCcgKyBjYXBOYW1lXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFfbWVqczIuZGVmYXVsdC5odG1sNW1lZGlhLnJlYWRPbmx5UHJvcGVydGllcy5pbmNsdWRlcyhwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmx2UGxheWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVbcHJvcE5hbWVdID0gdmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvcE5hbWUgPT09ICdzcmMnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbHZQbGF5ZXIuZGV0YWNoTWVkaWFFbGVtZW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbHZQbGF5ZXIuYXR0YWNoTWVkaWFFbGVtZW50KG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmx2UGxheWVyLmxvYWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0b3JlIGZvciBhZnRlciAiUkVBRFkiIGV2ZW50IGZpcmVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2goe3R5cGU6ICdzZXQnLCBwcm9wTmFtZTogcHJvcE5hbWUsIHZhbHVlOiB2YWx1ZX0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsID0gcHJvcHMubGVuZ3RoOyBpIDwgaWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbkdldHRlcnNTZXR0ZXJzKHByb3BzW2ldKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBJbml0aWFsIG1ldGhvZCB0byByZWdpc3RlciBhbGwgRkxWIGV2ZW50cwogICAgICAgICAgICAgICAgX3dpbmRvdzIuZGVmYXVsdFsnX19yZWFkeV9fJyArIGlkXSA9IGZ1bmN0aW9uIChfZmx2UGxheWVyKSB7CgogICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5mbHZQbGF5ZXIgPSBmbHZQbGF5ZXIgPSBfZmx2UGxheWVyOwoKICAgICAgICAgICAgICAgICAgICAvLyBkbyBjYWxsIHN0YWNrCiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YWNrLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IHN0YWNrLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RhY2tJdGVtID0gc3RhY2tbaV07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YWNrSXRlbS50eXBlID09PSAnc2V0JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcm9wTmFtZSA9IHN0YWNrSXRlbS5wcm9wTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FwTmFtZSA9ICcnICsgcHJvcE5hbWUuc3Vic3RyaW5nKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyBwcm9wTmFtZS5zdWJzdHJpbmcoMSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVbJ3NldCcgKyBjYXBOYW1lXShzdGFja0l0ZW0udmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFja0l0ZW0udHlwZSA9PT0gJ2NhbGwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZVtzdGFja0l0ZW0ubWV0aG9kTmFtZV0oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gQlVCQkxFIEVWRU5UUwogICAgICAgICAgICAgICAgICAgIHZhciBldmVudHMgPSBfbWVqczIuZGVmYXVsdC5odG1sNW1lZGlhLmV2ZW50cywKICAgICAgICAgICAgICAgICAgICAgICAgYXNzaWduRXZlbnRzID0gZnVuY3Rpb24gYXNzaWduRXZlbnRzKGV2ZW50TmFtZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudE5hbWUgPT09ICdsb2FkZWRtZXRhZGF0YScpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmx2UGxheWVyLmRldGFjaE1lZGlhRWxlbWVudCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsdlBsYXllci5hdHRhY2hNZWRpYUVsZW1lbnQobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmx2UGxheWVyLmxvYWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnROYW1lLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IF9kb2N1bWVudDIuZGVmYXVsdC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmluaXRFdmVudChlLnR5cGUsIGUuYnViYmxlcywgZS5jYW5jZWxhYmxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBldmVudC5zcmNFbGVtZW50ID0gZS5zcmNFbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGV2ZW50LnRhcmdldCA9IGUuc3JjRWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgZXZlbnRzID0gZXZlbnRzLmNvbmNhdChbJ2NsaWNrJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCddKTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBldmVudHMubGVuZ3RoOyBpIDwgaWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBhc3NpZ25FdmVudHMoZXZlbnRzW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGlmIChtZWRpYUZpbGVzICYmIG1lZGlhRmlsZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsID0gbWVkaWFGaWxlcy5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfcmVuZGVyZXIucmVuZGVyZXIucmVuZGVyZXJzW29wdGlvbnMucHJlZml4XS5jYW5QbGF5VHlwZShtZWRpYUZpbGVzW2ldLnR5cGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZSgnc3JjJywgbWVkaWFGaWxlc1tpXS5zcmMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoJ2lkJywgaWQpOwoKICAgICAgICAgICAgICAgIG9yaWdpbmFsTm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShub2RlLCBvcmlnaW5hbE5vZGUpOwogICAgICAgICAgICAgICAgb3JpZ2luYWxOb2RlLnJlbW92ZUF0dHJpYnV0ZSgnYXV0b3BsYXknKTsKICAgICAgICAgICAgICAgIG9yaWdpbmFsTm9kZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgICAgICAgICAgICAgIC8vIE9wdGlvbnMgdGhhdCBjYW5ub3QgYmUgb3ZlcnJpZGRlbgogICAgICAgICAgICAgICAgb3B0aW9ucy5mbHYudHlwZSA9ICdmbHYnOwogICAgICAgICAgICAgICAgb3B0aW9ucy5mbHYudXJsID0gbm9kZS5nZXRBdHRyaWJ1dGUoJ3NyYycpOwoKICAgICAgICAgICAgICAgIE5hdGl2ZUZsdi5wcmVwYXJlU2V0dGluZ3MoewogICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMuZmx2LAogICAgICAgICAgICAgICAgICAgIGlkOiBpZAogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgLy8gSEVMUEVSIE1FVEhPRFMKICAgICAgICAgICAgICAgIG5vZGUuc2V0U2l6ZSA9IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5zdHlsZS53aWR0aCA9IHdpZHRoICsgJ3B4JzsKICAgICAgICAgICAgICAgICAgICBub2RlLnN0eWxlLmhlaWdodCA9IGhlaWdodCArICdweCc7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIG5vZGUuaGlkZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBub2RlLnBhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBub2RlLnNob3cgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5zdHlsZS5kaXNwbGF5ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIG5vZGUuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBmbHZQbGF5ZXIuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ3JlbmRlcmVycmVhZHknLCBub2RlKTsKICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKCiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFJlZ2lzdGVyIE5hdGl2ZSBGTFYgdHlwZSBiYXNlZCBvbiBVUkwgc3RydWN0dXJlCiAgICAgICAgICoKICAgICAgICAgKi8KICAgICAgICBfbWVkaWEudHlwZUNoZWNrcy5wdXNoKGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgdXJsID0gdXJsLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHJldHVybiB1cmwuaW5jbHVkZXMoJy5mbHYnKSA/ICd2aWRlby9mbHYnIDogbnVsbDsKICAgICAgICB9KTsKCiAgICAgICAgX3JlbmRlcmVyLnJlbmRlcmVyLmFkZChGbHZOYXRpdmVSZW5kZXJlcik7CgogICAgfSwgeyIyIjogMiwgIjI3IjogMjcsICIyOCI6IDI4LCAiMyI6IDMsICIzMCI6IDMwLCAiNiI6IDYsICI3IjogN31dLAogICAgMjI6IFtmdW5jdGlvbiAoX2RlcmVxXywgbW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgCgogICAgICAgIHZhciBfd2luZG93ID0gX2RlcmVxXygzKTsKCiAgICAgICAgdmFyIF93aW5kb3cyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfd2luZG93KTsKCiAgICAgICAgdmFyIF9kb2N1bWVudCA9IF9kZXJlcV8oMik7CgogICAgICAgIHZhciBfZG9jdW1lbnQyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfZG9jdW1lbnQpOwoKICAgICAgICB2YXIgX21lanMgPSBfZGVyZXFfKDYpOwoKICAgICAgICB2YXIgX21lanMyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfbWVqcyk7CgogICAgICAgIHZhciBfcmVuZGVyZXIgPSBfZGVyZXFfKDcpOwoKICAgICAgICB2YXIgX2RvbSA9IF9kZXJlcV8oMjgpOwoKICAgICAgICB2YXIgX2NvbnN0YW50cyA9IF9kZXJlcV8oMjcpOwoKICAgICAgICB2YXIgX21lZGlhID0gX2RlcmVxXygzMCk7CgogICAgICAgIGZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ZGVmYXVsdDogb2JqfTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIE5hdGl2ZSBITFMgcmVuZGVyZXIKICAgICAgICAgKgogICAgICAgICAqIFVzZXMgRGFpbHlNb3Rpb24ncyBobHMuanMsIHdoaWNoIGlzIGEgSmF2YVNjcmlwdCBsaWJyYXJ5IHdoaWNoIGltcGxlbWVudHMgYW4gSFRUUCBMaXZlIFN0cmVhbWluZyBjbGllbnQuCiAgICAgICAgICogSXQgcmVsaWVzIG9uIEhUTUw1IHZpZGVvIGFuZCBNZWRpYVNvdXJjZSBFeHRlbnNpb25zIGZvciBwbGF5YmFjay4KICAgICAgICAgKiBUaGlzIHJlbmRlcmVyIGludGVncmF0ZXMgbmV3IGV2ZW50cyBhc3NvY2lhdGVkIHdpdGggbTN1OCBmaWxlcyB0aGUgc2FtZSB3YXkgRmxhc2ggdmVyc2lvbiBvZiBIbHMgZG9lcy4KICAgICAgICAgKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9kYWlseW1vdGlvbi9obHMuanMKICAgICAgICAgKgogICAgICAgICAqLwogICAgICAgIHZhciBOYXRpdmVIbHMgPSB7CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGlzTWVkaWFTdGFydGVkOiBmYWxzZSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNNZWRpYUxvYWRlZDogZmFsc2UsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7QXJyYXl9CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjcmVhdGlvblF1ZXVlOiBbXSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGUgYSBxdWV1ZSB0byBwcmVwYXJlIHRoZSBsb2FkaW5nIG9mIGFuIEhMUyBzb3VyY2UKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIC0gYW4gb2JqZWN0IHdpdGggc2V0dGluZ3MgbmVlZGVkIHRvIGxvYWQgYW4gSExTIHBsYXllciBpbnN0YW5jZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcHJlcGFyZVNldHRpbmdzOiBmdW5jdGlvbiBwcmVwYXJlU2V0dGluZ3Moc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIGlmIChOYXRpdmVIbHMuaXNMb2FkZWQpIHsKICAgICAgICAgICAgICAgICAgICBOYXRpdmVIbHMuY3JlYXRlSW5zdGFuY2Uoc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBOYXRpdmVIbHMubG9hZFNjcmlwdChzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAgICAgTmF0aXZlSGxzLmNyZWF0aW9uUXVldWUucHVzaChzZXR0aW5ncyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogTG9hZCBobHMuanMgc2NyaXB0IG9uIHRoZSBoZWFkZXIgb2YgdGhlIGRvY3VtZW50CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyAtIGFuIG9iamVjdCB3aXRoIHNldHRpbmdzIG5lZWRlZCB0byBsb2FkIGFuIEhMUyBwbGF5ZXIgaW5zdGFuY2UKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGxvYWRTY3JpcHQ6IGZ1bmN0aW9uIGxvYWRTY3JpcHQoc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIGlmICghTmF0aXZlSGxzLmlzTWVkaWFTdGFydGVkKSB7CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgSGxzICE9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgICAgICAgICBOYXRpdmVIbHMuY3JlYXRlSW5zdGFuY2Uoc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3Mub3B0aW9ucy5wYXRoID0gdHlwZW9mIHNldHRpbmdzLm9wdGlvbnMucGF0aCA9PT0gJ3N0cmluZycgPyBzZXR0aW5ncy5vcHRpb25zLnBhdGggOiAnLy9jZG4uanNkZWxpdnIubmV0L2hscy5qcy9sYXRlc3QvaGxzLm1pbi5qcyc7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjcmlwdCA9IF9kb2N1bWVudDIuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdFNjcmlwdFRhZyA9IF9kb2N1bWVudDIuZGVmYXVsdC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0JylbMF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdC5zcmMgPSBzZXR0aW5ncy5vcHRpb25zLnBhdGg7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXR0YWNoIGhhbmRsZXJzIGZvciBhbGwgYnJvd3NlcnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZG9uZSAmJiAoIXRoaXMucmVhZHlTdGF0ZSB8fCB0aGlzLnJlYWR5U3RhdGUgPT09IHVuZGVmaW5lZCB8fCB0aGlzLnJlYWR5U3RhdGUgPT09ICdsb2FkZWQnIHx8IHRoaXMucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE5hdGl2ZUhscy5tZWRpYVJlYWR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0U2NyaXB0VGFnLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHNjcmlwdCwgZmlyc3RTY3JpcHRUYWcpOwogICAgICAgICAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBOYXRpdmVIbHMuaXNNZWRpYVN0YXJ0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFByb2Nlc3MgcXVldWUgb2YgSExTIHBsYXllciBjcmVhdGlvbgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgbWVkaWFSZWFkeTogZnVuY3Rpb24gbWVkaWFSZWFkeSgpIHsKICAgICAgICAgICAgICAgIE5hdGl2ZUhscy5pc0xvYWRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBOYXRpdmVIbHMuaXNNZWRpYUxvYWRlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgd2hpbGUgKE5hdGl2ZUhscy5jcmVhdGlvblF1ZXVlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2V0dGluZ3MgPSBOYXRpdmVIbHMuY3JlYXRpb25RdWV1ZS5wb3AoKTsKICAgICAgICAgICAgICAgICAgICBOYXRpdmVIbHMuY3JlYXRlSW5zdGFuY2Uoc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBITFMgcGxheWVyIGFuZCB0cmlnZ2VyIGEgY3VzdG9tIGV2ZW50IHRvIGluaXRpYWxpemUgaXQKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIC0gYW4gb2JqZWN0IHdpdGggc2V0dGluZ3MgbmVlZGVkIHRvIGluc3RhbnRpYXRlIEhMUyBvYmplY3QKICAgICAgICAgICAgICogQHJldHVybiB7SGxzfQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY3JlYXRlSW5zdGFuY2U6IGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlKHNldHRpbmdzKSB7CiAgICAgICAgICAgICAgICB2YXIgcGxheWVyID0gbmV3IEhscyhzZXR0aW5ncy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIF93aW5kb3cyLmRlZmF1bHRbJ19fcmVhZHlfXycgKyBzZXR0aW5ncy5pZF0ocGxheWVyKTsKICAgICAgICAgICAgICAgIHJldHVybiBwbGF5ZXI7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgSGxzTmF0aXZlUmVuZGVyZXIgPSB7CiAgICAgICAgICAgIG5hbWU6ICduYXRpdmVfaGxzJywKCiAgICAgICAgICAgIG9wdGlvbnM6IHsKICAgICAgICAgICAgICAgIHByZWZpeDogJ25hdGl2ZV9obHMnLAogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBDdXN0b20gY29uZmlndXJhdGlvbiBmb3IgSExTIHBsYXllcgogICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAqIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2RhaWx5bW90aW9uL2hscy5qcy9ibG9iL21hc3Rlci9BUEkubWQjdXNlci1jb250ZW50LWZpbmUtdHVuaW5nCiAgICAgICAgICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICBobHM6IHsKICAgICAgICAgICAgICAgICAgICAvLyBTcGVjaWFsIGNvbmZpZzogdXNlZCB0byBzZXQgdGhlIGxvY2FsIHBhdGgvVVJMIG9mIGhscy5qcyBsaWJyYXJ5CiAgICAgICAgICAgICAgICAgICAgcGF0aDogJy8vY2RuLmpzZGVsaXZyLm5ldC9obHMuanMvbGF0ZXN0L2hscy5taW4uanMnLAogICAgICAgICAgICAgICAgICAgIGF1dG9TdGFydExvYWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRQb3NpdGlvbjogLTEsCiAgICAgICAgICAgICAgICAgICAgY2FwTGV2ZWxUb1BsYXllclNpemU6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGRlYnVnOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBtYXhCdWZmZXJMZW5ndGg6IDMwLAogICAgICAgICAgICAgICAgICAgIG1heE1heEJ1ZmZlckxlbmd0aDogNjAwLAogICAgICAgICAgICAgICAgICAgIG1heEJ1ZmZlclNpemU6IDYwICogMTAwMCAqIDEwMDAsCiAgICAgICAgICAgICAgICAgICAgbWF4QnVmZmVySG9sZTogMC41LAogICAgICAgICAgICAgICAgICAgIG1heFNlZWtIb2xlOiAyLAogICAgICAgICAgICAgICAgICAgIHNlZWtIb2xlTnVkZ2VEdXJhdGlvbjogMC4wMSwKICAgICAgICAgICAgICAgICAgICBtYXhGcmFnTG9va1VwVG9sZXJhbmNlOiAwLjIsCiAgICAgICAgICAgICAgICAgICAgbGl2ZVN5bmNEdXJhdGlvbkNvdW50OiAzLAogICAgICAgICAgICAgICAgICAgIGxpdmVNYXhMYXRlbmN5RHVyYXRpb25Db3VudDogMTAsCiAgICAgICAgICAgICAgICAgICAgZW5hYmxlV29ya2VyOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVuYWJsZVNvZnR3YXJlQUVTOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG1hbmlmZXN0TG9hZGluZ1RpbWVPdXQ6IDEwMDAwLAogICAgICAgICAgICAgICAgICAgIG1hbmlmZXN0TG9hZGluZ01heFJldHJ5OiA2LAogICAgICAgICAgICAgICAgICAgIG1hbmlmZXN0TG9hZGluZ1JldHJ5RGVsYXk6IDUwMCwKICAgICAgICAgICAgICAgICAgICBtYW5pZmVzdExvYWRpbmdNYXhSZXRyeVRpbWVvdXQ6IDY0MDAwLAogICAgICAgICAgICAgICAgICAgIGxldmVsTG9hZGluZ1RpbWVPdXQ6IDEwMDAwLAogICAgICAgICAgICAgICAgICAgIGxldmVsTG9hZGluZ01heFJldHJ5OiA2LAogICAgICAgICAgICAgICAgICAgIGxldmVsTG9hZGluZ1JldHJ5RGVsYXk6IDUwMCwKICAgICAgICAgICAgICAgICAgICBsZXZlbExvYWRpbmdNYXhSZXRyeVRpbWVvdXQ6IDY0MDAwLAogICAgICAgICAgICAgICAgICAgIGZyYWdMb2FkaW5nVGltZU91dDogMjAwMDAsCiAgICAgICAgICAgICAgICAgICAgZnJhZ0xvYWRpbmdNYXhSZXRyeTogNiwKICAgICAgICAgICAgICAgICAgICBmcmFnTG9hZGluZ1JldHJ5RGVsYXk6IDUwMCwKICAgICAgICAgICAgICAgICAgICBmcmFnTG9hZGluZ01heFJldHJ5VGltZW91dDogNjQwMDAsCiAgICAgICAgICAgICAgICAgICAgc3RhcnRGcmFnUHJlZmVjaDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgYXBwZW5kRXJyb3JNYXhSZXRyeTogMywKICAgICAgICAgICAgICAgICAgICBlbmFibGVDRUE3MDhDYXB0aW9uczogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBzdHJldGNoU2hvcnRWaWRlb1RyYWNrOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGZvcmNlS2V5RnJhbWVPbkRpc2NvbnRpbnVpdHk6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgYWJyRXdtYUZhc3RMaXZlOiA1LjAsCiAgICAgICAgICAgICAgICAgICAgYWJyRXdtYVNsb3dMaXZlOiA5LjAsCiAgICAgICAgICAgICAgICAgICAgYWJyRXdtYUZhc3RWb0Q6IDQuMCwKICAgICAgICAgICAgICAgICAgICBhYnJFd21hU2xvd1ZvRDogMTUuMCwKICAgICAgICAgICAgICAgICAgICBhYnJFd21hRGVmYXVsdEVzdGltYXRlOiA1MDAwMDAsCiAgICAgICAgICAgICAgICAgICAgYWJyQmFuZFdpZHRoRmFjdG9yOiAwLjgsCiAgICAgICAgICAgICAgICAgICAgYWJyQmFuZFdpZHRoVXBGYWN0b3I6IDAuNwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRGV0ZXJtaW5lIGlmIGEgc3BlY2lmaWMgZWxlbWVudCB0eXBlIGNhbiBiZSBwbGF5ZWQgd2l0aCB0aGlzIHJlbmRlcgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICAgICAgICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY2FuUGxheVR5cGU6IGZ1bmN0aW9uIGNhblBsYXlUeXBlKHR5cGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfY29uc3RhbnRzLkhBU19NU0UgJiYgWydhcHBsaWNhdGlvbi94LW1wZWd1cmwnLCAndm5kLmFwcGxlLm1wZWd1cmwnLCAnYXVkaW8vbXBlZ3VybCcsICdhdWRpby9obHMnLCAndmlkZW8vaGxzJ10uaW5jbHVkZXModHlwZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGUgdGhlIHBsYXllciBpbnN0YW5jZSBhbmQgYWRkIGFsbCBuYXRpdmUgZXZlbnRzL21ldGhvZHMvcHJvcGVydGllcyBhcyBwb3NzaWJsZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge01lZGlhRWxlbWVudH0gbWVkaWFFbGVtZW50IEluc3RhbmNlIG9mIG1lanMuTWVkaWFFbGVtZW50IGFscmVhZHkgY3JlYXRlZAogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBBbGwgdGhlIHBsYXllciBjb25maWd1cmF0aW9uIG9wdGlvbnMgcGFzc2VkIHRocm91Z2ggY29uc3RydWN0b3IKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3RbXX0gbWVkaWFGaWxlcyBMaXN0IG9mIHNvdXJjZXMgd2l0aCBmb3JtYXQ6IHtzcmM6IHVybCwgdHlwZTogeC95LXp9CiAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNyZWF0ZTogZnVuY3Rpb24gY3JlYXRlKG1lZGlhRWxlbWVudCwgb3B0aW9ucywgbWVkaWFGaWxlcykgewoKICAgICAgICAgICAgICAgIHZhciBub2RlID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbE5vZGUgPSBtZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlLAogICAgICAgICAgICAgICAgICAgIGlkID0gbWVkaWFFbGVtZW50LmlkICsgJ18nICsgb3B0aW9ucy5wcmVmaXgsCiAgICAgICAgICAgICAgICAgICAgaGxzUGxheWVyID0gdm9pZCAwLAogICAgICAgICAgICAgICAgICAgIHN0YWNrID0ge30sCiAgICAgICAgICAgICAgICAgICAgaSA9IHZvaWQgMCwKICAgICAgICAgICAgICAgICAgICBpbCA9IHZvaWQgMDsKCiAgICAgICAgICAgICAgICBub2RlID0gb3JpZ2luYWxOb2RlLmNsb25lTm9kZSh0cnVlKTsKICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKG9wdGlvbnMsIG1lZGlhRWxlbWVudC5vcHRpb25zKTsKCiAgICAgICAgICAgICAgICAvLyBXUkFQUEVSUyBmb3IgUFJPUHMKICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IF9tZWpzMi5kZWZhdWx0Lmh0bWw1bWVkaWEucHJvcGVydGllcywKICAgICAgICAgICAgICAgICAgICBhc3NpZ25HZXR0ZXJzU2V0dGVycyA9IGZ1bmN0aW9uIGFzc2lnbkdldHRlcnNTZXR0ZXJzKHByb3BOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYXBOYW1lID0gJycgKyBwcm9wTmFtZS5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHByb3BOYW1lLnN1YnN0cmluZygxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVbJ2dldCcgKyBjYXBOYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBobHNQbGF5ZXIgIT09IG51bGwgPyBub2RlW3Byb3BOYW1lXSA6IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBub2RlWydzZXQnICsgY2FwTmFtZV0gPSBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghX21lanMyLmRlZmF1bHQuaHRtbDVtZWRpYS5yZWFkT25seVByb3BlcnRpZXMuaW5jbHVkZXMocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhsc1BsYXllciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlW3Byb3BOYW1lXSA9IHZhbHVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb3BOYW1lID09PSAnc3JjJykgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhsc1BsYXllci5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBobHNQbGF5ZXIgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGxzUGxheWVyID0gTmF0aXZlSGxzLmNyZWF0ZUluc3RhbmNlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiBvcHRpb25zLmhscywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogaWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhsc1BsYXllci5hdHRhY2hNZWRpYShub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhsc1BsYXllci5vbihIbHMuRXZlbnRzLk1FRElBX0FUVEFDSEVELCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGxzUGxheWVyLmxvYWRTb3VyY2UodmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdG9yZSBmb3IgYWZ0ZXIgIlJFQURZIiBldmVudCBmaXJlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKHt0eXBlOiAnc2V0JywgcHJvcE5hbWU6IHByb3BOYW1lLCB2YWx1ZTogdmFsdWV9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IHByb3BzLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ25HZXR0ZXJzU2V0dGVycyhwcm9wc1tpXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW5pdGlhbCBtZXRob2QgdG8gcmVnaXN0ZXIgYWxsIEhMUyBldmVudHMKICAgICAgICAgICAgICAgIF93aW5kb3cyLmRlZmF1bHRbJ19fcmVhZHlfXycgKyBpZF0gPSBmdW5jdGlvbiAoX2hsc1BsYXllcikgewoKICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuaGxzUGxheWVyID0gaGxzUGxheWVyID0gX2hsc1BsYXllcjsKCiAgICAgICAgICAgICAgICAgICAgLy8gZG8gY2FsbCBzdGFjawogICAgICAgICAgICAgICAgICAgIGlmIChzdGFjay5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBzdGFjay5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YWNrSXRlbSA9IHN0YWNrW2ldOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGFja0l0ZW0udHlwZSA9PT0gJ3NldCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcE5hbWUgPSBzdGFja0l0ZW0ucHJvcE5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhcE5hbWUgPSAnJyArIHByb3BOYW1lLnN1YnN0cmluZygwLCAxKS50b1VwcGVyQ2FzZSgpICsgcHJvcE5hbWUuc3Vic3RyaW5nKDEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlWydzZXQnICsgY2FwTmFtZV0oc3RhY2tJdGVtLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhY2tJdGVtLnR5cGUgPT09ICdjYWxsJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVbc3RhY2tJdGVtLm1ldGhvZE5hbWVdKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIEJVQkJMRSBFVkVOVFMKICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRzID0gX21lanMyLmRlZmF1bHQuaHRtbDVtZWRpYS5ldmVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgIGhsc0V2ZW50cyA9IEhscy5FdmVudHMsCiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2lnbkV2ZW50cyA9IGZ1bmN0aW9uIGFzc2lnbkV2ZW50cyhldmVudE5hbWUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnROYW1lID09PSAnbG9hZGVkbWV0YWRhdGEnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhsc1BsYXllci5kZXRhY2hNZWRpYSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IG5vZGUuc3JjOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGxzUGxheWVyLmF0dGFjaE1lZGlhKG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBobHNQbGF5ZXIub24oaGxzRXZlbnRzLk1FRElBX0FUVEFDSEVELCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBobHNQbGF5ZXIubG9hZFNvdXJjZSh1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29weSBldmVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9IF9kb2N1bWVudDIuZGVmYXVsdC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmluaXRFdmVudChlLnR5cGUsIGUuYnViYmxlcywgZS5jYW5jZWxhYmxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBldmVudC5zcmNFbGVtZW50ID0gZS5zcmNFbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGV2ZW50LnRhcmdldCA9IGUuc3JjRWxlbWVudDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGV2ZW50cyA9IGV2ZW50cy5jb25jYXQoWydjbGljaycsICdtb3VzZW92ZXInLCAnbW91c2VvdXQnXSk7CgogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsID0gZXZlbnRzLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXNzaWduRXZlbnRzKGV2ZW50c1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiBDdXN0b20gSExTIGV2ZW50cwogICAgICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgICAgICogVGhlc2UgZXZlbnRzIGNhbiBiZSBhdHRhY2hlZCB0byB0aGUgb3JpZ2luYWwgbm9kZSB1c2luZyBhZGRFdmVudExpc3RlbmVyIGFuZCB0aGUgbmFtZSBvZiB0aGUgZXZlbnQsCiAgICAgICAgICAgICAgICAgICAgICogbm90IHVzaW5nIEhscy5FdmVudHMgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICogQHNlZSBodHRwczovL2dpdGh1Yi5jb20vZGFpbHltb3Rpb24vaGxzLmpzL2Jsb2IvbWFzdGVyL3NyYy9ldmVudHMuanMKICAgICAgICAgICAgICAgICAgICAgKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9kYWlseW1vdGlvbi9obHMuanMvYmxvYi9tYXN0ZXIvc3JjL2Vycm9ycy5qcwogICAgICAgICAgICAgICAgICAgICAqIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2RhaWx5bW90aW9uL2hscy5qcy9ibG9iL21hc3Rlci9BUEkubWQjcnVudGltZS1ldmVudHMKICAgICAgICAgICAgICAgICAgICAgKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9kYWlseW1vdGlvbi9obHMuanMvYmxvYi9tYXN0ZXIvQVBJLm1kI2Vycm9ycwogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgIHZhciBhc3NpZ25IbHNFdmVudHMgPSBmdW5jdGlvbiBhc3NpZ25IbHNFdmVudHMoZSwgZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoZSwgbm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBkYXRhOwogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZSA9PT0gJ2hsc0Vycm9yJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlLCBkYXRhKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBib3Jyb3dlZCBmcm9tIGh0dHA6Ly9kYWlseW1vdGlvbi5naXRodWIuaW8vaGxzLmpzL2RlbW8vCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5mYXRhbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhsc1BsYXllci5kZXN0cm95KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZGF0YS50eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ21lZGlhRXJyb3InOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGxzUGxheWVyLnJlY292ZXJNZWRpYUVycm9yKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ25ldHdvcmtFcnJvcic6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBobHNQbGF5ZXIuc3RhcnRMb2FkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgZXZlbnRUeXBlIGluIGhsc0V2ZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGxzRXZlbnRzLmhhc093blByb3BlcnR5KGV2ZW50VHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhsc1BsYXllci5vbihobHNFdmVudHNbZXZlbnRUeXBlXSwgYXNzaWduSGxzRXZlbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgaWYgKG1lZGlhRmlsZXMgJiYgbWVkaWFGaWxlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBtZWRpYUZpbGVzLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9yZW5kZXJlci5yZW5kZXJlci5yZW5kZXJlcnNbb3B0aW9ucy5wcmVmaXhdLmNhblBsYXlUeXBlKG1lZGlhRmlsZXNbaV0udHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKCdzcmMnLCBtZWRpYUZpbGVzW2ldLnNyYyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZSgnaWQnLCBpZCk7CgogICAgICAgICAgICAgICAgb3JpZ2luYWxOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5vZGUsIG9yaWdpbmFsTm9kZSk7CiAgICAgICAgICAgICAgICBvcmlnaW5hbE5vZGUucmVtb3ZlQXR0cmlidXRlKCdhdXRvcGxheScpOwogICAgICAgICAgICAgICAgb3JpZ2luYWxOb2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgogICAgICAgICAgICAgICAgTmF0aXZlSGxzLnByZXBhcmVTZXR0aW5ncyh7CiAgICAgICAgICAgICAgICAgICAgb3B0aW9uczogb3B0aW9ucy5obHMsCiAgICAgICAgICAgICAgICAgICAgaWQ6IGlkCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAvLyBIRUxQRVIgTUVUSE9EUwogICAgICAgICAgICAgICAgbm9kZS5zZXRTaXplID0gZnVuY3Rpb24gKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICBub2RlLnN0eWxlLndpZHRoID0gd2lkdGggKyAncHgnOwogICAgICAgICAgICAgICAgICAgIG5vZGUuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgJ3B4JzsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIG5vZGUuaGlkZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBub2RlLnBhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBub2RlLnNob3cgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5zdHlsZS5kaXNwbGF5ID0gJyc7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIG5vZGUuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBobHNQbGF5ZXIuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ3JlbmRlcmVycmVhZHknLCBub2RlKTsKICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKCiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFJlZ2lzdGVyIE5hdGl2ZSBITFMgdHlwZSBiYXNlZCBvbiBVUkwgc3RydWN0dXJlCiAgICAgICAgICoKICAgICAgICAgKi8KICAgICAgICBfbWVkaWEudHlwZUNoZWNrcy5wdXNoKGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICAgICAgdXJsID0gdXJsLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHJldHVybiB1cmwuaW5jbHVkZXMoJy5tM3U4JykgPyAnYXBwbGljYXRpb24veC1tcGVnVVJMJyA6IG51bGw7CiAgICAgICAgfSk7CgogICAgICAgIF9yZW5kZXJlci5yZW5kZXJlci5hZGQoSGxzTmF0aXZlUmVuZGVyZXIpOwoKICAgIH0sIHsiMiI6IDIsICIyNyI6IDI3LCAiMjgiOiAyOCwgIjMiOiAzLCAiMzAiOiAzMCwgIjYiOiA2LCAiNyI6IDd9XSwKICAgIDIzOiBbZnVuY3Rpb24gKF9kZXJlcV8sIG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgIAoKICAgICAgICB2YXIgX3dpbmRvdyA9IF9kZXJlcV8oMyk7CgogICAgICAgIHZhciBfd2luZG93MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3dpbmRvdyk7CgogICAgICAgIHZhciBfZG9jdW1lbnQgPSBfZGVyZXFfKDIpOwoKICAgICAgICB2YXIgX2RvY3VtZW50MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2RvY3VtZW50KTsKCiAgICAgICAgdmFyIF9tZWpzID0gX2RlcmVxXyg2KTsKCiAgICAgICAgdmFyIF9tZWpzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX21lanMpOwoKICAgICAgICB2YXIgX3JlbmRlcmVyID0gX2RlcmVxXyg3KTsKCiAgICAgICAgdmFyIF9kb20gPSBfZGVyZXFfKDI4KTsKCiAgICAgICAgdmFyIF9jb25zdGFudHMgPSBfZGVyZXFfKDI3KTsKCiAgICAgICAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHtkZWZhdWx0OiBvYmp9OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogTmF0aXZlIEhUTUw1IFJlbmRlcmVyCiAgICAgICAgICoKICAgICAgICAgKiBXcmFwcyB0aGUgbmF0aXZlIEhUTUw1IDxhdWRpbz4gb3IgPHZpZGVvPiB0YWcgYW5kIGJ1YmJsZXMgaXRzIHByb3BlcnRpZXMsIGV2ZW50cywgYW5kIG1ldGhvZHMgdXAgdG8gdGhlIG1lZGlhRWxlbWVudC4KICAgICAgICAgKi8KICAgICAgICB2YXIgSHRtbE1lZGlhRWxlbWVudCA9IHsKCiAgICAgICAgICAgIG5hbWU6ICdodG1sNScsCgogICAgICAgICAgICBvcHRpb25zOiB7CiAgICAgICAgICAgICAgICBwcmVmaXg6ICdodG1sNScKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBEZXRlcm1pbmUgaWYgYSBzcGVjaWZpYyBlbGVtZW50IHR5cGUgY2FuIGJlIHBsYXllZCB3aXRoIHRoaXMgcmVuZGVyCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAgICAgICAgICAqIEByZXR1cm4ge1N0cmluZ30KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNhblBsYXlUeXBlOiBmdW5jdGlvbiBjYW5QbGF5VHlwZSh0eXBlKSB7CgogICAgICAgICAgICAgICAgdmFyIG1lZGlhRWxlbWVudCA9IF9kb2N1bWVudDIuZGVmYXVsdC5jcmVhdGVFbGVtZW50KCd2aWRlbycpOwoKICAgICAgICAgICAgICAgIC8vIER1ZSB0byBhbiBpc3N1ZSBvbiBXZWJraXQsIGZvcmNlIHRoZSBNUDMgYW5kIE1QNCBvbiBBbmRyb2lkIGFuZCBjb25zaWRlciBuYXRpdmUgc3VwcG9ydCBmb3IgSExTCiAgICAgICAgICAgICAgICBpZiAoX2NvbnN0YW50cy5JU19BTkRST0lEICYmIHR5cGUubWF0Y2goL1wvbXAoM3w0KSQvZ2kpICE9PSBudWxsIHx8IFsnYXBwbGljYXRpb24veC1tcGVndXJsJywgJ3ZuZC5hcHBsZS5tcGVndXJsJywgJ2F1ZGlvL21wZWd1cmwnLCAnYXVkaW8vaGxzJywgJ3ZpZGVvL2hscyddLmluY2x1ZGVzKHR5cGUudG9Mb3dlckNhc2UoKSkgJiYgX2NvbnN0YW50cy5TVVBQT1JUU19OQVRJVkVfSExTKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd5ZXMnOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChtZWRpYUVsZW1lbnQuY2FuUGxheVR5cGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWVkaWFFbGVtZW50LmNhblBsYXlUeXBlKHR5cGUpLnJlcGxhY2UoL25vLywgJycpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGUgdGhlIHBsYXllciBpbnN0YW5jZSBhbmQgYWRkIGFsbCBuYXRpdmUgZXZlbnRzL21ldGhvZHMvcHJvcGVydGllcyBhcyBwb3NzaWJsZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge01lZGlhRWxlbWVudH0gbWVkaWFFbGVtZW50IEluc3RhbmNlIG9mIG1lanMuTWVkaWFFbGVtZW50IGFscmVhZHkgY3JlYXRlZAogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBBbGwgdGhlIHBsYXllciBjb25maWd1cmF0aW9uIG9wdGlvbnMgcGFzc2VkIHRocm91Z2ggY29uc3RydWN0b3IKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3RbXX0gbWVkaWFGaWxlcyBMaXN0IG9mIHNvdXJjZXMgd2l0aCBmb3JtYXQ6IHtzcmM6IHVybCwgdHlwZTogeC95LXp9CiAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNyZWF0ZTogZnVuY3Rpb24gY3JlYXRlKG1lZGlhRWxlbWVudCwgb3B0aW9ucywgbWVkaWFGaWxlcykgewoKICAgICAgICAgICAgICAgIHZhciBub2RlID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICBpZCA9IG1lZGlhRWxlbWVudC5pZCArICdfJyArIG9wdGlvbnMucHJlZml4LAogICAgICAgICAgICAgICAgICAgIGkgPSB2b2lkIDAsCiAgICAgICAgICAgICAgICAgICAgaWwgPSB2b2lkIDA7CgogICAgICAgICAgICAgICAgLy8gQ1JFQVRFIE5PREUKICAgICAgICAgICAgICAgIGlmIChtZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlID09PSB1bmRlZmluZWQgfHwgbWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIG5vZGUgPSBfZG9jdW1lbnQyLmRlZmF1bHQuY3JlYXRlRWxlbWVudCgnYXVkaW8nKTsKICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuYXBwZW5kQ2hpbGQobm9kZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5vZGUgPSBtZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKCdpZCcsIGlkKTsKCiAgICAgICAgICAgICAgICAvLyBXUkFQUEVSUyBmb3IgUFJPUHMKICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IF9tZWpzMi5kZWZhdWx0Lmh0bWw1bWVkaWEucHJvcGVydGllcywKICAgICAgICAgICAgICAgICAgICBhc3NpZ25HZXR0ZXJzU2V0dGVycyA9IGZ1bmN0aW9uIGFzc2lnbkdldHRlcnNTZXR0ZXJzKHByb3BOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYXBOYW1lID0gJycgKyBwcm9wTmFtZS5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHByb3BOYW1lLnN1YnN0cmluZygxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVbJ2dldCcgKyBjYXBOYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVbJ3NldCcgKyBjYXBOYW1lXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFfbWVqczIuZGVmYXVsdC5odG1sNW1lZGlhLnJlYWRPbmx5UHJvcGVydGllcy5pbmNsdWRlcyhwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlW3Byb3BOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBwcm9wcy5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYXNzaWduR2V0dGVyc1NldHRlcnMocHJvcHNbaV0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBldmVudHMgPSBfbWVqczIuZGVmYXVsdC5odG1sNW1lZGlhLmV2ZW50cy5jb25jYXQoWydjbGljaycsICdtb3VzZW92ZXInLCAnbW91c2VvdXQnXSksCiAgICAgICAgICAgICAgICAgICAgYXNzaWduRXZlbnRzID0gZnVuY3Rpb24gYXNzaWduRXZlbnRzKGV2ZW50TmFtZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKGV2ZW50TmFtZSwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvcHkgZXZlbnQKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBfZG9jdW1lbnQyLmRlZmF1bHQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LmluaXRFdmVudChlLnR5cGUsIGUuYnViYmxlcywgZS5jYW5jZWxhYmxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vZXZlbnQuc3JjRWxlbWVudCA9IGUuc3JjRWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vZXZlbnQudGFyZ2V0ID0gZS5zcmNFbGVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsID0gZXZlbnRzLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ25FdmVudHMoZXZlbnRzW2ldKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBIRUxQRVIgTUVUSE9EUwogICAgICAgICAgICAgICAgbm9kZS5zZXRTaXplID0gZnVuY3Rpb24gKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICBub2RlLnN0eWxlLndpZHRoID0gd2lkdGggKyAncHgnOwogICAgICAgICAgICAgICAgICAgIG5vZGUuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgJ3B4JzsKCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIG5vZGUuaGlkZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBub2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBub2RlLnNob3cgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgbm9kZS5zdHlsZS5kaXNwbGF5ID0gJyc7CgogICAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBpZiAobWVkaWFGaWxlcyAmJiBtZWRpYUZpbGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IG1lZGlhRmlsZXMubGVuZ3RoOyBpIDwgaWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3JlbmRlcmVyLnJlbmRlcmVyLnJlbmRlcmVyc1tvcHRpb25zLnByZWZpeF0uY2FuUGxheVR5cGUobWVkaWFGaWxlc1tpXS50eXBlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5zZXRBdHRyaWJ1dGUoJ3NyYycsIG1lZGlhRmlsZXNbaV0uc3JjKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgncmVuZGVyZXJyZWFkeScsIG5vZGUpOwogICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwoKICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgX3dpbmRvdzIuZGVmYXVsdC5IdG1sTWVkaWFFbGVtZW50ID0gX21lanMyLmRlZmF1bHQuSHRtbE1lZGlhRWxlbWVudCA9IEh0bWxNZWRpYUVsZW1lbnQ7CgogICAgICAgIF9yZW5kZXJlci5yZW5kZXJlci5hZGQoSHRtbE1lZGlhRWxlbWVudCk7CgogICAgfSwgeyIyIjogMiwgIjI3IjogMjcsICIyOCI6IDI4LCAiMyI6IDMsICI2IjogNiwgIjciOiA3fV0sCiAgICAyNDogW2Z1bmN0aW9uIChfZGVyZXFfLCBtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAKCiAgICAgICAgdmFyIF93aW5kb3cgPSBfZGVyZXFfKDMpOwoKICAgICAgICB2YXIgX3dpbmRvdzIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF93aW5kb3cpOwoKICAgICAgICB2YXIgX2RvY3VtZW50ID0gX2RlcmVxXygyKTsKCiAgICAgICAgdmFyIF9kb2N1bWVudDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9kb2N1bWVudCk7CgogICAgICAgIHZhciBfbWVqcyA9IF9kZXJlcV8oNik7CgogICAgICAgIHZhciBfbWVqczIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9tZWpzKTsKCiAgICAgICAgdmFyIF9yZW5kZXJlciA9IF9kZXJlcV8oNyk7CgogICAgICAgIHZhciBfZG9tID0gX2RlcmVxXygyOCk7CgogICAgICAgIHZhciBfbWVkaWEgPSBfZGVyZXFfKDMwKTsKCiAgICAgICAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHtkZWZhdWx0OiBvYmp9OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogU291bmRDbG91ZCByZW5kZXJlcgogICAgICAgICAqCiAgICAgICAgICogVXNlcyA8aWZyYW1lPiBhcHByb2FjaCBhbmQgdXNlcyBTb3VuZENsb3VkIFdpZGdldCBBUEkgdG8gbWFuaXB1bGF0ZSBpdC4KICAgICAgICAgKiBAc2VlIGh0dHBzOi8vZGV2ZWxvcGVycy5zb3VuZGNsb3VkLmNvbS9kb2NzL2FwaS9odG1sNS13aWRnZXQKICAgICAgICAgKi8KICAgICAgICB2YXIgU291bmRDbG91ZEFwaSA9IHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNTREtTdGFydGVkOiBmYWxzZSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNTREtMb2FkZWQ6IGZhbHNlLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHR5cGUge0FycmF5fQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaWZyYW1lUXVldWU6IFtdLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENyZWF0ZSBhIHF1ZXVlIHRvIHByZXBhcmUgdGhlIGNyZWF0aW9uIG9mIDxpZnJhbWU+CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyAtIGFuIG9iamVjdCB3aXRoIHNldHRpbmdzIG5lZWRlZCB0byBjcmVhdGUgPGlmcmFtZT4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGVucXVldWVJZnJhbWU6IGZ1bmN0aW9uIGVucXVldWVJZnJhbWUoc2V0dGluZ3MpIHsKCiAgICAgICAgICAgICAgICBpZiAoU291bmRDbG91ZEFwaS5pc0xvYWRlZCkgewogICAgICAgICAgICAgICAgICAgIFNvdW5kQ2xvdWRBcGkuY3JlYXRlSWZyYW1lKHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgU291bmRDbG91ZEFwaS5sb2FkSWZyYW1lQXBpKCk7CiAgICAgICAgICAgICAgICAgICAgU291bmRDbG91ZEFwaS5pZnJhbWVRdWV1ZS5wdXNoKHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBMb2FkIFNvdW5kQ2xvdWQgQVBJIHNjcmlwdCBvbiB0aGUgaGVhZGVyIG9mIHRoZSBkb2N1bWVudAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgbG9hZElmcmFtZUFwaTogZnVuY3Rpb24gbG9hZElmcmFtZUFwaSgpIHsKICAgICAgICAgICAgICAgIGlmICghU291bmRDbG91ZEFwaS5pc1NES1N0YXJ0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAoZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhlYWQgPSBfZG9jdW1lbnQyLmRlZmF1bHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImhlYWQiKVswXSB8fCBfZG9jdW1lbnQyLmRlZmF1bHQuZG9jdW1lbnRFbGVtZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0ID0gX2RvY3VtZW50Mi5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0LnNyYyA9ICcvL3cuc291bmRjbG91ZC5jb20vcGxheWVyL2FwaS5qcyc7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBBdHRhY2ggaGFuZGxlcnMgZm9yIGFsbCBicm93c2VycwogICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZG9uZSAmJiAoIVNvdW5kQ2xvdWRBcGkucmVhZHlTdGF0ZSB8fCBTb3VuZENsb3VkQXBpLnJlYWR5U3RhdGUgPT09ICJsb2FkZWQiIHx8IFNvdW5kQ2xvdWRBcGkucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTb3VuZENsb3VkQXBpLmFwaVJlYWR5KCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhhbmRsZSBtZW1vcnkgbGVhayBpbiBJRQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdC5vbmxvYWQgPSBzY3JpcHQub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZCAmJiBzY3JpcHQucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkLnJlbW92ZUNoaWxkKHNjcmlwdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBoZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIFNvdW5kQ2xvdWRBcGkuaXNTREtTdGFydGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIFByb2Nlc3MgcXVldWUgb2YgU291bmRDbG91ZCA8aWZyYW1lPiBlbGVtZW50IGNyZWF0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBhcGlSZWFkeTogZnVuY3Rpb24gYXBpUmVhZHkoKSB7CiAgICAgICAgICAgICAgICBTb3VuZENsb3VkQXBpLmlzTG9hZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIFNvdW5kQ2xvdWRBcGkuaXNTREtMb2FkZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgIHdoaWxlIChTb3VuZENsb3VkQXBpLmlmcmFtZVF1ZXVlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2V0dGluZ3MgPSBTb3VuZENsb3VkQXBpLmlmcmFtZVF1ZXVlLnBvcCgpOwogICAgICAgICAgICAgICAgICAgIFNvdW5kQ2xvdWRBcGkuY3JlYXRlSWZyYW1lKHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgU291bmRDbG91ZCBXaWRnZXQgcGxheWVyIGFuZCB0cmlnZ2VyIGEgY3VzdG9tIGV2ZW50IHRvIGluaXRpYWxpemUgaXQKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIC0gYW4gb2JqZWN0IHdpdGggc2V0dGluZ3MgbmVlZGVkIHRvIGNyZWF0ZSA8aWZyYW1lPgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY3JlYXRlSWZyYW1lOiBmdW5jdGlvbiBjcmVhdGVJZnJhbWUoc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIHZhciBwbGF5ZXIgPSBTQy5XaWRnZXQoc2V0dGluZ3MuaWZyYW1lKTsKICAgICAgICAgICAgICAgIF93aW5kb3cyLmRlZmF1bHRbJ19fcmVhZHlfXycgKyBzZXR0aW5ncy5pZF0ocGxheWVyKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciBTb3VuZENsb3VkSWZyYW1lUmVuZGVyZXIgPSB7CiAgICAgICAgICAgIG5hbWU6ICdzb3VuZGNsb3VkX2lmcmFtZScsCgogICAgICAgICAgICBvcHRpb25zOiB7CiAgICAgICAgICAgICAgICBwcmVmaXg6ICdzb3VuZGNsb3VkX2lmcmFtZScKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBEZXRlcm1pbmUgaWYgYSBzcGVjaWZpYyBlbGVtZW50IHR5cGUgY2FuIGJlIHBsYXllZCB3aXRoIHRoaXMgcmVuZGVyCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAgICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjYW5QbGF5VHlwZTogZnVuY3Rpb24gY2FuUGxheVR5cGUodHlwZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFsndmlkZW8vc291bmRjbG91ZCcsICd2aWRlby94LXNvdW5kY2xvdWQnXS5pbmNsdWRlcyh0eXBlKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGUgdGhlIHBsYXllciBpbnN0YW5jZSBhbmQgYWRkIGFsbCBuYXRpdmUgZXZlbnRzL21ldGhvZHMvcHJvcGVydGllcyBhcyBwb3NzaWJsZQogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge01lZGlhRWxlbWVudH0gbWVkaWFFbGVtZW50IEluc3RhbmNlIG9mIG1lanMuTWVkaWFFbGVtZW50IGFscmVhZHkgY3JlYXRlZAogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBBbGwgdGhlIHBsYXllciBjb25maWd1cmF0aW9uIG9wdGlvbnMgcGFzc2VkIHRocm91Z2ggY29uc3RydWN0b3IKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3RbXX0gbWVkaWFGaWxlcyBMaXN0IG9mIHNvdXJjZXMgd2l0aCBmb3JtYXQ6IHtzcmM6IHVybCwgdHlwZTogeC95LXp9CiAgICAgICAgICAgICAqIEByZXR1cm4ge09iamVjdH0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNyZWF0ZTogZnVuY3Rpb24gY3JlYXRlKG1lZGlhRWxlbWVudCwgb3B0aW9ucywgbWVkaWFGaWxlcykgewoKICAgICAgICAgICAgICAgIHZhciBzYyA9IHt9OwoKICAgICAgICAgICAgICAgIC8vIHN0b3JlIG1haW4gdmFyaWFibGUKICAgICAgICAgICAgICAgIHNjLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgICAgICAgc2MuaWQgPSBtZWRpYUVsZW1lbnQuaWQgKyAnXycgKyBvcHRpb25zLnByZWZpeDsKICAgICAgICAgICAgICAgIHNjLm1lZGlhRWxlbWVudCA9IG1lZGlhRWxlbWVudDsKCiAgICAgICAgICAgICAgICAvLyBjcmVhdGUgb3VyIGZha2UgZWxlbWVudCB0aGF0IGFsbG93cyBldmVudHMgYW5kIHN1Y2ggdG8gd29yawogICAgICAgICAgICAgICAgdmFyIGFwaVN0YWNrID0gW10sCiAgICAgICAgICAgICAgICAgICAgc2NQbGF5ZXJSZWFkeSA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIHNjUGxheWVyID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICBzY0lmcmFtZSA9IG51bGwsCiAgICAgICAgICAgICAgICAgICAgY3VycmVudFRpbWUgPSAwLAogICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uID0gMCwKICAgICAgICAgICAgICAgICAgICBidWZmZXJlZFRpbWUgPSAwLAogICAgICAgICAgICAgICAgICAgIHBhdXNlZCA9IHRydWUsCiAgICAgICAgICAgICAgICAgICAgdm9sdW1lID0gMSwKICAgICAgICAgICAgICAgICAgICBtdXRlZCA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGVuZGVkID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgcmVhZHlTdGF0ZSA9IDQsCiAgICAgICAgICAgICAgICAgICAgaSA9IHZvaWQgMCwKICAgICAgICAgICAgICAgICAgICBpbCA9IHZvaWQgMDsKCiAgICAgICAgICAgICAgICAvLyB3cmFwcGVycyBmb3IgZ2V0L3NldAogICAgICAgICAgICAgICAgdmFyIHByb3BzID0gX21lanMyLmRlZmF1bHQuaHRtbDVtZWRpYS5wcm9wZXJ0aWVzLAogICAgICAgICAgICAgICAgICAgIGFzc2lnbkdldHRlcnNTZXR0ZXJzID0gZnVuY3Rpb24gYXNzaWduR2V0dGVyc1NldHRlcnMocHJvcE5hbWUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFkZCB0byBmbGFzaCBzdGF0ZSB0aGF0IHdlIHdpbGwgc3RvcmUKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYXBOYW1lID0gJycgKyBwcm9wTmFtZS5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHByb3BOYW1lLnN1YnN0cmluZygxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHNjWydnZXQnICsgY2FwTmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NQbGF5ZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmaWd1cmUgb3V0IGhvdyB0byBnZXQgZG0gZHRhIGhlcmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHByb3BOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2N1cnJlbnRUaW1lJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VGltZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2R1cmF0aW9uJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkdXJhdGlvbjsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3ZvbHVtZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdm9sdW1lOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncGF1c2VkJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXVzZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdlbmRlZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW5kZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdtdXRlZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbXV0ZWQ7IC8vID8KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2J1ZmZlcmVkJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIHN0YXJ0KCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZDogZnVuY3Rpb24gZW5kKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYnVmZmVyZWRUaW1lICogZHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGg6IDEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NyYyc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2NJZnJhbWUgPyBzY0lmcmFtZS5zcmMgOiAnJzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JlYWR5U3RhdGUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlYWR5U3RhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgc2NbJ3NldCcgKyBjYXBOYW1lXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzY1BsYXllciAhPT0gbnVsbCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkbyBzb21ldGhpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHByb3BOYW1lKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzcmMnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyB2YWx1ZSA6IHZhbHVlWzBdLnNyYzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY1BsYXllci5sb2FkKHVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2N1cnJlbnRUaW1lJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjUGxheWVyLnNlZWtUbyh2YWx1ZSAqIDEwMDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdtdXRlZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY1BsYXllci5zZXRWb2x1bWUoMCk7IC8vID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NQbGF5ZXIuc2V0Vm9sdW1lKDEpOyAvLyA/CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ3ZvbHVtZWNoYW5nZScsIHNjKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3ZvbHVtZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY1BsYXllci5zZXRWb2x1bWUodmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCd2b2x1bWVjaGFuZ2UnLCBzYyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgNTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdyZWFkeVN0YXRlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgnY2FucGxheScsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdG9yZSBmb3IgYWZ0ZXIgIlJFQURZIiBldmVudCBmaXJlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwaVN0YWNrLnB1c2goe3R5cGU6ICdzZXQnLCBwcm9wTmFtZTogcHJvcE5hbWUsIHZhbHVlOiB2YWx1ZX0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBwcm9wcy5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYXNzaWduR2V0dGVyc1NldHRlcnMocHJvcHNbaV0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGFkZCB3cmFwcGVycyBmb3IgbmF0aXZlIG1ldGhvZHMKICAgICAgICAgICAgICAgIHZhciBtZXRob2RzID0gX21lanMyLmRlZmF1bHQuaHRtbDVtZWRpYS5tZXRob2RzLAogICAgICAgICAgICAgICAgICAgIGFzc2lnbk1ldGhvZHMgPSBmdW5jdGlvbiBhc3NpZ25NZXRob2RzKG1ldGhvZE5hbWUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJ1biB0aGUgbWV0aG9kIG9uIHRoZSBTb3VuZGNsb3VkIEFQSQogICAgICAgICAgICAgICAgICAgICAgICBzY1ttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NQbGF5ZXIgIT09IG51bGwpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRE8gbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChtZXRob2ROYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3BsYXknOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNjUGxheWVyLnBsYXkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncGF1c2UnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNjUGxheWVyLnBhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2xvYWQnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBpU3RhY2sucHVzaCh7dHlwZTogJ2NhbGwnLCBtZXRob2ROYW1lOiBtZXRob2ROYW1lfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IG1ldGhvZHMubGVuZ3RoOyBpIDwgaWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbk1ldGhvZHMobWV0aG9kc1tpXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYWRkIGEgcmVhZHkgbWV0aG9kIHRoYXQgU0MgY2FuIGZpcmUKICAgICAgICAgICAgICAgIF93aW5kb3cyLmRlZmF1bHRbJ19fcmVhZHlfXycgKyBzYy5pZF0gPSBmdW5jdGlvbiAoX3NjUGxheWVyKSB7CgogICAgICAgICAgICAgICAgICAgIHNjUGxheWVyUmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5zY1BsYXllciA9IHNjUGxheWVyID0gX3NjUGxheWVyOwoKICAgICAgICAgICAgICAgICAgICAvLyBkbyBjYWxsIHN0YWNrCiAgICAgICAgICAgICAgICAgICAgaWYgKGFwaVN0YWNrLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IGFwaVN0YWNrLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RhY2tJdGVtID0gYXBpU3RhY2tbaV07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHN0YWNrSXRlbS50eXBlID09PSAnc2V0JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcm9wTmFtZSA9IHN0YWNrSXRlbS5wcm9wTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FwTmFtZSA9ICcnICsgcHJvcE5hbWUuc3Vic3RyaW5nKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyBwcm9wTmFtZS5zdWJzdHJpbmcoMSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjWydzZXQnICsgY2FwTmFtZV0oc3RhY2tJdGVtLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhY2tJdGVtLnR5cGUgPT09ICdjYWxsJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjW3N0YWNrSXRlbS5tZXRob2ROYW1lXSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBTb3VuZENsb3VkIHByb3BlcnRpZXMgYXJlIGFzeW5jLCBzbyB3ZSBkb24ndCBmaXJlIHRoZSBldmVudCB1bnRpbCB0aGUgcHJvcGVydHkgY2FsbGJhY2sgZmlyZXMKICAgICAgICAgICAgICAgICAgICBzY1BsYXllci5iaW5kKFNDLldpZGdldC5FdmVudHMuUExBWV9QUk9HUkVTUywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXVzZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgZW5kZWQgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHNjUGxheWVyLmdldFBvc2l0aW9uKGZ1bmN0aW9uIChfY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUaW1lID0gX2N1cnJlbnRUaW1lIC8gMTAwMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgndGltZXVwZGF0ZScsIHNjKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIHNjUGxheWVyLmJpbmQoU0MuV2lkZ2V0LkV2ZW50cy5QQVVTRSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXVzZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCdwYXVzZScsIHNjKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHNjUGxheWVyLmJpbmQoU0MuV2lkZ2V0LkV2ZW50cy5QTEFZLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhdXNlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBlbmRlZCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCdwbGF5Jywgc2MpOwogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgc2NQbGF5ZXIuYmluZChTQy5XaWRnZXQuRXZlbnRzLkZJTklTSEVELCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhdXNlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBlbmRlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ2VuZGVkJywgc2MpOwogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgc2NQbGF5ZXIuYmluZChTQy5XaWRnZXQuRXZlbnRzLlJFQURZLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjUGxheWVyLmdldER1cmF0aW9uKGZ1bmN0aW9uIChfZHVyYXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uID0gX2R1cmF0aW9uIC8gMTAwMDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ2xvYWRlZG1ldGFkYXRhJywgc2MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBzY1BsYXllci5iaW5kKFNDLldpZGdldC5FdmVudHMuTE9BRF9QUk9HUkVTUywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBzY1BsYXllci5nZXREdXJhdGlvbihmdW5jdGlvbiAobG9hZFByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyZWRUaW1lID0gZHVyYXRpb24gKiBsb2FkUHJvZ3Jlc3M7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgncHJvZ3Jlc3MnLCBzYyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgc2NQbGF5ZXIuZ2V0RHVyYXRpb24oZnVuY3Rpb24gKF9kdXJhdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYXRpb24gPSBfZHVyYXRpb247CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCdsb2FkZWRtZXRhZGF0YScsIHNjKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIGdpdmUgaW5pdGlhbCBldmVudHMKICAgICAgICAgICAgICAgICAgICB2YXIgaW5pdEV2ZW50cyA9IFsncmVuZGVyZXJyZWFkeScsICdsb2FkZWRkYXRhJywgJ2xvYWRlZG1ldGFkYXRhJywgJ2NhbnBsYXknXTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwLCBfaWwgPSBpbml0RXZlbnRzLmxlbmd0aDsgX2kgPCBfaWw7IF9pKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKGluaXRFdmVudHNbX2ldLCBzYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIC8vIGNvbnRhaW5lciBmb3IgQVBJIEFQSQogICAgICAgICAgICAgICAgc2NJZnJhbWUgPSBfZG9jdW1lbnQyLmRlZmF1bHQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CiAgICAgICAgICAgICAgICBzY0lmcmFtZS5pZCA9IHNjLmlkOwogICAgICAgICAgICAgICAgc2NJZnJhbWUud2lkdGggPSAxMDsKICAgICAgICAgICAgICAgIHNjSWZyYW1lLmhlaWdodCA9IDEwOwogICAgICAgICAgICAgICAgc2NJZnJhbWUuZnJhbWVCb3JkZXIgPSAwOwogICAgICAgICAgICAgICAgc2NJZnJhbWUuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwogICAgICAgICAgICAgICAgc2NJZnJhbWUuc3JjID0gbWVkaWFGaWxlc1swXS5zcmM7CiAgICAgICAgICAgICAgICBzY0lmcmFtZS5zY3JvbGxpbmcgPSAnbm8nOwoKICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5hcHBlbmRDaGlsZChzY0lmcmFtZSk7CiAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgogICAgICAgICAgICAgICAgdmFyIHNjU2V0dGluZ3MgPSB7CiAgICAgICAgICAgICAgICAgICAgaWZyYW1lOiBzY0lmcmFtZSwKICAgICAgICAgICAgICAgICAgICBpZDogc2MuaWQKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgU291bmRDbG91ZEFwaS5lbnF1ZXVlSWZyYW1lKHNjU2V0dGluZ3MpOwoKICAgICAgICAgICAgICAgIHNjLnNldFNpemUgPSBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewogICAgICAgICAgICAgICAgICAgIC8vIG5vdGhpbmcgaGVyZSwgYXVkaW8gb25seQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHNjLmhpZGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgc2MucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoc2NJZnJhbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NJZnJhbWUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgc2Muc2hvdyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2NJZnJhbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NJZnJhbWUuc3R5bGUuZGlzcGxheSA9ICcnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBzYy5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHNjUGxheWVyLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgcmV0dXJuIHNjOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVnaXN0ZXIgU291bmRDbG91ZCB0eXBlIGJhc2VkIG9uIFVSTCBzdHJ1Y3R1cmUKICAgICAgICAgKgogICAgICAgICAqLwogICAgICAgIF9tZWRpYS50eXBlQ2hlY2tzLnB1c2goZnVuY3Rpb24gKHVybCkgewogICAgICAgICAgICB1cmwgPSB1cmwudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgcmV0dXJuIHVybC5pbmNsdWRlcygnLy9zb3VuZGNsb3VkLmNvbScpIHx8IHVybC5pbmNsdWRlcygnLy93LnNvdW5kY2xvdWQuY29tJykgPyAndmlkZW8veC1zb3VuZGNsb3VkJyA6IG51bGw7CiAgICAgICAgfSk7CgogICAgICAgIF9yZW5kZXJlci5yZW5kZXJlci5hZGQoU291bmRDbG91ZElmcmFtZVJlbmRlcmVyKTsKCiAgICB9LCB7IjIiOiAyLCAiMjgiOiAyOCwgIjMiOiAzLCAiMzAiOiAzMCwgIjYiOiA2LCAiNyI6IDd9XSwKICAgIDI1OiBbZnVuY3Rpb24gKF9kZXJlcV8sIG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgIAoKICAgICAgICB2YXIgX3dpbmRvdyA9IF9kZXJlcV8oMyk7CgogICAgICAgIHZhciBfd2luZG93MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX3dpbmRvdyk7CgogICAgICAgIHZhciBfZG9jdW1lbnQgPSBfZGVyZXFfKDIpOwoKICAgICAgICB2YXIgX2RvY3VtZW50MiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX2RvY3VtZW50KTsKCiAgICAgICAgdmFyIF9tZWpzID0gX2RlcmVxXyg2KTsKCiAgICAgICAgdmFyIF9tZWpzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX21lanMpOwoKICAgICAgICB2YXIgX3JlbmRlcmVyID0gX2RlcmVxXyg3KTsKCiAgICAgICAgdmFyIF9kb20gPSBfZGVyZXFfKDI4KTsKCiAgICAgICAgdmFyIF9tZWRpYSA9IF9kZXJlcV8oMzApOwoKICAgICAgICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDoge2RlZmF1bHQ6IG9ian07CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBWaW1lbyByZW5kZXJlcgogICAgICAgICAqCiAgICAgICAgICogVXNlcyA8aWZyYW1lPiBhcHByb2FjaCBhbmQgdXNlcyBWaW1lbyBBUEkgdG8gbWFuaXB1bGF0ZSBpdC4KICAgICAgICAgKiBBbGwgVmltZW8gY2FsbHMgcmV0dXJuIGEgUHJvbWlzZSBzbyB0aGlzIHJlbmRlcmVyIGFjY291bnRzIGZvciB0aGF0CiAgICAgICAgICogdG8gdXBkYXRlIGFsbCB0aGUgbmVjZXNzYXJ5IHZhbHVlcyB0byBpbnRlcmFjdCB3aXRoIE1lZGlhRWxlbWVudCBwbGF5ZXIuCiAgICAgICAgICogTm90ZTogSUU4IGltcGxlbWVudHMgRUNNQVNjcmlwdCAzIHRoYXQgZG9lcyBub3QgYWxsb3cgYmFyZSBrZXl3b3JkcyBpbiBkb3Qgbm90YXRpb247CiAgICAgICAgICogdGhhdCdzIHdoeSBpbnN0ZWFkIG9mIHVzaW5nIC5jYXRjaCBbJ2NhdGNoJ10gaXMgYmVpbmcgdXNlZC4KICAgICAgICAgKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS92aW1lby9wbGF5ZXIuanMKICAgICAgICAgKgogICAgICAgICAqLwogICAgICAgIHZhciB2aW1lb0FwaSA9IHsKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGlzSWZyYW1lU3RhcnRlZDogZmFsc2UsCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBAdHlwZSB7Qm9vbGVhbn0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGlzSWZyYW1lTG9hZGVkOiBmYWxzZSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtBcnJheX0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGlmcmFtZVF1ZXVlOiBbXSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGUgYSBxdWV1ZSB0byBwcmVwYXJlIHRoZSBjcmVhdGlvbiBvZiA8aWZyYW1lPgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2V0dGluZ3MgLSBhbiBvYmplY3Qgd2l0aCBzZXR0aW5ncyBuZWVkZWQgdG8gY3JlYXRlIDxpZnJhbWU+CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBlbnF1ZXVlSWZyYW1lOiBmdW5jdGlvbiBlbnF1ZXVlSWZyYW1lKHNldHRpbmdzKSB7CgogICAgICAgICAgICAgICAgaWYgKHZpbWVvQXBpLmlzTG9hZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmltZW9BcGkuY3JlYXRlSWZyYW1lKHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmltZW9BcGkubG9hZElmcmFtZUFwaSgpOwogICAgICAgICAgICAgICAgICAgIHZpbWVvQXBpLmlmcmFtZVF1ZXVlLnB1c2goc2V0dGluZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIExvYWQgVmltZW8gQVBJIHNjcmlwdCBvbiB0aGUgaGVhZGVyIG9mIHRoZSBkb2N1bWVudAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgbG9hZElmcmFtZUFwaTogZnVuY3Rpb24gbG9hZElmcmFtZUFwaSgpIHsKCiAgICAgICAgICAgICAgICBpZiAoIXZpbWVvQXBpLmlzSWZyYW1lU3RhcnRlZCkgewogICAgICAgICAgICAgICAgICAgIChmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2NyaXB0ID0gX2RvY3VtZW50Mi5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RTY3JpcHRUYWcgPSBfZG9jdW1lbnQyLmRlZmF1bHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3NjcmlwdCcpWzBdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0LnNyYyA9ICcvL3BsYXllci52aW1lby5jb20vYXBpL3BsYXllci5qcyc7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBBdHRhY2ggaGFuZGxlcnMgZm9yIGFsbCBicm93c2VycwogICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZG9uZSAmJiAoIXZpbWVvQXBpLnJlYWR5U3RhdGUgfHwgdmltZW9BcGkucmVhZHlTdGF0ZSA9PT0gdW5kZWZpbmVkIHx8IHZpbWVvQXBpLnJlYWR5U3RhdGUgPT09ICJsb2FkZWQiIHx8IHZpbWVvQXBpLnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9BcGkuaUZyYW1lUmVhZHkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHQub25sb2FkID0gc2NyaXB0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0U2NyaXB0VGFnLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHNjcmlwdCwgZmlyc3RTY3JpcHRUYWcpOwogICAgICAgICAgICAgICAgICAgICAgICB2aW1lb0FwaS5pc0lmcmFtZVN0YXJ0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUHJvY2VzcyBxdWV1ZSBvZiBWaW1lbyA8aWZyYW1lPiBlbGVtZW50IGNyZWF0aW9uCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpRnJhbWVSZWFkeTogZnVuY3Rpb24gaUZyYW1lUmVhZHkoKSB7CgogICAgICAgICAgICAgICAgdmltZW9BcGkuaXNMb2FkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgdmltZW9BcGkuaXNJZnJhbWVMb2FkZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgIHdoaWxlICh2aW1lb0FwaS5pZnJhbWVRdWV1ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHNldHRpbmdzID0gdmltZW9BcGkuaWZyYW1lUXVldWUucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgdmltZW9BcGkuY3JlYXRlSWZyYW1lKHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgVmltZW8gQVBJIHBsYXllciBhbmQgdHJpZ2dlciBhIGN1c3RvbSBldmVudCB0byBpbml0aWFsaXplIGl0CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyAtIGFuIG9iamVjdCB3aXRoIHNldHRpbmdzIG5lZWRlZCB0byBjcmVhdGUgPGlmcmFtZT4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNyZWF0ZUlmcmFtZTogZnVuY3Rpb24gY3JlYXRlSWZyYW1lKHNldHRpbmdzKSB7CiAgICAgICAgICAgICAgICB2YXIgcGxheWVyID0gbmV3IFZpbWVvLlBsYXllcihzZXR0aW5ncy5pZnJhbWUpOwogICAgICAgICAgICAgICAgX3dpbmRvdzIuZGVmYXVsdFsnX19yZWFkeV9fJyArIHNldHRpbmdzLmlkXShwbGF5ZXIpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEV4dHJhY3QgbnVtZXJpYyB2YWx1ZSBmcm9tIFZpbWVvIHRvIGJlIGxvYWRlZCB0aHJvdWdoIEFQSQogICAgICAgICAgICAgKiBWYWxpZCBVUkwgZm9ybWF0KHMpOgogICAgICAgICAgICAgKiAgLSBodHRwczovL3BsYXllci52aW1lby5jb20vdmlkZW8vNTk3NzczOTIKICAgICAgICAgICAgICogIC0gaHR0cHM6Ly92aW1lby5jb20vNTk3NzczOTIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVybCAtIFZpbWVvIGZ1bGwgVVJMIHRvIGdyYWIgdGhlIG51bWJlciBJZCBvZiB0aGUgc291cmNlCiAgICAgICAgICAgICAqIEByZXR1cm4ge2ludH0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldFZpbWVvSWQ6IGZ1bmN0aW9uIGdldFZpbWVvSWQodXJsKSB7CiAgICAgICAgICAgICAgICBpZiAodXJsID09PSB1bmRlZmluZWQgfHwgdXJsID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHBhcnRzID0gdXJsLnNwbGl0KCc/Jyk7CgogICAgICAgICAgICAgICAgdXJsID0gcGFydHNbMF07CgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlSW50KHVybC5zdWJzdHJpbmcodXJsLmxhc3RJbmRleE9mKCcvJykgKyAxKSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogR2VuZXJhdGUgY3VzdG9tIGVycm9ycyBmb3IgVmltZW8gYmFzZWQgb24gdGhlIEFQSSBzcGVjaWZpY2F0aW9ucwogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS92aW1lby9wbGF5ZXIuanMjZXJyb3IKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGVycm9yCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSB0YXJnZXQKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGVycm9ySGFuZGxlcjogZnVuY3Rpb24gZXJyb3JIYW5kbGVyKGVycm9yLCB0YXJnZXQpIHsKICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgnZXJyb3InLCB0YXJnZXQpOwogICAgICAgICAgICAgICAgZXZlbnQubWVzc2FnZSA9IGVycm9yLm5hbWUgKyAnOiAnICsgZXJyb3IubWVzc2FnZTsKICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHZhciB2aW1lb0lmcmFtZVJlbmRlcmVyID0gewoKICAgICAgICAgICAgbmFtZTogJ3ZpbWVvX2lmcmFtZScsCgogICAgICAgICAgICBvcHRpb25zOiB7CiAgICAgICAgICAgICAgICBwcmVmaXg6ICd2aW1lb19pZnJhbWUnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBEZXRlcm1pbmUgaWYgYSBzcGVjaWZpYyBlbGVtZW50IHR5cGUgY2FuIGJlIHBsYXllZCB3aXRoIHRoaXMgcmVuZGVyCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAgICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICAgICAqLwogICAgICAgICAgICBjYW5QbGF5VHlwZTogZnVuY3Rpb24gY2FuUGxheVR5cGUodHlwZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFsndmlkZW8vdmltZW8nLCAndmlkZW8veC12aW1lbyddLmluY2x1ZGVzKHR5cGUpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENyZWF0ZSB0aGUgcGxheWVyIGluc3RhbmNlIGFuZCBhZGQgYWxsIG5hdGl2ZSBldmVudHMvbWV0aG9kcy9wcm9wZXJ0aWVzIGFzIHBvc3NpYmxlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7TWVkaWFFbGVtZW50fSBtZWRpYUVsZW1lbnQgSW5zdGFuY2Ugb2YgbWVqcy5NZWRpYUVsZW1lbnQgYWxyZWFkeSBjcmVhdGVkCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEFsbCB0aGUgcGxheWVyIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBwYXNzZWQgdGhyb3VnaCBjb25zdHJ1Y3RvcgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdFtdfSBtZWRpYUZpbGVzIExpc3Qgb2Ygc291cmNlcyB3aXRoIGZvcm1hdDoge3NyYzogdXJsLCB0eXBlOiB4L3kten0KICAgICAgICAgICAgICogQHJldHVybiB7T2JqZWN0fQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY3JlYXRlOiBmdW5jdGlvbiBjcmVhdGUobWVkaWFFbGVtZW50LCBvcHRpb25zLCBtZWRpYUZpbGVzKSB7CgogICAgICAgICAgICAgICAgLy8gZXhwb3NlZCBvYmplY3QKICAgICAgICAgICAgICAgIHZhciBhcGlTdGFjayA9IFtdLAogICAgICAgICAgICAgICAgICAgIHZpbWVvQXBpUmVhZHkgPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICB2aW1lbyA9IHt9LAogICAgICAgICAgICAgICAgICAgIHZpbWVvUGxheWVyID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICBwYXVzZWQgPSB0cnVlLAogICAgICAgICAgICAgICAgICAgIHZvbHVtZSA9IDEsCiAgICAgICAgICAgICAgICAgICAgb2xkVm9sdW1lID0gdm9sdW1lLAogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUaW1lID0gMCwKICAgICAgICAgICAgICAgICAgICBidWZmZXJlZFRpbWUgPSAwLAogICAgICAgICAgICAgICAgICAgIGVuZGVkID0gZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb24gPSAwLAogICAgICAgICAgICAgICAgICAgIHVybCA9ICIiLAogICAgICAgICAgICAgICAgICAgIHJlYWR5U3RhdGUgPSA0LAogICAgICAgICAgICAgICAgICAgIGkgPSB2b2lkIDAsCiAgICAgICAgICAgICAgICAgICAgaWwgPSB2b2lkIDA7CgogICAgICAgICAgICAgICAgdmltZW8ub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgICAgICAgICB2aW1lby5pZCA9IG1lZGlhRWxlbWVudC5pZCArICdfJyArIG9wdGlvbnMucHJlZml4OwogICAgICAgICAgICAgICAgdmltZW8ubWVkaWFFbGVtZW50ID0gbWVkaWFFbGVtZW50OwoKICAgICAgICAgICAgICAgIC8vIHdyYXBwZXJzIGZvciBnZXQvc2V0CiAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBfbWVqczIuZGVmYXVsdC5odG1sNW1lZGlhLnByb3BlcnRpZXMsCiAgICAgICAgICAgICAgICAgICAgYXNzaWduR2V0dGVyc1NldHRlcnMgPSBmdW5jdGlvbiBhc3NpZ25HZXR0ZXJzU2V0dGVycyhwcm9wTmFtZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNhcE5hbWUgPSAnJyArIHByb3BOYW1lLnN1YnN0cmluZygwLCAxKS50b1VwcGVyQ2FzZSgpICsgcHJvcE5hbWUuc3Vic3RyaW5nKDEpOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9bJ2dldCcgKyBjYXBOYW1lXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aW1lb1BsYXllciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocHJvcE5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY3VycmVudFRpbWUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRUaW1lOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZHVyYXRpb24nOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGR1cmF0aW9uOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAndm9sdW1lJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2b2x1bWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ211dGVkJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2b2x1bWUgPT09IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3BhdXNlZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGF1c2VkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdlbmRlZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW5kZWQ7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzcmMnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9QbGF5ZXIuZ2V0VmlkZW9VcmwoKS50aGVuKGZ1bmN0aW9uIChfdXJsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsID0gX3VybDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1cmw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2J1ZmZlcmVkJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uIHN0YXJ0KCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZDogZnVuY3Rpb24gZW5kKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYnVmZmVyZWRUaW1lICogZHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGg6IDEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JlYWR5U3RhdGUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlYWR5U3RhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9bJ3NldCcgKyBjYXBOYW1lXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aW1lb1BsYXllciAhPT0gbnVsbCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBkbyBzb21ldGhpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHByb3BOYW1lKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzcmMnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF91cmwyID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHZhbHVlIDogdmFsdWVbMF0uc3JjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZGVvSWQgPSB2aW1lb0FwaS5nZXRWaW1lb0lkKF91cmwyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aW1lb1BsYXllci5sb2FkVmlkZW8odmlkZW9JZCkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lZGlhRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2F1dG9wbGF5JykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9QbGF5ZXIucGxheSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpbWVvQXBpLmVycm9ySGFuZGxlcihlcnJvciwgdmltZW8pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2N1cnJlbnRUaW1lJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpbWVvUGxheWVyLnNldEN1cnJlbnRUaW1lKHZhbHVlKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50VGltZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ3RpbWV1cGRhdGUnLCB2aW1lbyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCA1MCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVsnY2F0Y2gnXShmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aW1lb0FwaS5lcnJvckhhbmRsZXIoZXJyb3IsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2b2x1bWUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9QbGF5ZXIuc2V0Vm9sdW1lKHZhbHVlKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2x1bWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRWb2x1bWUgPSB2b2x1bWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgndm9sdW1lY2hhbmdlJywgdmltZW8pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgNTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9BcGkuZXJyb3JIYW5kbGVyKGVycm9yLCB2aW1lbyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbG9vcCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aW1lb1BsYXllci5zZXRMb29wKHZhbHVlKVsnY2F0Y2gnXShmdW5jdGlvbiAoZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aW1lb0FwaS5lcnJvckhhbmRsZXIoZXJyb3IsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ211dGVkJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpbWVvUGxheWVyLnNldFZvbHVtZSgwKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdm9sdW1lID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ3ZvbHVtZWNoYW5nZScsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgNTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aW1lb0FwaS5lcnJvckhhbmRsZXIoZXJyb3IsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9QbGF5ZXIuc2V0Vm9sdW1lKG9sZFZvbHVtZSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZvbHVtZSA9IG9sZFZvbHVtZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ3ZvbHVtZWNoYW5nZScsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgNTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pWydjYXRjaCddKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aW1lb0FwaS5lcnJvckhhbmRsZXIoZXJyb3IsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdyZWFkeVN0YXRlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgnY2FucGxheScsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0b3JlIGZvciBhZnRlciAiUkVBRFkiIGV2ZW50IGZpcmVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBpU3RhY2sucHVzaCh7dHlwZTogJ3NldCcsIHByb3BOYW1lOiBwcm9wTmFtZSwgdmFsdWU6IHZhbHVlfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IHByb3BzLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBhc3NpZ25HZXR0ZXJzU2V0dGVycyhwcm9wc1tpXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYWRkIHdyYXBwZXJzIGZvciBuYXRpdmUgbWV0aG9kcwogICAgICAgICAgICAgICAgdmFyIG1ldGhvZHMgPSBfbWVqczIuZGVmYXVsdC5odG1sNW1lZGlhLm1ldGhvZHMsCiAgICAgICAgICAgICAgICAgICAgYXNzaWduTWV0aG9kcyA9IGZ1bmN0aW9uIGFzc2lnbk1ldGhvZHMobWV0aG9kTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2aW1lb1ttZXRob2ROYW1lXSA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmltZW9QbGF5ZXIgIT09IG51bGwpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRE8gbWV0aG9kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChtZXRob2ROYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3BsYXknOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF1c2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmltZW9QbGF5ZXIucGxheSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdwYXVzZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXVzZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZpbWVvUGxheWVyLnBhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2xvYWQnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBpU3RhY2sucHVzaCh7dHlwZTogJ2NhbGwnLCBtZXRob2ROYW1lOiBtZXRob2ROYW1lfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IG1ldGhvZHMubGVuZ3RoOyBpIDwgaWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbk1ldGhvZHMobWV0aG9kc1tpXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSW5pdGlhbCBtZXRob2QgdG8gcmVnaXN0ZXIgYWxsIFZpbWVvIGV2ZW50cyB3aGVuIGluaXRpYWxpemluZyA8aWZyYW1lPgogICAgICAgICAgICAgICAgX3dpbmRvdzIuZGVmYXVsdFsnX19yZWFkeV9fJyArIHZpbWVvLmlkXSA9IGZ1bmN0aW9uIChfdmltZW9QbGF5ZXIpIHsKCiAgICAgICAgICAgICAgICAgICAgdmltZW9BcGlSZWFkeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LnZpbWVvUGxheWVyID0gdmltZW9QbGF5ZXIgPSBfdmltZW9QbGF5ZXI7CgogICAgICAgICAgICAgICAgICAgIC8vIGRvIGNhbGwgc3RhY2sKICAgICAgICAgICAgICAgICAgICBpZiAoYXBpU3RhY2subGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsID0gYXBpU3RhY2subGVuZ3RoOyBpIDwgaWw7IGkrKykgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFja0l0ZW0gPSBhcGlTdGFja1tpXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhY2tJdGVtLnR5cGUgPT09ICdzZXQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BOYW1lID0gc3RhY2tJdGVtLnByb3BOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXBOYW1lID0gJycgKyBwcm9wTmFtZS5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHByb3BOYW1lLnN1YnN0cmluZygxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9bJ3NldCcgKyBjYXBOYW1lXShzdGFja0l0ZW0udmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFja0l0ZW0udHlwZSA9PT0gJ2NhbGwnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9bc3RhY2tJdGVtLm1ldGhvZE5hbWVdKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciB2aW1lb0lmcmFtZSA9IF9kb2N1bWVudDIuZGVmYXVsdC5nZXRFbGVtZW50QnlJZCh2aW1lby5pZCksCiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50cyA9IHZvaWQgMDsKCiAgICAgICAgICAgICAgICAgICAgLy8gYSBmZXcgbW9yZSBldmVudHMKICAgICAgICAgICAgICAgICAgICBldmVudHMgPSBbJ21vdXNlb3ZlcicsICdtb3VzZW91dCddOwoKICAgICAgICAgICAgICAgICAgICB2YXIgYXNzaWduRXZlbnRzID0gZnVuY3Rpb24gYXNzaWduRXZlbnRzKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKGUudHlwZSwgdmltZW8pOwogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiBpbiBldmVudHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50TmFtZSA9IGV2ZW50c1tqXTsKICAgICAgICAgICAgICAgICAgICAgICAgKDAsIF9kb20uYWRkRXZlbnQpKHZpbWVvSWZyYW1lLCBldmVudE5hbWUsIGFzc2lnbkV2ZW50cyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBWaW1lbyBldmVudHMKICAgICAgICAgICAgICAgICAgICB2aW1lb1BsYXllci5vbignbG9hZGVkJywgZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9QbGF5ZXIuZ2V0RHVyYXRpb24oKS50aGVuKGZ1bmN0aW9uIChsb2FkUHJvZ3Jlc3MpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbiA9IGxvYWRQcm9ncmVzczsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyZWRUaW1lID0gZHVyYXRpb24gKiBsb2FkUHJvZ3Jlc3M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCdsb2FkZWRtZXRhZGF0YScsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aW1lb0FwaS5lcnJvckhhbmRsZXIoZXJyb3IsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIHZpbWVvUGxheWVyLm9uKCdwcm9ncmVzcycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9QbGF5ZXIuZ2V0RHVyYXRpb24oKS50aGVuKGZ1bmN0aW9uIChsb2FkUHJvZ3Jlc3MpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbiA9IGxvYWRQcm9ncmVzczsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZHVyYXRpb24gPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyZWRUaW1lID0gZHVyYXRpb24gKiBsb2FkUHJvZ3Jlc3M7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCdwcm9ncmVzcycsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSlbJ2NhdGNoJ10oZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aW1lb0FwaS5lcnJvckhhbmRsZXIoZXJyb3IsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdmltZW9QbGF5ZXIub24oJ3RpbWV1cGRhdGUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZpbWVvUGxheWVyLmdldEN1cnJlbnRUaW1lKCkudGhlbihmdW5jdGlvbiAoc2Vjb25kcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFRpbWUgPSBzZWNvbmRzOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgndGltZXVwZGF0ZScsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHZpbWVvUGxheWVyLm9uKCdwbGF5JywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXVzZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgZW5kZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCdwbGF5JywgdmltZW8pOwogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CgogICAgICAgICAgICAgICAgICAgICAgICBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgncGxheWluZycsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIHZpbWVvUGxheWVyLm9uKCdwYXVzZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGF1c2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgZW5kZWQgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgncGF1c2UnLCB2aW1lbyk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB2aW1lb1BsYXllci5vbignZW5kZWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhdXNlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBlbmRlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ2VuZGVkJywgdmltZW8pOwogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIC8vIGdpdmUgaW5pdGlhbCBldmVudHMKICAgICAgICAgICAgICAgICAgICBldmVudHMgPSBbJ3JlbmRlcmVycmVhZHknLCAnbG9hZGVkZGF0YScsICdsb2FkZWRtZXRhZGF0YScsICdjYW5wbGF5J107CgogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsID0gZXZlbnRzLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKGV2ZW50c1tpXSwgdmltZW8pOwogICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICB2YXIgaGVpZ2h0ID0gbWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZS5oZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgd2lkdGggPSBtZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlLndpZHRoLAogICAgICAgICAgICAgICAgICAgIHZpbWVvQ29udGFpbmVyID0gX2RvY3VtZW50Mi5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpLAogICAgICAgICAgICAgICAgICAgIHN0YW5kYXJkVXJsID0gJy8vcGxheWVyLnZpbWVvLmNvbS92aWRlby8nICsgdmltZW9BcGkuZ2V0VmltZW9JZChtZWRpYUZpbGVzWzBdLnNyYyksCiAgICAgICAgICAgICAgICAgICAgcXVlcnlBcmdzID0gbWVkaWFGaWxlc1swXS5zcmMuaW5jbHVkZXMoJz8nKSA/ICc/JyArIG1lZGlhRmlsZXNbMF0uc3JjLnNsaWNlKG1lZGlhRmlsZXNbMF0uc3JjLmluZGV4T2YoJz8nKSArIDEpIDogJyc7CgogICAgICAgICAgICAgICAgLy8gQ3JlYXRlIFZpbWVvIDxpZnJhbWU+IG1hcmt1cAogICAgICAgICAgICAgICAgdmltZW9Db250YWluZXIuc2V0QXR0cmlidXRlKCdpZCcsIHZpbWVvLmlkKTsKICAgICAgICAgICAgICAgIHZpbWVvQ29udGFpbmVyLnNldEF0dHJpYnV0ZSgnd2lkdGgnLCB3aWR0aCk7CiAgICAgICAgICAgICAgICB2aW1lb0NvbnRhaW5lci5zZXRBdHRyaWJ1dGUoJ2hlaWdodCcsIGhlaWdodCk7CiAgICAgICAgICAgICAgICB2aW1lb0NvbnRhaW5lci5zZXRBdHRyaWJ1dGUoJ2ZyYW1lQm9yZGVyJywgJzAnKTsKICAgICAgICAgICAgICAgIHZpbWVvQ29udGFpbmVyLnNldEF0dHJpYnV0ZSgnc3JjJywgJycgKyBzdGFuZGFyZFVybCArIHF1ZXJ5QXJncyk7CiAgICAgICAgICAgICAgICB2aW1lb0NvbnRhaW5lci5zZXRBdHRyaWJ1dGUoJ3dlYmtpdGFsbG93ZnVsbHNjcmVlbicsICcnKTsKICAgICAgICAgICAgICAgIHZpbWVvQ29udGFpbmVyLnNldEF0dHJpYnV0ZSgnbW96YWxsb3dmdWxsc2NyZWVuJywgJycpOwogICAgICAgICAgICAgICAgdmltZW9Db250YWluZXIuc2V0QXR0cmlidXRlKCdhbGxvd2Z1bGxzY3JlZW4nLCAnJyk7CgogICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh2aW1lb0NvbnRhaW5lciwgbWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZSk7CiAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgogICAgICAgICAgICAgICAgdmltZW9BcGkuZW5xdWV1ZUlmcmFtZSh7CiAgICAgICAgICAgICAgICAgICAgaWZyYW1lOiB2aW1lb0NvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICBpZDogdmltZW8uaWQKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHZpbWVvLmhpZGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmltZW8ucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICBpZiAodmltZW9QbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9Db250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdmltZW8uc2V0U2l6ZSA9IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgdmltZW9Db250YWluZXIuc2V0QXR0cmlidXRlKCd3aWR0aCcsIHdpZHRoKTsKICAgICAgICAgICAgICAgICAgICB2aW1lb0NvbnRhaW5lci5zZXRBdHRyaWJ1dGUoJ2hlaWdodCcsIGhlaWdodCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdmltZW8uc2hvdyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodmltZW9QbGF5ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmltZW9Db250YWluZXIuc3R5bGUuZGlzcGxheSA9ICcnOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgcmV0dXJuIHZpbWVvOwogICAgICAgICAgICB9CgogICAgICAgIH07CgogICAgICAgIC8qKgogICAgICAgICAqIFJlZ2lzdGVyIFZpbWVvIHR5cGUgYmFzZWQgb24gVVJMIHN0cnVjdHVyZQogICAgICAgICAqCiAgICAgICAgICovCiAgICAgICAgX21lZGlhLnR5cGVDaGVja3MucHVzaChmdW5jdGlvbiAodXJsKSB7CiAgICAgICAgICAgIHVybCA9IHVybC50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICByZXR1cm4gdXJsLmluY2x1ZGVzKCcvL3BsYXllci52aW1lbycpIHx8IHVybC5pbmNsdWRlcygndmltZW8uY29tJykgPyAndmlkZW8veC12aW1lbycgOiBudWxsOwogICAgICAgIH0pOwoKICAgICAgICBfcmVuZGVyZXIucmVuZGVyZXIuYWRkKHZpbWVvSWZyYW1lUmVuZGVyZXIpOwoKICAgIH0sIHsiMiI6IDIsICIyOCI6IDI4LCAiMyI6IDMsICIzMCI6IDMwLCAiNiI6IDYsICI3IjogN31dLAogICAgMjY6IFtmdW5jdGlvbiAoX2RlcmVxXywgbW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgCgogICAgICAgIHZhciBfdHlwZW9mID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID09PSAic3ltYm9sIiA/IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqOwogICAgICAgICAgICB9IDogZnVuY3Rpb24gKG9iaikgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG9iaiAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsKICAgICAgICAgICAgfTsKCiAgICAgICAgdmFyIF93aW5kb3cgPSBfZGVyZXFfKDMpOwoKICAgICAgICB2YXIgX3dpbmRvdzIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF93aW5kb3cpOwoKICAgICAgICB2YXIgX2RvY3VtZW50ID0gX2RlcmVxXygyKTsKCiAgICAgICAgdmFyIF9kb2N1bWVudDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9kb2N1bWVudCk7CgogICAgICAgIHZhciBfbWVqcyA9IF9kZXJlcV8oNik7CgogICAgICAgIHZhciBfbWVqczIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9tZWpzKTsKCiAgICAgICAgdmFyIF9yZW5kZXJlciA9IF9kZXJlcV8oNyk7CgogICAgICAgIHZhciBfZG9tID0gX2RlcmVxXygyOCk7CgogICAgICAgIHZhciBfbWVkaWEgPSBfZGVyZXFfKDMwKTsKCiAgICAgICAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHtkZWZhdWx0OiBvYmp9OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogWW91VHViZSByZW5kZXJlcgogICAgICAgICAqCiAgICAgICAgICogVXNlcyA8aWZyYW1lPiBhcHByb2FjaCBhbmQgdXNlcyBZb3VUdWJlIEFQSSB0byBtYW5pcHVsYXRlIGl0LgogICAgICAgICAqIE5vdGU6IElFNi03IGRvbid0IGhhdmUgcG9zdE1lc3NhZ2Ugc28gZG9uJ3Qgc3VwcG9ydCA8aWZyYW1lPiBBUEksIGFuZCBJRTggZG9lc24ndCBmaXJlIHRoZSBvblJlYWR5IGV2ZW50LAogICAgICAgICAqIHNvIGl0IGRvZXNuJ3Qgd29yayAtIG5vdCBzdXJlIGlmIEdvb2dsZSBwcm9ibGVtIG9yIG5vdC4KICAgICAgICAgKiBAc2VlIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL3lvdXR1YmUvaWZyYW1lX2FwaV9yZWZlcmVuY2UKICAgICAgICAgKi8KICAgICAgICB2YXIgWW91VHViZUFwaSA9IHsKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNJZnJhbWVTdGFydGVkOiBmYWxzZSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEB0eXBlIHtCb29sZWFufQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNJZnJhbWVMb2FkZWQ6IGZhbHNlLAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogQHR5cGUge0FycmF5fQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaWZyYW1lUXVldWU6IFtdLAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENyZWF0ZSBhIHF1ZXVlIHRvIHByZXBhcmUgdGhlIGNyZWF0aW9uIG9mIDxpZnJhbWU+CiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyAtIGFuIG9iamVjdCB3aXRoIHNldHRpbmdzIG5lZWRlZCB0byBjcmVhdGUgPGlmcmFtZT4KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGVucXVldWVJZnJhbWU6IGZ1bmN0aW9uIGVucXVldWVJZnJhbWUoc2V0dGluZ3MpIHsKCiAgICAgICAgICAgICAgICBpZiAoWW91VHViZUFwaS5pc0xvYWRlZCkgewogICAgICAgICAgICAgICAgICAgIFlvdVR1YmVBcGkuY3JlYXRlSWZyYW1lKHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgWW91VHViZUFwaS5sb2FkSWZyYW1lQXBpKCk7CiAgICAgICAgICAgICAgICAgICAgWW91VHViZUFwaS5pZnJhbWVRdWV1ZS5wdXNoKHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBMb2FkIFlvdVR1YmUgQVBJIHNjcmlwdCBvbiB0aGUgaGVhZGVyIG9mIHRoZSBkb2N1bWVudAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgbG9hZElmcmFtZUFwaTogZnVuY3Rpb24gbG9hZElmcmFtZUFwaSgpIHsKICAgICAgICAgICAgICAgIGlmICghWW91VHViZUFwaS5pc0lmcmFtZVN0YXJ0ZWQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGFnID0gX2RvY3VtZW50Mi5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwogICAgICAgICAgICAgICAgICAgIHRhZy5zcmMgPSAnLy93d3cueW91dHViZS5jb20vcGxheWVyX2FwaSc7CiAgICAgICAgICAgICAgICAgICAgdmFyIGZpcnN0U2NyaXB0VGFnID0gX2RvY3VtZW50Mi5kZWZhdWx0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKVswXTsKICAgICAgICAgICAgICAgICAgICBmaXJzdFNjcmlwdFRhZy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0YWcsIGZpcnN0U2NyaXB0VGFnKTsKICAgICAgICAgICAgICAgICAgICBZb3VUdWJlQXBpLmlzSWZyYW1lU3RhcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogUHJvY2VzcyBxdWV1ZSBvZiBZb3VUdWJlIDxpZnJhbWU+IGVsZW1lbnQgY3JlYXRpb24KICAgICAgICAgICAgICoKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGlGcmFtZVJlYWR5OiBmdW5jdGlvbiBpRnJhbWVSZWFkeSgpIHsKCiAgICAgICAgICAgICAgICBZb3VUdWJlQXBpLmlzTG9hZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIFlvdVR1YmVBcGkuaXNJZnJhbWVMb2FkZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgIHdoaWxlIChZb3VUdWJlQXBpLmlmcmFtZVF1ZXVlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc2V0dGluZ3MgPSBZb3VUdWJlQXBpLmlmcmFtZVF1ZXVlLnBvcCgpOwogICAgICAgICAgICAgICAgICAgIFlvdVR1YmVBcGkuY3JlYXRlSWZyYW1lKHNldHRpbmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgWW91VHViZSBBUEkgcGxheWVyIGFuZCB0cmlnZ2VyIGEgY3VzdG9tIGV2ZW50IHRvIGluaXRpYWxpemUgaXQKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIC0gYW4gb2JqZWN0IHdpdGggc2V0dGluZ3MgbmVlZGVkIHRvIGNyZWF0ZSA8aWZyYW1lPgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY3JlYXRlSWZyYW1lOiBmdW5jdGlvbiBjcmVhdGVJZnJhbWUoc2V0dGluZ3MpIHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgWVQuUGxheWVyKHNldHRpbmdzLmNvbnRhaW5lcklkLCBzZXR0aW5ncyk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogRXh0cmFjdCBJRCBmcm9tIFlvdVR1YmUncyBVUkwgdG8gYmUgbG9hZGVkIHRocm91Z2ggQVBJCiAgICAgICAgICAgICAqIFZhbGlkIFVSTCBmb3JtYXQocyk6CiAgICAgICAgICAgICAqIC0gaHR0cDovL3d3dy55b3V0dWJlLmNvbS93YXRjaD9mZWF0dXJlPXBsYXllcl9lbWJlZGRlZCZ2PXl5V1dYU3d0UFAwCiAgICAgICAgICAgICAqIC0gaHR0cDovL3d3dy55b3V0dWJlLmNvbS92L1ZJREVPX0lEP3ZlcnNpb249MwogICAgICAgICAgICAgKiAtIGh0dHA6Ly95b3V0dS5iZS9EamQ2dFByeGMwOAogICAgICAgICAgICAgKiAtIGh0dHA6Ly93d3cueW91dHViZS1ub2Nvb2tpZS5jb20vd2F0Y2g/ZmVhdHVyZT1wbGF5ZXJfZW1iZWRkZWQmdj15eVdXWFN3dFBQMAogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsCiAgICAgICAgICAgICAqIEByZXR1cm4ge3N0cmluZ30KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldFlvdVR1YmVJZDogZnVuY3Rpb24gZ2V0WW91VHViZUlkKHVybCkgewoKICAgICAgICAgICAgICAgIHZhciB5b3VUdWJlSWQgPSAiIjsKCiAgICAgICAgICAgICAgICBpZiAodXJsLmluZGV4T2YoJz8nKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAvLyBhc3N1bWluZzogaHR0cDovL3d3dy55b3V0dWJlLmNvbS93YXRjaD9mZWF0dXJlPXBsYXllcl9lbWJlZGRlZCZ2PXl5V1dYU3d0UFAwCiAgICAgICAgICAgICAgICAgICAgeW91VHViZUlkID0gWW91VHViZUFwaS5nZXRZb3VUdWJlSWRGcm9tUGFyYW0odXJsKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgaXQncyBodHRwOi8vd3d3LnlvdXR1YmUuY29tL3YvVklERU9fSUQ/dmVyc2lvbj0zCiAgICAgICAgICAgICAgICAgICAgaWYgKHlvdVR1YmVJZCA9PT0gJycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgeW91VHViZUlkID0gWW91VHViZUFwaS5nZXRZb3VUdWJlSWRGcm9tVXJsKHVybCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB5b3VUdWJlSWQgPSBZb3VUdWJlQXBpLmdldFlvdVR1YmVJZEZyb21VcmwodXJsKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4geW91VHViZUlkOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIEdldCBJRCBmcm9tIFVSTCB3aXRoIGZvcm1hdDogaHR0cDovL3d3dy55b3V0dWJlLmNvbS93YXRjaD9mZWF0dXJlPXBsYXllcl9lbWJlZGRlZCZ2PXl5V1dYU3d0UFAwCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwKICAgICAgICAgICAgICogQHJldHVybnMge3N0cmluZ30KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldFlvdVR1YmVJZEZyb21QYXJhbTogZnVuY3Rpb24gZ2V0WW91VHViZUlkRnJvbVBhcmFtKHVybCkgewoKICAgICAgICAgICAgICAgIGlmICh1cmwgPT09IHVuZGVmaW5lZCB8fCB1cmwgPT09IG51bGwgfHwgIXVybC50cmltKCkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHlvdVR1YmVJZCA9ICcnLAogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gdXJsLnNwbGl0KCc/JyksCiAgICAgICAgICAgICAgICAgICAgcGFyYW1ldGVycyA9IHBhcnRzWzFdLnNwbGl0KCcmJyk7CgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGlsID0gcGFyYW1ldGVycy5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmFtUGFydHMgPSBwYXJhbWV0ZXJzW2ldLnNwbGl0KCc9Jyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtUGFydHNbMF0gPT09ICd2JykgewogICAgICAgICAgICAgICAgICAgICAgICB5b3VUdWJlSWQgPSBwYXJhbVBhcnRzWzFdOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHlvdVR1YmVJZDsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBHZXQgSUQgZnJvbSBVUkwgd2l0aCBmb3JtYXRzCiAgICAgICAgICAgICAqICAtIGh0dHA6Ly93d3cueW91dHViZS5jb20vdi9WSURFT19JRD92ZXJzaW9uPTMKICAgICAgICAgICAgICogIC0gaHR0cDovL3lvdXR1LmJlL0RqZDZ0UHJ4YzA4CiAgICAgICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwKICAgICAgICAgICAgICogQHJldHVybiB7P1N0cmluZ30KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGdldFlvdVR1YmVJZEZyb21Vcmw6IGZ1bmN0aW9uIGdldFlvdVR1YmVJZEZyb21VcmwodXJsKSB7CgogICAgICAgICAgICAgICAgaWYgKHVybCA9PT0gdW5kZWZpbmVkIHx8IHVybCA9PT0gbnVsbCB8fCAhdXJsLnRyaW0oKS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgcGFydHMgPSB1cmwuc3BsaXQoJz8nKTsKICAgICAgICAgICAgICAgIHVybCA9IHBhcnRzWzBdOwogICAgICAgICAgICAgICAgcmV0dXJuIHVybC5zdWJzdHJpbmcodXJsLmxhc3RJbmRleE9mKCcvJykgKyAxKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBJbmplY3QgYG5vLWNvb2tpZWAgZWxlbWVudCB0byBVUkwuIE9ubHkgd29ya3Mgd2l0aCBmb3JtYXQ6IGh0dHA6Ly93d3cueW91dHViZS5jb20vdi9WSURFT19JRD92ZXJzaW9uPTMKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVybAogICAgICAgICAgICAgKiBAcmV0dXJuIHs/U3RyaW5nfQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgZ2V0WW91VHViZU5vQ29va2llVXJsOiBmdW5jdGlvbiBnZXRZb3VUdWJlTm9Db29raWVVcmwodXJsKSB7CiAgICAgICAgICAgICAgICBpZiAodXJsID09PSB1bmRlZmluZWQgfHwgdXJsID09PSBudWxsIHx8ICF1cmwudHJpbSgpLmxlbmd0aCB8fCAhdXJsLmluY2x1ZGVzKCcvL3d3dy55b3V0dWJlJykpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXJsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IHVybC5zcGxpdCgnLycpOwogICAgICAgICAgICAgICAgcGFydHNbMl0gPSBwYXJ0c1syXS5yZXBsYWNlKCcuY29tJywgJy1ub2Nvb2tpZS5jb20nKTsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0cy5qb2luKCcvJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICB2YXIgWW91VHViZUlmcmFtZVJlbmRlcmVyID0gewogICAgICAgICAgICBuYW1lOiAneW91dHViZV9pZnJhbWUnLAoKICAgICAgICAgICAgb3B0aW9uczogewogICAgICAgICAgICAgICAgcHJlZml4OiAneW91dHViZV9pZnJhbWUnLAogICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgKiBDdXN0b20gY29uZmlndXJhdGlvbiBmb3IgWW91VHViZSBwbGF5ZXIKICAgICAgICAgICAgICAgICAqCiAgICAgICAgICAgICAgICAgKiBAc2VlIGh0dHBzOi8vZGV2ZWxvcGVycy5nb29nbGUuY29tL3lvdXR1YmUvcGxheWVyX3BhcmFtZXRlcnMjUGFyYW1ldGVycwogICAgICAgICAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgeW91dHViZTogewogICAgICAgICAgICAgICAgICAgIGF1dG9wbGF5OiAwLAogICAgICAgICAgICAgICAgICAgIGNvbnRyb2xzOiAwLAogICAgICAgICAgICAgICAgICAgIGRpc2FibGVrYjogMSwKICAgICAgICAgICAgICAgICAgICBlbmQ6IDAsCiAgICAgICAgICAgICAgICAgICAgbG9vcDogMCwKICAgICAgICAgICAgICAgICAgICBtb2Rlc3RicmFuZGluZzogMCwKICAgICAgICAgICAgICAgICAgICBwbGF5c2lubGluZTogMCwKICAgICAgICAgICAgICAgICAgICByZWw6IDAsCiAgICAgICAgICAgICAgICAgICAgc2hvd2luZm86IDAsCiAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgICAgICAgICAgICAgLy8gY3VzdG9tIHRvIGluamVjdCBgLW5vY29va2llYCBlbGVtZW50IGluIFVSTAogICAgICAgICAgICAgICAgICAgIG5vY29va2llOiBmYWxzZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIERldGVybWluZSBpZiBhIHNwZWNpZmljIGVsZW1lbnQgdHlwZSBjYW4gYmUgcGxheWVkIHdpdGggdGhpcyByZW5kZXIKICAgICAgICAgICAgICoKICAgICAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAgICAgICAgICovCiAgICAgICAgICAgIGNhblBsYXlUeXBlOiBmdW5jdGlvbiBjYW5QbGF5VHlwZSh0eXBlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWyd2aWRlby95b3V0dWJlJywgJ3ZpZGVvL3gteW91dHViZSddLmluY2x1ZGVzKHR5cGUpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENyZWF0ZSB0aGUgcGxheWVyIGluc3RhbmNlIGFuZCBhZGQgYWxsIG5hdGl2ZSBldmVudHMvbWV0aG9kcy9wcm9wZXJ0aWVzIGFzIHBvc3NpYmxlCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEBwYXJhbSB7TWVkaWFFbGVtZW50fSBtZWRpYUVsZW1lbnQgSW5zdGFuY2Ugb2YgbWVqcy5NZWRpYUVsZW1lbnQgYWxyZWFkeSBjcmVhdGVkCiAgICAgICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIEFsbCB0aGUgcGxheWVyIGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBwYXNzZWQgdGhyb3VnaCBjb25zdHJ1Y3RvcgogICAgICAgICAgICAgKiBAcGFyYW0ge09iamVjdFtdfSBtZWRpYUZpbGVzIExpc3Qgb2Ygc291cmNlcyB3aXRoIGZvcm1hdDoge3NyYzogdXJsLCB0eXBlOiB4L3kten0KICAgICAgICAgICAgICogQHJldHVybiB7T2JqZWN0fQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgY3JlYXRlOiBmdW5jdGlvbiBjcmVhdGUobWVkaWFFbGVtZW50LCBvcHRpb25zLCBtZWRpYUZpbGVzKSB7CgogICAgICAgICAgICAgICAgLy8gZXhwb3NlZCBvYmplY3QKICAgICAgICAgICAgICAgIHZhciB5b3V0dWJlID0ge307CiAgICAgICAgICAgICAgICB5b3V0dWJlLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgICAgICAgeW91dHViZS5pZCA9IG1lZGlhRWxlbWVudC5pZCArICdfJyArIG9wdGlvbnMucHJlZml4OwogICAgICAgICAgICAgICAgeW91dHViZS5tZWRpYUVsZW1lbnQgPSBtZWRpYUVsZW1lbnQ7CgogICAgICAgICAgICAgICAgLy8gQVBJIG9iamVjdHMKICAgICAgICAgICAgICAgIHZhciBhcGlTdGFjayA9IFtdLAogICAgICAgICAgICAgICAgICAgIHlvdVR1YmVBcGkgPSBudWxsLAogICAgICAgICAgICAgICAgICAgIHlvdVR1YmVBcGlSZWFkeSA9IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIHBhdXNlZCA9IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZW5kZWQgPSBmYWxzZSwKICAgICAgICAgICAgICAgICAgICB5b3VUdWJlSWZyYW1lID0gbnVsbCwKICAgICAgICAgICAgICAgICAgICB2b2x1bWUgPSAxLAogICAgICAgICAgICAgICAgICAgIHJlYWR5U3RhdGUgPSA0LAogICAgICAgICAgICAgICAgICAgIGkgPSB2b2lkIDAsCiAgICAgICAgICAgICAgICAgICAgaWwgPSB2b2lkIDA7CgogICAgICAgICAgICAgICAgLy8gd3JhcHBlcnMgZm9yIGdldC9zZXQKICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IF9tZWpzMi5kZWZhdWx0Lmh0bWw1bWVkaWEucHJvcGVydGllcywKICAgICAgICAgICAgICAgICAgICBhc3NpZ25HZXR0ZXJzU2V0dGVycyA9IGZ1bmN0aW9uIGFzc2lnbkdldHRlcnNTZXR0ZXJzKHByb3BOYW1lKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGQgdG8gZmxhc2ggc3RhdGUgdGhhdCB3ZSB3aWxsIHN0b3JlCgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2FwTmFtZSA9ICcnICsgcHJvcE5hbWUuc3Vic3RyaW5nKDAsIDEpLnRvVXBwZXJDYXNlKCkgKyBwcm9wTmFtZS5zdWJzdHJpbmcoMSk7CgogICAgICAgICAgICAgICAgICAgICAgICB5b3V0dWJlWydnZXQnICsgY2FwTmFtZV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoeW91VHViZUFwaSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZpZ3VyZSBvdXQgaG93IHRvIGdldCB5b3V0dWJlIGR0YSBoZXJlCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfcmV0ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHByb3BOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjdXJyZW50VGltZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjogeW91VHViZUFwaS5nZXRDdXJyZW50VGltZSgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdkdXJhdGlvbic6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjogeW91VHViZUFwaS5nZXREdXJhdGlvbigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2b2x1bWUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZvbHVtZSA9IHlvdVR1YmVBcGkuZ2V0Vm9sdW1lKCkgLyAxMDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjogdm9sdW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdwYXVzZWQnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHY6IHBhdXNlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZW5kZWQnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHY6IGVuZGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdtdXRlZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjogeW91VHViZUFwaS5pc011dGVkKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2J1ZmZlcmVkJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGVyY2VudExvYWRlZCA9IHlvdVR1YmVBcGkuZ2V0VmlkZW9Mb2FkZWRGcmFjdGlvbigpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbiA9IHlvdVR1YmVBcGkuZ2V0RHVyYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2OiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydDogZnVuY3Rpb24gc3RhcnQoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kOiBmdW5jdGlvbiBlbmQoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBlcmNlbnRMb2FkZWQgKiBkdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGg6IDEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdzcmMnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHY6IHlvdVR1YmVBcGkuZ2V0VmlkZW9VcmwoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncmVhZHlTdGF0ZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdjogcmVhZHlTdGF0ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KCk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodHlwZW9mIF9yZXQgPT09ICd1bmRlZmluZWQnID8gJ3VuZGVmaW5lZCcgOiBfdHlwZW9mKF9yZXQpKSA9PT0gIm9iamVjdCIpIHJldHVybiBfcmV0LnY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHlvdXR1YmVbJ3NldCcgKyBjYXBOYW1lXSA9IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh5b3VUdWJlQXBpICE9PSBudWxsKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRvIHNvbWV0aGluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocHJvcE5hbWUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3NyYyc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXJsID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHZhbHVlIDogdmFsdWVbMF0uc3JjLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF92aWRlb0lkID0gWW91VHViZUFwaS5nZXRZb3VUdWJlSWQodXJsKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVkaWFFbGVtZW50LmdldEF0dHJpYnV0ZSgnYXV0b3BsYXknKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlvdVR1YmVBcGkubG9hZFZpZGVvQnlJZChfdmlkZW9JZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlvdVR1YmVBcGkuY3VlVmlkZW9CeUlkKF92aWRlb0lkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY3VycmVudFRpbWUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeW91VHViZUFwaS5zZWVrVG8odmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdtdXRlZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5b3VUdWJlQXBpLm11dGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeW91VHViZUFwaS51bk11dGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgndm9sdW1lY2hhbmdlJywgeW91dHViZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgNTApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICd2b2x1bWUnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdm9sdW1lID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5b3VUdWJlQXBpLnNldFZvbHVtZSh2YWx1ZSAqIDEwMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoJ3ZvbHVtZWNoYW5nZScsIHlvdXR1YmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDUwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdyZWFkeVN0YXRlJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudCA9ICgwLCBfZG9tLmNyZWF0ZUV2ZW50KSgnY2FucGxheScsIHZpbWVvKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdG9yZSBmb3IgYWZ0ZXIgIlJFQURZIiBldmVudCBmaXJlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwaVN0YWNrLnB1c2goe3R5cGU6ICdzZXQnLCBwcm9wTmFtZTogcHJvcE5hbWUsIHZhbHVlOiB2YWx1ZX0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBwcm9wcy5sZW5ndGg7IGkgPCBpbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYXNzaWduR2V0dGVyc1NldHRlcnMocHJvcHNbaV0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGFkZCB3cmFwcGVycyBmb3IgbmF0aXZlIG1ldGhvZHMKICAgICAgICAgICAgICAgIHZhciBtZXRob2RzID0gX21lanMyLmRlZmF1bHQuaHRtbDVtZWRpYS5tZXRob2RzLAogICAgICAgICAgICAgICAgICAgIGFzc2lnbk1ldGhvZHMgPSBmdW5jdGlvbiBhc3NpZ25NZXRob2RzKG1ldGhvZE5hbWUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJ1biB0aGUgbWV0aG9kIG9uIHRoZSBuYXRpdmUgSFRNTE1lZGlhRWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICB5b3V0dWJlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh5b3VUdWJlQXBpICE9PSBudWxsKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIERPIG1ldGhvZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAobWV0aG9kTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdwbGF5JzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB5b3VUdWJlQXBpLnBsYXlWaWRlbygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdwYXVzZSc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geW91VHViZUFwaS5wYXVzZVZpZGVvKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2xvYWQnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBpU3RhY2sucHVzaCh7dHlwZTogJ2NhbGwnLCBtZXRob2ROYW1lOiBtZXRob2ROYW1lfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBpbCA9IG1ldGhvZHMubGVuZ3RoOyBpIDwgaWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFzc2lnbk1ldGhvZHMobWV0aG9kc1tpXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ1JFQVRFIFlvdVR1YmUKICAgICAgICAgICAgICAgIHZhciB5b3V0dWJlQ29udGFpbmVyID0gX2RvY3VtZW50Mi5kZWZhdWx0LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgICAgICAgICAgeW91dHViZUNvbnRhaW5lci5pZCA9IHlvdXR1YmUuaWQ7CgogICAgICAgICAgICAgICAgLy8gSWYgYG5vY29va2llYCBmZWF0dXJlIHdhcyBlbmFibGVkLCBtb2RpZnkgb3JpZ2luYWwgVVJMCiAgICAgICAgICAgICAgICBpZiAoeW91dHViZS5vcHRpb25zLnlvdXR1YmUubm9jb29raWUpIHsKICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlLnNldEF0dHJpYnV0ZSgnc3JjJywgWW91VHViZUFwaS5nZXRZb3VUdWJlTm9Db29raWVVcmwobWVkaWFGaWxlc1swXS5zcmMpKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQub3JpZ2luYWxOb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHlvdXR1YmVDb250YWluZXIsIG1lZGlhRWxlbWVudC5vcmlnaW5hbE5vZGUpOwogICAgICAgICAgICAgICAgbWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKICAgICAgICAgICAgICAgIHZhciBpc0F1ZGlvID0gbWVkaWFFbGVtZW50Lm9yaWdpbmFsTm9kZS50YWdOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdhdWRpbycsCiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0ID0gaXNBdWRpbyA/ICcwJyA6IG1lZGlhRWxlbWVudC5vcmlnaW5hbE5vZGUuaGVpZ2h0LAogICAgICAgICAgICAgICAgICAgIHdpZHRoID0gaXNBdWRpbyA/ICcwJyA6IG1lZGlhRWxlbWVudC5vcmlnaW5hbE5vZGUud2lkdGgsCiAgICAgICAgICAgICAgICAgICAgdmlkZW9JZCA9IFlvdVR1YmVBcGkuZ2V0WW91VHViZUlkKG1lZGlhRmlsZXNbMF0uc3JjKSwKICAgICAgICAgICAgICAgICAgICB5b3V0dWJlU2V0dGluZ3MgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiB5b3V0dWJlLmlkLAogICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJJZDogeW91dHViZUNvbnRhaW5lci5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgdmlkZW9JZDogdmlkZW9JZCwKICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiB3aWR0aCwKICAgICAgICAgICAgICAgICAgICAgICAgcGxheWVyVmFyczogT2JqZWN0LmFzc2lnbih7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sczogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbDogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVrYjogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dpbmZvOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZXN0YnJhbmRpbmc6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sNTogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXlzaW5saW5lOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmQ6IDAKICAgICAgICAgICAgICAgICAgICAgICAgfSwgeW91dHViZS5vcHRpb25zLnlvdXR1YmUpLAogICAgICAgICAgICAgICAgICAgICAgICBvcmlnaW46IF93aW5kb3cyLmRlZmF1bHQubG9jYXRpb24uaG9zdCwKICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblJlYWR5OiBmdW5jdGlvbiBvblJlYWR5KGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeW91VHViZUFwaVJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQueW91VHViZUFwaSA9IHlvdVR1YmVBcGkgPSBlLnRhcmdldDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQueW91VHViZVN0YXRlID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXVzZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZGVkOiBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRvIGNhbGwgc3RhY2sKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBpU3RhY2subGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIGlsID0gYXBpU3RhY2subGVuZ3RoOyBpIDwgaWw7IGkrKykgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGFja0l0ZW0gPSBhcGlTdGFja1tpXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhY2tJdGVtLnR5cGUgPT09ICdzZXQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BOYW1lID0gc3RhY2tJdGVtLnByb3BOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXBOYW1lID0gJycgKyBwcm9wTmFtZS5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHByb3BOYW1lLnN1YnN0cmluZygxKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeW91dHViZVsnc2V0JyArIGNhcE5hbWVdKHN0YWNrSXRlbS52YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YWNrSXRlbS50eXBlID09PSAnY2FsbCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5b3V0dWJlW3N0YWNrSXRlbS5tZXRob2ROYW1lXSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhIGZldyBtb3JlIGV2ZW50cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlvdVR1YmVJZnJhbWUgPSB5b3VUdWJlQXBpLmdldElmcmFtZSgpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRzID0gWydtb3VzZW92ZXInLCAnbW91c2VvdXQnXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzaWduRXZlbnRzID0gZnVuY3Rpb24gYXNzaWduRXZlbnRzKGUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3RXZlbnQgPSAoMCwgX2RvbS5jcmVhdGVFdmVudCkoZS50eXBlLCB5b3V0dWJlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KG5ld0V2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiBpbiBldmVudHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKDAsIF9kb20uYWRkRXZlbnQpKHlvdVR1YmVJZnJhbWUsIGV2ZW50c1tqXSwgYXNzaWduRXZlbnRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNlbmQgaW5pdCBldmVudHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5pdEV2ZW50cyA9IFsncmVuZGVyZXJyZWFkeScsICdsb2FkZWRkYXRhJywgJ2xvYWRlZG1ldGFkYXRhJywgJ2NhbnBsYXknXTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgaWwgPSBpbml0RXZlbnRzLmxlbmd0aDsgaSA8IGlsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKGluaXRFdmVudHNbaV0sIHlvdXR1YmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uU3RhdGVDaGFuZ2U6IGZ1bmN0aW9uIG9uU3RhdGVDaGFuZ2UoZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0cmFuc2xhdGUgZXZlbnRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50cyA9IFtdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGUuZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIC0xOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbm90IHN0YXJ0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50cyA9IFsnbG9hZGVkbWV0YWRhdGEnXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdXNlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBZVC5QbGF5ZXJTdGF0ZS5FTkRFRAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzID0gWydlbmRlZCddOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF1c2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRlZCA9IHRydWU7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeW91dHViZS5zdG9wSW50ZXJ2YWwoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gWVQuUGxheWVyU3RhdGUuUExBWUlORwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzID0gWydwbGF5JywgJ3BsYXlpbmcnXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdXNlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kZWQgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5b3V0dWJlLnN0YXJ0SW50ZXJ2YWwoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFlULlBsYXllclN0YXRlLlBBVVNFRAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzID0gWydwYXVzZWQnXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdXNlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRlZCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlvdXR1YmUuc3RvcEludGVydmFsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFlULlBsYXllclN0YXRlLkJVRkZFUklORwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzID0gWydwcm9ncmVzcyddOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF1c2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbmRlZCA9IGZhbHNlOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBZVC5QbGF5ZXJTdGF0ZS5DVUVECiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudHMgPSBbJ2xvYWRlZGRhdGEnLCAnbG9hZGVkbWV0YWRhdGEnLCAnY2FucGxheSddOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF1c2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZGVkID0gZmFsc2U7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzZW5kIGV2ZW50cyB1cAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIF9pID0gMCwgX2lsID0gZXZlbnRzLmxlbmd0aDsgX2kgPCBfaWw7IF9pKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKGV2ZW50c1tfaV0sIHlvdXR1YmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZWRpYUVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyBUaGUgZm9sbG93aW5nIHdpbGwgcHJldmVudCB0aGF0IGluIG1vYmlsZSBkZXZpY2VzLCBZb3VUdWJlIGlzIGRpc3BsYXllZCBpbiBmdWxsc2NyZWVuIHdoZW4gdXNpbmcgYXVkaW8KICAgICAgICAgICAgICAgIGlmIChpc0F1ZGlvKSB7CiAgICAgICAgICAgICAgICAgICAgeW91dHViZVNldHRpbmdzLnBsYXllclZhcnMucGxheXNpbmxpbmUgPSAxOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHNlbmQgaXQgb2ZmIGZvciBhc3luYyBsb2FkaW5nIGFuZCBjcmVhdGlvbgogICAgICAgICAgICAgICAgWW91VHViZUFwaS5lbnF1ZXVlSWZyYW1lKHlvdXR1YmVTZXR0aW5ncyk7CgogICAgICAgICAgICAgICAgeW91dHViZS5vbkV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgcGxheWVyLCBfeW91VHViZVN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKF95b3VUdWJlU3RhdGUgIT09IG51bGwgJiYgX3lvdVR1YmVTdGF0ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC55b3VUdWJlU3RhdGUgPSBfeW91VHViZVN0YXRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgeW91dHViZS5zZXRTaXplID0gZnVuY3Rpb24gKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoeW91VHViZUFwaSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB5b3VUdWJlQXBpLnNldFNpemUod2lkdGgsIGhlaWdodCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHlvdXR1YmUuaGlkZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB5b3V0dWJlLnN0b3BJbnRlcnZhbCgpOwogICAgICAgICAgICAgICAgICAgIHlvdXR1YmUucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoeW91VHViZUlmcmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICB5b3VUdWJlSWZyYW1lLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHlvdXR1YmUuc2hvdyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoeW91VHViZUlmcmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICB5b3VUdWJlSWZyYW1lLnN0eWxlLmRpc3BsYXkgPSAnJzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgeW91dHViZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHlvdVR1YmVBcGkuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHlvdXR1YmUuaW50ZXJ2YWwgPSBudWxsOwoKICAgICAgICAgICAgICAgIHlvdXR1YmUuc3RhcnRJbnRlcnZhbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAvLyBjcmVhdGUgdGltZXIKICAgICAgICAgICAgICAgICAgICB5b3V0dWJlLmludGVydmFsID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gKDAsIF9kb20uY3JlYXRlRXZlbnQpKCd0aW1ldXBkYXRlJywgeW91dHViZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lZGlhRWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICB9LCAyNTApOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHlvdXR1YmUuc3RvcEludGVydmFsID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh5b3V0dWJlLmludGVydmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoeW91dHViZS5pbnRlcnZhbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICByZXR1cm4geW91dHViZTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGlmIChfd2luZG93Mi5kZWZhdWx0LnBvc3RNZXNzYWdlICYmIF90eXBlb2YoX3dpbmRvdzIuZGVmYXVsdC5hZGRFdmVudExpc3RlbmVyKSkgewoKICAgICAgICAgICAgX3dpbmRvdzIuZGVmYXVsdC5vbllvdVR1YmVQbGF5ZXJBUElSZWFkeSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIFlvdVR1YmVBcGkuaUZyYW1lUmVhZHkoKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIF9tZWRpYS50eXBlQ2hlY2tzLnB1c2goZnVuY3Rpb24gKHVybCkgewogICAgICAgICAgICAgICAgdXJsID0gdXJsLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdXJsLmluY2x1ZGVzKCcvL3d3dy55b3V0dWJlJykgfHwgdXJsLmluY2x1ZGVzKCcvL3lvdXR1LmJlJykgPyAndmlkZW8veC15b3V0dWJlJyA6IG51bGw7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgX3JlbmRlcmVyLnJlbmRlcmVyLmFkZChZb3VUdWJlSWZyYW1lUmVuZGVyZXIpOwogICAgICAgIH0KCiAgICB9LCB7IjIiOiAyLCAiMjgiOiAyOCwgIjMiOiAzLCAiMzAiOiAzMCwgIjYiOiA2LCAiNyI6IDd9XSwKICAgIDI3OiBbZnVuY3Rpb24gKF9kZXJlcV8sIG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgIAoKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICAgICAgICAgIHZhbHVlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgZXhwb3J0cy5jYW5jZWxGdWxsU2NyZWVuID0gZXhwb3J0cy5yZXF1ZXN0RnVsbFNjcmVlbiA9IGV4cG9ydHMuaXNGdWxsU2NyZWVuID0gZXhwb3J0cy5GVUxMU0NSRUVOX0VWRU5UX05BTUUgPSBleHBvcnRzLkhBU19OQVRJVkVfRlVMTFNDUkVFTl9FTkFCTEVEID0gZXhwb3J0cy5IQVNfVFJVRV9OQVRJVkVfRlVMTFNDUkVFTiA9IGV4cG9ydHMuSEFTX0lPU19GVUxMU0NSRUVOID0gZXhwb3J0cy5IQVNfTVNfTkFUSVZFX0ZVTExTQ1JFRU4gPSBleHBvcnRzLkhBU19NT1pfTkFUSVZFX0ZVTExTQ1JFRU4gPSBleHBvcnRzLkhBU19XRUJLSVRfTkFUSVZFX0ZVTExTQ1JFRU4gPSBleHBvcnRzLkhBU19OQVRJVkVfRlVMTFNDUkVFTiA9IGV4cG9ydHMuU1VQUE9SVFNfTkFUSVZFX0hMUyA9IGV4cG9ydHMuU1VQUE9SVFNfTUVESUFfVEFHID0gZXhwb3J0cy5TVVBQT1JUX1BPSU5URVJfRVZFTlRTID0gZXhwb3J0cy5IQVNfTVNFID0gZXhwb3J0cy5IQVNfVE9VQ0ggPSBleHBvcnRzLklTX1NUT0NLX0FORFJPSUQgPSBleHBvcnRzLklTX1NBRkFSSSA9IGV4cG9ydHMuSVNfRklSRUZPWCA9IGV4cG9ydHMuSVNfQ0hST01FID0gZXhwb3J0cy5JU19JRSA9IGV4cG9ydHMuSVNfQU5EUk9JRCA9IGV4cG9ydHMuSVNfSU9TID0gZXhwb3J0cy5JU19JUEhPTkUgPSBleHBvcnRzLklTX0lQQUQgPSBleHBvcnRzLlVBID0gZXhwb3J0cy5OQVYgPSB1bmRlZmluZWQ7CgogICAgICAgIHZhciBfd2luZG93ID0gX2RlcmVxXygzKTsKCiAgICAgICAgdmFyIF93aW5kb3cyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfd2luZG93KTsKCiAgICAgICAgdmFyIF9kb2N1bWVudCA9IF9kZXJlcV8oMik7CgogICAgICAgIHZhciBfZG9jdW1lbnQyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfZG9jdW1lbnQpOwoKICAgICAgICB2YXIgX21lanMgPSBfZGVyZXFfKDYpOwoKICAgICAgICB2YXIgX21lanMyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfbWVqcyk7CgogICAgICAgIGZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ZGVmYXVsdDogb2JqfTsKICAgICAgICB9CgogICAgICAgIHZhciBOQVYgPSBleHBvcnRzLk5BViA9IF93aW5kb3cyLmRlZmF1bHQubmF2aWdhdG9yOwogICAgICAgIHZhciBVQSA9IGV4cG9ydHMuVUEgPSBOQVYudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7CgogICAgICAgIHZhciBJU19JUEFEID0gZXhwb3J0cy5JU19JUEFEID0gVUEubWF0Y2goL2lwYWQvaSkgIT09IG51bGw7CiAgICAgICAgdmFyIElTX0lQSE9ORSA9IGV4cG9ydHMuSVNfSVBIT05FID0gVUEubWF0Y2goL2lwaG9uZS9pKSAhPT0gbnVsbDsKICAgICAgICB2YXIgSVNfSU9TID0gZXhwb3J0cy5JU19JT1MgPSBJU19JUEhPTkUgfHwgSVNfSVBBRDsKICAgICAgICB2YXIgSVNfQU5EUk9JRCA9IGV4cG9ydHMuSVNfQU5EUk9JRCA9IFVBLm1hdGNoKC9hbmRyb2lkL2kpICE9PSBudWxsOwogICAgICAgIHZhciBJU19JRSA9IGV4cG9ydHMuSVNfSUUgPSBOQVYuYXBwTmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdtaWNyb3NvZnQnKSB8fCBOQVYuYXBwTmFtZS50b0xvd2VyQ2FzZSgpLm1hdGNoKC90cmlkZW50L2dpKSAhPT0gbnVsbDsKICAgICAgICB2YXIgSVNfQ0hST01FID0gZXhwb3J0cy5JU19DSFJPTUUgPSBVQS5tYXRjaCgvY2hyb21lL2dpKSAhPT0gbnVsbDsKICAgICAgICB2YXIgSVNfRklSRUZPWCA9IGV4cG9ydHMuSVNfRklSRUZPWCA9IFVBLm1hdGNoKC9maXJlZm94L2dpKSAhPT0gbnVsbDsKICAgICAgICB2YXIgSVNfU0FGQVJJID0gZXhwb3J0cy5JU19TQUZBUkkgPSBVQS5tYXRjaCgvc2FmYXJpL2dpKSAhPT0gbnVsbCAmJiAhSVNfQ0hST01FOwogICAgICAgIHZhciBJU19TVE9DS19BTkRST0lEID0gZXhwb3J0cy5JU19TVE9DS19BTkRST0lEID0gVUEubWF0Y2goL15tb3ppbGxhXC9cZCtcLlxkK1xzXChsaW51eDtcc3U7L2dpKSAhPT0gbnVsbDsKCiAgICAgICAgdmFyIEhBU19UT1VDSCA9IGV4cG9ydHMuSEFTX1RPVUNIID0gISEoJ29udG91Y2hzdGFydCcgaW4gX3dpbmRvdzIuZGVmYXVsdCB8fCBfd2luZG93Mi5kZWZhdWx0LkRvY3VtZW50VG91Y2ggJiYgX2RvY3VtZW50Mi5kZWZhdWx0IGluc3RhbmNlb2YgX3dpbmRvdzIuZGVmYXVsdC5Eb2N1bWVudFRvdWNoKTsKICAgICAgICB2YXIgSEFTX01TRSA9IGV4cG9ydHMuSEFTX01TRSA9ICdNZWRpYVNvdXJjZScgaW4gX3dpbmRvdzIuZGVmYXVsdDsKICAgICAgICB2YXIgU1VQUE9SVF9QT0lOVEVSX0VWRU5UUyA9IGV4cG9ydHMuU1VQUE9SVF9QT0lOVEVSX0VWRU5UUyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSBfZG9jdW1lbnQyLmRlZmF1bHQuY3JlYXRlRWxlbWVudCgneCcpLAogICAgICAgICAgICAgICAgZG9jdW1lbnRFbGVtZW50ID0gX2RvY3VtZW50Mi5kZWZhdWx0LmRvY3VtZW50RWxlbWVudCwKICAgICAgICAgICAgICAgIGdldENvbXB1dGVkU3R5bGUgPSBfd2luZG93Mi5kZWZhdWx0LmdldENvbXB1dGVkU3R5bGUsCiAgICAgICAgICAgICAgICBzdXBwb3J0cyA9IHZvaWQgMDsKCiAgICAgICAgICAgIGlmICghKCdwb2ludGVyRXZlbnRzJyBpbiBlbGVtZW50LnN0eWxlKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBlbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnYXV0byc7CiAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICd4JzsKICAgICAgICAgICAgZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKGVsZW1lbnQpOwogICAgICAgICAgICBzdXBwb3J0cyA9IGdldENvbXB1dGVkU3R5bGUgJiYgZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCAnJykucG9pbnRlckV2ZW50cyA9PT0gJ2F1dG8nOwogICAgICAgICAgICBkb2N1bWVudEVsZW1lbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCk7CiAgICAgICAgICAgIHJldHVybiAhIXN1cHBvcnRzOwogICAgICAgIH0oKTsKCi8vIGZvciBJRQogICAgICAgIHZhciBodG1sNUVsZW1lbnRzID0gWydzb3VyY2UnLCAndHJhY2snLCAnYXVkaW8nLCAndmlkZW8nXSwKICAgICAgICAgICAgdmlkZW8gPSB2b2lkIDA7CgogICAgICAgIGZvciAodmFyIGkgPSAwLCBpbCA9IGh0bWw1RWxlbWVudHMubGVuZ3RoOyBpIDwgaWw7IGkrKykgewogICAgICAgICAgICB2aWRlbyA9IF9kb2N1bWVudDIuZGVmYXVsdC5jcmVhdGVFbGVtZW50KGh0bWw1RWxlbWVudHNbaV0pOwogICAgICAgIH0KCi8vIFRlc3QgaWYgTWVkaWEgU291cmNlIEV4dGVuc2lvbnMgYXJlIHN1cHBvcnRlZCBieSBicm93c2VyCiAgICAgICAgdmFyIFNVUFBPUlRTX01FRElBX1RBRyA9IGV4cG9ydHMuU1VQUE9SVFNfTUVESUFfVEFHID0gdmlkZW8uY2FuUGxheVR5cGUgIT09IHVuZGVmaW5lZCB8fCBIQVNfTVNFOwoKLy8gVGVzdCBpZiBicm93c2VycyBzdXBwb3J0IEhMUyBuYXRpdmVseSAocmlnaHQgbm93IFNhZmFyaSwgQW5kcm9pZCdzIENocm9tZSBhbmQgU3RvY2sgYnJvd3NlcnMsIGFuZCBNUyBFZGdlKQogICAgICAgIHZhciBTVVBQT1JUU19OQVRJVkVfSExTID0gZXhwb3J0cy5TVVBQT1JUU19OQVRJVkVfSExTID0gSVNfU0FGQVJJIHx8IElTX0FORFJPSUQgJiYgKElTX0NIUk9NRSB8fCBJU19TVE9DS19BTkRST0lEKSB8fCBJU19JRSAmJiBVQS5tYXRjaCgvZWRnZS9naSkgIT09IG51bGw7CgovLyBEZXRlY3QgbmF0aXZlIEphdmFTY3JpcHQgZnVsbHNjcmVlbiAoU2FmYXJpL0ZpcmVmb3ggb25seSwgQ2hyb21lIHN0aWxsIGZhaWxzKQoKLy8gaU9TCiAgICAgICAgdmFyIGhhc2lPU0Z1bGxTY3JlZW4gPSB2aWRlby53ZWJraXRFbnRlckZ1bGxzY3JlZW4gIT09IHVuZGVmaW5lZDsKCi8vIFczQwogICAgICAgIHZhciBoYXNOYXRpdmVGdWxsc2NyZWVuID0gdmlkZW8ucmVxdWVzdEZ1bGxzY3JlZW4gIT09IHVuZGVmaW5lZDsKCi8vIE9TIFggMTAuNSBjYW4ndCBkbyB0aGlzIGV2ZW4gaWYgaXQgc2F5cyBpdCBjYW4gOigKICAgICAgICBpZiAoaGFzaU9TRnVsbFNjcmVlbiAmJiBVQS5tYXRjaCgvbWFjIG9zIHggMTBfNS9pKSkgewogICAgICAgICAgICBoYXNOYXRpdmVGdWxsc2NyZWVuID0gZmFsc2U7CiAgICAgICAgICAgIGhhc2lPU0Z1bGxTY3JlZW4gPSBmYWxzZTsKICAgICAgICB9CgovLyB3ZWJraXQvZmlyZWZveC9JRTExKwogICAgICAgIHZhciBoYXNXZWJraXROYXRpdmVGdWxsU2NyZWVuID0gdmlkZW8ud2Via2l0UmVxdWVzdEZ1bGxTY3JlZW4gIT09IHVuZGVmaW5lZDsKICAgICAgICB2YXIgaGFzTW96TmF0aXZlRnVsbFNjcmVlbiA9IHZpZGVvLm1velJlcXVlc3RGdWxsU2NyZWVuICE9PSB1bmRlZmluZWQ7CiAgICAgICAgdmFyIGhhc01zTmF0aXZlRnVsbFNjcmVlbiA9IHZpZGVvLm1zUmVxdWVzdEZ1bGxzY3JlZW4gIT09IHVuZGVmaW5lZDsKCiAgICAgICAgdmFyIGhhc1RydWVOYXRpdmVGdWxsU2NyZWVuID0gaGFzV2Via2l0TmF0aXZlRnVsbFNjcmVlbiB8fCBoYXNNb3pOYXRpdmVGdWxsU2NyZWVuIHx8IGhhc01zTmF0aXZlRnVsbFNjcmVlbjsKICAgICAgICB2YXIgbmF0aXZlRnVsbFNjcmVlbkVuYWJsZWQgPSBoYXNUcnVlTmF0aXZlRnVsbFNjcmVlbjsKCiAgICAgICAgdmFyIGZ1bGxTY3JlZW5FdmVudE5hbWUgPSAnJzsKICAgICAgICB2YXIgaXNGdWxsU2NyZWVuID0gdm9pZCAwLAogICAgICAgICAgICByZXF1ZXN0RnVsbFNjcmVlbiA9IHZvaWQgMCwKICAgICAgICAgICAgY2FuY2VsRnVsbFNjcmVlbiA9IHZvaWQgMDsKCi8vIEVuYWJsZWQ/CiAgICAgICAgaWYgKGhhc01vek5hdGl2ZUZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgbmF0aXZlRnVsbFNjcmVlbkVuYWJsZWQgPSBfZG9jdW1lbnQyLmRlZmF1bHQubW96RnVsbFNjcmVlbkVuYWJsZWQ7CiAgICAgICAgfSBlbHNlIGlmIChoYXNNc05hdGl2ZUZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgbmF0aXZlRnVsbFNjcmVlbkVuYWJsZWQgPSBfZG9jdW1lbnQyLmRlZmF1bHQubXNGdWxsc2NyZWVuRW5hYmxlZDsKICAgICAgICB9CgogICAgICAgIGlmIChJU19DSFJPTUUpIHsKICAgICAgICAgICAgaGFzaU9TRnVsbFNjcmVlbiA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKGhhc1RydWVOYXRpdmVGdWxsU2NyZWVuKSB7CgogICAgICAgICAgICBpZiAoaGFzV2Via2l0TmF0aXZlRnVsbFNjcmVlbikgewogICAgICAgICAgICAgICAgZnVsbFNjcmVlbkV2ZW50TmFtZSA9ICd3ZWJraXRmdWxsc2NyZWVuY2hhbmdlJzsKICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNNb3pOYXRpdmVGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgICBmdWxsU2NyZWVuRXZlbnROYW1lID0gJ21vemZ1bGxzY3JlZW5jaGFuZ2UnOwogICAgICAgICAgICB9IGVsc2UgaWYgKGhhc01zTmF0aXZlRnVsbFNjcmVlbikgewogICAgICAgICAgICAgICAgZnVsbFNjcmVlbkV2ZW50TmFtZSA9ICdNU0Z1bGxzY3JlZW5DaGFuZ2UnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBleHBvcnRzLmlzRnVsbFNjcmVlbiA9IGlzRnVsbFNjcmVlbiA9IGZ1bmN0aW9uIGlzRnVsbFNjcmVlbigpIHsKICAgICAgICAgICAgICAgIGlmIChoYXNNb3pOYXRpdmVGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9kb2N1bWVudDIuZGVmYXVsdC5tb3pGdWxsU2NyZWVuOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNXZWJraXROYXRpdmVGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9kb2N1bWVudDIuZGVmYXVsdC53ZWJraXRJc0Z1bGxTY3JlZW47CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhc01zTmF0aXZlRnVsbFNjcmVlbikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBfZG9jdW1lbnQyLmRlZmF1bHQubXNGdWxsc2NyZWVuRWxlbWVudCAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGV4cG9ydHMucmVxdWVzdEZ1bGxTY3JlZW4gPSByZXF1ZXN0RnVsbFNjcmVlbiA9IGZ1bmN0aW9uIHJlcXVlc3RGdWxsU2NyZWVuKGVsKSB7CgogICAgICAgICAgICAgICAgaWYgKGhhc1dlYmtpdE5hdGl2ZUZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgICAgICAgICBlbC53ZWJraXRSZXF1ZXN0RnVsbFNjcmVlbigpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNNb3pOYXRpdmVGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgICAgICAgZWwubW96UmVxdWVzdEZ1bGxTY3JlZW4oKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzTXNOYXRpdmVGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgICAgICAgZWwubXNSZXF1ZXN0RnVsbHNjcmVlbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZXhwb3J0cy5jYW5jZWxGdWxsU2NyZWVuID0gY2FuY2VsRnVsbFNjcmVlbiA9IGZ1bmN0aW9uIGNhbmNlbEZ1bGxTY3JlZW4oKSB7CiAgICAgICAgICAgICAgICBpZiAoaGFzV2Via2l0TmF0aXZlRnVsbFNjcmVlbikgewogICAgICAgICAgICAgICAgICAgIF9kb2N1bWVudDIuZGVmYXVsdC53ZWJraXRDYW5jZWxGdWxsU2NyZWVuKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGhhc01vek5hdGl2ZUZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgICAgICAgICBfZG9jdW1lbnQyLmRlZmF1bHQubW96Q2FuY2VsRnVsbFNjcmVlbigpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChoYXNNc05hdGl2ZUZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgICAgICAgICBfZG9jdW1lbnQyLmRlZmF1bHQubXNFeGl0RnVsbHNjcmVlbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgdmFyIEhBU19OQVRJVkVfRlVMTFNDUkVFTiA9IGV4cG9ydHMuSEFTX05BVElWRV9GVUxMU0NSRUVOID0gaGFzTmF0aXZlRnVsbHNjcmVlbjsKICAgICAgICB2YXIgSEFTX1dFQktJVF9OQVRJVkVfRlVMTFNDUkVFTiA9IGV4cG9ydHMuSEFTX1dFQktJVF9OQVRJVkVfRlVMTFNDUkVFTiA9IGhhc1dlYmtpdE5hdGl2ZUZ1bGxTY3JlZW47CiAgICAgICAgdmFyIEhBU19NT1pfTkFUSVZFX0ZVTExTQ1JFRU4gPSBleHBvcnRzLkhBU19NT1pfTkFUSVZFX0ZVTExTQ1JFRU4gPSBoYXNNb3pOYXRpdmVGdWxsU2NyZWVuOwogICAgICAgIHZhciBIQVNfTVNfTkFUSVZFX0ZVTExTQ1JFRU4gPSBleHBvcnRzLkhBU19NU19OQVRJVkVfRlVMTFNDUkVFTiA9IGhhc01zTmF0aXZlRnVsbFNjcmVlbjsKICAgICAgICB2YXIgSEFTX0lPU19GVUxMU0NSRUVOID0gZXhwb3J0cy5IQVNfSU9TX0ZVTExTQ1JFRU4gPSBoYXNpT1NGdWxsU2NyZWVuOwogICAgICAgIHZhciBIQVNfVFJVRV9OQVRJVkVfRlVMTFNDUkVFTiA9IGV4cG9ydHMuSEFTX1RSVUVfTkFUSVZFX0ZVTExTQ1JFRU4gPSBoYXNUcnVlTmF0aXZlRnVsbFNjcmVlbjsKICAgICAgICB2YXIgSEFTX05BVElWRV9GVUxMU0NSRUVOX0VOQUJMRUQgPSBleHBvcnRzLkhBU19OQVRJVkVfRlVMTFNDUkVFTl9FTkFCTEVEID0gbmF0aXZlRnVsbFNjcmVlbkVuYWJsZWQ7CiAgICAgICAgdmFyIEZVTExTQ1JFRU5fRVZFTlRfTkFNRSA9IGV4cG9ydHMuRlVMTFNDUkVFTl9FVkVOVF9OQU1FID0gZnVsbFNjcmVlbkV2ZW50TmFtZTsKCiAgICAgICAgZXhwb3J0cy5pc0Z1bGxTY3JlZW4gPSBpc0Z1bGxTY3JlZW47CiAgICAgICAgZXhwb3J0cy5yZXF1ZXN0RnVsbFNjcmVlbiA9IHJlcXVlc3RGdWxsU2NyZWVuOwogICAgICAgIGV4cG9ydHMuY2FuY2VsRnVsbFNjcmVlbiA9IGNhbmNlbEZ1bGxTY3JlZW47CgoKICAgICAgICBfbWVqczIuZGVmYXVsdC5GZWF0dXJlcyA9IF9tZWpzMi5kZWZhdWx0LkZlYXR1cmVzIHx8IHt9OwogICAgICAgIF9tZWpzMi5kZWZhdWx0LkZlYXR1cmVzLmlzaVBhZCA9IElTX0lQQUQ7CiAgICAgICAgX21lanMyLmRlZmF1bHQuRmVhdHVyZXMuaXNpUGhvbmUgPSBJU19JUEhPTkU7CiAgICAgICAgX21lanMyLmRlZmF1bHQuRmVhdHVyZXMuaXNpT1MgPSBfbWVqczIuZGVmYXVsdC5GZWF0dXJlcy5pc2lQaG9uZSB8fCBfbWVqczIuZGVmYXVsdC5GZWF0dXJlcy5pc2lQYWQ7CiAgICAgICAgX21lanMyLmRlZmF1bHQuRmVhdHVyZXMuaXNBbmRyb2lkID0gSVNfQU5EUk9JRDsKICAgICAgICBfbWVqczIuZGVmYXVsdC5GZWF0dXJlcy5pc0lFID0gSVNfSUU7CiAgICAgICAgX21lanMyLmRlZmF1bHQuRmVhdHVyZXMuaXNDaHJvbWUgPSBJU19DSFJPTUU7CiAgICAgICAgX21lanMyLmRlZmF1bHQuRmVhdHVyZXMuaXNGaXJlZm94ID0gSVNfRklSRUZPWDsKICAgICAgICBfbWVqczIuZGVmYXVsdC5GZWF0dXJlcy5pc1NhZmFyaSA9IElTX1NBRkFSSTsKICAgICAgICBfbWVqczIuZGVmYXVsdC5GZWF0dXJlcy5pc1N0b2NrQW5kcm9pZCA9IElTX1NUT0NLX0FORFJPSUQ7CiAgICAgICAgX21lanMyLmRlZmF1bHQuRmVhdHVyZXMuaGFzVG91Y2ggPSBIQVNfVE9VQ0g7CiAgICAgICAgX21lanMyLmRlZmF1bHQuRmVhdHVyZXMuaGFzTVNFID0gSEFTX01TRTsKICAgICAgICBfbWVqczIuZGVmYXVsdC5GZWF0dXJlcy5zdXBwb3J0c01lZGlhVGFnID0gU1VQUE9SVFNfTUVESUFfVEFHOwogICAgICAgIF9tZWpzMi5kZWZhdWx0LkZlYXR1cmVzLnN1cHBvcnRzTmF0aXZlSExTID0gU1VQUE9SVFNfTkFUSVZFX0hMUzsKCiAgICAgICAgX21lanMyLmRlZmF1bHQuRmVhdHVyZXMuc3VwcG9ydHNQb2ludGVyRXZlbnRzID0gU1VQUE9SVF9QT0lOVEVSX0VWRU5UUzsKICAgICAgICBfbWVqczIuZGVmYXVsdC5GZWF0dXJlcy5oYXNpT1NGdWxsU2NyZWVuID0gSEFTX0lPU19GVUxMU0NSRUVOOwogICAgICAgIF9tZWpzMi5kZWZhdWx0LkZlYXR1cmVzLmhhc05hdGl2ZUZ1bGxzY3JlZW4gPSBIQVNfTkFUSVZFX0ZVTExTQ1JFRU47CiAgICAgICAgX21lanMyLmRlZmF1bHQuRmVhdHVyZXMuaGFzV2Via2l0TmF0aXZlRnVsbFNjcmVlbiA9IEhBU19XRUJLSVRfTkFUSVZFX0ZVTExTQ1JFRU47CiAgICAgICAgX21lanMyLmRlZmF1bHQuRmVhdHVyZXMuaGFzTW96TmF0aXZlRnVsbFNjcmVlbiA9IEhBU19NT1pfTkFUSVZFX0ZVTExTQ1JFRU47CiAgICAgICAgX21lanMyLmRlZmF1bHQuRmVhdHVyZXMuaGFzTXNOYXRpdmVGdWxsU2NyZWVuID0gSEFTX01TX05BVElWRV9GVUxMU0NSRUVOOwogICAgICAgIF9tZWpzMi5kZWZhdWx0LkZlYXR1cmVzLmhhc1RydWVOYXRpdmVGdWxsU2NyZWVuID0gSEFTX1RSVUVfTkFUSVZFX0ZVTExTQ1JFRU47CiAgICAgICAgX21lanMyLmRlZmF1bHQuRmVhdHVyZXMubmF0aXZlRnVsbFNjcmVlbkVuYWJsZWQgPSBIQVNfTkFUSVZFX0ZVTExTQ1JFRU5fRU5BQkxFRDsKICAgICAgICBfbWVqczIuZGVmYXVsdC5GZWF0dXJlcy5mdWxsU2NyZWVuRXZlbnROYW1lID0gRlVMTFNDUkVFTl9FVkVOVF9OQU1FOwogICAgICAgIF9tZWpzMi5kZWZhdWx0LkZlYXR1cmVzLmlzRnVsbFNjcmVlbiA9IGlzRnVsbFNjcmVlbjsKICAgICAgICBfbWVqczIuZGVmYXVsdC5GZWF0dXJlcy5yZXF1ZXN0RnVsbFNjcmVlbiA9IHJlcXVlc3RGdWxsU2NyZWVuOwogICAgICAgIF9tZWpzMi5kZWZhdWx0LkZlYXR1cmVzLmNhbmNlbEZ1bGxTY3JlZW4gPSBjYW5jZWxGdWxsU2NyZWVuOwoKICAgIH0sIHsiMiI6IDIsICIzIjogMywgIjYiOiA2fV0sCiAgICAyODogW2Z1bmN0aW9uIChfZGVyZXFfLCBtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAKCiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgICAgICAgICB2YWx1ZTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIGV4cG9ydHMuY3JlYXRlRXZlbnQgPSBjcmVhdGVFdmVudDsKICAgICAgICBleHBvcnRzLmFkZEV2ZW50ID0gYWRkRXZlbnQ7CiAgICAgICAgZXhwb3J0cy5yZW1vdmVFdmVudCA9IHJlbW92ZUV2ZW50OwogICAgICAgIGV4cG9ydHMuaXNOb2RlQWZ0ZXIgPSBpc05vZGVBZnRlcjsKCiAgICAgICAgdmFyIF9kb2N1bWVudCA9IF9kZXJlcV8oMik7CgogICAgICAgIHZhciBfZG9jdW1lbnQyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfZG9jdW1lbnQpOwoKICAgICAgICB2YXIgX21lanMgPSBfZGVyZXFfKDYpOwoKICAgICAgICB2YXIgX21lanMyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfbWVqcyk7CgogICAgICAgIGZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7CiAgICAgICAgICAgIHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ZGVmYXVsdDogb2JqfTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50TmFtZQogICAgICAgICAqIEBwYXJhbSB7Kn0gdGFyZ2V0CiAgICAgICAgICogQHJldHVybiB7RXZlbnR8T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50KGV2ZW50TmFtZSwgdGFyZ2V0KSB7CgogICAgICAgICAgICBpZiAodHlwZW9mIGV2ZW50TmFtZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXZlbnQgbmFtZSBtdXN0IGJlIGEgc3RyaW5nJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBldmVudCA9IHZvaWQgMDsKCiAgICAgICAgICAgIGlmIChfZG9jdW1lbnQyLmRlZmF1bHQuY3JlYXRlRXZlbnQpIHsKICAgICAgICAgICAgICAgIGV2ZW50ID0gX2RvY3VtZW50Mi5kZWZhdWx0LmNyZWF0ZUV2ZW50KCdFdmVudCcpOwogICAgICAgICAgICAgICAgZXZlbnQuaW5pdEV2ZW50KGV2ZW50TmFtZSwgdHJ1ZSwgZmFsc2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXZlbnQgPSB7fTsKICAgICAgICAgICAgICAgIGV2ZW50LnR5cGUgPSBldmVudE5hbWU7CiAgICAgICAgICAgICAgICBldmVudC50YXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICAgICAgICBldmVudC5jYW5jZWxlYWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBldmVudC5idWJiYWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZXZlbnQ7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuCiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnQob2JqLCB0eXBlLCBmbikgewogICAgICAgICAgICBpZiAob2JqLmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgIG9iai5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZuLCBmYWxzZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAob2JqLmF0dGFjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICBvYmpbJ2UnICsgdHlwZSArIGZuXSA9IGZuOwogICAgICAgICAgICAgICAgb2JqWycnICsgdHlwZSArIGZuXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBvYmpbJ2UnICsgdHlwZSArIGZuXSh3aW5kb3cuZXZlbnQpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIG9iai5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgb2JqWycnICsgdHlwZSArIGZuXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9iagogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiByZW1vdmVFdmVudChvYmosIHR5cGUsIGZuKSB7CgogICAgICAgICAgICBpZiAob2JqLnJlbW92ZUV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgIG9iai5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGZuLCBmYWxzZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAob2JqLmRldGFjaEV2ZW50KSB7CiAgICAgICAgICAgICAgICBvYmouZGV0YWNoRXZlbnQoJ29uJyArIHR5cGUsIG9ialsnJyArIHR5cGUgKyBmbl0pOwogICAgICAgICAgICAgICAgb2JqWycnICsgdHlwZSArIGZuXSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0YXJnZXROb2RlIGFwcGVhcnMgYWZ0ZXIgc291cmNlTm9kZSBpbiB0aGUgZG9tLgogICAgICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IHNvdXJjZU5vZGUgLSB0aGUgc291cmNlIG5vZGUgZm9yIGNvbXBhcmlzb24KICAgICAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSB0YXJnZXROb2RlIC0gdGhlIG5vZGUgdG8gY29tcGFyZSBhZ2FpbnN0IHNvdXJjZU5vZGUKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBpc05vZGVBZnRlcihzb3VyY2VOb2RlLCB0YXJnZXROb2RlKSB7CiAgICAgICAgICAgIHJldHVybiAhIShzb3VyY2VOb2RlICYmIHRhcmdldE5vZGUgJiYgc291cmNlTm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbih0YXJnZXROb2RlKSAmJiBOb2RlLkRPQ1VNRU5UX1BPU0lUSU9OX1BSRUNFRElORyk7CiAgICAgICAgfQoKICAgICAgICBfbWVqczIuZGVmYXVsdC5VdGlscyA9IF9tZWpzMi5kZWZhdWx0LlV0aWxzIHx8IHt9OwogICAgICAgIF9tZWpzMi5kZWZhdWx0LlV0aWxzLmNyZWF0ZUV2ZW50ID0gY3JlYXRlRXZlbnQ7CiAgICAgICAgX21lanMyLmRlZmF1bHQuVXRpbHMucmVtb3ZlRXZlbnQgPSByZW1vdmVFdmVudDsKICAgICAgICBfbWVqczIuZGVmYXVsdC5VdGlscy5pc05vZGVBZnRlciA9IGlzTm9kZUFmdGVyOwoKICAgIH0sIHsiMiI6IDIsICI2IjogNn1dLAogICAgMjk6IFtmdW5jdGlvbiAoX2RlcmVxXywgbW9kdWxlLCBleHBvcnRzKSB7CiAgICAgICAgCgogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsKICAgICAgICAgICAgdmFsdWU6IHRydWUKICAgICAgICB9KTsKICAgICAgICBleHBvcnRzLmVzY2FwZUhUTUwgPSBlc2NhcGVIVE1MOwogICAgICAgIGV4cG9ydHMuZGVib3VuY2UgPSBkZWJvdW5jZTsKICAgICAgICBleHBvcnRzLmlzT2JqZWN0RW1wdHkgPSBpc09iamVjdEVtcHR5OwogICAgICAgIGV4cG9ydHMuc3BsaXRFdmVudHMgPSBzcGxpdEV2ZW50czsKICAgICAgICBleHBvcnRzLmdldEVsZW1lbnRzQnlDbGFzc05hbWUgPSBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lOwoKICAgICAgICB2YXIgX2RvY3VtZW50ID0gX2RlcmVxXygyKTsKCiAgICAgICAgdmFyIF9kb2N1bWVudDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9kb2N1bWVudCk7CgogICAgICAgIHZhciBfbWVqcyA9IF9kZXJlcV8oNik7CgogICAgICAgIHZhciBfbWVqczIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KF9tZWpzKTsKCiAgICAgICAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHtkZWZhdWx0OiBvYmp9OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gaW5wdXQKICAgICAgICAgKiBAcmV0dXJuIHtzdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZXNjYXBlSFRNTChpbnB1dCkgewoKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQXJndW1lbnQgcGFzc2VkIG11c3QgYmUgYSBzdHJpbmcnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG1hcCA9IHsKICAgICAgICAgICAgICAgICcmJzogJyZhbXA7JywKICAgICAgICAgICAgICAgICc8JzogJyZsdDsnLAogICAgICAgICAgICAgICAgJz4nOiAnJmd0OycsCiAgICAgICAgICAgICAgICAnIic6ICcmcXVvdDsnCiAgICAgICAgICAgIH07CgogICAgICAgICAgICByZXR1cm4gaW5wdXQucmVwbGFjZSgvWyY8PiJdL2csIGZ1bmN0aW9uIChjKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWFwW2NdOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgovLyB0YWtlbiBmcm9tIHVuZGVyc2NvcmUKICAgICAgICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCB3YWl0KSB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXMsCiAgICAgICAgICAgICAgICBfYXJndW1lbnRzID0gYXJndW1lbnRzOwoKICAgICAgICAgICAgdmFyIGltbWVkaWF0ZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogZmFsc2U7CgoKICAgICAgICAgICAgaWYgKHR5cGVvZiBmdW5jICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZW9mIHdhaXQgIT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NlY29uZCBhcmd1bWVudCBtdXN0IGJlIGEgbnVtZXJpYyB2YWx1ZScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgdGltZW91dCA9IHZvaWQgMDsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gX3RoaXMsCiAgICAgICAgICAgICAgICAgICAgYXJncyA9IF9hcmd1bWVudHM7CiAgICAgICAgICAgICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbiBsYXRlcigpIHsKICAgICAgICAgICAgICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAoIWltbWVkaWF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB2YXIgY2FsbE5vdyA9IGltbWVkaWF0ZSAmJiAhdGltZW91dDsKICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICAgICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKCiAgICAgICAgICAgICAgICBpZiAoY2FsbE5vdykgewogICAgICAgICAgICAgICAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBEZXRlcm1pbmUgaWYgYW4gb2JqZWN0IGNvbnRhaW5zIGFueSBlbGVtZW50cwogICAgICAgICAqCiAgICAgICAgICogQHNlZSBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzY3OTkxNS9ob3ctZG8taS10ZXN0LWZvci1hbi1lbXB0eS1qYXZhc2NyaXB0LW9iamVjdAogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBpbnN0YW5jZQogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gaXNPYmplY3RFbXB0eShpbnN0YW5jZSkgewogICAgICAgICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoaW5zdGFuY2UpLmxlbmd0aCA8PSAwOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gc3BsaXRFdmVudHMoZXZlbnRzLCBpZCkgewogICAgICAgICAgICB2YXIgcndpbmRvdyA9IC9eKChhZnRlcnxiZWZvcmUpcHJpbnR8KGJlZm9yZSk/dW5sb2FkfGhhc2hjaGFuZ2V8bWVzc2FnZXxvKGZmfG4pbGluZXxwYWdlKGhpZGV8c2hvdyl8cG9wc3RhdGV8cmVzaXplfHN0b3JhZ2UpXGIvOwogICAgICAgICAgICAvLyBhZGQgcGxheWVyIElEIGFzIGFuIGV2ZW50IG5hbWVzcGFjZSBzbyBpdCdzIGVhc2llciB0byB1bmJpbmQgdGhlbSBhbGwgbGF0ZXIKICAgICAgICAgICAgdmFyIHJldCA9IHtkOiBbXSwgdzogW119OwogICAgICAgICAgICAoZXZlbnRzIHx8ICcnKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24gKHYpIHsKICAgICAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSB2ICsgJy4nICsgaWQ7CgogICAgICAgICAgICAgICAgaWYgKGV2ZW50TmFtZS5zdGFydHNXaXRoKCcuJykpIHsKICAgICAgICAgICAgICAgICAgICByZXQuZC5wdXNoKGV2ZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0LncucHVzaChldmVudE5hbWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXRbcndpbmRvdy50ZXN0KHYpID8gJ3cnIDogJ2QnXS5wdXNoKGV2ZW50TmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgcmV0LmQgPSByZXQuZC5qb2luKCcgJyk7CiAgICAgICAgICAgIHJldC53ID0gcmV0Lncuam9pbignICcpOwogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gY2xhc3NOYW1lCiAgICAgICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gbm9kZQogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0YWcKICAgICAgICAgKiBAcmV0dXJuIHtIVE1MRWxlbWVudFtdfQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NOYW1lLCBub2RlLCB0YWcpIHsKCiAgICAgICAgICAgIGlmIChub2RlID09PSB1bmRlZmluZWQgfHwgbm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZSA9IF9kb2N1bWVudDIuZGVmYXVsdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICE9PSB1bmRlZmluZWQgJiYgbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gdW5kZWZpbmVkIHx8IHRhZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGFnID0gJyonOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgY2xhc3NFbGVtZW50cyA9IFtdLAogICAgICAgICAgICAgICAgaiA9IDAsCiAgICAgICAgICAgICAgICB0ZXN0c3RyID0gdm9pZCAwLAogICAgICAgICAgICAgICAgZWxzID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpLAogICAgICAgICAgICAgICAgZWxzTGVuID0gZWxzLmxlbmd0aDsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxzTGVuOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChlbHNbaV0uY2xhc3NOYW1lLmluZGV4T2YoY2xhc3NOYW1lKSA+IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdGVzdHN0ciA9ICcsJyArIGVsc1tpXS5jbGFzc05hbWUuc3BsaXQoJyAnKS5qb2luKCcsJykgKyAnLCc7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRlc3RzdHIuaW5kZXhPZignLCcgKyBjbGFzc05hbWUgKyAnLCcpID4gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NFbGVtZW50c1tqXSA9IGVsc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgaisrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGNsYXNzRWxlbWVudHM7CiAgICAgICAgfQoKICAgICAgICBfbWVqczIuZGVmYXVsdC5VdGlscyA9IF9tZWpzMi5kZWZhdWx0LlV0aWxzIHx8IHt9OwogICAgICAgIF9tZWpzMi5kZWZhdWx0LlV0aWxzLmVzY2FwZUhUTUwgPSBlc2NhcGVIVE1MOwogICAgICAgIF9tZWpzMi5kZWZhdWx0LlV0aWxzLmRlYm91bmNlID0gZGVib3VuY2U7CiAgICAgICAgX21lanMyLmRlZmF1bHQuVXRpbHMuaXNPYmplY3RFbXB0eSA9IGlzT2JqZWN0RW1wdHk7CiAgICAgICAgX21lanMyLmRlZmF1bHQuVXRpbHMuc3BsaXRFdmVudHMgPSBzcGxpdEV2ZW50czsKICAgICAgICBfbWVqczIuZGVmYXVsdC5VdGlscy5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lID0gZ2V0RWxlbWVudHNCeUNsYXNzTmFtZTsKCiAgICB9LCB7IjIiOiAyLCAiNiI6IDZ9XSwKICAgIDMwOiBbZnVuY3Rpb24gKF9kZXJlcV8sIG1vZHVsZSwgZXhwb3J0cykgewogICAgICAgIAoKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgIl9fZXNNb2R1bGUiLCB7CiAgICAgICAgICAgIHZhbHVlOiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgZXhwb3J0cy50eXBlQ2hlY2tzID0gdW5kZWZpbmVkOwogICAgICAgIGV4cG9ydHMuYWJzb2x1dGl6ZVVybCA9IGFic29sdXRpemVVcmw7CiAgICAgICAgZXhwb3J0cy5mb3JtYXRUeXBlID0gZm9ybWF0VHlwZTsKICAgICAgICBleHBvcnRzLmdldE1pbWVGcm9tVHlwZSA9IGdldE1pbWVGcm9tVHlwZTsKICAgICAgICBleHBvcnRzLmdldFR5cGVGcm9tRmlsZSA9IGdldFR5cGVGcm9tRmlsZTsKICAgICAgICBleHBvcnRzLmdldEV4dGVuc2lvbiA9IGdldEV4dGVuc2lvbjsKICAgICAgICBleHBvcnRzLm5vcm1hbGl6ZUV4dGVuc2lvbiA9IG5vcm1hbGl6ZUV4dGVuc2lvbjsKCiAgICAgICAgdmFyIF9tZWpzID0gX2RlcmVxXyg2KTsKCiAgICAgICAgdmFyIF9tZWpzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX21lanMpOwoKICAgICAgICB2YXIgX2dlbmVyYWwgPSBfZGVyZXFfKDI5KTsKCiAgICAgICAgZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHtkZWZhdWx0OiBvYmp9OwogICAgICAgIH0KCiAgICAgICAgdmFyIHR5cGVDaGVja3MgPSBleHBvcnRzLnR5cGVDaGVja3MgPSBbXTsKCiAgICAgICAgLyoqCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsCiAgICAgICAgICogQHJldHVybiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGFic29sdXRpemVVcmwodXJsKSB7CgogICAgICAgICAgICBpZiAodHlwZW9mIHVybCAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYHVybGAgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZycpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgZWwuaW5uZXJIVE1MID0gJzxhIGhyZWY9IicgKyAoMCwgX2dlbmVyYWwuZXNjYXBlSFRNTCkodXJsKSArICciPng8L2E+JzsKICAgICAgICAgICAgcmV0dXJuIGVsLmZpcnN0Q2hpbGQuaHJlZjsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEdldCB0aGUgZm9ybWF0IG9mIGEgc3BlY2lmaWMgbWVkaWEsIGJhc2VkIG9uIFVSTCBhbmQgYWRkaXRpb25hbGx5IGl0cyBtaW1lIHR5cGUKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdHlwZQogICAgICAgICAqIEByZXR1cm4ge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBmb3JtYXRUeXBlKHVybCkgewogICAgICAgICAgICB2YXIgdHlwZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogJyc7CgogICAgICAgICAgICByZXR1cm4gdXJsICYmICF0eXBlID8gZ2V0VHlwZUZyb21GaWxlKHVybCkgOiBnZXRNaW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm4gdGhlIG1pbWUgcGFydCBvZiB0aGUgdHlwZSBpbiBjYXNlIHRoZSBhdHRyaWJ1dGUgY29udGFpbnMgdGhlIGNvZGVjCiAgICAgICAgICogKGB2aWRlby9tcDQ7IGNvZGVjcz0iYXZjMS40MkUwMUUsIG1wNGEuNDAuMiJgIGJlY29tZXMgYHZpZGVvL21wNGApCiAgICAgICAgICoKICAgICAgICAgKiBAc2VlIGh0dHA6Ly93d3cud2hhdHdnLm9yZy9zcGVjcy93ZWItYXBwcy9jdXJyZW50LXdvcmsvbXVsdGlwYWdlL3ZpZGVvLmh0bWwjdGhlLXNvdXJjZS1lbGVtZW50CiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAgICAgKiBAcmV0dXJuIHtTdHJpbmd9CiAgICAgICAgICovCiAgICAgICAgZnVuY3Rpb24gZ2V0TWltZUZyb21UeXBlKHR5cGUpIHsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYHR5cGVgIGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHR5cGUgJiYgfnR5cGUuaW5kZXhPZignOycpID8gdHlwZS5zdWJzdHIoMCwgdHlwZS5pbmRleE9mKCc7JykpIDogdHlwZTsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEdldCB0aGUgdHlwZSBvZiBtZWRpYSBiYXNlZCBvbiBVUkwgc3RydWN0dXJlCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsCiAgICAgICAgICogQHJldHVybiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIGdldFR5cGVGcm9tRmlsZSh1cmwpIHsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdgdXJsYCBhcmd1bWVudCBtdXN0IGJlIGEgc3RyaW5nJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciB0eXBlID0gdm9pZCAwOwoKICAgICAgICAgICAgLy8gVmFsaWRhdGUgYHR5cGVDaGVja3NgIGFycmF5CiAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh0eXBlQ2hlY2tzKSkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdgdHlwZUNoZWNrc2AgbXVzdCBiZSBhbiBhcnJheScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZUNoZWNrcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCB0b3RhbCA9IHR5cGVDaGVja3MubGVuZ3RoOyBpIDwgdG90YWw7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBfdHlwZSA9IHR5cGVDaGVja3NbaV07CgogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgX3R5cGUgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFbGVtZW50IGluIGFycmF5IG11c3QgYmUgYSBmdW5jdGlvbicpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gZG8gdHlwZSBjaGVja3MgZmlyc3QKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwLCBfdG90YWwgPSB0eXBlQ2hlY2tzLmxlbmd0aDsgX2kgPCBfdG90YWw7IF9pKyspIHsKCiAgICAgICAgICAgICAgICB0eXBlID0gdHlwZUNoZWNrc1tfaV0odXJsKTsKCiAgICAgICAgICAgICAgICBpZiAodHlwZSAhPT0gdW5kZWZpbmVkICYmIHR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gdGhlIGRvIHN0YW5kYXJkIGV4dGVuc2lvbiBjaGVjawogICAgICAgICAgICB2YXIgZXh0ID0gZ2V0RXh0ZW5zaW9uKHVybCksCiAgICAgICAgICAgICAgICBub3JtYWxpemVkRXh0ID0gbm9ybWFsaXplRXh0ZW5zaW9uKGV4dCk7CgogICAgICAgICAgICByZXR1cm4gKC8obXA0fG00dnxvZ2d8b2d2fHdlYm18d2VibXZ8Zmx2fHdtdnxtcGVnfG1vdikvZ2kudGVzdChleHQpID8gJ3ZpZGVvJyA6ICdhdWRpbycpICsgJy8nICsgbm9ybWFsaXplZEV4dDsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIEdldCBtZWRpYSBmaWxlIGV4dGVuc2lvbiBmcm9tIFVSTAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVybAogICAgICAgICAqIEByZXR1cm4ge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBnZXRFeHRlbnNpb24odXJsKSB7CgogICAgICAgICAgICBpZiAodHlwZW9mIHVybCAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYHVybGAgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZycpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgYmFzZVVybCA9IHVybC5zcGxpdCgnPycpWzBdOwoKICAgICAgICAgICAgcmV0dXJuIH5iYXNlVXJsLmluZGV4T2YoJy4nKSA/IGJhc2VVcmwuc3Vic3RyaW5nKGJhc2VVcmwubGFzdEluZGV4T2YoJy4nKSArIDEpIDogJyc7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBHZXQgc3RhbmRhcmQgZXh0ZW5zaW9uIG9mIGEgbWVkaWEgZmlsZQogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV4dGVuc2lvbgogICAgICAgICAqIEByZXR1cm4ge1N0cmluZ30KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBub3JtYWxpemVFeHRlbnNpb24oZXh0ZW5zaW9uKSB7CgogICAgICAgICAgICBpZiAodHlwZW9mIGV4dGVuc2lvbiAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignYGV4dGVuc2lvbmAgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZycpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzd2l0Y2ggKGV4dGVuc2lvbikgewogICAgICAgICAgICAgICAgY2FzZSAnbXA0JzoKICAgICAgICAgICAgICAgIGNhc2UgJ200dic6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdtcDQnOwogICAgICAgICAgICAgICAgY2FzZSAnd2VibSc6CiAgICAgICAgICAgICAgICBjYXNlICd3ZWJtYSc6CiAgICAgICAgICAgICAgICBjYXNlICd3ZWJtdic6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd3ZWJtJzsKICAgICAgICAgICAgICAgIGNhc2UgJ29nZyc6CiAgICAgICAgICAgICAgICBjYXNlICdvZ2EnOgogICAgICAgICAgICAgICAgY2FzZSAnb2d2JzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ29nZyc7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHJldHVybiBleHRlbnNpb247CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIF9tZWpzMi5kZWZhdWx0LlV0aWxzID0gX21lanMyLmRlZmF1bHQuVXRpbHMgfHwge307CiAgICAgICAgX21lanMyLmRlZmF1bHQuVXRpbHMuYWJzb2x1dGl6ZVVybCA9IGFic29sdXRpemVVcmw7CiAgICAgICAgX21lanMyLmRlZmF1bHQuVXRpbHMuZm9ybWF0VHlwZSA9IGZvcm1hdFR5cGU7CiAgICAgICAgX21lanMyLmRlZmF1bHQuVXRpbHMuZ2V0TWltZUZyb21UeXBlID0gZ2V0TWltZUZyb21UeXBlOwogICAgICAgIF9tZWpzMi5kZWZhdWx0LlV0aWxzLmdldFR5cGVGcm9tRmlsZSA9IGdldFR5cGVGcm9tRmlsZTsKICAgICAgICBfbWVqczIuZGVmYXVsdC5VdGlscy5nZXRFeHRlbnNpb24gPSBnZXRFeHRlbnNpb247CiAgICAgICAgX21lanMyLmRlZmF1bHQuVXRpbHMubm9ybWFsaXplRXh0ZW5zaW9uID0gbm9ybWFsaXplRXh0ZW5zaW9uOwoKICAgIH0sIHsiMjkiOiAyOSwgIjYiOiA2fV0sCiAgICAzMTogW2Z1bmN0aW9uIChfZGVyZXFfLCBtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAKCiAgICAgICAgdmFyIF9kb2N1bWVudCA9IF9kZXJlcV8oMik7CgogICAgICAgIHZhciBfZG9jdW1lbnQyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChfZG9jdW1lbnQpOwoKICAgICAgICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDoge2RlZmF1bHQ6IG9ian07CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBQb2x5ZmlsbAogICAgICAgICAqCiAgICAgICAgICogTWltaWNzIHRoZSBtaXNzaW5nIG1ldGhvZHMgbGlrZSBPYmplY3QuYXNzaWduLCBBcnJheS5pbmNsdWRlcywgZXRjLiwgYXMgYSB3YXkgdG8gYXZvaWQgaW5jbHVkaW5nIHRoZSB3aG9sZSBsaXN0CiAgICAgICAgICogb2YgcG9seWZpbGxzIHByb3ZpZGVkIGJ5IEJhYmVsLgogICAgICAgICAqLwoKLy8gSUU2LDcsOAovLyBQcm9kdWN0aW9uIHN0ZXBzIG9mIEVDTUEtMjYyLCBFZGl0aW9uIDUsIDE1LjQuNC4xNAovLyBSZWZlcmVuY2U6IGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4MTUuNC40LjE0CiAgICAgICAgaWYgKCFBcnJheS5wcm90b3R5cGUuaW5kZXhPZikgewogICAgICAgICAgICBBcnJheS5wcm90b3R5cGUuaW5kZXhPZiA9IGZ1bmN0aW9uIChzZWFyY2hFbGVtZW50LCBmcm9tSW5kZXgpIHsKCiAgICAgICAgICAgICAgICB2YXIgayA9IHZvaWQgMDsKCiAgICAgICAgICAgICAgICAvLyAxLiBMZXQgTyBiZSB0aGUgcmVzdWx0IG9mIGNhbGxpbmcgVG9PYmplY3QgcGFzc2luZwogICAgICAgICAgICAgICAgLy8JICAgdGhlIHRoaXMgdmFsdWUgYXMgdGhlIGFyZ3VtZW50LgogICAgICAgICAgICAgICAgaWYgKHVuZGVmaW5lZCA9PT0gdW5kZWZpbmVkIHx8IHVuZGVmaW5lZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJ0aGlzIiBpcyBudWxsIG9yIG5vdCBkZWZpbmVkJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIE8gPSBPYmplY3QodW5kZWZpbmVkKTsKCiAgICAgICAgICAgICAgICAvLyAyLiBMZXQgbGVuVmFsdWUgYmUgdGhlIHJlc3VsdCBvZiBjYWxsaW5nIHRoZSBHZXQKICAgICAgICAgICAgICAgIC8vCSAgIGludGVybmFsIG1ldGhvZCBvZiBPIHdpdGggdGhlIGFyZ3VtZW50ICJsZW5ndGgiLgogICAgICAgICAgICAgICAgLy8gMy4gTGV0IGxlbiBiZSBUb1VpbnQzMihsZW5WYWx1ZSkuCiAgICAgICAgICAgICAgICB2YXIgbGVuID0gTy5sZW5ndGggPj4+IDA7CgogICAgICAgICAgICAgICAgLy8gNC4gSWYgbGVuIGlzIDAsIHJldHVybiAtMS4KICAgICAgICAgICAgICAgIGlmIChsZW4gPT09IDApIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNS4gSWYgYXJndW1lbnQgZnJvbUluZGV4IHdhcyBwYXNzZWQgbGV0IG4gYmUKICAgICAgICAgICAgICAgIC8vCSAgIFRvSW50ZWdlcihmcm9tSW5kZXgpOyBlbHNlIGxldCBuIGJlIDAuCiAgICAgICAgICAgICAgICB2YXIgbiA9ICtmcm9tSW5kZXggfHwgMDsKCiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMobikgPT09IEluZmluaXR5KSB7CiAgICAgICAgICAgICAgICAgICAgbiA9IDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gNi4gSWYgbiA+PSBsZW4sIHJldHVybiAtMS4KICAgICAgICAgICAgICAgIGlmIChuID49IGxlbikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyA3LiBJZiBuID49IDAsIHRoZW4gTGV0IGsgYmUgbi4KICAgICAgICAgICAgICAgIC8vIDguIEVsc2UsIG48MCwgTGV0IGsgYmUgbGVuIC0gYWJzKG4pLgogICAgICAgICAgICAgICAgLy8JICAgSWYgayBpcyBsZXNzIHRoYW4gMCwgdGhlbiBsZXQgayBiZSAwLgogICAgICAgICAgICAgICAgayA9IE1hdGgubWF4KG4gPj0gMCA/IG4gOiBsZW4gLSBNYXRoLmFicyhuKSwgMCk7CgogICAgICAgICAgICAgICAgLy8gOS4gUmVwZWF0LCB3aGlsZSBrIDwgbGVuCiAgICAgICAgICAgICAgICB3aGlsZSAoayA8IGxlbikgewogICAgICAgICAgICAgICAgICAgIC8vIGEuIExldCBQayBiZSBUb1N0cmluZyhrKS4KICAgICAgICAgICAgICAgICAgICAvLyAgIFRoaXMgaXMgaW1wbGljaXQgZm9yIExIUyBvcGVyYW5kcyBvZiB0aGUgaW4gb3BlcmF0b3IKICAgICAgICAgICAgICAgICAgICAvLyBiLiBMZXQga1ByZXNlbnQgYmUgdGhlIHJlc3VsdCBvZiBjYWxsaW5nIHRoZQogICAgICAgICAgICAgICAgICAgIC8vCUhhc1Byb3BlcnR5IGludGVybmFsIG1ldGhvZCBvZiBPIHdpdGggYXJndW1lbnQgUGsuCiAgICAgICAgICAgICAgICAgICAgLy8gICBUaGlzIHN0ZXAgY2FuIGJlIGNvbWJpbmVkIHdpdGggYwogICAgICAgICAgICAgICAgICAgIC8vIGMuIElmIGtQcmVzZW50IGlzIHRydWUsIHRoZW4KICAgICAgICAgICAgICAgICAgICAvLwlpLglMZXQgZWxlbWVudEsgYmUgdGhlIHJlc3VsdCBvZiBjYWxsaW5nIHRoZSBHZXQKICAgICAgICAgICAgICAgICAgICAvLwkJaW50ZXJuYWwgbWV0aG9kIG9mIE8gd2l0aCB0aGUgYXJndW1lbnQgVG9TdHJpbmcoaykuCiAgICAgICAgICAgICAgICAgICAgLy8gICBpaS4JTGV0IHNhbWUgYmUgdGhlIHJlc3VsdCBvZiBhcHBseWluZyB0aGUKICAgICAgICAgICAgICAgICAgICAvLwkJU3RyaWN0IEVxdWFsaXR5IENvbXBhcmlzb24gQWxnb3JpdGhtIHRvCiAgICAgICAgICAgICAgICAgICAgLy8JCXNlYXJjaEVsZW1lbnQgYW5kIGVsZW1lbnRLLgogICAgICAgICAgICAgICAgICAgIC8vICBpaWkuCUlmIHNhbWUgaXMgdHJ1ZSwgcmV0dXJuIGsuCiAgICAgICAgICAgICAgICAgICAgaWYgKGsgaW4gTyAmJiBPW2tdID09PSBzZWFyY2hFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBrKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKLy8gZG9jdW1lbnQuY3JlYXRlRXZlbnQgZm9yIElFOCBvciBvdGhlciBvbGQgYnJvd3NlcnMgdGhhdCBkbyBub3QgaW1wbGVtZW50IGl0Ci8vIFJlZmVyZW5jZTogaHR0cHM6Ly9naXRodWIuY29tL1dlYlJlZmxlY3Rpb24vaWU4L2Jsb2IvbWFzdGVyL2J1aWxkL2llOC5tYXguanMKICAgICAgICBpZiAoX2RvY3VtZW50Mi5kZWZhdWx0LmNyZWF0ZUV2ZW50ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgX2RvY3VtZW50Mi5kZWZhdWx0LmNyZWF0ZUV2ZW50ID0gZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgIHZhciBlID0gdm9pZCAwOwoKICAgICAgICAgICAgICAgIGUgPSBfZG9jdW1lbnQyLmRlZmF1bHQuY3JlYXRlRXZlbnRPYmplY3QoKTsKICAgICAgICAgICAgICAgIGUudGltZVN0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgICAgICAgICBlLmVudW1lcmFibGUgPSB0cnVlOwogICAgICAgICAgICAgICAgZS53cml0YWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBlLmNvbmZpZ3VyYWJsZSA9IHRydWU7CgogICAgICAgICAgICAgICAgZS5pbml0RXZlbnQgPSBmdW5jdGlvbiAodHlwZSwgYnViYmxlcywgY2FuY2VsYWJsZSkgewogICAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZC50eXBlID0gdHlwZTsKICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQuYnViYmxlcyA9ICEhYnViYmxlczsKICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQuY2FuY2VsYWJsZSA9ICEhY2FuY2VsYWJsZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXVuZGVmaW5lZC5idWJibGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZC5zdG9wUHJvcGFnYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmRlZmluZWQuc3RvcHBlZFByb3BhZ2F0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVmaW5lZC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgcmV0dXJuIGU7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKLy8gT2JqZWN0LmFzc2lnbiBwb2x5ZmlsbAovLyBSZWZlcmVuY2U6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL09iamVjdC9hc3NpZ24jUG9seWZpbGwKICAgICAgICBpZiAodHlwZW9mIE9iamVjdC5hc3NpZ24gIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgT2JqZWN0LmFzc2lnbiA9IGZ1bmN0aW9uICh0YXJnZXQsIHZhckFyZ3MpIHsKICAgICAgICAgICAgICAgIC8vIC5sZW5ndGggb2YgZnVuY3Rpb24gaXMgMgoKICAgICAgICAgICAgICAgIAoKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQgPT09IG51bGwgfHwgdGFyZ2V0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAvLyBUeXBlRXJyb3IgaWYgdW5kZWZpbmVkIG9yIG51bGwKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY29udmVydCB1bmRlZmluZWQgb3IgbnVsbCB0byBvYmplY3QnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgdG8gPSBPYmplY3QodGFyZ2V0KTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpbmRleCA9IDE7IGluZGV4IDwgYXJndW1lbnRzLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBuZXh0U291cmNlID0gYXJndW1lbnRzW2luZGV4XTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRTb3VyY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2tpcCBvdmVyIGlmIHVuZGVmaW5lZCBvciBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG5leHRLZXkgaW4gbmV4dFNvdXJjZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQXZvaWQgYnVncyB3aGVuIGhhc093blByb3BlcnR5IGlzIHNoYWRvd2VkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG5leHRTb3VyY2UsIG5leHRLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9bbmV4dEtleV0gPSBuZXh0U291cmNlW25leHRLZXldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRvOwogICAgICAgICAgICB9OwogICAgICAgIH0KCi8vIEFycmF5LmluY2x1ZGVzIHBvbHlmaWxsCi8vIFJlZmVyZW5jZTogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvQXJyYXkvaW5jbHVkZXMjUG9seWZpbGwKICAgICAgICBpZiAoIUFycmF5LnByb3RvdHlwZS5pbmNsdWRlcykgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQXJyYXkucHJvdG90eXBlLCAnaW5jbHVkZXMnLCB7CiAgICAgICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoc2VhcmNoRWxlbWVudCwgZnJvbUluZGV4KSB7CgogICAgICAgICAgICAgICAgICAgIC8vIDEuIExldCBPIGJlID8gVG9PYmplY3QodGhpcyB2YWx1ZSkuCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMgPT09IG51bGwgfHwgdGhpcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJyJ0aGlzIiBpcyBudWxsIG9yIG5vdCBkZWZpbmVkJyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgbyA9IE9iamVjdCh0aGlzKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gMi4gTGV0IGxlbiBiZSA/IFRvTGVuZ3RoKD8gR2V0KE8sICJsZW5ndGgiKSkuCiAgICAgICAgICAgICAgICAgICAgdmFyIGxlbiA9IG8ubGVuZ3RoID4+PiAwOwoKICAgICAgICAgICAgICAgICAgICAvLyAzLiBJZiBsZW4gaXMgMCwgcmV0dXJuIGZhbHNlLgogICAgICAgICAgICAgICAgICAgIGlmIChsZW4gPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gNC4gTGV0IG4gYmUgPyBUb0ludGVnZXIoZnJvbUluZGV4KS4KICAgICAgICAgICAgICAgICAgICAvLyAgICAoSWYgZnJvbUluZGV4IGlzIHVuZGVmaW5lZCwgdGhpcyBzdGVwIHByb2R1Y2VzIHRoZSB2YWx1ZSAwLikKICAgICAgICAgICAgICAgICAgICB2YXIgbiA9IGZyb21JbmRleCB8IDA7CgogICAgICAgICAgICAgICAgICAgIC8vIDUuIElmIG4g4omlIDAsIHRoZW4KICAgICAgICAgICAgICAgICAgICAvLyAgYS4gTGV0IGsgYmUgbi4KICAgICAgICAgICAgICAgICAgICAvLyA2LiBFbHNlIG4gPCAwLAogICAgICAgICAgICAgICAgICAgIC8vICBhLiBMZXQgayBiZSBsZW4gKyBuLgogICAgICAgICAgICAgICAgICAgIC8vICBiLiBJZiBrIDwgMCwgbGV0IGsgYmUgMC4KICAgICAgICAgICAgICAgICAgICB2YXIgayA9IE1hdGgubWF4KG4gPj0gMCA/IG4gOiBsZW4gLSBNYXRoLmFicyhuKSwgMCk7CgogICAgICAgICAgICAgICAgICAgIC8vIDcuIFJlcGVhdCwgd2hpbGUgayA8IGxlbgogICAgICAgICAgICAgICAgICAgIHdoaWxlIChrIDwgbGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGEuIExldCBlbGVtZW50SyBiZSB0aGUgcmVzdWx0IG9mID8gR2V0KE8sICEgVG9TdHJpbmcoaykpLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBiLiBJZiBTYW1lVmFsdWVaZXJvKHNlYXJjaEVsZW1lbnQsIGVsZW1lbnRLKSBpcyB0cnVlLCByZXR1cm4gdHJ1ZS4KICAgICAgICAgICAgICAgICAgICAgICAgLy8gYy4gSW5jcmVhc2UgayBieSAxLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBOT1RFOiA9PT0gcHJvdmlkZXMgdGhlIGNvcnJlY3QgIlNhbWVWYWx1ZVplcm8iIGNvbXBhcmlzb24gbmVlZGVkIGhlcmUuCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvW2tdID09PSBzZWFyY2hFbGVtZW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBrKys7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyA4LiBSZXR1cm4gZmFsc2UKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFTdHJpbmcucHJvdG90eXBlLmluY2x1ZGVzKSB7CiAgICAgICAgICAgIFN0cmluZy5wcm90b3R5cGUuaW5jbHVkZXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLnByb3RvdHlwZS5pbmRleE9mLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgIT09IC0xOwogICAgICAgICAgICB9OwogICAgICAgIH0KCi8vIFN0cmluZy5zdGFydHNXaXRoIHBvbHlmaWxsCi8vIFJlZmVyZW5jZTogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvU3RyaW5nL3N0YXJ0c1dpdGgjUG9seWZpbGwKICAgICAgICBpZiAoIVN0cmluZy5wcm90b3R5cGUuc3RhcnRzV2l0aCkgewogICAgICAgICAgICBTdHJpbmcucHJvdG90eXBlLnN0YXJ0c1dpdGggPSBmdW5jdGlvbiAoc2VhcmNoU3RyaW5nLCBwb3NpdGlvbikgewogICAgICAgICAgICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbiB8fCAwOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3Vic3RyKHBvc2l0aW9uLCBzZWFyY2hTdHJpbmcubGVuZ3RoKSA9PT0gc2VhcmNoU3RyaW5nOwogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICB9LCB7IjIiOiAyfV0sCiAgICAzMjogW2Z1bmN0aW9uIChfZGVyZXFfLCBtb2R1bGUsIGV4cG9ydHMpIHsKICAgICAgICAKCiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogICAgICAgICAgICB2YWx1ZTogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIGV4cG9ydHMuc2Vjb25kc1RvVGltZUNvZGUgPSBzZWNvbmRzVG9UaW1lQ29kZTsKICAgICAgICBleHBvcnRzLnRpbWVDb2RlVG9TZWNvbmRzID0gdGltZUNvZGVUb1NlY29uZHM7CiAgICAgICAgZXhwb3J0cy5jYWxjdWxhdGVUaW1lRm9ybWF0ID0gY2FsY3VsYXRlVGltZUZvcm1hdDsKICAgICAgICBleHBvcnRzLmNvbnZlcnRTTVBURXRvU2Vjb25kcyA9IGNvbnZlcnRTTVBURXRvU2Vjb25kczsKCiAgICAgICAgdmFyIF9tZWpzID0gX2RlcmVxXyg2KTsKCiAgICAgICAgdmFyIF9tZWpzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQoX21lanMpOwoKICAgICAgICBmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgewogICAgICAgICAgICByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDoge2RlZmF1bHQ6IG9ian07CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBGb3JtYXQgYSBudW1lcmljIHRpbWUgaW4gZm9ybWF0ICcwMDowMDowMCcKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSB0aW1lIC0gSWRlYWxseSBhIG51bWJlciwgYnV0IGlmIG5vdCBvciBsZXNzIHRoYW4gemVybywgaXMgZGVmYXVsdGVkIHRvIHplcm8KICAgICAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IGZvcmNlSG91cnMKICAgICAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IHNob3dGcmFtZUNvdW50CiAgICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGZwcyAtIEZyYW1lcyBwZXIgc2Vjb25kCiAgICAgICAgICogQHJldHVybiB7U3RyaW5nfQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHNlY29uZHNUb1RpbWVDb2RlKHRpbWUpIHsKICAgICAgICAgICAgdmFyIGZvcmNlSG91cnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IGZhbHNlOwogICAgICAgICAgICB2YXIgc2hvd0ZyYW1lQ291bnQgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1syXSA6IGZhbHNlOwogICAgICAgICAgICB2YXIgZnBzID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbM10gOiAyNTsKCgogICAgICAgICAgICB0aW1lID0gIXRpbWUgfHwgdHlwZW9mIHRpbWUgIT09ICdudW1iZXInIHx8IHRpbWUgPCAwID8gMCA6IHRpbWU7CgogICAgICAgICAgICB2YXIgaG91cnMgPSBNYXRoLmZsb29yKHRpbWUgLyAzNjAwKSAlIDI0OwogICAgICAgICAgICB2YXIgbWludXRlcyA9IE1hdGguZmxvb3IodGltZSAvIDYwKSAlIDYwOwogICAgICAgICAgICB2YXIgc2Vjb25kcyA9IE1hdGguZmxvb3IodGltZSAlIDYwKTsKICAgICAgICAgICAgdmFyIGZyYW1lcyA9IE1hdGguZmxvb3IoKHRpbWUgJSAxICogZnBzKS50b0ZpeGVkKDMpKTsKCiAgICAgICAgICAgIGhvdXJzID0gaG91cnMgPD0gMCA/IDAgOiBob3VyczsKICAgICAgICAgICAgbWludXRlcyA9IG1pbnV0ZXMgPD0gMCA/IDAgOiBtaW51dGVzOwogICAgICAgICAgICBzZWNvbmRzID0gc2Vjb25kcyA8PSAwID8gMCA6IHNlY29uZHM7CgogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZm9yY2VIb3VycyB8fCBob3VycyA+IDAgPyAoaG91cnMgPCAxMCA/ICcwJyArIGhvdXJzIDogaG91cnMpICsgJzonIDogJyc7CiAgICAgICAgICAgIHJlc3VsdCArPSAobWludXRlcyA8IDEwID8gJzAnICsgbWludXRlcyA6IG1pbnV0ZXMpICsgJzonOwogICAgICAgICAgICByZXN1bHQgKz0gJycgKyAoc2Vjb25kcyA8IDEwID8gJzAnICsgc2Vjb25kcyA6IHNlY29uZHMpOwogICAgICAgICAgICByZXN1bHQgKz0gJycgKyAoc2hvd0ZyYW1lQ291bnQgPyAnOicgKyAoZnJhbWVzIDwgMTAgPyAnMCcgKyBmcmFtZXMgOiBmcmFtZXMpIDogJycpOwoKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqIENvbnZlcnQgYSAnMDA6MDA6MDAnIHRpbWUgc3RyaW5nIGludG8gc2Vjb25kcwogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRpbWUKICAgICAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IHNob3dGcmFtZUNvdW50CiAgICAgICAgICogQHBhcmFtIHtOdW1iZXJ9IGZwcyAtIEZyYW1lcyBwZXIgc2Vjb25kCiAgICAgICAgICogQHJldHVybiB7TnVtYmVyfQogICAgICAgICAqLwogICAgICAgIGZ1bmN0aW9uIHRpbWVDb2RlVG9TZWNvbmRzKHRpbWUpIHsKICAgICAgICAgICAgdmFyIHNob3dGcmFtZUNvdW50ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBmYWxzZTsKICAgICAgICAgICAgdmFyIGZwcyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogMjU7CgoKICAgICAgICAgICAgaWYgKHR5cGVvZiB0aW1lICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVGltZSBtdXN0IGJlIGEgc3RyaW5nJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghdGltZS5tYXRjaCgvXGR7Mn0oXDpcZHsyfSl7MCwzfS8pKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdUaW1lIGNvZGUgbXVzdCBoYXZlIHRoZSBmb3JtYXQgYDAwOjAwOjAwYCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgcGFydHMgPSB0aW1lLnNwbGl0KCc6JyksCiAgICAgICAgICAgICAgICBob3VycyA9IDAsCiAgICAgICAgICAgICAgICBtaW51dGVzID0gMCwKICAgICAgICAgICAgICAgIGZyYW1lcyA9IDAsCiAgICAgICAgICAgICAgICBzZWNvbmRzID0gMCwKICAgICAgICAgICAgICAgIG91dHB1dCA9IHZvaWQgMDsKCiAgICAgICAgICAgIHN3aXRjaCAocGFydHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICAgIHNlY29uZHMgPSBwYXJzZUludChwYXJ0c1swXSwgMTApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgIG1pbnV0ZXMgPSBwYXJzZUludChwYXJ0c1swXSwgMTApOwogICAgICAgICAgICAgICAgICAgIHNlY29uZHMgPSBwYXJzZUludChwYXJ0c1sxXSwgMTApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgICAgICAgIGhvdXJzID0gcGFyc2VJbnQocGFydHNbMF0sIDEwKTsKICAgICAgICAgICAgICAgICAgICBtaW51dGVzID0gcGFyc2VJbnQocGFydHNbMV0sIDEwKTsKICAgICAgICAgICAgICAgICAgICBzZWNvbmRzID0gcGFyc2VJbnQocGFydHNbMl0sIDEwKTsKICAgICAgICAgICAgICAgICAgICBmcmFtZXMgPSBzaG93RnJhbWVDb3VudCA/IHBhcnNlSW50KHBhcnRzWzNdKSAvIGZwcyA6IDA7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICB9CgogICAgICAgICAgICBvdXRwdXQgPSBob3VycyAqIDM2MDAgKyBtaW51dGVzICogNjAgKyBzZWNvbmRzICsgZnJhbWVzOwogICAgICAgICAgICByZXR1cm4gcGFyc2VGbG9hdChvdXRwdXQudG9GaXhlZCgzKSk7CiAgICAgICAgfQoKICAgICAgICAvKioKICAgICAgICAgKiBDYWxjdWxhdGUgdGhlIHRpbWUgZm9ybWF0IHRvIHVzZQogICAgICAgICAqCiAgICAgICAgICogVGhlcmUgaXMgYSBkZWZhdWx0IGZvcm1hdCBzZXQgaW4gdGhlIG9wdGlvbnMgYnV0IGl0IGNhbiBiZSBpbmNvbXBsZXRlLCBzbyBpdCBpcyBhZGp1c3RlZCBhY2NvcmRpbmcgdG8gdGhlIG1lZGlhCiAgICAgICAgICogZHVyYXRpb24uIEZvcm1hdDogJ2hoOm1tOnNzOmZmJwogICAgICAgICAqIEBwYXJhbSB7Kn0gdGltZSAtIElkZWFsbHkgYSBudW1iZXIsIGJ1dCBpZiBub3Qgb3IgbGVzcyB0aGFuIHplcm8sIGlzIGRlZmF1bHRlZCB0byB6ZXJvCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgICAgICAgKiBAcGFyYW0ge051bWJlcn0gZnBzIC0gRnJhbWVzIHBlciBzZWNvbmQKICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjYWxjdWxhdGVUaW1lRm9ybWF0KHRpbWUsIG9wdGlvbnMpIHsKICAgICAgICAgICAgdmFyIGZwcyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogMjU7CgoKICAgICAgICAgICAgdGltZSA9ICF0aW1lIHx8IHR5cGVvZiB0aW1lICE9PSAnbnVtYmVyJyB8fCB0aW1lIDwgMCA/IDAgOiB0aW1lOwoKICAgICAgICAgICAgdmFyIHJlcXVpcmVkID0gZmFsc2UsCiAgICAgICAgICAgICAgICBmb3JtYXQgPSBvcHRpb25zLnRpbWVGb3JtYXQsCiAgICAgICAgICAgICAgICBmaXJzdENoYXIgPSBmb3JtYXRbMF0sCiAgICAgICAgICAgICAgICBmaXJzdFR3b1BsYWNlcyA9IGZvcm1hdFsxXSA9PT0gZm9ybWF0WzBdLAogICAgICAgICAgICAgICAgc2VwYXJhdG9ySW5kZXggPSBmaXJzdFR3b1BsYWNlcyA/IDIgOiAxLAogICAgICAgICAgICAgICAgc2VwYXJhdG9yID0gZm9ybWF0Lmxlbmd0aCA8IHNlcGFyYXRvckluZGV4ID8gZm9ybWF0W3NlcGFyYXRvckluZGV4XSA6ICc6JywKICAgICAgICAgICAgICAgIGhvdXJzID0gTWF0aC5mbG9vcih0aW1lIC8gMzYwMCkgJSAyNCwKICAgICAgICAgICAgICAgIG1pbnV0ZXMgPSBNYXRoLmZsb29yKHRpbWUgLyA2MCkgJSA2MCwKICAgICAgICAgICAgICAgIHNlY29uZHMgPSBNYXRoLmZsb29yKHRpbWUgJSA2MCksCiAgICAgICAgICAgICAgICBmcmFtZXMgPSBNYXRoLmZsb29yKCh0aW1lICUgMSAqIGZwcykudG9GaXhlZCgzKSksCiAgICAgICAgICAgICAgICBsaXMgPSBbW2ZyYW1lcywgJ2YnXSwgW3NlY29uZHMsICdzJ10sIFttaW51dGVzLCAnbSddLCBbaG91cnMsICdoJ11dOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGxpcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgaWYgKGZvcm1hdC5pbmRleE9mKGxpc1tpXVsxXSkgPiAtMSkgewogICAgICAgICAgICAgICAgICAgIHJlcXVpcmVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVxdWlyZWQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaGFzTmV4dFZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IGk7IGogPCBsZW47IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGlzW2pdWzBdID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzTmV4dFZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoIWhhc05leHRWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmICghZmlyc3RUd29QbGFjZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0ID0gZmlyc3RDaGFyICsgZm9ybWF0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmb3JtYXQgPSBsaXNbaV1bMV0gKyBzZXBhcmF0b3IgKyBmb3JtYXQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpcnN0VHdvUGxhY2VzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdCA9IGxpc1tpXVsxXSArIGZvcm1hdDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZmlyc3RDaGFyID0gbGlzW2ldWzFdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBvcHRpb25zLmN1cnJlbnRUaW1lRm9ybWF0ID0gZm9ybWF0OwogICAgICAgIH0KCiAgICAgICAgLyoqCiAgICAgICAgICogQ29udmVydCBTb2NpZXR5IG9mIE1vdGlvbiBQaWN0dXJlIGFuZCBUZWxldmlzaW9uIEVuZ2luZWVycyAoU01UUEUpIHRpbWUgY29kZSBpbnRvIHNlY29uZHMKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBTTVBURQogICAgICAgICAqIEByZXR1cm4ge051bWJlcn0KICAgICAgICAgKi8KICAgICAgICBmdW5jdGlvbiBjb252ZXJ0U01QVEV0b1NlY29uZHMoU01QVEUpIHsKCiAgICAgICAgICAgIGlmICh0eXBlb2YgU01QVEUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudCBtdXN0IGJlIGEgc3RyaW5nIHZhbHVlJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIFNNUFRFID0gU01QVEUucmVwbGFjZSgnLCcsICcuJyk7CgogICAgICAgICAgICB2YXIgc2VjcyA9IDAsCiAgICAgICAgICAgICAgICBkZWNpbWFsTGVuID0gU01QVEUuaW5kZXhPZignLicpID4gLTEgPyBTTVBURS5zcGxpdCgnLicpWzFdLmxlbmd0aCA6IDAsCiAgICAgICAgICAgICAgICBtdWx0aXBsaWVyID0gMTsKCiAgICAgICAgICAgIFNNUFRFID0gU01QVEUuc3BsaXQoJzonKS5yZXZlcnNlKCk7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IFNNUFRFLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBtdWx0aXBsaWVyID0gMTsKICAgICAgICAgICAgICAgIGlmIChpID4gMCkgewogICAgICAgICAgICAgICAgICAgIG11bHRpcGxpZXIgPSBNYXRoLnBvdyg2MCwgaSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZWNzICs9IE51bWJlcihTTVBURVtpXSkgKiBtdWx0aXBsaWVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBOdW1iZXIoc2Vjcy50b0ZpeGVkKGRlY2ltYWxMZW4pKTsKICAgICAgICB9CgogICAgICAgIF9tZWpzMi5kZWZhdWx0LlV0aWxzID0gX21lanMyLmRlZmF1bHQuVXRpbHMgfHwge307CiAgICAgICAgX21lanMyLmRlZmF1bHQuVXRpbHMuc2Vjb25kc1RvVGltZUNvZGUgPSBzZWNvbmRzVG9UaW1lQ29kZTsKICAgICAgICBfbWVqczIuZGVmYXVsdC5VdGlscy50aW1lQ29kZVRvU2Vjb25kcyA9IHRpbWVDb2RlVG9TZWNvbmRzOwogICAgICAgIF9tZWpzMi5kZWZhdWx0LlV0aWxzLmNhbGN1bGF0ZVRpbWVGb3JtYXQgPSBjYWxjdWxhdGVUaW1lRm9ybWF0OwogICAgICAgIF9tZWpzMi5kZWZhdWx0LlV0aWxzLmNvbnZlcnRTTVBURXRvU2Vjb25kcyA9IGNvbnZlcnRTTVBURXRvU2Vjb25kczsKCiAgICB9LCB7IjYiOiA2fV0KfSwge30sIFszMSwgNSwgNCwgMTQsIDIzLCAyMCwgMTcsIDE4LCAxOSwgMjEsIDIyLCAyNCwgMjUsIDI2LCAxNSwgMTYsIDgsIDksIDEwLCAxMSwgMTIsIDEzXSk7Cg==</ActualData>
          </HTTPData>
        </HTTPDataSet>
        <IsExternalData>false</IsExternalData>
      </HTTPBody>
      <TcpPackets>
        <PacketInfo time="80862375" offset="0" length="757" />
        <PacketInfo time="80862375" offset="757" length="16355" />
        <PacketInfo time="80862375" offset="17112" length="16355" />
        <PacketInfo time="80862375" offset="33467" length="16355" />
        <PacketInfo time="80862390" offset="49822" length="16355" />
        <PacketInfo time="80862390" offset="66177" length="16355" />
        <PacketInfo time="80862390" offset="82532" length="16355" />
        <PacketInfo time="80862390" offset="98887" length="16355" />
        <PacketInfo time="80862390" offset="115242" length="16355" />
        <PacketInfo time="80862390" offset="131597" length="16355" />
        <PacketInfo time="80862390" offset="147952" length="16355" />
        <PacketInfo time="80862390" offset="164307" length="16355" />
        <PacketInfo time="80862406" offset="180662" length="16355" />
        <PacketInfo time="80862406" offset="197017" length="16355" />
        <PacketInfo time="80862406" offset="213372" length="16355" />
        <PacketInfo time="80862406" offset="229727" length="16355" />
        <PacketInfo time="80862406" offset="246082" length="16355" />
        <PacketInfo time="80862406" offset="262437" length="16355" />
        <PacketInfo time="80862406" offset="278792" length="16355" />
        <PacketInfo time="80862406" offset="295147" length="16355" />
        <PacketInfo time="80862421" offset="311502" length="16355" />
        <PacketInfo time="80862421" offset="327857" length="16355" />
        <PacketInfo time="80862421" offset="344212" length="16355" />
        <PacketInfo time="80862437" offset="360567" length="16355" />
        <PacketInfo time="80862437" offset="376922" length="16355" />
        <PacketInfo time="80862437" offset="393277" length="16355" />
        <PacketInfo time="80862453" offset="409632" length="16355" />
        <PacketInfo time="80862453" offset="425987" length="16355" />
        <PacketInfo time="80862453" offset="442342" length="16355" />
        <PacketInfo time="80862453" offset="458697" length="16355" />
        <PacketInfo time="80862468" offset="475052" length="16355" />
        <PacketInfo time="80862468" offset="491407" length="16355" />
        <PacketInfo time="80862468" offset="507762" length="3167" />
      </TcpPackets>
    </HTTPResponse>
  </HTTPTask>
</HTTPSnapshot>